
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>impy.arrays.labeledarray &#8212; impy 1.19.5 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">impy 1.19.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">impy.arrays.labeledarray</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for impy.arrays.labeledarray</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span> <span class="k">as</span> <span class="n">ndi</span>

<span class="kn">from</span> <span class="nn">.specials</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.utils._skimage</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_misc</span><span class="p">,</span> <span class="n">_docs</span>
<span class="kn">from</span> <span class="nn">.bases</span> <span class="kn">import</span> <span class="n">HistoryArray</span>
<span class="kn">from</span> <span class="nn">.label</span> <span class="kn">import</span> <span class="n">Label</span>

<span class="kn">from</span> <span class="nn">..utils.deco</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..utils.utilcls</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..utils.axesop</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..utils.misc</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..utils.io</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">..collections</span> <span class="kn">import</span> <span class="n">DataList</span>
<span class="kn">from</span> <span class="nn">..axes</span> <span class="kn">import</span> <span class="n">ImageAxesError</span>
<span class="kn">from</span> <span class="nn">..frame</span> <span class="kn">import</span> <span class="n">MarkerFrame</span>
<span class="kn">from</span> <span class="nn">.._types</span> <span class="kn">import</span> <span class="o">*</span>

<div class="viewcode-block" id="LabeledArray"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray">[docs]</a><span class="k">class</span> <span class="nc">LabeledArray</span><span class="p">(</span><span class="n">HistoryArray</span><span class="p">):</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    
<div class="viewcode-block" id="LabeledArray.set_scale"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.set_scale">[docs]</a>    <span class="k">def</span> <span class="nf">set_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>
        
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">):</span>
            <span class="n">labels_shape_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">shape_info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels_shape_info</span> <span class="o">=</span> <span class="s2">&quot;No label&quot;</span>
            
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>\
               <span class="sa">f</span><span class="s2">&quot;    shape     : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_info</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>\
               <span class="sa">f</span><span class="s2">&quot;  label shape : </span><span class="si">{</span><span class="n">labels_shape_info</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>\
               <span class="sa">f</span><span class="s2">&quot;    dtype     : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>\
               <span class="sa">f</span><span class="s2">&quot;  directory   : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dirpath</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>\
               <span class="sa">f</span><span class="s2">&quot;original image: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>\
               <span class="sa">f</span><span class="s2">&quot;   history    : </span><span class="si">{</span><span class="s1">&#39;-&gt;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    
    <span class="k">def</span> <span class="nf">_repr_dict_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">):</span>
            <span class="n">labels_shape_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">shape_info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels_shape_info</span> <span class="o">=</span> <span class="s2">&quot;No label&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;    shape     &quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_info</span><span class="p">,</span>
                <span class="s2">&quot;  label shape &quot;</span><span class="p">:</span> <span class="n">labels_shape_info</span><span class="p">,</span>
                <span class="s2">&quot;    dtype     &quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="s2">&quot;  directory   &quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirpath</span><span class="p">,</span>
                <span class="s2">&quot;original image&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;   history    &quot;</span><span class="p">:</span> <span class="s2">&quot;-&gt;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)}</span>
    
    
<div class="viewcode-block" id="LabeledArray.imsave"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.imsave">[docs]</a>    <span class="k">def</span> <span class="nf">imsave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tifname</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save image at the same directory as the original image by default. If the image contains</span>
<span class="sd">        wrong axes for ImageJ (= except for tzcyx), then it will converted automatically if possible.</span>
<span class="sd">        zyx-scale is also saved.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tifname : str</span>
<span class="sd">            File name.</span>
<span class="sd">        dtype : Any that can be interpreted as numpy.dtype, optional</span>
<span class="sd">            In what data type img will be saved.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="c1"># set default values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tifname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">):</span>
            <span class="n">tifname</span> <span class="o">+=</span> <span class="s2">&quot;.tif&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tifname</span><span class="p">:</span>
            <span class="n">tifname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">tifname</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
            
        <span class="c1"># change axes if needed</span>
        <span class="n">rest_axes</span> <span class="o">=</span> <span class="n">complement_axes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="s2">&quot;tzcyx&quot;</span><span class="p">)</span>
        <span class="n">new_axes</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">axes_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="s2">&quot;tzcyx&quot;</span><span class="p">:</span>
                <span class="n">new_axes</span> <span class="o">+=</span> <span class="n">a</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest_axes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ImageAxesError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot save image with axes </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">new_axes</span> <span class="o">+=</span> <span class="n">rest_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">rest_axes</span> <span class="o">=</span> <span class="n">rest_axes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">axes_changed</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># make a copy of the image for saving</span>
        <span class="k">if</span> <span class="n">new_axes</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">img</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">new_axes</span>
            <span class="n">img</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">as_img_type</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">sort_axes</span><span class="p">()</span>
        <span class="n">imsave_kwargs</span> <span class="o">=</span> <span class="n">get_imsave_meta_from_img</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">update_lut</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># save image</span>
        <span class="n">imwrite</span><span class="p">(</span><span class="n">tifname</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="o">**</span><span class="n">imsave_kwargs</span><span class="p">)</span>

        <span class="c1"># notifications</span>
        <span class="k">if</span> <span class="n">axes_changed</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_axes</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">axes</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image axes changed: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">new_axes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image axes changed and sorted: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">new_axes</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">axes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Succesfully saved: </span><span class="si">{</span><span class="n">tifname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>
    
    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
    <span class="c1">#   Basic Functions</span>
    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
    
    <span class="k">def</span> <span class="nf">__array_finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__array_finalize__</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view_labels</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_view_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a view of label **if possible**.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">axes_included</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_shape_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">labels</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">labels</span>
    
    <span class="k">def</span> <span class="nf">_getitem_additional_set_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_getitem_additional_set_info</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">axes</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">_keys</span> <span class="o">=</span> <span class="n">key</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_keys</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="p">,)</span>
            <span class="n">label_sl</span> <span class="o">=</span> <span class="p">[</span><span class="n">_keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span> 
                        <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">axes</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">_keys</span><span class="p">)]</span>
                    
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_sl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_sl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
                <span class="n">label_sl</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">label_sl</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;`labels` was not inherited due to IndexError :&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_set_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">next_history</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">new_axes</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;inherit&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_set_info</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">next_history</span><span class="p">,</span> <span class="n">new_axes</span><span class="p">)</span>
        
        <span class="c1"># inherit labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view_labels</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">as_img_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
    <span class="c1">#   Type Conversions</span>
    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
    
<div class="viewcode-block" id="LabeledArray.as_uint8"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.as_uint8">[docs]</a>    <span class="k">def</span> <span class="nf">as_uint8</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LabeledArray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="mi">256</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="mi">256</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mf">0.5</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid data type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">_set_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="LabeledArray.as_uint16"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.as_uint16">[docs]</a>    <span class="k">def</span> <span class="nf">as_uint16</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LabeledArray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="mi">256</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="mi">65535</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mf">0.5</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid data type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">_set_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>
    
<div class="viewcode-block" id="LabeledArray.as_float"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.as_float">[docs]</a>    <span class="k">def</span> <span class="nf">as_float</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LabeledArray</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">_set_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>
        
    
<div class="viewcode-block" id="LabeledArray.as_img_type"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.as_img_type">[docs]</a>    <span class="k">def</span> <span class="nf">as_img_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LabeledArray</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">dtype</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint16&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_uint16</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint8&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_uint8</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;float32&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_float</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;bool&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;bool&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;float64&quot;</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Data type float64 is not valid for images. It was converted to float32 instead&quot;</span><span class="p">,</span>
                 <span class="ne">UserWarning</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_float</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;int8&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int8&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dtype: </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
    
    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
    <span class="c1">#   Simple Visualizations</span>
    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

<div class="viewcode-block" id="LabeledArray.hist"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.hist">[docs]</a>    <span class="k">def</span> <span class="nf">hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contrast</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show intensity profile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_plot</span> <span class="k">as</span> <span class="n">_plt</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">contrast</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LabeledArray.imshow"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.imshow">[docs]</a>    <span class="nd">@dims_to_spatial_axes</span>
    <span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_plot</span> <span class="k">as</span> <span class="n">_plt</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_plt</span><span class="o">.</span><span class="n">plot_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">_plt</span><span class="o">.</span><span class="n">plot_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hist</span><span class="p">()</span>
            
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;c&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
                <span class="n">imglist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">find_first_appeared</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">dims</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imglist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Too many images. First 24 images are shown.&quot;</span><span class="p">)</span>
                    <span class="n">imglist</span> <span class="o">=</span> <span class="n">imglist</span><span class="p">[:</span><span class="mi">24</span><span class="p">]</span>
                <span class="n">_plt</span><span class="o">.</span><span class="n">plot_3d</span><span class="p">(</span><span class="n">imglist</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_chn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_chn</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">n_chn</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_chn</span><span class="p">):</span>
                    <span class="n">_plt</span><span class="o">.</span><span class="n">plot_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;c=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Image must have three or less dimensions.&quot;</span><span class="p">)</span>
        
        <span class="n">_plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="LabeledArray.imshow_comparewith"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.imshow_comparewith">[docs]</a>    <span class="k">def</span> <span class="nf">imshow_comparewith</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_plot</span> <span class="k">as</span> <span class="n">_plt</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">plot_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">plot_2d</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>        
        <span class="n">_plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    
<div class="viewcode-block" id="LabeledArray.imshow_label"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.imshow_label">[docs]</a>    <span class="nd">@dims_to_spatial_axes</span>
    <span class="k">def</span> <span class="nf">imshow_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_plot</span> <span class="k">as</span> <span class="n">_plt</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No label to show.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">_plt</span><span class="o">.</span><span class="n">plot_2d_label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hist</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;c&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
                <span class="n">imglist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">find_first_appeared</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">dims</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imglist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Too many images. First 24 images are shown.&quot;</span><span class="p">)</span>
                    <span class="n">imglist</span> <span class="o">=</span> <span class="n">imglist</span><span class="p">[:</span><span class="mi">24</span><span class="p">]</span>

                <span class="n">_plt</span><span class="o">.</span><span class="n">plot_3d_label</span><span class="p">(</span><span class="n">imglist</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">imglist</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_chn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_chn</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">n_chn</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_chn</span><span class="p">):</span>
                    <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;c=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                    <span class="n">_plt</span><span class="o">.</span><span class="n">plot_2d_label</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Image must be two or three dimensional.&quot;</span><span class="p">)</span>
        
        <span class="n">_plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    
    
    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
    <span class="c1">#   Cropping</span>
    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
    
<div class="viewcode-block" id="LabeledArray.crop_center"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.crop_center">[docs]</a>    <span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
    <span class="nd">@record</span><span class="p">()</span>
    <span class="nd">@dims_to_spatial_axes</span>
    <span class="k">def</span> <span class="nf">crop_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span><span class="n">nDFloat</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LabeledArray</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Crop out the center of an image. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scale : float or array-like, default is 0.5</span>
<span class="sd">            Scale of the cropped image. If an array is given, each axis will be cropped in different scales,</span>
<span class="sd">            using each value respectively.</span>
<span class="sd">        {dims}</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LabeledArray</span>
<span class="sd">            CroppedImage</span>
<span class="sd">            </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        1. Create a :math:`512\times512` image from a :math:`1024\times1024` image.</span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; img_cropped = img.crop_center(scale=0.5)</span>
<span class="sd">            </span>
<span class="sd">        2. Create a :math:`21\times256\times256` image from a :math:`63\times1024\times1024` image.</span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; img_cropped = img.crop_center(scale=[1/3, 1/2, 1/2])</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check scale</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">dims</span> <span class="o">==</span> <span class="s2">&quot;yx&quot;</span><span class="p">:</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="s2">&quot;zyx&quot;</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">check_nd</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">((</span><span class="n">scale</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">scale</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;scale must be (0, 1], but got </span><span class="si">{</span><span class="n">scale</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Make axis-targeted slicing string</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sizesof</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">sc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sc</span><span class="p">))</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">sc</span><span class="p">)))</span>
            <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">x0</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">x1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">slices</span><span class="p">)]</span>
        
        <span class="k">return</span> <span class="n">out</span></div>
    
<div class="viewcode-block" id="LabeledArray.crop_kernel"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.crop_kernel">[docs]</a>    <span class="nd">@record</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">crop_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">:</span><span class="n">nDInt</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LabeledArray</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a kernel from an image by cropping out the center region. This function is useful especially</span>
<span class="sd">        in `ImgArray.defocus()`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        radius : int or array-like of int, default is 2</span>
<span class="sd">            Radius of the kernel.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LabeledArray</span>
<span class="sd">            Kernel</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Make a :math:`4\times4\times4` kernel from a point spread function image (suppose the image shapes </span>
<span class="sd">        are all even numbers).</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; psf = ip.imread(r&quot;.../PSF.tif&quot;)</span>
<span class="sd">            &gt;&gt;&gt; psfker = psf.crop_kernel()</span>
<span class="sd">            &gt;&gt;&gt; psfer.shape</span>
<span class="sd">            (4, 4, 4)</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="n">check_nd</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">s</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">radii</span><span class="p">))]</span></div>
    
<div class="viewcode-block" id="LabeledArray.remove_edges"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.remove_edges">[docs]</a>    <span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
    <span class="nd">@record</span><span class="p">()</span>
    <span class="nd">@dims_to_spatial_axes</span>
    <span class="k">def</span> <span class="nf">remove_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel</span><span class="p">:</span><span class="n">nDInt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LabeledArray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove pixels from the edges.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pixel : int or array-like, default is 1</span>
<span class="sd">            Number of pixels to remove. If an array is given, each axis will be cropped with different pixels,</span>
<span class="sd">            using each value respectively.</span>
<span class="sd">        {dims}</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LabeledArray</span>
<span class="sd">            Cropped image.</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pixel</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pixel</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="s2">&quot;zyx&quot;</span>
        <span class="n">pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">check_nd</span><span class="p">(</span><span class="n">pixel</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">pixel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`pixel` must be positive.&quot;</span><span class="p">)</span>
            
        <span class="n">slices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">px</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">pixel</span><span class="p">):</span>
            <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">px</span><span class="si">}</span><span class="s2">:-</span><span class="si">{</span><span class="n">px</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">slices</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">out</span></div>
    
<div class="viewcode-block" id="LabeledArray.rotated_crop"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.rotated_crop">[docs]</a>    <span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
    <span class="nd">@record</span><span class="p">()</span>
    <span class="nd">@dims_to_spatial_axes</span>
    <span class="k">def</span> <span class="nf">rotated_crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">dst1</span><span class="p">,</span> <span class="n">dst2</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LabeledArray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Crop the image at four courners of an rotated rectangle. Currently only supports rotation within </span>
<span class="sd">        yx-plane. An rotated rectangle is specified with positions of a origin and two destinations `dst1`</span>
<span class="sd">        and `dst2`, i.e., vectors (dst1-origin) and (dst2-origin) represent a rotated rectangle. Let </span>
<span class="sd">        origin be the origin of a xy-plane, the rotation direction from dst1 to dst2 must be counter-</span>
<span class="sd">        clockwise, or the cropped image will be reversed.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ---------- </span>
<span class="sd">        origin : (float, float)</span>
<span class="sd">        dst1 : (float, float)</span>
<span class="sd">        dst2 :(float, float)</span>
<span class="sd">        {dims}</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LabeledArray</span>
<span class="sd">            Cropped array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
        <span class="n">dst1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dst1</span><span class="p">)</span>
        <span class="n">dst2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dst2</span><span class="p">)</span>
        <span class="n">ax0</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">make_rotated_axis</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">dst2</span><span class="p">)</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">_misc</span><span class="o">.</span><span class="n">make_rotated_axis</span><span class="p">(</span><span class="n">dst1</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>
        <span class="n">all_coords</span> <span class="o">=</span> <span class="n">ax0</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">ax1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">origin</span>
        <span class="n">all_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">all_coords</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cropped_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_dask</span><span class="p">(</span><span class="n">ndi</span><span class="o">.</span><span class="n">map_coordinates</span><span class="p">,</span> <span class="n">complement_axes</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">),</span> 
                                      <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                      <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">all_coords</span><span class="p">,),</span>
                                      <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">prefilter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                      <span class="p">)</span>
        <span class="n">cropped_img</span> <span class="o">=</span> <span class="n">cropped_img</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">cropped_img</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span>
                <span class="n">cropped_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">lbl</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">all_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">lbl</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sl</span><span class="p">,</span> <span class="n">lbl2d</span> <span class="ow">in</span> <span class="n">lbl</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">complement_axes</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">lbl</span><span class="o">.</span><span class="n">axes</span><span class="p">)):</span>
                    <span class="n">cropped_labels</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">map_coordinates</span><span class="p">(</span><span class="n">lbl2d</span><span class="p">,</span> <span class="n">all_coords</span><span class="p">,</span> <span class="n">prefilter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cropping labels failed&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cropped_img</span><span class="o">.</span><span class="n">append_label</span><span class="p">(</span><span class="n">cropped_labels</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">cropped_img</span></div>
    
    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
    <span class="c1">#   Label handling and others</span>
    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
    
<div class="viewcode-block" id="LabeledArray.specify"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.specify">[docs]</a>    <span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
    <span class="nd">@dims_to_spatial_axes</span>
    <span class="k">def</span> <span class="nf">specify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">:</span><span class="n">Coords</span><span class="p">,</span> <span class="n">radius</span><span class="p">:</span><span class="n">Coords</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labeltype</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;square&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Label</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make rectangle or ellipse labels from points.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        center : array like or MarkerFrame</span>
<span class="sd">            Coordinates of centers. For MarkerFrame, it must have the same axes order.</span>
<span class="sd">        radius : float or array-like</span>
<span class="sd">            Radius of labels.</span>
<span class="sd">        {dims}</span>
<span class="sd">        labeltype : str, default is &quot;square&quot;</span>
<span class="sd">            The shape of labels.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Label</span>
<span class="sd">            Labeled regions.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Find single molecules, draw circular labels around them if mean values were greater than 100.</span>
<span class="sd">            &gt;&gt;&gt; coords = img.find_sm()</span>
<span class="sd">            &gt;&gt;&gt; filter_func = lambda a: np.mean(a) &gt; 100</span>
<span class="sd">            &gt;&gt;&gt; img.specify(coords, 3.5, filt=filter_func, labeltype=&quot;circle&quot;)</span>
<span class="sd">            &gt;&gt;&gt; ip.gui.add(img)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">MarkerFrame</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">.utils._process_numba</span> <span class="kn">import</span> <span class="n">_specify_circ_2d</span><span class="p">,</span> <span class="n">_specify_circ_3d</span><span class="p">,</span> <span class="n">_specify_square_2d</span><span class="p">,</span> <span class="n">_specify_square_3d</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">check_nd</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">ndim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">labeltype</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;square&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">):</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="n">_specify</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="n">_specify_square_2d</span><span class="p">,</span>
                            <span class="mi">3</span><span class="p">:</span> <span class="n">_specify_square_3d</span><span class="p">}[</span><span class="n">ndim</span><span class="p">]</span>
                
            <span class="k">elif</span> <span class="n">labeltype</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;circle&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">):</span>
                <span class="n">_specify</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="n">_specify_circ_2d</span><span class="p">,</span>
                            <span class="mi">3</span><span class="p">:</span> <span class="n">_specify_circ_3d</span><span class="p">}[</span><span class="n">ndim</span><span class="p">]</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`labeltype` must be &#39;square&#39; or &#39;circle&#39;.&quot;</span><span class="p">)</span>
            
            <span class="n">label_axes</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">center</span><span class="o">.</span><span class="n">col_axes</span><span class="p">)</span>
            <span class="n">label_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sizesof</span><span class="p">(</span><span class="n">label_axes</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">largest_zeros</span><span class="p">(</span><span class="n">label_shape</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="n">Progress</span><span class="p">(</span><span class="s2">&quot;specify&quot;</span><span class="p">):</span>
                <span class="n">n_label</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">sl</span><span class="p">,</span> <span class="n">crds</span> <span class="ow">in</span> <span class="n">center</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">complement_axes</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">center</span><span class="o">.</span><span class="n">col_axes</span><span class="p">)):</span>
                    <span class="n">_specify</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">sl</span><span class="p">],</span> <span class="n">crds</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">n_label</span><span class="p">)</span>
                    <span class="n">n_label</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">crds</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Existing labels are updated.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">Label</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">label_axes</span><span class="p">)</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">center</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">center</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="n">cols</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span><span class="s2">&quot;yx&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="s2">&quot;zyx&quot;</span><span class="p">}[</span><span class="n">center</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">MarkerFrame</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">specify</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">labeltype</span><span class="o">=</span><span class="n">labeltype</span><span class="p">)</span>     
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span></div>
       
<div class="viewcode-block" id="LabeledArray.reslice"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.reslice">[docs]</a>    <span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
    <span class="nd">@record</span><span class="p">(</span><span class="n">append_history</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">reslice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PropArray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Measure line profile (kymograph) iteratively for every slice of image. This function is almost </span>
<span class="sd">        same as `skimage.measure.profile_line`, but can reslice 3D-images. The argument `linewidth` is </span>
<span class="sd">        not implemented here because it is useless.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        a : array-like</span>
<span class="sd">            Path or source coordinate. If the former, it must be like:</span>
<span class="sd">            `a = [[y0, x0], [y1, x1], ..., [yn, xn]]`</span>
<span class="sd">        b : array-like, optional</span>
<span class="sd">            Destination coordinate. If specified, `a` must be the source coordinate.</span>
<span class="sd">        {order}</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PropArray</span>
<span class="sd">            Line scans.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        1. Rescile along a line and fit to a model function for every time frame.</span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; scan = img.reslice([18, 32], [53, 48])</span>
<span class="sd">            &gt;&gt;&gt; out = scan.curve_fit(func, init, return_fit=True)</span>
<span class="sd">            &gt;&gt;&gt; plt.plot(scan[0])</span>
<span class="sd">            &gt;&gt;&gt; plt.plot(out.fit[0])</span>
<span class="sd">            </span>
<span class="sd">        2. Rescile along a path.</span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; scan = img.reslice([[18,32], [53,48], [22,45], [28, 32]])</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="c1"># path = [[y1, x1],[y2, x2], ..., [yn, xn]]</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">b</span><span class="p">)]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">npoints</span><span class="p">,</span> <span class="n">ndim</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="k">if</span> <span class="n">npoints</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Insufficient number of points for a path.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">npoints</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">a</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">-</span> <span class="n">src</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">d</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">src_</span><span class="p">,</span> <span class="n">dst_</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="k">for</span> <span class="n">src_</span><span class="p">,</span> <span class="n">dst_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>    
            <span class="kn">from</span> <span class="nn">.utils._process_numba</span> <span class="kn">import</span> <span class="n">_get_coordinate</span>
            
            <span class="n">each_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">total_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">each_length</span><span class="p">)</span>
            
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ndim</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_length</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">_get_coordinate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>
        
        <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span><span class="o">+</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,)</span><span class="o">*</span><span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="n">complement_axes</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">)[</span><span class="o">-</span><span class="n">ndim</span><span class="p">:]</span>
        <span class="n">c_axes</span> <span class="o">=</span> <span class="n">complement_axes</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_float</span><span class="p">()</span><span class="o">.</span><span class="n">apply_dask</span><span class="p">(</span><span class="n">ndi</span><span class="o">.</span><span class="n">map_coordinates</span><span class="p">,</span> 
                                            <span class="n">c_axes</span><span class="o">=</span><span class="n">c_axes</span><span class="p">,</span> 
                                            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                            <span class="n">drop_axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">coords</span><span class="p">,),</span>
                                            <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">prefilter</span><span class="o">=</span><span class="n">order</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
                                            <span class="p">)</span>
        
        <span class="n">sl</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">ndim</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axisof</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">sl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">out</span> <span class="o">=</span> <span class="n">PropArray</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">sl</span><span class="p">)],</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                        <span class="n">axes</span><span class="o">=</span><span class="n">c_axes</span><span class="o">+</span><span class="n">dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">propname</span><span class="o">=</span><span class="s2">&quot;reslice&quot;</span><span class="p">)</span>
        
        <span class="n">out</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>
    
<div class="viewcode-block" id="LabeledArray.label"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.label">[docs]</a>    <span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
    <span class="nd">@dims_to_spatial_axes</span>
    <span class="nd">@record</span><span class="p">(</span><span class="n">append_history</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Label</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run skimage&#39;s label() and store the results as attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        label_image : array, optional</span>
<span class="sd">            Image to make label, by default self is used.</span>
<span class="sd">        {dims}</span>
<span class="sd">        {connectivity}</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Label</span>
<span class="sd">            Labeled image.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Label the image with threshold and visualize with napari.</span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; thr = img.threshold()</span>
<span class="sd">            &gt;&gt;&gt; img.label(thr)</span>
<span class="sd">            &gt;&gt;&gt; ip.gui.add(img)</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="c1"># check the shape of label_image</span>
        <span class="k">if</span> <span class="n">label_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label_image</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">label_image</span><span class="p">,</span> <span class="s2">&quot;axes&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">label_image</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">is_none</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Use Array with axes for label_image.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">axes_included</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_image</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ImageAxesError</span><span class="p">(</span><span class="s2">&quot;Not all the axes in &#39;label_image&#39; are included in self: &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label_image</span><span class="o">.</span><span class="n">axes</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">_shape_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_image</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ImageAxesError</span><span class="p">(</span><span class="s2">&quot;Shape mismatch.&quot;</span><span class="p">)</span>
        
        <span class="n">c_axes</span> <span class="o">=</span> <span class="n">complement_axes</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">largest_zeros</span><span class="p">(</span><span class="n">label_image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        
        <span class="n">labels</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">label_image</span><span class="o">.</span><span class="n">apply_dask</span><span class="p">(</span><span class="n">skmes</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> 
                                           <span class="n">c_axes</span><span class="o">=</span><span class="n">c_axes</span><span class="p">,</span> 
                                           <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">background</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="n">connectivity</span><span class="p">)</span>
                                           <span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
    
        <span class="c1"># correct the label numbers of `labels`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">Label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">_set_info</span><span class="p">(</span><span class="n">label_image</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">increment_iter</span><span class="p">(</span><span class="n">c_axes</span><span class="p">)</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span></div>
    
<div class="viewcode-block" id="LabeledArray.label_if"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.label_if">[docs]</a>    <span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
    <span class="nd">@dims_to_spatial_axes</span>
    <span class="nd">@record</span><span class="p">(</span><span class="n">append_history</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">label_if</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Label</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Label image using `label_image` as reference image only if certain condition</span>
<span class="sd">        dictated in `filt` is satisfied. `skimage.measure.regionprops_table` is called</span>
<span class="sd">        inside every time image is labeled.</span>
<span class="sd">        </span>
<span class="sd">            .. code-block:: python</span>
<span class="sd">            </span>
<span class="sd">                def filt(img, lbl, area, major_axis_length):</span>
<span class="sd">                    return area&gt;10 and major_axis_length&gt;5</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        label_image : array, optional</span>
<span class="sd">            Image to make label, by default self is used.</span>
<span class="sd">        filt : callable, positional argument but not optional</span>
<span class="sd">            Filter function. The first argument is intensity image sliced from `self`, the </span>
<span class="sd">            second is label image sliced from labeled `label_image`, and the rest arguments </span>
<span class="sd">            is properties that will be calculated using `regionprops` function. The property </span>
<span class="sd">            arguments **must be named exactly same** as the properties in `regionprops`.</span>
<span class="sd">            Number of arguments can be two.</span>
<span class="sd">        {dims}</span>
<span class="sd">        {connectivity}</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LabeledArray</span>
<span class="sd">            Labeled image</span>
<span class="sd">        </span>
<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        1. Label regions if only intensity is high.</span>
<span class="sd">            &gt;&gt;&gt; def high_intensity(img, lbl, slice):</span>
<span class="sd">            &gt;&gt;&gt;     return np.mean(img[slice]) &gt; 10000</span>
<span class="sd">            &gt;&gt;&gt; img.label_if(lbl, filt)</span>
<span class="sd">        </span>
<span class="sd">        2. Label regions if no hole exists.</span>
<span class="sd">            &gt;&gt;&gt; def no_hole(img, lbl, euler_number):</span>
<span class="sd">            &gt;&gt;&gt;     return euler_number &gt; 0</span>
<span class="sd">            &gt;&gt;&gt; img.label_if(lbl, filt)</span>
<span class="sd">        </span>
<span class="sd">        3. Label regions if centroids are inside themselves.</span>
<span class="sd">            &gt;&gt;&gt; def no_hole(img, lbl, centroid):</span>
<span class="sd">            &gt;&gt;&gt;     yc, xc = map(int, centroid)</span>
<span class="sd">            &gt;&gt;&gt;     return lbl[yc, xc] &gt; 0</span>
<span class="sd">            &gt;&gt;&gt; img.label_if(lbl, filt)</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="c1"># check the shape of label_image</span>
        <span class="k">if</span> <span class="n">label_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label_image</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">label_image</span><span class="p">,</span> <span class="s2">&quot;axes&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">label_image</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">is_none</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Use Array with axes for label_image.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">axes_included</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_image</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ImageAxesError</span><span class="p">(</span><span class="s2">&quot;Not all the axes in &#39;label_image&#39; are included in self: &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label_image</span><span class="o">.</span><span class="n">axes</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">_shape_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_image</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ImageAxesError</span><span class="p">(</span><span class="s2">&quot;Shape mismatch.&quot;</span><span class="p">)</span>
        
        <span class="c1"># check filter function</span>
        <span class="k">if</span> <span class="n">filt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`filt` must be given.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">filt</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`filt` must be callable.&quot;</span><span class="p">)</span>
        
        <span class="n">properties</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
            
        <span class="n">c_axes</span> <span class="o">=</span> <span class="n">complement_axes</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">largest_zeros</span><span class="p">(</span><span class="n">label_image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">sl</span><span class="p">,</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">label_image</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">c_axes</span><span class="p">):</span>
            <span class="n">lbl</span> <span class="o">=</span> <span class="n">skmes</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">lbl</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="n">connectivity</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span>
            <span class="c1"># Following lines are essentially doing the same thing as `skmes.regionprops_table`.</span>
            <span class="c1"># However, `skmes.regionprops_table` returns tuples in the separated columns in</span>
            <span class="c1"># DataFrame and rename property names like &quot;centroid-0&quot; and &quot;centroid-1&quot;.</span>
            <span class="n">props_obj</span> <span class="o">=</span> <span class="n">skmes</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">lbl</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">prop_name</span><span class="p">:</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">props_obj</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">prop_name</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">}</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">del_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">filt</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lbl</span><span class="p">,</span> <span class="o">**</span><span class="n">r</span><span class="p">)]</span>
            <span class="n">labels</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span> <span class="o">=</span> <span class="n">skseg</span><span class="o">.</span><span class="n">relabel_sequential</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">lbl</span><span class="p">,</span> <span class="n">del_list</span><span class="p">),</span>
                                                        <span class="mi">0</span><span class="p">,</span> <span class="n">lbl</span><span class="p">),</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">labels</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">Label</span><span class="p">)</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">_set_info</span><span class="p">(</span><span class="n">label_image</span><span class="p">,</span> <span class="s2">&quot;label_if&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span></div>
    
<div class="viewcode-block" id="LabeledArray.append_label"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.append_label">[docs]</a>    <span class="nd">@record</span><span class="p">(</span><span class="n">append_history</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">append_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_image</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">new</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Label</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append new labels from an array. This function works for boolean or signed int arrays.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        label_image : np.ndarray</span>
<span class="sd">            Labeled image.</span>
<span class="sd">        new : bool, default is False</span>
<span class="sd">            If True, existing labels will be removed anyway.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Label</span>
<span class="sd">            New labels.</span>
<span class="sd">        </span>
<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        Make label from different channels.</span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; thr0 = img[&quot;c=0&quot;].threshold(&quot;90%&quot;)</span>
<span class="sd">            &gt;&gt;&gt; thr0.label() # binary to label</span>
<span class="sd">            &gt;&gt;&gt; thr1 = img[&quot;c=1&quot;].threshold(&quot;90%&quot;)</span>
<span class="sd">            &gt;&gt;&gt; thr1.label() # binary to label</span>
<span class="sd">            &gt;&gt;&gt; img.append_label(thr0.labels)</span>
<span class="sd">            &gt;&gt;&gt; img.append_label(thr1.labels)</span>
<span class="sd">            </span>
<span class="sd">        If `thr0` has 100 labels and `thr1` has 150 labels then `img` will have :math:`100+150=250` labels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check and cast label dtype</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label_image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`label_image` must be ndarray, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">label_image</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">label_image</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">label_image</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">label_image</span> <span class="o">=</span> <span class="n">label_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">label_image</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">:</span>
            <span class="n">label_image</span> <span class="o">=</span> <span class="n">label_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">label_image</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">:</span>
            <span class="n">label_image</span> <span class="o">=</span> <span class="n">label_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">label_image</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
            <span class="n">label_image</span> <span class="o">=</span> <span class="n">label_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`label_image` has dtype </span><span class="si">{</span><span class="n">label_image</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">, which is unable to be &quot;</span>
                             <span class="s2">&quot;interpreted as an label.&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">label_image</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ImageAxesError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape mismatch. Existing labels have shape </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;while labels with shape </span><span class="si">{</span><span class="n">label_image</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> is given.&quot;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span><span class="n">label_image</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># when label_image is simple ndarray</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">label_image</span><span class="p">,</span> <span class="s2">&quot;axes&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">label_image</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                    <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span>
                <span class="k">elif</span> <span class="n">label_image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="ow">and</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
                    <span class="n">axes</span> <span class="o">=</span> <span class="s2">&quot;yx&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not infer axes of `label_image`.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">label_image</span><span class="o">.</span><span class="n">axes</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">axes_included</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_image</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ImageAxesError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Axes mismatch. Image has </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="si">}</span><span class="s2">-axes but </span><span class="si">{</span><span class="n">axes</span><span class="si">}</span><span class="s2"> was given.&quot;</span><span class="p">)</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">Label</span><span class="p">(</span><span class="n">label_image</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">dirpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dirpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span></div>
    
<div class="viewcode-block" id="LabeledArray.proj_labels"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.proj_labels">[docs]</a>    <span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
    <span class="nd">@dims_to_spatial_axes</span>
    <span class="nd">@record</span><span class="p">(</span><span class="n">append_history</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">need_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">proj_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">forbid_overlap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Label</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Label projection. This function is useful when yx-labels are drawn in different z but</span>
<span class="sd">        you want to merge them.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        {dims}</span>
<span class="sd">        forbid_overlap : bool, default is False</span>
<span class="sd">            If True and there were any label overlap, this function will raise ValueError.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Label</span>
<span class="sd">            Projected labels.</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">c_axes</span> <span class="o">=</span> <span class="n">complement_axes</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">new_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">c_axes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">forbid_overlap</span><span class="p">:</span>
            <span class="n">test_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">c_axes</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">test_array</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Label overlapped.&quot;</span><span class="p">)</span>
        <span class="n">new_labels</span><span class="o">.</span><span class="n">_set_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="s2">&quot;proj&quot;</span><span class="p">,</span> <span class="n">new_axes</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">new_labels</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span></div>
    
<div class="viewcode-block" id="LabeledArray.split"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataList</span><span class="p">[</span><span class="n">LabeledArray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split n-dimensional image into (n-1)-dimensional images. This function is different from</span>
<span class="sd">        `np.split`, which split an array into smaller pieces (n-D to n-D).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        axis : str or int, optional</span>
<span class="sd">            Along which axis the original image will be split, by default &quot;c&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of arrays</span>
<span class="sd">            Separate images</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># determine axis in int.</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">find_first_appeared</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="s2">&quot;cztp&lt;&quot;</span><span class="p">)</span>
        <span class="n">axisint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axisof</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        
        <span class="n">imgs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">axisint</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">axisint</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
                <span class="n">lbl</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">del_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">axisint</span><span class="p">)</span>
                <span class="n">lbl</span><span class="o">.</span><span class="n">set_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
                <span class="n">img</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">lbl</span>
            
        <span class="k">return</span> <span class="n">imgs</span></div>
    
<div class="viewcode-block" id="LabeledArray.tile"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.tile">[docs]</a>    <span class="k">def</span> <span class="nf">tile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">along</span><span class="p">:</span><span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span><span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LabeledArray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tile images in a certain order. Label is also tiled in the same manner.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        shape : tuple[int, int], optional</span>
<span class="sd">            Grid shape. This parameter must be specified unless the length of `along` is 2.</span>
<span class="sd">        along : str, optional</span>
<span class="sd">            Axis (Axes) over which will be iterated.</span>
<span class="sd">        order : str, {&quot;r&quot;, &quot;c&quot;}, optional</span>
<span class="sd">            Order of iteration. &quot;r&quot; means row-wise and &quot;c&quot; means column-wise.</span>

<span class="sd">            </span>
<span class="sd">            .. code-block::</span>
<span class="sd">            </span>
<span class="sd">                row-wise</span>
<span class="sd">                    -----&gt;</span>
<span class="sd">                    -----&gt;</span>
<span class="sd">                    -----&gt;</span>
<span class="sd">                </span>
<span class="sd">                column-wise</span>
<span class="sd">                    | | |</span>
<span class="sd">                    | | |</span>
<span class="sd">                    v v v</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        HistoryArray</span>
<span class="sd">            Tiled array</span>
<span class="sd">            </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        1. Read images as stack and tile them in grid shape :math:`5 \times 4`.</span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; img = ip.imread_collection(r&quot;C:\...&quot;)</span>
<span class="sd">            &gt;&gt;&gt; tiled_img = img.tile((5, 4))</span>
<span class="sd">            </span>
<span class="sd">        2. Read OME-TIFF images </span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; img = ip.imread_stack(r&quot;C:\...\Images_MMStack-Pos_$i_$j.ome.tif&quot;)</span>
<span class="sd">            &gt;&gt;&gt; tiled_img = img.tile()</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">tiled_img</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">along</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">):</span>
            <span class="n">tiled_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">along</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
            <span class="n">tiled_img</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">tiled_label</span>
        <span class="k">return</span> <span class="n">tiled_img</span></div>
    
<div class="viewcode-block" id="LabeledArray.for_each_channel"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.for_each_channel">[docs]</a>    <span class="nd">@record</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">for_each_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">along</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LabeledArray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply same function with different parameters for each channel. This function will be useful</span>
<span class="sd">        when the parameters are dependent on channels, like wave length.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func : str</span>
<span class="sd">            Function name to apply over channel axis.</span>
<span class="sd">        along : str, default is &quot;c&quot;</span>
<span class="sd">            Along which axis function will be applied to.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LabeledArray</span>
<span class="sd">            output image stack</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="si">}</span><span class="s2"> does not have method </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">along</span><span class="p">)</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">kw</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">_iter_dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">))):</span>
            <span class="n">img</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">func</span><span class="p">)(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">along</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span></div>
    
<div class="viewcode-block" id="LabeledArray.for_params"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.for_params">[docs]</a>    <span class="nd">@record</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">for_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span><span class="n">Callable</span><span class="o">|</span><span class="nb">str</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Iterable</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataList</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply same function with different parameters with same input. This function will be useful</span>
<span class="sd">        when you want to try different conditions to the same image.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func : callable or str</span>
<span class="sd">            Function to apply repetitively. If str, then member method will be called. </span>
<span class="sd">        var : dict[str, Iterable], optional</span>
<span class="sd">            Name of variable and the values to try. If you want to try sigma=1,2,3 then you should</span>
<span class="sd">            give `var={&quot;sigma&quot;: [1, 2, 3]}`.</span>
<span class="sd">        kwargs</span>
<span class="sd">            Fixed paramters that will be passed to `func`. If `var` is not given and only one parameter</span>
<span class="sd">            is provided in `kwargs`, then kwargs will be `var`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataList</span>
<span class="sd">            List of outputs.</span>
<span class="sd">            </span>
<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        1. Try LoG filter with different Gaussian kernel size and visualize all of them in napari.</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; out = img.for_params(&quot;log_filter&quot;, var={&quot;sigma&quot;:[1, 2, 3, 4]})</span>
<span class="sd">            # or</span>
<span class="sd">            &gt;&gt;&gt; out = img.for_params(&quot;log_filter&quot;, sigma=[1, 2, 3, 4])</span>
<span class="sd">            # then</span>
<span class="sd">            &gt;&gt;&gt; ip.gui.add(out)</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> is neither </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="si">}</span><span class="s2">&#39;s&#39; method nor callable object.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong inputs.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keyword </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> exists in `kwargs`.&quot;</span><span class="p">)</span>
        <span class="n">outlist</span> <span class="o">=</span> <span class="n">DataList</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outlist</span>        </div>
        
    
<div class="viewcode-block" id="LabeledArray.extract"><a class="viewcode-back" href="../../../impy.arrays.html#impy.arrays.labeledarray.LabeledArray.extract">[docs]</a>    <span class="nd">@record</span><span class="p">(</span><span class="n">need_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cval</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataList</span><span class="p">[</span><span class="n">LabeledArray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract certain regions of the image and substitute others to `cval`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        label_ids : int or iterable of int, by default all the label IDs.</span>
<span class="sd">            Which label regions are extracted.</span>
<span class="sd">        filt : callable, optional</span>
<span class="sd">            If given, only regions `X` that satisfy filt(self, X) will extracted.</span>
<span class="sd">        cval : float, default is 0.</span>
<span class="sd">            Constant value to fill regions outside the extracted labeled regions.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataList of LabeledArray</span>
<span class="sd">            Extracted image(s)</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="k">if</span> <span class="n">filt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">arr</span><span class="p">,</span> <span class="n">lbl</span><span class="p">:</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">filt</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`filt` must be callable if given.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">label_ids</span><span class="p">):</span>
            <span class="n">label_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_ids</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">label_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># All the labels except for 0 (which means not labeled)</span>
            <span class="n">label_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
        
        <span class="n">slices</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">label_ids</span><span class="p">:</span>
            <span class="n">sl</span> <span class="o">=</span> <span class="n">slices</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span>
            <span class="n">subregion</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">labels</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">filt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subregion</span><span class="p">):</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="o">~</span><span class="n">subregion</span><span class="p">]</span> <span class="o">=</span> <span class="n">cval</span>
                <span class="k">del</span> <span class="n">obj</span><span class="o">.</span><span class="n">labels</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                
        <span class="n">out</span> <span class="o">=</span> <span class="n">DataList</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">out</span></div></div>

<span class="k">def</span> <span class="nf">_iter_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">nparam</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nparam</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nparam</span><span class="p">:</span>
                    <span class="c1"># raise error here for an earlier feedback.</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of parameter &#39;</span><span class="si">{k}</span><span class="s2">&#39; does not match the number channels.&quot;</span><span class="p">)</span>
                <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">yield</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">_shape_match</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    e.g.)</span>
<span class="sd">    img   ... 12(t), 100(y), 50(x)</span>
<span class="sd">    label ... 100(y), 50(x)</span>
<span class="sd">        -&gt; True</span>
<span class="sd">    img   ... 12(t), 100(y), 50(x)</span>
<span class="sd">    label ... 30(y), 50(x)</span>
<span class="sd">        -&gt; False</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="n">img</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">==</span><span class="n">label</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">label</span><span class="o">.</span><span class="n">axes</span><span class="p">])</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">impy 1.19.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">impy.arrays.labeledarray</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Hanjin Liu.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.1.2.
    </div>
  </body>
</html>