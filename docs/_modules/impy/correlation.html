<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>impy.correlation &mdash; impy 2.0.0.alpha documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> impy
          </a>
              <div class="version">
                2.0.0.alpha
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_cmd.html">Command Line Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">impy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>impy.correlation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for impy.correlation</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
<span class="kn">from</span> <span class="nn">.core</span> <span class="kn">import</span> <span class="n">asarray</span> <span class="k">as</span> <span class="n">ip_asarray</span>
<span class="kn">from</span> <span class="nn">.arrays</span> <span class="kn">import</span> <span class="n">ImgArray</span><span class="p">,</span> <span class="n">PropArray</span>
<span class="kn">from</span> <span class="nn">.arrays._utils</span> <span class="kn">import</span> <span class="n">_docs</span>
<span class="kn">from</span> <span class="nn">.arrays._utils._transform</span> <span class="kn">import</span> <span class="n">polar2d</span>
<span class="kn">from</span> <span class="nn">.arrays._utils._corr</span> <span class="kn">import</span> <span class="n">subpixel_pcc</span><span class="p">,</span> <span class="n">subpixel_ncc</span><span class="p">,</span> <span class="n">draw_pcc_landscape</span><span class="p">,</span> <span class="n">draw_ncc_landscape</span>
<span class="kn">from</span> <span class="nn">.utils.axesop</span> <span class="kn">import</span> <span class="n">complement_axes</span><span class="p">,</span> <span class="n">add_axes</span>
<span class="kn">from</span> <span class="nn">.utils.deco</span> <span class="kn">import</span> <span class="n">dims_to_spatial_axes</span>
<span class="kn">from</span> <span class="nn">.array_api</span> <span class="kn">import</span> <span class="n">xp</span>
<span class="kn">from</span> <span class="nn">._types</span> <span class="kn">import</span> <span class="n">Dims</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;fsc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fourier_shell_correlation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ncc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;zncc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fourier_ncc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fourier_zncc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nmi&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pcc_maximum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pcc_maximum_with_corr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ft_pcc_maximum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ft_pcc_maximum_with_corr&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;polar_pcc_maximum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;polar_pcc_maximum_with_corr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;zncc_maximum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;zncc_maximum_with_corr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pcc_landscape&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;ft_pcc_landscape&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;zncc_landscape&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pearson_coloc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;manders_coloc&quot;</span><span class="p">,</span>
<span class="p">]</span>

<div class="viewcode-block" id="fsc"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.fsc">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="k">def</span> <span class="nf">fsc</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">dfreq</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Fourier Shell Correlation (FSC; or Fourier Ring Correlation, FRC, for 2-D images) </span>
<span class="sd">    between two images. FSC is defined as:</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">        FSC(r) = \frac{Re(\sum_{r&lt;r&#39;&lt;r+dr}[F_0(r&#39;) \cdot \bar{F_1}(r)])}</span>
<span class="sd">        {\sqrt{\sum_{r&lt;r&#39;&lt;r+dr}|F_0(r&#39;)|^2 \cdot \sum_{r&lt;r&#39;&lt;r+dr}|F_1(r&#39;)|^2}}</span>
<span class="sd">    </span>
<span class="sd">    In this function, frequency domain will be binned like this:</span>
<span class="sd">    </span>
<span class="sd">    .. code-block::</span>

<span class="sd">        |---|---|---|---|---|</span>
<span class="sd">        0  0.1 0.2 0.3 0.4 0.5</span>
<span class="sd">    </span>
<span class="sd">    and frequencies calculated in each bin will be 0.05, 0.15, ..., 0.45.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    dfreq : float, default is 0.02</span>
<span class="sd">        Difference of frequencies. This value will be the width of bins.</span>
<span class="sd">                </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Two np.ndarray</span>
<span class="sd">        The first array is frequency, and the second array is FSC.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">img0</span><span class="p">,</span> <span class="n">img1</span> <span class="o">=</span> <span class="n">_check_inputs</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">)</span>
    
    <span class="n">shape</span> <span class="o">=</span> <span class="n">img0</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="n">img0</span><span class="o">.</span><span class="n">axes</span>
    
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">xp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">],</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">))</span>

    <span class="c1"># make radially separated labels</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">dfreq</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
    <span class="n">nlabels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
    
    <span class="n">out</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nlabels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">radial_sum</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndi</span><span class="o">.</span><span class="n">sum_labels</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">xp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nlabels</span><span class="p">))</span>

    <span class="n">f0</span> <span class="o">=</span> <span class="n">img0</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">img1</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span>
    
    <span class="n">cov</span> <span class="o">=</span> <span class="n">f0</span><span class="o">.</span><span class="n">real</span><span class="o">*</span><span class="n">f1</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="n">f0</span><span class="o">.</span><span class="n">imag</span><span class="o">*</span><span class="n">f1</span><span class="o">.</span><span class="n">imag</span>
    <span class="n">pw0</span> <span class="o">=</span> <span class="n">f0</span><span class="o">.</span><span class="n">real</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">f0</span><span class="o">.</span><span class="n">imag</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">pw1</span> <span class="o">=</span> <span class="n">f1</span><span class="o">.</span><span class="n">real</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">f1</span><span class="o">.</span><span class="n">imag</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">radial_sum</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span><span class="o">/</span><span class="n">xp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">radial_sum</span><span class="p">(</span><span class="n">pw0</span><span class="p">)</span> <span class="o">*</span> <span class="n">radial_sum</span><span class="p">(</span><span class="n">pw1</span><span class="p">))</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">dfreq</span>
    <span class="k">return</span> <span class="n">freq</span><span class="p">,</span> <span class="n">xp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>

<span class="c1"># alias</span>
<span class="n">fourier_shell_correlation</span> <span class="o">=</span> <span class="n">fsc</span>


<span class="k">def</span> <span class="nf">_ncc</span><span class="p">(</span><span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> <span class="n">dims</span><span class="p">:</span> <span class="n">Dims</span><span class="p">):</span>
    <span class="c1"># Basic Normalized Cross Correlation with batch processing</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">sizesof</span><span class="p">(</span><span class="n">dims</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">axisof</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">)</span>
    <span class="n">img0</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img0</span><span class="p">)</span>
    <span class="n">img1</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img1</span><span class="p">)</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img0</span> <span class="o">*</span> <span class="n">img1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
        <span class="n">xp</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span><span class="o">*</span><span class="n">xp</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dims</span><span class="p">))</span> <span class="o">/</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">xp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_masked_ncc</span><span class="p">(</span><span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> <span class="n">dims</span><span class="p">:</span> <span class="n">Dims</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">sizesof</span><span class="p">(</span><span class="n">dims</span><span class="p">))</span>
    <span class="n">img0ma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">img1ma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img1</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">axisof</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img0ma</span> <span class="o">*</span> <span class="n">img1ma</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">img0ma</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">img1ma</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span> <span class="o">/</span> <span class="n">n</span>


<span class="k">def</span> <span class="nf">_zncc</span><span class="p">(</span><span class="n">img0</span><span class="p">:</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">img1</span><span class="p">:</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">dims</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]):</span>
    <span class="c1"># Basic Zero-mean Normalized Cross Correlation with batch processing.</span>
    <span class="c1"># Inputs must be already zero-normalized.</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img0</span> <span class="o">*</span> <span class="n">img1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
        <span class="n">xp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img0</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span><span class="o">*</span><span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img1</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dims</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">corr</span>


<span class="k">def</span> <span class="nf">_masked_zncc</span><span class="p">(</span><span class="n">img0</span><span class="p">:</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">img1</span><span class="p">:</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">dims</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">mask</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">xp</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;cupy&quot;</span><span class="p">:</span>
        <span class="n">img0</span> <span class="o">=</span> <span class="n">img0</span><span class="o">*</span><span class="n">mask</span>
        <span class="n">img1</span> <span class="o">=</span> <span class="n">img1</span><span class="o">*</span><span class="n">mask</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img0</span><span class="o">*</span><span class="n">img1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">xp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img0</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span><span class="o">*</span><span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img1</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dims</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">img0ma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">img1ma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img0ma</span> <span class="o">*</span> <span class="n">img1ma</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img0ma</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img1ma</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dims</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">out</span>

<div class="viewcode-block" id="ncc"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.ncc">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="nd">@dims_to_spatial_axes</span>
<span class="k">def</span> <span class="nf">ncc</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">mask</span><span class="p">:</span> <span class="n">ImgArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
    <span class="o">*</span><span class="p">,</span> 
    <span class="n">dims</span><span class="p">:</span> <span class="n">Dims</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PropArray</span> <span class="o">|</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalized Cross Correlation.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    mask : boolean ImgArray, optional</span>
<span class="sd">        If provided, True regions will be masked and will not be taken into account when calculate </span>
<span class="sd">        correlation.</span>
<span class="sd">    {squeeze}</span>
<span class="sd">    {dims}</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    PropArray or float</span>
<span class="sd">        Correlation value(s).</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">img0</span><span class="p">,</span> <span class="n">img1</span> <span class="o">=</span> <span class="n">_check_inputs</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">_ncc</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">img0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">add_axes</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">img0</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">_masked_ncc</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">_make_corr_output</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">img0</span><span class="p">,</span> <span class="s2">&quot;ncc&quot;</span><span class="p">,</span> <span class="n">squeeze</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span></div>

<div class="viewcode-block" id="zncc"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.zncc">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="nd">@dims_to_spatial_axes</span>
<span class="k">def</span> <span class="nf">zncc</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">mask</span><span class="p">:</span> <span class="n">ImgArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">dims</span><span class="p">:</span> <span class="n">Dims</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PropArray</span> <span class="o">|</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Zero-mean Normalized Cross Correlation.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    mask : boolean ImgArray, optional</span>
<span class="sd">        If provided, True regions will be masked and will not be taken into account when calculate </span>
<span class="sd">        correlation.</span>
<span class="sd">    {squeeze}</span>
<span class="sd">    {dims}</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    PropArray or float</span>
<span class="sd">        Correlation value(s).</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">img0</span><span class="p">,</span> <span class="n">img1</span> <span class="o">=</span> <span class="n">_check_inputs</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">)</span>
    <span class="n">_dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">axisof</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">)</span>
    <span class="n">_img0</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">_img1</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img1</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">img0zn</span> <span class="o">=</span> <span class="n">_img0</span> <span class="o">-</span> <span class="n">xp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">_img0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">_dims</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">img1zn</span> <span class="o">=</span> <span class="n">_img1</span> <span class="o">-</span> <span class="n">xp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">_img1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">_dims</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">_zncc</span><span class="p">(</span><span class="n">img0zn</span><span class="p">,</span> <span class="n">img1zn</span><span class="p">,</span> <span class="n">_dims</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">img0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">add_axes</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">img0</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">_masked_zncc</span><span class="p">(</span><span class="n">img0zn</span><span class="p">,</span> <span class="n">img1zn</span><span class="p">,</span> <span class="n">_dims</span><span class="p">,</span> <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">_make_corr_output</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">corr</span><span class="p">),</span> <span class="n">img0</span><span class="p">,</span> <span class="s2">&quot;zncc&quot;</span><span class="p">,</span> <span class="n">squeeze</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span></div>

<span class="c1"># alias</span>
<span class="n">pearson_coloc</span> <span class="o">=</span> <span class="n">zncc</span>

<div class="viewcode-block" id="nmi"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.nmi">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="nd">@dims_to_spatial_axes</span>
<span class="k">def</span> <span class="nf">nmi</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span>
    <span class="n">mask</span><span class="p">:</span> <span class="n">ImgArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> 
    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span> 
    <span class="n">dims</span><span class="p">:</span> <span class="n">Dims</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PropArray</span> <span class="o">|</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalized Mutual Information.</span>
<span class="sd">    </span>
<span class="sd">    :math:`Y(A, B) = \frac{H(A) + H(B)}{H(A, B)}`</span>
<span class="sd">                   </span>
<span class="sd">    See &quot;Elegant SciPy&quot;</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    mask : boolean ImgArray, optional</span>
<span class="sd">        If provided, True regions will be masked and will not be taken into account when calculate </span>
<span class="sd">        correlation.</span>
<span class="sd">    bins : int, default is 100</span>
<span class="sd">        Number of bins to construct histograms.</span>
<span class="sd">    {squeeze}</span>
<span class="sd">    {dims}</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    PropArray or float</span>
<span class="sd">        Correlation value(s).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">entropy</span>

    <span class="n">img0</span><span class="p">,</span> <span class="n">img1</span> <span class="o">=</span> <span class="n">_check_inputs</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">)</span>
    <span class="n">c_axes</span> <span class="o">=</span> <span class="n">complement_axes</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">img0</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">sizesof</span><span class="p">(</span><span class="n">c_axes</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="n">img0</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">add_axes</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">img0</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sl</span><span class="p">,</span> <span class="n">img0_</span><span class="p">,</span> <span class="n">img1_</span> <span class="ow">in</span> <span class="n">iter2</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">,</span> <span class="n">c_axes</span><span class="p">):</span>
        <span class="n">mask_</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span>
        <span class="n">hist</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">img0_</span><span class="p">[</span><span class="n">mask_</span><span class="p">]),</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">img1_</span><span class="p">[</span><span class="n">mask_</span><span class="p">])],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
        <span class="n">hist</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="n">entropy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># Shannon entropy</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">entropy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">e12</span> <span class="o">=</span> <span class="n">entropy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span> <span class="c1"># mutual entropy</span>
        <span class="n">out</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">e1</span> <span class="o">+</span> <span class="n">e2</span><span class="p">)</span><span class="o">/</span><span class="n">e12</span>
    <span class="k">return</span> <span class="n">_make_corr_output</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">img0</span><span class="p">,</span> <span class="s2">&quot;nmi&quot;</span><span class="p">,</span> <span class="n">squeeze</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span></div>

<div class="viewcode-block" id="fourier_ncc"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.fourier_ncc">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="nd">@dims_to_spatial_axes</span>
<span class="k">def</span> <span class="nf">fourier_ncc</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">mask</span><span class="p">:</span> <span class="n">ImgArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
    <span class="o">*</span><span class="p">,</span> 
    <span class="n">dims</span><span class="p">:</span> <span class="n">Dims</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PropArray</span> <span class="o">|</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalized Cross Correlation in Fourier space.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    mask : boolean ImgArray, optional</span>
<span class="sd">        If provided, True regions will be masked and will not be taken into account when calculate</span>
<span class="sd">        correlation.</span>
<span class="sd">    {squeeze}</span>
<span class="sd">    {dims}</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    PropArray or float</span>
<span class="sd">        Correlation value(s).</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">img0</span><span class="p">,</span> <span class="n">img1</span> <span class="o">=</span> <span class="n">_check_inputs</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">)</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">power_spectra</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">zero_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">img1</span><span class="o">.</span><span class="n">power_spectra</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">zero_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">_ncc</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">img0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">add_axes</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">img0</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">_masked_ncc</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">_make_corr_output</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">img0</span><span class="p">,</span> <span class="s2">&quot;fourier_ncc&quot;</span><span class="p">,</span> <span class="n">squeeze</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span></div>

<div class="viewcode-block" id="fourier_zncc"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.fourier_zncc">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="nd">@dims_to_spatial_axes</span>
<span class="k">def</span> <span class="nf">fourier_zncc</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span>
    <span class="n">mask</span><span class="p">:</span> <span class="n">ImgArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
    <span class="o">*</span><span class="p">,</span> 
    <span class="n">dims</span><span class="p">:</span> <span class="n">Dims</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PropArray</span> <span class="o">|</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Zero-mean Normalized Cross Correlation in Fourier space.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    mask : boolean ImgArray, optional</span>
<span class="sd">        If provided, True regions will be masked and will not be taken into account </span>
<span class="sd">        when calculate correlation.</span>
<span class="sd">    {squeeze}</span>
<span class="sd">    {dims}</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    PropArray or float</span>
<span class="sd">        Correlation value(s).</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">img0</span><span class="p">,</span> <span class="n">img1</span> <span class="o">=</span> <span class="n">_check_inputs</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">)</span>
    <span class="n">pw0</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">power_spectra</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">zero_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">pw1</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img1</span><span class="o">.</span><span class="n">power_spectra</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">zero_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    
    <span class="n">_dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">axisof</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">)</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pw0</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pw1</span><span class="p">)</span>
    <span class="n">f0</span> <span class="o">-=</span> <span class="n">xp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">_dims</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">-=</span> <span class="n">xp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">_dims</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">_zncc</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">_dims</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">img0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">add_axes</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">img0</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">_masked_zncc</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">_dims</span><span class="p">,</span> <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">_make_corr_output</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">corr</span><span class="p">),</span> <span class="n">img0</span><span class="p">,</span> <span class="s2">&quot;fourier_zncc&quot;</span><span class="p">,</span> <span class="n">squeeze</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span></div>

<div class="viewcode-block" id="pcc_maximum"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.pcc_maximum">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="k">def</span> <span class="nf">pcc_maximum</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">mask</span><span class="p">:</span> <span class="n">ImgArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">upsample_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">max_shifts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate lateral shift between two images using phase cross correlation.</span>
<span class="sd">    </span>
<span class="sd">    Same as ``skimage.registration.phase_cross_correlation`` but some additional parameters </span>
<span class="sd">    are supported.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    upsample_factor : int, default is 10</span>
<span class="sd">        Up-sampling factor when calculating phase cross correlation.</span>
<span class="sd">    max_shifts : int, tuple of int, optional</span>
<span class="sd">        Maximum shifts in each dimension. If a single integer is given, it is interpreted </span>
<span class="sd">        as maximum shifts in all dimensions. No upper bound of shifts if not given.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Shift in pixel.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">return</span> <span class="n">pcc_maximum_with_corr</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">upsample_factor</span><span class="p">,</span> <span class="n">max_shifts</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="pcc_maximum_with_corr"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.pcc_maximum_with_corr">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="k">def</span> <span class="nf">pcc_maximum_with_corr</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">mask</span><span class="p">:</span> <span class="n">ImgArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">upsample_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">max_shifts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate lateral shift between two images using phase cross correlation.</span>
<span class="sd">    </span>
<span class="sd">    Same as ``skimage.registration.phase_cross_correlation`` but some additional parameters </span>
<span class="sd">    are supported.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    upsample_factor : int, default is 10</span>
<span class="sd">        Up-sampling factor when calculating phase cross correlation.</span>
<span class="sd">    max_shifts : int, tuple of int, optional</span>
<span class="sd">        Maximum shifts in each dimension. If a single integer is given, it is interpreted </span>
<span class="sd">        as maximum shifts in all dimensions. No upper bound of shifts if not given.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray and float</span>
<span class="sd">        Shift in pixel and phase cross correlation</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="n">img0</span> <span class="ow">is</span> <span class="n">img1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
    <span class="n">img0</span><span class="p">,</span> <span class="n">img1</span> <span class="o">=</span> <span class="n">_check_inputs</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">)</span>
    <span class="n">ft0</span> <span class="o">=</span> <span class="n">img0</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="n">img0</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
    <span class="n">ft1</span> <span class="o">=</span> <span class="n">img1</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="n">img1</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ft0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">max_shifts</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_shifts</span><span class="p">,)</span> <span class="o">*</span> <span class="n">img0</span><span class="o">.</span><span class="n">ndim</span>
    <span class="n">shift</span><span class="p">,</span> <span class="n">pcc</span> <span class="o">=</span> <span class="n">subpixel_pcc</span><span class="p">(</span>
        <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ft0</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> 
        <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ft1</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
        <span class="n">upsample_factor</span><span class="p">,</span> 
        <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">xp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">shift</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">pcc</span><span class="p">)</span></div>

<div class="viewcode-block" id="ft_pcc_maximum"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.ft_pcc_maximum">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="k">def</span> <span class="nf">ft_pcc_maximum</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span>
    <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">mask</span><span class="p">:</span> <span class="n">ImgArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">upsample_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">max_shifts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate lateral shift between two images using phase cross correlation.</span>
<span class="sd">    </span>
<span class="sd">    This function takes Fourier transformed images as input. If you have to repetitively</span>
<span class="sd">    use a same template image, this function is faster.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    upsample_factor : int, default is 10</span>
<span class="sd">        Up-sampling factor when calculating phase cross correlation.</span>
<span class="sd">    max_shifts : float, tuple of float, optional</span>
<span class="sd">        Maximum shifts in each dimension. If a single scalar is given, it is interpreted as</span>
<span class="sd">        maximum shifts in all dimensions. No upper bound of shifts if not given.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Shift in pixel.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">return</span> <span class="n">ft_pcc_maximum_with_corr</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">upsample_factor</span><span class="p">,</span> <span class="n">max_shifts</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="ft_pcc_maximum_with_corr"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.ft_pcc_maximum_with_corr">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="k">def</span> <span class="nf">ft_pcc_maximum_with_corr</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span>
    <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">mask</span><span class="p">:</span> <span class="n">ImgArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">upsample_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">max_shifts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate lateral shift between two images using phase cross correlation.</span>
<span class="sd">    </span>
<span class="sd">    This function takes Fourier transformed images as input. If you have to repetitively</span>
<span class="sd">    use a same template image, this function is faster.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    upsample_factor : int, default is 10</span>
<span class="sd">        Up-sampling factor when calculating phase cross correlation.</span>
<span class="sd">    max_shifts : float, tuple of float, optional</span>
<span class="sd">        Maximum shifts in each dimension. If a single scalar is given, it is interpreted as</span>
<span class="sd">        maximum shifts in all dimensions. No upper bound of shifts if not given.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray and float</span>
<span class="sd">        Shift in pixel and phase cross correlation.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">_check_dimensions</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">img0</span> <span class="o">=</span> <span class="n">img0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">img0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">max_shifts</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_shifts</span><span class="p">,)</span> <span class="o">*</span> <span class="n">img0</span><span class="o">.</span><span class="n">ndim</span>
    <span class="n">shift</span><span class="p">,</span> <span class="n">pcc</span> <span class="o">=</span> <span class="n">subpixel_pcc</span><span class="p">(</span>
        <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> 
        <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img1</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
        <span class="n">upsample_factor</span><span class="p">,</span>
        <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">xp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">shift</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">pcc</span><span class="p">)</span></div>

<div class="viewcode-block" id="pcc_landscape"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.pcc_landscape">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="k">def</span> <span class="nf">pcc_landscape</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span>
    <span class="n">max_shifts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create landscape of phase cross correlation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    max_shifts : float, tuple of float, optional</span>
<span class="sd">        Maximum shifts in each dimension. If a single scalar is given, it is interpreted as</span>
<span class="sd">        maximum shifts in all dimensions. No upper bound of shifts if not given.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ImgArray</span>
<span class="sd">        Landscape image.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">_check_dimensions</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">max_shifts</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_shifts</span><span class="p">,)</span> <span class="o">*</span> <span class="n">img0</span><span class="o">.</span><span class="n">ndim</span>
    
    <span class="n">ft0</span> <span class="o">=</span> <span class="n">img0</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="n">img0</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
    <span class="n">ft1</span> <span class="o">=</span> <span class="n">img1</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="n">img1</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
    <span class="n">landscape</span> <span class="o">=</span> <span class="n">draw_pcc_landscape</span><span class="p">(</span>
        <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ft0</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> 
        <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ft1</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
        <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ip_asarray</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">landscape</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="n">img1</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span></div>

<div class="viewcode-block" id="ft_pcc_landscape"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.ft_pcc_landscape">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="k">def</span> <span class="nf">ft_pcc_landscape</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span>
    <span class="n">max_shifts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create landscape of phase cross correlation.</span>

<span class="sd">    This function takes Fourier transformed images as input. If you have to repetitively</span>
<span class="sd">    use a same template image, this function is faster.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    max_shifts : float, tuple of float, optional</span>
<span class="sd">        Maximum shifts in each dimension. If a single scalar is given, it is interpreted as</span>
<span class="sd">        maximum shifts in all dimensions. No upper bound of shifts if not given.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ImgArray</span>
<span class="sd">        Landscape image.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">_check_dimensions</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">max_shifts</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_shifts</span><span class="p">,)</span> <span class="o">*</span> <span class="n">img0</span><span class="o">.</span><span class="n">ndim</span>

    <span class="n">landscape</span> <span class="o">=</span> <span class="n">draw_pcc_landscape</span><span class="p">(</span>
        <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> 
        <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img1</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
        <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ip_asarray</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">landscape</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="n">img1</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span></div>

<div class="viewcode-block" id="polar_pcc_maximum"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.polar_pcc_maximum">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="k">def</span> <span class="nf">polar_pcc_maximum</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span>
    <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span>
    <span class="n">upsample_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">max_degree</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate rotational shift between two images using polar Fourier transformation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    upsample_factor : int, default is 10</span>
<span class="sd">        Up-sampling factor when calculating phase cross correlation.</span>
<span class="sd">    max_degree : int, tuple of int, optional</span>
<span class="sd">        Maximum rotation in degree.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Rotation in degree</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">return</span> <span class="n">polar_pcc_maximum_with_corr</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">,</span> <span class="n">upsample_factor</span><span class="p">,</span> <span class="n">max_degree</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="polar_pcc_maximum_with_corr"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.polar_pcc_maximum_with_corr">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="k">def</span> <span class="nf">polar_pcc_maximum_with_corr</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span>
    <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span>
    <span class="n">upsample_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">max_degree</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate rotational shift between two images using polar Fourier transformation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    upsample_factor : int, default is 10</span>
<span class="sd">        Up-sampling factor when calculating phase cross correlation.</span>
<span class="sd">    max_degree : int, tuple of int, optional</span>
<span class="sd">        Maximum rotation in degree.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float and float</span>
<span class="sd">        Rotation in degree and phase cross correlation</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">img0</span><span class="p">,</span> <span class="n">img1</span> <span class="o">=</span> <span class="n">_check_inputs</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">img0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Currently only 2D image is supported.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_degree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_degree</span> <span class="o">=</span> <span class="mi">180</span>
    <span class="n">rmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">imgp</span> <span class="o">=</span> <span class="n">ip_asarray</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">polar2d</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">rmax</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)))</span>
    <span class="n">imgrotp</span> <span class="o">=</span> <span class="n">ip_asarray</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">polar2d</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">rmax</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)))</span>
    <span class="n">max_shifts</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_degree</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">shift</span><span class="p">,</span> <span class="n">pcc</span> <span class="o">=</span> <span class="n">pcc_maximum_with_corr</span><span class="p">(</span>
        <span class="n">imgp</span><span class="p">,</span> <span class="n">imgrotp</span><span class="p">,</span> <span class="n">upsample_factor</span><span class="o">=</span><span class="n">upsample_factor</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span>
    <span class="p">)</span>
    <span class="c1"># Here, `shift` satisfies `img0.rotate(-shift[0]) == img1`</span>
    <span class="k">return</span> <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pcc</span></div>

<div class="viewcode-block" id="zncc_maximum"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.zncc_maximum">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="k">def</span> <span class="nf">zncc_maximum</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span>
    <span class="n">upsample_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">max_shifts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate lateral shift between two images using zero-mean normalized cross correlation.</span>
<span class="sd">    </span>
<span class="sd">    Similar to :func:`pcc_maximum`, this function can determine shift at sub-pixel precision.</span>
<span class="sd">    Since ZNCC uses real space, this function performs better than PCC when the input images</span>
<span class="sd">    have frequency loss.</span>
<span class="sd">    Unlike :func:`zncc_maximum_with_corr`, this function only returns the optimal shift.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    upsample_factor : int, default is 10</span>
<span class="sd">        Up-sampling factor when calculating cross correlation. Convolution image will be</span>
<span class="sd">        up-sampled by third-order interpolation.</span>
<span class="sd">    max_shifts : float, tuple of float, optional</span>
<span class="sd">        Maximum shifts in each dimension. If a single scalar is given, it is interpreted as</span>
<span class="sd">        maximum shifts in all dimensions. No upper bound of shifts if not given.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Shift in pixel .</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">return</span> <span class="n">zncc_maximum_with_corr</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">,</span> <span class="n">upsample_factor</span><span class="p">,</span> <span class="n">max_shifts</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="zncc_maximum_with_corr"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.zncc_maximum_with_corr">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="k">def</span> <span class="nf">zncc_maximum_with_corr</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span>
    <span class="n">upsample_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">max_shifts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate lateral shift between two images using zero-mean normalized cross correlation.</span>
<span class="sd">    </span>
<span class="sd">    Similar to :func:`pcc_maximum`, this function can determine shift at sub-pixel precision.</span>
<span class="sd">    Since ZNCC uses real space, this function performs better than PCC when the input images</span>
<span class="sd">    have frequency loss.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    upsample_factor : int, default is 10</span>
<span class="sd">        Up-sampling factor when calculating cross correlation. Convolution image will be</span>
<span class="sd">        up-sampled by third-order interpolation.</span>
<span class="sd">    max_shifts : float, tuple of float, optional</span>
<span class="sd">        Maximum shifts in each dimension. If a single scalar is given, it is interpreted as</span>
<span class="sd">        maximum shifts in all dimensions. No upper bound of shifts if not given.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray and float</span>
<span class="sd">        Shift in pixel and ZNCC value.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="n">img0</span> <span class="ow">is</span> <span class="n">img1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">ndim</span><span class="p">),</span> <span class="mf">1.</span>
    <span class="n">img0</span><span class="p">,</span> <span class="n">img1</span> <span class="o">=</span> <span class="n">img0</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">img1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">img0z</span> <span class="o">=</span> <span class="n">img0</span> <span class="o">-</span> <span class="n">img0</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">img1z</span> <span class="o">=</span> <span class="n">img1</span> <span class="o">-</span> <span class="n">img1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">max_shifts</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_shifts</span><span class="p">,)</span> <span class="o">*</span> <span class="n">img0</span><span class="o">.</span><span class="n">ndim</span>
    <span class="n">shift</span><span class="p">,</span> <span class="n">zncc</span> <span class="o">=</span> <span class="n">subpixel_ncc</span><span class="p">(</span>
        <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img0z</span><span class="p">)),</span> 
        <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img1z</span><span class="p">)),</span>
        <span class="n">upsample_factor</span><span class="p">,</span> 
        <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">xp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">shift</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">zncc</span><span class="p">)</span></div>

<div class="viewcode-block" id="zncc_landscape"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.zncc_landscape">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="k">def</span> <span class="nf">zncc_landscape</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span>
    <span class="n">max_shifts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create landscape of zero-mean normalized cross correlation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    max_shifts : float, tuple of float, optional</span>
<span class="sd">        Maximum shifts in each dimension. If a single scalar is given, it is interpreted as</span>
<span class="sd">        maximum shifts in all dimensions. No upper bound of shifts if not given.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ImgArray</span>
<span class="sd">        Landscape image.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">img0</span><span class="p">,</span> <span class="n">img1</span> <span class="o">=</span> <span class="n">img0</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">img1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">img0z</span> <span class="o">=</span> <span class="n">img0</span> <span class="o">-</span> <span class="n">img0</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">img1z</span> <span class="o">=</span> <span class="n">img1</span> <span class="o">-</span> <span class="n">img1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">max_shifts</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_shifts</span><span class="p">,)</span> <span class="o">*</span> <span class="n">img0</span><span class="o">.</span><span class="n">ndim</span>
    <span class="n">landscape</span> <span class="o">=</span> <span class="n">draw_ncc_landscape</span><span class="p">(</span>
        <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img0z</span><span class="p">)),</span> 
        <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img1z</span><span class="p">)),</span>
        <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ip_asarray</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">landscape</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="n">img1</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span></div>

<div class="viewcode-block" id="manders_coloc"><a class="viewcode-back" href="../../apidoc/impy.html#impy.correlation.manders_coloc">[docs]</a><span class="nd">@_docs</span><span class="o">.</span><span class="n">write_docs</span>
<span class="nd">@dims_to_spatial_axes</span>
<span class="k">def</span> <span class="nf">manders_coloc</span><span class="p">(</span>
    <span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> 
    <span class="n">img1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">dims</span><span class="p">:</span> <span class="n">Dims</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PropArray</span> <span class="o">|</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manders&#39; correlation coefficient. This is defined as following:</span>
<span class="sd">    </span>
<span class="sd">    :math:`r = \frac{\sum_{i \in I_{ref}} I_i}{\sum_{i} I_i}`</span>
<span class="sd">    </span>
<span class="sd">    This value is NOT independent of background intensity. You need to correctly subtract</span>
<span class="sd">    background from self. This value is NOT interchangable between channels.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    {inputs_of_correlation}</span>
<span class="sd">    {squeeze}</span>
<span class="sd">    {dims}</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    PropArray or float</span>
<span class="sd">        Correlation coefficient(s).</span>
<span class="sd">    &quot;&quot;&quot;</span>        
    <span class="k">if</span> <span class="n">img1</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`ref` must be a binary image.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">img0</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">img1</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape mismatch. `img0` has shape </span><span class="si">{</span><span class="n">img0</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> but `img1` &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;has shape </span><span class="si">{</span><span class="n">img1</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">img0</span><span class="o">.</span><span class="n">axes</span> <span class="o">!=</span> <span class="n">img1</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Axes mismatch. `img0` has axes </span><span class="si">{</span><span class="n">img0</span><span class="o">.</span><span class="n">axes</span><span class="si">}</span><span class="s2"> but `img1` has axes </span><span class="si">{</span><span class="n">img1</span><span class="o">.</span><span class="n">axes</span><span class="si">}</span><span class="s2">. &quot;</span>
              <span class="s2">&quot;Result may be wrong due to this mismatch.&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>
    <span class="n">img0</span> <span class="o">=</span> <span class="n">img0</span><span class="o">.</span><span class="n">as_float</span><span class="p">()</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span>
    <span class="n">img0</span> <span class="o">=</span> <span class="n">img0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">img0</span><span class="p">[</span><span class="o">~</span><span class="n">img1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span> <span class="o">/</span> <span class="n">total</span>
    <span class="k">return</span> <span class="n">_make_corr_output</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">img0</span><span class="p">,</span> <span class="s2">&quot;manders_coloc&quot;</span><span class="p">,</span> <span class="n">squeeze</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span></div>
    

<span class="k">def</span> <span class="nf">iter2</span><span class="p">(</span><span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> <span class="n">axes</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">israw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="n">i0</span><span class="p">),</span> <span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="n">i1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">img0</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">israw</span><span class="o">=</span><span class="n">israw</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">),</span>
                                  <span class="n">img1</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">israw</span><span class="o">=</span><span class="n">israw</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)):</span>
        <span class="k">yield</span> <span class="n">sl</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span> <span class="n">i1</span>
        
<span class="k">def</span> <span class="nf">_check_inputs</span><span class="p">(</span><span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">):</span>
    <span class="n">_check_dimensions</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">img1</span><span class="p">)</span>

    <span class="n">img0</span> <span class="o">=</span> <span class="n">img0</span><span class="o">.</span><span class="n">as_float</span><span class="p">()</span>
    <span class="n">img1</span> <span class="o">=</span> <span class="n">img1</span><span class="o">.</span><span class="n">as_float</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">img0</span><span class="p">,</span> <span class="n">img1</span>

<span class="k">def</span> <span class="nf">_check_dimensions</span><span class="p">(</span><span class="n">img0</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> <span class="n">img1</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">img0</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">img1</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape mismatch. `img0` has shape </span><span class="si">{</span><span class="n">img0</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> but `img1` &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;has shape </span><span class="si">{</span><span class="n">img1</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">img0</span><span class="o">.</span><span class="n">axes</span> <span class="o">!=</span> <span class="n">img1</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Axes mismatch. `img0` has axes </span><span class="si">{</span><span class="n">img0</span><span class="o">.</span><span class="n">axes</span><span class="si">}</span><span class="s2"> but `img1` has axes </span><span class="si">{</span><span class="n">img1</span><span class="o">.</span><span class="n">axes</span><span class="si">}</span><span class="s2">. &quot;</span>
              <span class="s2">&quot;Result may be wrong due to this mismatch.&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_make_corr_output</span><span class="p">(</span><span class="n">corr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">refimg</span><span class="p">:</span> <span class="n">ImgArray</span><span class="p">,</span> <span class="n">propname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">dims</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">corr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">squeeze</span><span class="p">:</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[()]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">PropArray</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">refimg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">complement_axes</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">refimg</span><span class="o">.</span><span class="n">axes</span><span class="p">),</span> 
                        <span class="n">source</span><span class="o">=</span><span class="n">refimg</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">refimg</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> 
                        <span class="n">propname</span><span class="o">=</span><span class="n">propname</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">corr</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Hanjin Liu.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>