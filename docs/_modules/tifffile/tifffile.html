<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tifffile.tifffile &mdash; impy 2.0.0.alpha documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> impy
          </a>
              <div class="version">
                2.0.0.alpha
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_cmd.html">Command Line Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">impy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>tifffile.tifffile</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tifffile.tifffile</h1><div class="highlight"><pre>
<span></span><span class="c1"># tifffile.py</span>

<span class="c1"># Copyright (c) 2008-2021, Christoph Gohlke</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright notice,</span>
<span class="c1">#    this list of conditions and the following disclaimer.</span>
<span class="c1">#</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1">#    this list of conditions and the following disclaimer in the documentation</span>
<span class="c1">#    and/or other materials provided with the distribution.</span>
<span class="c1">#</span>
<span class="c1"># 3. Neither the name of the copyright holder nor the names of its</span>
<span class="c1">#    contributors may be used to endorse or promote products derived from</span>
<span class="c1">#    this software without specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="c1"># AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="c1"># IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="c1"># ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE</span>
<span class="c1"># LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="c1"># CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="c1"># SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="c1"># INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<span class="c1"># CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="c1"># ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="c1"># POSSIBILITY OF SUCH DAMAGE.</span>

<span class="sa">r</span><span class="sd">&quot;&quot;&quot;Read and write TIFF files.</span>

<span class="sd">Tifffile is a Python library to</span>

<span class="sd">(1) store numpy arrays in TIFF (Tagged Image File Format) files, and</span>
<span class="sd">(2) read image and metadata from TIFF-like files used in bioimaging.</span>

<span class="sd">Image and metadata can be read from TIFF, BigTIFF, OME-TIFF, STK, LSM, SGI,</span>
<span class="sd">NIHImage, ImageJ, MicroManager, FluoView, ScanImage, SEQ, GEL, SVS, SCN, SIS,</span>
<span class="sd">BIF, ZIF (Zoomable Image File Format), QPTIFF (QPI), NDPI, and GeoTIFF files.</span>

<span class="sd">Image data can be read as numpy arrays or zarr arrays/groups from strips,</span>
<span class="sd">tiles, pages (IFDs), SubIFDs, higher order series, and pyramidal levels.</span>

<span class="sd">Numpy arrays can be written to TIFF, BigTIFF, OME-TIFF, and ImageJ hyperstack</span>
<span class="sd">compatible files in multi-page, volumetric, pyramidal, memory-mappable, tiled,</span>
<span class="sd">predicted, or compressed form.</span>

<span class="sd">A subset of the TIFF specification is supported, mainly 8, 16, 32 and 64-bit</span>
<span class="sd">integer, 16, 32 and 64-bit float, grayscale and multi-sample images.</span>
<span class="sd">Specifically, CCITT and OJPEG compression, chroma subsampling without JPEG</span>
<span class="sd">compression, color space transformations, samples with differing types, or</span>
<span class="sd">IPTC, ICC, and XMP metadata are not implemented.</span>

<span class="sd">TIFF, the Tagged Image File Format, was created by the Aldus Corporation and</span>
<span class="sd">Adobe Systems Incorporated. BigTIFF allows for files larger than 4 GB.</span>
<span class="sd">STK, LSM, FluoView, SGI, SEQ, GEL, QPTIFF, NDPI, SCN, SVS, ZIF, BIF, and</span>
<span class="sd">OME-TIFF, are custom extensions defined by Molecular Devices (Universal Imaging</span>
<span class="sd">Corporation), Carl Zeiss MicroImaging, Olympus, Silicon Graphics International,</span>
<span class="sd">Media Cybernetics, Molecular Dynamics, PerkinElmer, Hamamatsu, Leica,</span>
<span class="sd">ObjectivePathology, Roche Digital Pathology, and the Open Microscopy</span>
<span class="sd">Environment consortium, respectively.</span>

<span class="sd">For command line usage run ``python -m tifffile --help``</span>

<span class="sd">:Author:</span>
<span class="sd">  `Christoph Gohlke &lt;https://www.lfd.uci.edu/~gohlke/&gt;`_</span>

<span class="sd">:Organization:</span>
<span class="sd">  Laboratory for Fluorescence Dynamics, University of California, Irvine</span>

<span class="sd">:License: BSD 3-Clause</span>

<span class="sd">:Version: 2021.11.2</span>

<span class="sd">Requirements</span>
<span class="sd">------------</span>
<span class="sd">This release has been tested with the following requirements and dependencies</span>
<span class="sd">(other versions may work):</span>

<span class="sd">* `CPython 3.7.9, 3.8.10, 3.9.7, 3.10.0, 64-bit &lt;https://www.python.org&gt;`_</span>
<span class="sd">* `Numpy 1.21.3 &lt;https://pypi.org/project/numpy/&gt;`_</span>
<span class="sd">* `Imagecodecs 2021.8.26  &lt;https://pypi.org/project/imagecodecs/&gt;`_</span>
<span class="sd">  (required only for encoding or decoding LZW, JPEG, etc.)</span>
<span class="sd">* `Matplotlib 3.4.3 &lt;https://pypi.org/project/matplotlib/&gt;`_</span>
<span class="sd">  (required only for plotting)</span>
<span class="sd">* `Lxml 4.6.3 &lt;https://pypi.org/project/lxml/&gt;`_</span>
<span class="sd">  (required only for validating and printing XML)</span>
<span class="sd">* `Zarr 2.10.3 &lt;https://pypi.org/project/zarr/&gt;`_</span>
<span class="sd">  (required only for opening zarr storage)</span>

<span class="sd">Revisions</span>
<span class="sd">---------</span>
<span class="sd">2021.11.2</span>
<span class="sd">    Pass 4731 tests.</span>
<span class="sd">    Lazy-load non-essential tag values (breaking).</span>
<span class="sd">    Warn when reading from closed file.</span>
<span class="sd">    Support ImageJ &#39;prop&#39; metadata type (#103).</span>
<span class="sd">    Support writing indexed ImageJ format.</span>
<span class="sd">    Fix multi-threaded access of multi-page Zarr stores with chunkmode 2.</span>
<span class="sd">    Raise error if truncate is used with compression, packints, or tile.</span>
<span class="sd">    Read STK metadata without UIC2tag.</span>
<span class="sd">    Improve log and warning messages (WIP).</span>
<span class="sd">    Improve string representation of large tag values.</span>
<span class="sd">2021.10.12</span>
<span class="sd">    Revert renaming of &#39;file&#39; parameter in FileSequence.asarray (breaking).</span>
<span class="sd">    Deprecate &#39;file&#39; parameter in FileSequence.asarray.</span>
<span class="sd">2021.10.10</span>
<span class="sd">    Disallow letters as indices in FileSequence; use categories (breaking).</span>
<span class="sd">    Do not warn of missing files in FileSequence; use files_missing property.</span>
<span class="sd">    Support predictors in ZarrTiffStore.write_fsspec.</span>
<span class="sd">    Add option to specify zarr group name in write_fsspec.</span>
<span class="sd">    Add option to specify categories for FileSequence patterns (#76).</span>
<span class="sd">    Add option to specify chunk shape and dtype for ZarrFileSequenceStore.</span>
<span class="sd">    Add option to tile ZarrFileSequenceStore and FileSequence.asarray.</span>
<span class="sd">    Add option to pass additional zattrs to Zarr stores.</span>
<span class="sd">    Detect Roche BIF files.</span>
<span class="sd">2021.8.30</span>
<span class="sd">    Fix horizontal differencing with non-native byte order.</span>
<span class="sd">    Fix multi-threaded access of memory-mappable, multi-page Zarr stores (#67).</span>
<span class="sd">2021.8.8</span>
<span class="sd">    Fix tag offset and valueoffset for NDPI &gt; 4 GB (#96).</span>
<span class="sd">2021.7.30</span>
<span class="sd">    Deprecate first parameter to TiffTag.overwrite (no longer required).</span>
<span class="sd">    TiffTag init API change (breaking).</span>
<span class="sd">    Detect Ventana BIF series and warn that tiles are not stitched.</span>
<span class="sd">    Enable reading PreviewImage from RAW formats (#93, #94).</span>
<span class="sd">    Work around numpy.ndarray.tofile is very slow for non-contiguous arrays.</span>
<span class="sd">    Fix issues with PackBits compression (requires imagecodecs 2021.7.30).</span>
<span class="sd">2021.7.2</span>
<span class="sd">    Decode complex integer images found in SAR GeoTIFF.</span>
<span class="sd">    Support reading NDPI with JPEG-XR compression.</span>
<span class="sd">    Deprecate TiffWriter RGB auto-detection, except for RGB24/48 and RGBA32/64.</span>
<span class="sd">2021.6.14</span>
<span class="sd">    Set stacklevel for deprecation warnings (#89).</span>
<span class="sd">    Fix svs_description_metadata for SVS with double header (#88, breaking).</span>
<span class="sd">    Fix reading JPEG compressed CMYK images.</span>
<span class="sd">    Support ALT_JPEG and JPEG_2000_LOSSY compression found in Bio-Formats.</span>
<span class="sd">    Log warning if TiffWriter auto-detects RGB mode (specify photometric).</span>
<span class="sd">2021.6.6</span>
<span class="sd">    Fix TIFF.COMPESSOR typo (#85).</span>
<span class="sd">    Round resolution numbers that do not fit in 64-bit rationals (#81).</span>
<span class="sd">    Add support for JPEG XL compression.</span>
<span class="sd">    Add numcodecs compatible TIFF codec.</span>
<span class="sd">    Rename ZarrFileStore to ZarrFileSequenceStore (breaking).</span>
<span class="sd">    Add method to export fsspec ReferenceFileSystem from ZarrFileStore.</span>
<span class="sd">    Fix fsspec ReferenceFileSystem v1 for multifile series.</span>
<span class="sd">    Fix creating OME-TIFF with micron character in OME-XML.</span>
<span class="sd">2021.4.8</span>
<span class="sd">    Fix reading OJPEG with wrong photometric or samplesperpixel tags (#75).</span>
<span class="sd">    Fix fsspec ReferenceFileSystem v1 and JPEG compression.</span>
<span class="sd">    Use TiffTagRegistry for NDPI_TAGS, EXIF_TAGS, GPS_TAGS, IOP_TAGS constants.</span>
<span class="sd">    Make TIFF.GEO_KEYS an Enum (breaking).</span>
<span class="sd">2021.3.31</span>
<span class="sd">    Use JPEG restart markers as tile offsets in NDPI.</span>
<span class="sd">    Support version 1 and more codecs in fsspec ReferenceFileSystem (untested).</span>
<span class="sd">2021.3.17</span>
<span class="sd">    Fix regression reading multi-file OME-TIFF with missing files (#72).</span>
<span class="sd">    Fix fsspec ReferenceFileSystem with non-native byte order (#56).</span>
<span class="sd">2021.3.16</span>
<span class="sd">    TIFF is no longer a defended trademark.</span>
<span class="sd">    Add method to export fsspec ReferenceFileSystem from ZarrTiffStore (#56).</span>
<span class="sd">2021.3.5</span>
<span class="sd">    Preliminary support for EER format (#68).</span>
<span class="sd">    Do not warn about unknown compression (#68).</span>
<span class="sd">2021.3.4</span>
<span class="sd">    Fix reading multi-file, multi-series OME-TIFF (#67).</span>
<span class="sd">    Detect ScanImage 2021 files (#46).</span>
<span class="sd">    Shape new version ScanImage series according to metadata (breaking).</span>
<span class="sd">    Remove Description key from TiffFile.scanimage_metadata dict (breaking).</span>
<span class="sd">    Also return ScanImage version from read_scanimage_metadata (breaking).</span>
<span class="sd">    Fix docstrings.</span>
<span class="sd">2021.2.26</span>
<span class="sd">    Squeeze axes of LSM series by default (breaking).</span>
<span class="sd">    Add option to preserve single dimensions when reading from series (WIP).</span>
<span class="sd">    Do not allow appending to OME-TIFF files.</span>
<span class="sd">    Fix reading STK files without name attribute in metadata.</span>
<span class="sd">    Make TIFF constants multi-thread safe and pickleable (#64).</span>
<span class="sd">    Add detection of NDTiffStorage MajorVersion to read_micromanager_metadata.</span>
<span class="sd">    Support ScanImage v4 files in read_scanimage_metadata.</span>
<span class="sd">2021.2.1</span>
<span class="sd">    Fix multi-threaded access of ZarrTiffStores using same TiffFile instance.</span>
<span class="sd">    Use fallback zlib and lzma codecs with imagecodecs lite builds.</span>
<span class="sd">    Open Olympus and Panasonic RAW files for parsing, albeit not supported.</span>
<span class="sd">    Support X2 and X4 differencing found in DNG.</span>
<span class="sd">    Support reading JPEG_LOSSY compression found in DNG.</span>
<span class="sd">2021.1.14</span>
<span class="sd">    Try ImageJ series if OME series fails (#54)</span>
<span class="sd">    Add option to use pages as chunks in ZarrFileStore (experimental).</span>
<span class="sd">    Fix reading from file objects with no readinto function.</span>
<span class="sd">2021.1.11</span>
<span class="sd">    Fix test errors on PyPy.</span>
<span class="sd">    Fix decoding bitorder with imagecodecs &gt;= 2021.1.11.</span>
<span class="sd">2021.1.8</span>
<span class="sd">    Decode float24 using imagecodecs &gt;= 2021.1.8.</span>
<span class="sd">    Consolidate reading of segments if possible.</span>
<span class="sd">2020.12.8</span>
<span class="sd">    Fix corrupted ImageDescription in multi shaped series if buffer too small.</span>
<span class="sd">    Fix libtiff warning that ImageDescription contains null byte in value.</span>
<span class="sd">    Fix reading invalid files using JPEG compression with palette colorspace.</span>
<span class="sd">2020.12.4</span>
<span class="sd">    Fix reading some JPEG compressed CFA images.</span>
<span class="sd">    Make index of SubIFDs a tuple.</span>
<span class="sd">    Pass through FileSequence.imread arguments in imread.</span>
<span class="sd">    Do not apply regex flags to FileSequence axes patterns (breaking).</span>
<span class="sd">2020.11.26</span>
<span class="sd">    Add option to pass axes metadata to ImageJ writer.</span>
<span class="sd">    Pad incomplete tiles passed to TiffWriter.write (#38).</span>
<span class="sd">    Split TiffTag constructor (breaking).</span>
<span class="sd">    Change TiffTag.dtype to TIFF.DATATYPES (breaking).</span>
<span class="sd">    Add TiffTag.overwrite method.</span>
<span class="sd">    Add script to change ImageDescription in files.</span>
<span class="sd">    Add TiffWriter.overwrite_description method (WIP).</span>
<span class="sd">2020.11.18</span>
<span class="sd">    Support writing SEPARATED color space (#37).</span>
<span class="sd">    Use imagecodecs.deflate codec if available.</span>
<span class="sd">    Fix SCN and NDPI series with Z dimensions.</span>
<span class="sd">    Add TiffReader alias for TiffFile.</span>
<span class="sd">    TiffPage.is_volumetric returns True if ImageDepth &gt; 1.</span>
<span class="sd">    Zarr store getitem returns numpy arrays instead of bytes.</span>
<span class="sd">2020.10.1</span>
<span class="sd">    Formally deprecate unused TiffFile parameters (scikit-image #4996).</span>
<span class="sd">2020.9.30</span>
<span class="sd">    Allow to pass additional arguments to compression codecs.</span>
<span class="sd">    Deprecate TiffWriter.save method (use TiffWriter.write).</span>
<span class="sd">    Deprecate TiffWriter.save compress parameter (use compression).</span>
<span class="sd">    Remove multifile parameter from TiffFile (breaking).</span>
<span class="sd">    Pass all is_flag arguments from imread to TiffFile.</span>
<span class="sd">    Do not byte-swap JPEG2000, WEBP, PNG, JPEGXR segments in TiffPage.decode.</span>
<span class="sd">2020.9.29</span>
<span class="sd">    Fix reading files produced by ScanImage &gt; 2015 (#29).</span>
<span class="sd">2020.9.28</span>
<span class="sd">    Derive ZarrStore from MutableMapping.</span>
<span class="sd">    Support zero shape ZarrTiffStore.</span>
<span class="sd">    Fix ZarrFileStore with non-TIFF files.</span>
<span class="sd">    Fix ZarrFileStore with missing files.</span>
<span class="sd">    Cache one chunk in ZarrFileStore.</span>
<span class="sd">    Keep track of already opened files in FileCache.</span>
<span class="sd">    Change parse_filenames function to return zero-based indices.</span>
<span class="sd">    Remove reopen parameter from asarray (breaking).</span>
<span class="sd">    Rename FileSequence.fromfile to imread (breaking).</span>
<span class="sd">2020.9.22</span>
<span class="sd">    Add experimental zarr storage interface (WIP).</span>
<span class="sd">    Remove unused first dimension from TiffPage.shaped (breaking).</span>
<span class="sd">    Move reading of STK planes to series interface (breaking).</span>
<span class="sd">    Always use virtual frames for ScanImage files.</span>
<span class="sd">    Use DimensionOrder to determine axes order in OmeXml.</span>
<span class="sd">    Enable writing striped volumetric images.</span>
<span class="sd">    Keep complete dataoffsets and databytecounts for TiffFrames.</span>
<span class="sd">    Return full size tiles from Tiffpage.segments.</span>
<span class="sd">    Rename TiffPage.is_sgi property to is_volumetric (breaking).</span>
<span class="sd">    Rename TiffPageSeries.is_pyramid to is_pyramidal (breaking).</span>
<span class="sd">    Fix TypeError when passing jpegtables to non-JPEG decode method (#25).</span>
<span class="sd">2020.9.3</span>
<span class="sd">    Do not write contiguous series by default (breaking).</span>
<span class="sd">    Allow to write to SubIFDs (WIP).</span>
<span class="sd">    Fix writing F-contiguous numpy arrays (#24).</span>
<span class="sd">2020.8.25</span>
<span class="sd">    Do not convert EPICS timeStamp to datetime object.</span>
<span class="sd">    Read incompletely written Micro-Manager image file stack header (#23).</span>
<span class="sd">    Remove tag 51123 values from TiffFile.micromanager_metadata (breaking).</span>
<span class="sd">2020.8.13</span>
<span class="sd">    Use tifffile metadata over OME and ImageJ for TiffFile.series (breaking).</span>
<span class="sd">    Fix writing iterable of pages with compression (#20).</span>
<span class="sd">    Expand error checking of TiffWriter data, dtype, shape, and tile arguments.</span>
<span class="sd">2020.7.24</span>
<span class="sd">    Parse nested OmeXml metadata argument (WIP).</span>
<span class="sd">    Do not lazy load TiffFrame JPEGTables.</span>
<span class="sd">    Fix conditionally skipping some tests.</span>
<span class="sd">2020.7.22</span>
<span class="sd">    Do not auto-enable OME-TIFF if description is passed to TiffWriter.save.</span>
<span class="sd">    Raise error writing empty bilevel or tiled images.</span>
<span class="sd">    Allow to write tiled bilevel images.</span>
<span class="sd">    Allow to write multi-page TIFF from iterable of single page images (WIP).</span>
<span class="sd">    Add function to validate OME-XML.</span>
<span class="sd">    Correct Philips slide width and length.</span>
<span class="sd">2020.7.17</span>
<span class="sd">    Initial support for writing OME-TIFF (WIP).</span>
<span class="sd">    Return samples as separate dimension in OME series (breaking).</span>
<span class="sd">    Fix modulo dimensions for multiple OME series.</span>
<span class="sd">    Fix some test errors on big endian systems (#18).</span>
<span class="sd">    Fix BytesWarning.</span>
<span class="sd">    Allow to pass TIFF.PREDICTOR values to TiffWriter.save.</span>
<span class="sd">2020.7.4</span>
<span class="sd">    Deprecate support for Python 3.6 (NEP 29).</span>
<span class="sd">    Move pyramidal subresolution series to TiffPageSeries.levels (breaking).</span>
<span class="sd">    Add parser for SVS, SCN, NDPI, and QPI pyramidal series.</span>
<span class="sd">    Read single-file OME-TIFF pyramids.</span>
<span class="sd">    Read NDPI files &gt; 4 GB (#15).</span>
<span class="sd">    Include SubIFDs in generic series.</span>
<span class="sd">    Preliminary support for writing packed integer arrays (#11, WIP).</span>
<span class="sd">    Read more LSM info subrecords.</span>
<span class="sd">    Fix missing ReferenceBlackWhite tag for YCbCr photometrics.</span>
<span class="sd">    Fix reading lossless JPEG compressed DNG files.</span>
<span class="sd">2020.6.3</span>
<span class="sd">    ...</span>

<span class="sd">Refer to the CHANGES file for older revisions.</span>

<span class="sd">Notes</span>
<span class="sd">-----</span>
<span class="sd">The API is not stable yet and might change between revisions.</span>

<span class="sd">Tested on little-endian platforms only.</span>

<span class="sd">Python 32-bit versions are deprecated. Python &lt;= 3.7 are no longer supported.</span>

<span class="sd">Tifffile relies on the `imagecodecs &lt;https://pypi.org/project/imagecodecs/&gt;`_</span>
<span class="sd">package for encoding and decoding LZW, JPEG, and other compressed image</span>
<span class="sd">segments.</span>

<span class="sd">Several TIFF-like formats do not strictly adhere to the TIFF6 specification,</span>
<span class="sd">some of which allow file or data sizes to exceed the 4 GB limit:</span>

<span class="sd">* *BigTIFF* is identified by version number 43 and uses different file</span>
<span class="sd">  header, IFD, and tag structures with 64-bit offsets. It adds more data types.</span>
<span class="sd">  Tifffile can read and write BigTIFF files.</span>
<span class="sd">* *ImageJ* hyperstacks store all image data, which may exceed 4 GB,</span>
<span class="sd">  contiguously after the first IFD. Files &gt; 4 GB contain one IFD only.</span>
<span class="sd">  The size (shape and dtype) of the up to 6-dimensional image data can be</span>
<span class="sd">  determined from the ImageDescription tag of the first IFD, which is Latin-1</span>
<span class="sd">  encoded. Tifffile can read and write ImageJ hyperstacks.</span>
<span class="sd">* *OME-TIFF* stores up to 8-dimensional data in one or multiple TIFF of BigTIFF</span>
<span class="sd">  files. The 8-bit UTF-8 encoded OME-XML metadata found in the ImageDescription</span>
<span class="sd">  tag of the first IFD defines the position of TIFF IFDs in the high</span>
<span class="sd">  dimensional data. Tifffile can read OME-TIFF files, except when the OME-XML</span>
<span class="sd">  metadata are stored in a separate file. Tifffile can write numpy arrays</span>
<span class="sd">  to single-file OME-TIFF.</span>
<span class="sd">* *LSM* stores all IFDs below 4 GB but wraps around 32-bit StripOffsets.</span>
<span class="sd">  The StripOffsets of each series and position require separate unwrapping.</span>
<span class="sd">  The StripByteCounts tag contains the number of bytes for the uncompressed</span>
<span class="sd">  data. Tifffile can read large LSM files.</span>
<span class="sd">* *STK* (MetaMorph Stack) contains additional image planes stored contiguously</span>
<span class="sd">  after the image data of the first page. The total number of planes</span>
<span class="sd">  is equal to the counts of the UIC2tag. Tifffile can read STK files.</span>
<span class="sd">* *NDPI* uses some 64-bit offsets in the file header, IFD, and tag structures.</span>
<span class="sd">  Tag values/offsets can be corrected using high bits stored after IFD</span>
<span class="sd">  structures. Tifffile can read NDPI files &gt; 4 GB.</span>
<span class="sd">  JPEG compressed segments with dimensions &gt;65530 or missing restart markers</span>
<span class="sd">  are not decodable with libjpeg. Tifffile works around this limitation by</span>
<span class="sd">  separately decoding the MCUs between restart markers.</span>
<span class="sd">  BitsPerSample, SamplesPerPixel, and PhotometricInterpretation tags may</span>
<span class="sd">  contain wrong values, which can be corrected using the value of tag 65441.</span>
<span class="sd">* *Philips* TIFF slides store wrong ImageWidth and ImageLength tag values for</span>
<span class="sd">  tiled pages. The values can be corrected using the DICOM_PIXEL_SPACING</span>
<span class="sd">  attributes of the XML formatted description of the first page. Tifffile can</span>
<span class="sd">  read Philips slides.</span>
<span class="sd">* *Ventana/Roche BIF* slides store tiles and metadata in a BigTIFF container.</span>
<span class="sd">  Tiles may overlap and require stitching based on the TileJointInfo elements</span>
<span class="sd">  in the XMP tag. Volumetric scans are stored using the ImageDepth extension.</span>
<span class="sd">  Tifffile can read BIF and decode individual tiles, but does not perform</span>
<span class="sd">  stitching.</span>
<span class="sd">* *ScanImage* optionally allows corrupted non-BigTIFF files &gt; 2 GB. The values</span>
<span class="sd">  of StripOffsets and StripByteCounts can be recovered using the constant</span>
<span class="sd">  differences of the offsets of IFD and tag values throughout the file.</span>
<span class="sd">  Tifffile can read such files if the image data are stored contiguously in</span>
<span class="sd">  each page.</span>
<span class="sd">* *GeoTIFF* sparse files allow strip or tile offsets and byte counts to be 0.</span>
<span class="sd">  Such segments are implicitly set to 0 or the NODATA value on reading.</span>
<span class="sd">  Tifffile can read GeoTIFF sparse files.</span>

<span class="sd">Other libraries for reading scientific TIFF files from Python:</span>

<span class="sd">* `Python-bioformats &lt;https://github.com/CellProfiler/python-bioformats&gt;`_</span>
<span class="sd">* `Imread &lt;https://github.com/luispedro/imread&gt;`_</span>
<span class="sd">* `GDAL &lt;https://github.com/OSGeo/gdal/tree/master/gdal/swig/python&gt;`_</span>
<span class="sd">* `OpenSlide-python &lt;https://github.com/openslide/openslide-python&gt;`_</span>
<span class="sd">* `Slideio &lt;https://gitlab.com/bioslide/slideio&gt;`_</span>
<span class="sd">* `PyLibTiff &lt;https://github.com/pearu/pylibtiff&gt;`_</span>
<span class="sd">* `SimpleITK &lt;https://github.com/SimpleITK/SimpleITK&gt;`_</span>
<span class="sd">* `PyLSM &lt;https://launchpad.net/pylsm&gt;`_</span>
<span class="sd">* `PyMca.TiffIO.py &lt;https://github.com/vasole/pymca&gt;`_ (same as fabio.TiffIO)</span>
<span class="sd">* `BioImageXD.Readers &lt;http://www.bioimagexd.net/&gt;`_</span>
<span class="sd">* `CellCognition &lt;https://cellcognition-project.org/&gt;`_</span>
<span class="sd">* `pymimage &lt;https://github.com/ardoi/pymimage&gt;`_</span>
<span class="sd">* `pytiff &lt;https://github.com/FZJ-INM1-BDA/pytiff&gt;`_</span>
<span class="sd">* `ScanImageTiffReaderPython</span>
<span class="sd">  &lt;https://gitlab.com/vidriotech/scanimagetiffreader-python&gt;`_</span>
<span class="sd">* `bigtiff &lt;https://pypi.org/project/bigtiff&gt;`_</span>
<span class="sd">* `Large Image &lt;https://github.com/girder/large_image&gt;`_</span>

<span class="sd">Some libraries are using tifffile to write OME-TIFF files:</span>

<span class="sd">* `Zeiss Apeer OME-TIFF library</span>
<span class="sd">  &lt;https://github.com/apeer-micro/apeer-ometiff-library&gt;`_</span>
<span class="sd">* `Allen Institute for Cell Science imageio</span>
<span class="sd">  &lt;https://pypi.org/project/aicsimageio&gt;`_</span>
<span class="sd">* `xtiff &lt;https://github.com/BodenmillerGroup/xtiff&gt;`_</span>

<span class="sd">Other tools for inspecting and manipulating TIFF files:</span>

<span class="sd">* `tifftools &lt;https://github.com/DigitalSlideArchive/tifftools&gt;`_</span>
<span class="sd">* `Tyf &lt;https://github.com/Moustikitos/tyf&gt;`_</span>

<span class="sd">References</span>
<span class="sd">----------</span>
<span class="sd">* TIFF 6.0 Specification and Supplements. Adobe Systems Incorporated.</span>
<span class="sd">  https://www.adobe.io/open/standards/TIFF.html</span>
<span class="sd">* TIFF File Format FAQ. https://www.awaresystems.be/imaging/tiff/faq.html</span>
<span class="sd">* The BigTIFF File Format.</span>
<span class="sd">  https://www.awaresystems.be/imaging/tiff/bigtiff.html</span>
<span class="sd">* MetaMorph Stack (STK) Image File Format.</span>
<span class="sd">  http://mdc.custhelp.com/app/answers/detail/a_id/18862</span>
<span class="sd">* Image File Format Description LSM 5/7 Release 6.0 (ZEN 2010).</span>
<span class="sd">  Carl Zeiss MicroImaging GmbH. BioSciences. May 10, 2011</span>
<span class="sd">* The OME-TIFF format.</span>
<span class="sd">  https://docs.openmicroscopy.org/ome-model/latest/</span>
<span class="sd">* UltraQuant(r) Version 6.0 for Windows Start-Up Guide.</span>
<span class="sd">  http://www.ultralum.com/images%20ultralum/pdf/UQStart%20Up%20Guide.pdf</span>
<span class="sd">* Micro-Manager File Formats.</span>
<span class="sd">  https://micro-manager.org/wiki/Micro-Manager_File_Formats</span>
<span class="sd">* ScanImage BigTiff Specification - ScanImage 2019.</span>
<span class="sd">  http://scanimage.vidriotechnologies.com/display/SI2019/</span>
<span class="sd">  ScanImage+BigTiff+Specification</span>
<span class="sd">* ZIF, the Zoomable Image File format. http://zif.photo/</span>
<span class="sd">* GeoTIFF File Format https://gdal.org/drivers/raster/gtiff.html</span>
<span class="sd">* Cloud optimized GeoTIFF.</span>
<span class="sd">  https://github.com/cogeotiff/cog-spec/blob/master/spec.md</span>
<span class="sd">* Tags for TIFF and Related Specifications. Digital Preservation.</span>
<span class="sd">  https://www.loc.gov/preservation/digital/formats/content/tiff_tags.shtml</span>
<span class="sd">* CIPA DC-008-2016: Exchangeable image file format for digital still cameras:</span>
<span class="sd">  Exif Version 2.31.</span>
<span class="sd">  http://www.cipa.jp/std/documents/e/DC-008-Translation-2016-E.pdf</span>
<span class="sd">* The EER (Electron Event Representation) file format.</span>
<span class="sd">  https://github.com/fei-company/EerReaderLib</span>
<span class="sd">* Digital Negative (DNG) Specification. Version 1.5.0.0, June 2012.</span>
<span class="sd">  https://www.adobe.com/content/dam/acom/en/products/photoshop/pdfs/</span>
<span class="sd">  dng_spec_1.5.0.0.pdf</span>
<span class="sd">* Roche Digital Pathology. BIF image file format for digital pathology.</span>
<span class="sd">  https://diagnostics.roche.com/content/dam/diagnostics/Blueprint/en/pdf/rmd/</span>
<span class="sd">  Roche-Digital-Pathology-BIF-Whitepaper.pdf</span>

<span class="sd">Examples</span>
<span class="sd">--------</span>
<span class="sd">Write a numpy array to a single-page RGB TIFF file:</span>

<span class="sd">&gt;&gt;&gt; data = numpy.random.randint(0, 255, (256, 256, 3), &#39;uint8&#39;)</span>
<span class="sd">&gt;&gt;&gt; imwrite(&#39;temp.tif&#39;, data, photometric=&#39;rgb&#39;)</span>

<span class="sd">Read the image from the TIFF file as numpy array:</span>

<span class="sd">&gt;&gt;&gt; image = imread(&#39;temp.tif&#39;)</span>
<span class="sd">&gt;&gt;&gt; image.shape</span>
<span class="sd">(256, 256, 3)</span>

<span class="sd">Write a 3D numpy array to a multi-page, 16-bit grayscale TIFF file:</span>

<span class="sd">&gt;&gt;&gt; data = numpy.random.randint(0, 2**12, (64, 301, 219), &#39;uint16&#39;)</span>
<span class="sd">&gt;&gt;&gt; imwrite(&#39;temp.tif&#39;, data, photometric=&#39;minisblack&#39;)</span>

<span class="sd">Read the whole image stack from the TIFF file as numpy array:</span>

<span class="sd">&gt;&gt;&gt; image_stack = imread(&#39;temp.tif&#39;)</span>
<span class="sd">&gt;&gt;&gt; image_stack.shape</span>
<span class="sd">(64, 301, 219)</span>
<span class="sd">&gt;&gt;&gt; image_stack.dtype</span>
<span class="sd">dtype(&#39;uint16&#39;)</span>

<span class="sd">Read the image from the first page in the TIFF file as numpy array:</span>

<span class="sd">&gt;&gt;&gt; image = imread(&#39;temp.tif&#39;, key=0)</span>
<span class="sd">&gt;&gt;&gt; image.shape</span>
<span class="sd">(301, 219)</span>

<span class="sd">Read images from a selected range of pages:</span>

<span class="sd">&gt;&gt;&gt; images = imread(&#39;temp.tif&#39;, key=range(4, 40, 2))</span>
<span class="sd">&gt;&gt;&gt; images.shape</span>
<span class="sd">(18, 301, 219)</span>

<span class="sd">Iterate over all pages in the TIFF file and successively read images:</span>

<span class="sd">&gt;&gt;&gt; with TiffFile(&#39;temp.tif&#39;) as tif:</span>
<span class="sd">...     for page in tif.pages:</span>
<span class="sd">...         image = page.asarray()</span>

<span class="sd">Get information about the image stack in the TIFF file without reading</span>
<span class="sd">the image data:</span>

<span class="sd">&gt;&gt;&gt; tif = TiffFile(&#39;temp.tif&#39;)</span>
<span class="sd">&gt;&gt;&gt; len(tif.pages)  # number of pages in the file</span>
<span class="sd">64</span>
<span class="sd">&gt;&gt;&gt; page = tif.pages[0]  # get shape and dtype of the image in the first page</span>
<span class="sd">&gt;&gt;&gt; page.shape</span>
<span class="sd">(301, 219)</span>
<span class="sd">&gt;&gt;&gt; page.dtype</span>
<span class="sd">dtype(&#39;uint16&#39;)</span>
<span class="sd">&gt;&gt;&gt; page.axes</span>
<span class="sd">&#39;YX&#39;</span>
<span class="sd">&gt;&gt;&gt; series = tif.series[0]  # get shape and dtype of the first image series</span>
<span class="sd">&gt;&gt;&gt; series.shape</span>
<span class="sd">(64, 301, 219)</span>
<span class="sd">&gt;&gt;&gt; series.dtype</span>
<span class="sd">dtype(&#39;uint16&#39;)</span>
<span class="sd">&gt;&gt;&gt; series.axes</span>
<span class="sd">&#39;QYX&#39;</span>
<span class="sd">&gt;&gt;&gt; tif.close()</span>

<span class="sd">Inspect the &quot;XResolution&quot; tag from the first page in the TIFF file:</span>

<span class="sd">&gt;&gt;&gt; with TiffFile(&#39;temp.tif&#39;) as tif:</span>
<span class="sd">...     tag = tif.pages[0].tags[&#39;XResolution&#39;]</span>
<span class="sd">&gt;&gt;&gt; tag.value</span>
<span class="sd">(1, 1)</span>
<span class="sd">&gt;&gt;&gt; tag.name</span>
<span class="sd">&#39;XResolution&#39;</span>
<span class="sd">&gt;&gt;&gt; tag.code</span>
<span class="sd">282</span>
<span class="sd">&gt;&gt;&gt; tag.count</span>
<span class="sd">1</span>
<span class="sd">&gt;&gt;&gt; tag.dtype</span>
<span class="sd">&lt;DATATYPES.RATIONAL: 5&gt;</span>

<span class="sd">Iterate over all tags in the TIFF file:</span>

<span class="sd">&gt;&gt;&gt; with TiffFile(&#39;temp.tif&#39;) as tif:</span>
<span class="sd">...     for page in tif.pages:</span>
<span class="sd">...         for tag in page.tags:</span>
<span class="sd">...             tag_name, tag_value = tag.name, tag.value</span>

<span class="sd">Overwrite the value of an existing tag, e.g. XResolution:</span>

<span class="sd">&gt;&gt;&gt; with TiffFile(&#39;temp.tif&#39;, mode=&#39;r+b&#39;) as tif:</span>
<span class="sd">...     _ = tif.pages[0].tags[&#39;XResolution&#39;].overwrite((96000, 1000))</span>

<span class="sd">Write a floating-point ndarray and metadata using BigTIFF format, tiling,</span>
<span class="sd">compression, and planar storage:</span>

<span class="sd">&gt;&gt;&gt; data = numpy.random.rand(2, 5, 3, 301, 219).astype(&#39;float32&#39;)</span>
<span class="sd">&gt;&gt;&gt; imwrite(&#39;temp.tif&#39;, data, bigtiff=True, photometric=&#39;minisblack&#39;,</span>
<span class="sd">...         compression=&#39;zlib&#39;, planarconfig=&#39;separate&#39;, tile=(32, 32),</span>
<span class="sd">...         metadata={&#39;axes&#39;: &#39;TZCYX&#39;})</span>

<span class="sd">Write a 10 fps time series of volumes with xyz voxel size 2.6755x2.6755x3.9474</span>
<span class="sd">micron^3 to an ImageJ hyperstack formatted TIFF file:</span>

<span class="sd">&gt;&gt;&gt; volume = numpy.random.randn(6, 57, 256, 256).astype(&#39;float32&#39;)</span>
<span class="sd">&gt;&gt;&gt; imwrite(&#39;temp.tif&#39;, volume, imagej=True, resolution=(1./2.6755, 1./2.6755),</span>
<span class="sd">...         metadata={&#39;spacing&#39;: 3.947368, &#39;unit&#39;: &#39;um&#39;, &#39;finterval&#39;: 1/10,</span>
<span class="sd">...                   &#39;axes&#39;: &#39;TZYX&#39;})</span>

<span class="sd">Read the volume and metadata from the ImageJ file:</span>

<span class="sd">&gt;&gt;&gt; with TiffFile(&#39;temp.tif&#39;) as tif:</span>
<span class="sd">...     volume = tif.asarray()</span>
<span class="sd">...     axes = tif.series[0].axes</span>
<span class="sd">...     imagej_metadata = tif.imagej_metadata</span>
<span class="sd">&gt;&gt;&gt; volume.shape</span>
<span class="sd">(6, 57, 256, 256)</span>
<span class="sd">&gt;&gt;&gt; axes</span>
<span class="sd">&#39;TZYX&#39;</span>
<span class="sd">&gt;&gt;&gt; imagej_metadata[&#39;slices&#39;]</span>
<span class="sd">57</span>
<span class="sd">&gt;&gt;&gt; imagej_metadata[&#39;frames&#39;]</span>
<span class="sd">6</span>

<span class="sd">Create a TIFF file containing an empty image and write to the memory-mapped</span>
<span class="sd">numpy array:</span>

<span class="sd">&gt;&gt;&gt; memmap_image = memmap(</span>
<span class="sd">...     &#39;temp.tif&#39;, shape=(256, 256, 3), dtype=&#39;float32&#39;, photometric=&#39;rgb&#39;</span>
<span class="sd">... )</span>
<span class="sd">&gt;&gt;&gt; type(memmap_image)</span>
<span class="sd">&lt;class &#39;numpy.memmap&#39;&gt;</span>
<span class="sd">&gt;&gt;&gt; memmap_image[255, 255, 1] = 1.0</span>
<span class="sd">&gt;&gt;&gt; memmap_image.flush()</span>
<span class="sd">&gt;&gt;&gt; del memmap_image</span>

<span class="sd">Memory-map and read contiguous image data in the TIFF file:</span>

<span class="sd">&gt;&gt;&gt; memmap_image = memmap(&#39;temp.tif&#39;)</span>
<span class="sd">&gt;&gt;&gt; memmap_image.shape</span>
<span class="sd">(256, 256, 3)</span>
<span class="sd">&gt;&gt;&gt; memmap_image[255, 255, 1]</span>
<span class="sd">1.0</span>
<span class="sd">&gt;&gt;&gt; del memmap_image</span>

<span class="sd">Write two numpy arrays to a multi-series TIFF file:</span>

<span class="sd">&gt;&gt;&gt; series0 = numpy.random.randint(0, 255, (32, 32, 3), &#39;uint8&#39;)</span>
<span class="sd">&gt;&gt;&gt; series1 = numpy.random.randint(0, 1023, (4, 256, 256), &#39;uint16&#39;)</span>
<span class="sd">&gt;&gt;&gt; with TiffWriter(&#39;temp.tif&#39;) as tif:</span>
<span class="sd">...     tif.write(series0, photometric=&#39;rgb&#39;)</span>
<span class="sd">...     tif.write(series1, photometric=&#39;minisblack&#39;)</span>

<span class="sd">Read the second image series from the TIFF file:</span>

<span class="sd">&gt;&gt;&gt; series1 = imread(&#39;temp.tif&#39;, series=1)</span>
<span class="sd">&gt;&gt;&gt; series1.shape</span>
<span class="sd">(4, 256, 256)</span>

<span class="sd">Successively write the frames of one contiguous series to a TIFF file:</span>

<span class="sd">&gt;&gt;&gt; data = numpy.random.randint(0, 255, (30, 301, 219), &#39;uint8&#39;)</span>
<span class="sd">&gt;&gt;&gt; with TiffWriter(&#39;temp.tif&#39;) as tif:</span>
<span class="sd">...     for frame in data:</span>
<span class="sd">...         tif.write(frame, contiguous=True)</span>

<span class="sd">Append an image series to the existing TIFF file:</span>

<span class="sd">&gt;&gt;&gt; data = numpy.random.randint(0, 255, (301, 219, 3), &#39;uint8&#39;)</span>
<span class="sd">&gt;&gt;&gt; imwrite(&#39;temp.tif&#39;, data, photometric=&#39;rgb&#39;, append=True)</span>

<span class="sd">Create a TIFF file from a generator of tiles:</span>

<span class="sd">&gt;&gt;&gt; data = numpy.random.randint(0, 2**12, (31, 33, 3), &#39;uint16&#39;)</span>
<span class="sd">&gt;&gt;&gt; def tiles(data, tileshape):</span>
<span class="sd">...     for y in range(0, data.shape[0], tileshape[0]):</span>
<span class="sd">...         for x in range(0, data.shape[1], tileshape[1]):</span>
<span class="sd">...             yield data[y : y + tileshape[0], x : x + tileshape[1]]</span>
<span class="sd">&gt;&gt;&gt; imwrite(&#39;temp.tif&#39;, tiles(data, (16, 16)), tile=(16, 16),</span>
<span class="sd">...         shape=data.shape, dtype=data.dtype, photometric=&#39;rgb&#39;)</span>

<span class="sd">Write two numpy arrays to a multi-series OME-TIFF file:</span>

<span class="sd">&gt;&gt;&gt; series0 = numpy.random.randint(0, 255, (32, 32, 3), &#39;uint8&#39;)</span>
<span class="sd">&gt;&gt;&gt; series1 = numpy.random.randint(0, 1023, (4, 256, 256), &#39;uint16&#39;)</span>
<span class="sd">&gt;&gt;&gt; with TiffWriter(&#39;temp.ome.tif&#39;) as tif:</span>
<span class="sd">...     tif.write(series0, photometric=&#39;rgb&#39;)</span>
<span class="sd">...     tif.write(series1, photometric=&#39;minisblack&#39;,</span>
<span class="sd">...               metadata={&#39;axes&#39;: &#39;ZYX&#39;, &#39;SignificantBits&#39;: 10,</span>
<span class="sd">...                         &#39;Plane&#39;: {&#39;PositionZ&#39;: [0.0, 1.0, 2.0, 3.0]}})</span>

<span class="sd">Write a tiled, multi-resolution, pyramidal, OME-TIFF file using</span>
<span class="sd">JPEG compression. Sub-resolution images are written to SubIFDs:</span>

<span class="sd">&gt;&gt;&gt; data = numpy.arange(1024*1024*3, dtype=&#39;uint8&#39;).reshape((1024, 1024, 3))</span>
<span class="sd">&gt;&gt;&gt; with TiffWriter(&#39;temp.ome.tif&#39;, bigtiff=True) as tif:</span>
<span class="sd">...     options = dict(tile=(256, 256), photometric=&#39;rgb&#39;, compression=&#39;jpeg&#39;)</span>
<span class="sd">...     tif.write(data, subifds=2, **options)</span>
<span class="sd">...     # save pyramid levels to the two subifds</span>
<span class="sd">...     # in production use resampling to generate sub-resolutions</span>
<span class="sd">...     tif.write(data[::2, ::2], subfiletype=1, **options)</span>
<span class="sd">...     tif.write(data[::4, ::4], subfiletype=1, **options)</span>

<span class="sd">Access the image levels in the pyramidal OME-TIFF file:</span>

<span class="sd">&gt;&gt;&gt; baseimage = imread(&#39;temp.ome.tif&#39;)</span>
<span class="sd">&gt;&gt;&gt; second_level = imread(&#39;temp.ome.tif&#39;, series=0, level=1)</span>
<span class="sd">&gt;&gt;&gt; with TiffFile(&#39;temp.ome.tif&#39;) as tif:</span>
<span class="sd">...     baseimage = tif.series[0].asarray()</span>
<span class="sd">...     second_level = tif.series[0].levels[1].asarray()</span>

<span class="sd">Iterate over and decode single JPEG compressed tiles in the TIFF file:</span>

<span class="sd">&gt;&gt;&gt; with TiffFile(&#39;temp.ome.tif&#39;) as tif:</span>
<span class="sd">...     fh = tif.filehandle</span>
<span class="sd">...     for page in tif.pages:</span>
<span class="sd">...         for index, (offset, bytecount) in enumerate(</span>
<span class="sd">...             zip(page.dataoffsets, page.databytecounts)</span>
<span class="sd">...         ):</span>
<span class="sd">...             _ = fh.seek(offset)</span>
<span class="sd">...             data = fh.read(bytecount)</span>
<span class="sd">...             tile, indices, shape = page.decode(</span>
<span class="sd">...                 data, index, jpegtables=page.jpegtables</span>
<span class="sd">...             )</span>

<span class="sd">Use zarr to read parts of the tiled, pyramidal images in the TIFF file:</span>

<span class="sd">&gt;&gt;&gt; import zarr</span>
<span class="sd">&gt;&gt;&gt; store = imread(&#39;temp.ome.tif&#39;, aszarr=True)</span>
<span class="sd">&gt;&gt;&gt; z = zarr.open(store, mode=&#39;r&#39;)</span>
<span class="sd">&gt;&gt;&gt; z</span>
<span class="sd">&lt;zarr.hierarchy.Group &#39;/&#39; read-only&gt;</span>
<span class="sd">&gt;&gt;&gt; z[0]  # base layer</span>
<span class="sd">&lt;zarr.core.Array &#39;/0&#39; (1024, 1024, 3) uint8 read-only&gt;</span>
<span class="sd">&gt;&gt;&gt; z[0][256:512, 512:768].shape  # read a tile from the base layer</span>
<span class="sd">(256, 256, 3)</span>
<span class="sd">&gt;&gt;&gt; store.close()</span>

<span class="sd">Read images from a sequence of TIFF files as numpy array:</span>

<span class="sd">&gt;&gt;&gt; imwrite(&#39;temp_C001T001.tif&#39;, numpy.random.rand(64, 64))</span>
<span class="sd">&gt;&gt;&gt; imwrite(&#39;temp_C001T002.tif&#39;, numpy.random.rand(64, 64))</span>
<span class="sd">&gt;&gt;&gt; image_sequence = imread([&#39;temp_C001T001.tif&#39;, &#39;temp_C001T002.tif&#39;])</span>
<span class="sd">&gt;&gt;&gt; image_sequence.shape</span>
<span class="sd">(2, 64, 64)</span>
<span class="sd">&gt;&gt;&gt; image_sequence.dtype</span>
<span class="sd">dtype(&#39;float64&#39;)</span>

<span class="sd">Read an image stack from a series of TIFF files with a file name pattern</span>
<span class="sd">as numpy or zarr arrays:</span>

<span class="sd">&gt;&gt;&gt; image_sequence = TiffSequence(&#39;temp_C0*.tif&#39;, pattern=r&#39;_(C)(\d+)(T)(\d+)&#39;)</span>
<span class="sd">&gt;&gt;&gt; image_sequence.shape</span>
<span class="sd">(1, 2)</span>
<span class="sd">&gt;&gt;&gt; image_sequence.axes</span>
<span class="sd">&#39;CT&#39;</span>
<span class="sd">&gt;&gt;&gt; data = image_sequence.asarray()</span>
<span class="sd">&gt;&gt;&gt; data.shape</span>
<span class="sd">(1, 2, 64, 64)</span>
<span class="sd">&gt;&gt;&gt; with image_sequence.aszarr() as store:</span>
<span class="sd">...     zarr.open(store, mode=&#39;r&#39;)</span>
<span class="sd">&lt;zarr.core.Array (1, 2, 64, 64) float64 read-only&gt;</span>
<span class="sd">&gt;&gt;&gt; image_sequence.close()</span>

<span class="sd">Write the zarr store to a fsspec ReferenceFileSystem in JSON format:</span>

<span class="sd">&gt;&gt;&gt; with image_sequence.aszarr() as store:</span>
<span class="sd">...     store.write_fsspec(&#39;temp.json&#39;, url=&#39;file://&#39;)</span>

<span class="sd">Open the fsspec ReferenceFileSystem as a zarr array:</span>

<span class="sd">&gt;&gt;&gt; import fsspec</span>
<span class="sd">&gt;&gt;&gt; import tifffile.numcodecs</span>
<span class="sd">&gt;&gt;&gt; tifffile.numcodecs.register_codec()</span>
<span class="sd">&gt;&gt;&gt; mapper = fsspec.get_mapper(</span>
<span class="sd">...     &#39;reference://&#39;, fo=&#39;temp.json&#39;, target_protocol=&#39;file&#39;)</span>
<span class="sd">&gt;&gt;&gt; zarr.open(mapper, mode=&#39;r&#39;)</span>
<span class="sd">&lt;zarr.core.Array (1, 2, 64, 64) float64 read-only&gt;</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;2021.11.2&#39;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;OmeXml&#39;</span><span class="p">,</span>
    <span class="s1">&#39;OmeXmlError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TIFF&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TiffFile&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TiffFileError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TiffFrame&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TiffPage&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TiffPageSeries&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TiffReader&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TiffSequence&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TiffTag&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TiffTags&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TiffTagRegistry&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TiffWriter&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ZarrFileSequenceStore&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ZarrStore&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ZarrTiffStore&#39;</span><span class="p">,</span>
    <span class="s1">&#39;imread&#39;</span><span class="p">,</span>
    <span class="s1">&#39;imshow&#39;</span><span class="p">,</span>
    <span class="s1">&#39;imwrite&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lsm2bin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;memmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;read_micromanager_metadata&#39;</span><span class="p">,</span>
    <span class="s1">&#39;read_scanimage_metadata&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tiff2fsspec&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tiffcomment&#39;</span><span class="p">,</span>
    <span class="c1"># utility classes and functions used by oiffile, czifile, etc.</span>
    <span class="s1">&#39;FileCache&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FileHandle&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FileSequence&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Timer&#39;</span><span class="p">,</span>
    <span class="s1">&#39;askopenfilename&#39;</span><span class="p">,</span>
    <span class="s1">&#39;astype&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_output&#39;</span><span class="p">,</span>
    <span class="s1">&#39;enumarg&#39;</span><span class="p">,</span>
    <span class="s1">&#39;enumstr&#39;</span><span class="p">,</span>
    <span class="s1">&#39;format_size&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lazyattr&#39;</span><span class="p">,</span>
    <span class="s1">&#39;matlabstr2py&#39;</span><span class="p">,</span>
    <span class="s1">&#39;natural_sorted&#39;</span><span class="p">,</span>
    <span class="s1">&#39;nullfunc&#39;</span><span class="p">,</span>
    <span class="s1">&#39;parse_kwargs&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pformat&#39;</span><span class="p">,</span>
    <span class="s1">&#39;product&#39;</span><span class="p">,</span>
    <span class="s1">&#39;repeat_nd&#39;</span><span class="p">,</span>
    <span class="s1">&#39;reshape_axes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;reshape_nd&#39;</span><span class="p">,</span>
    <span class="s1">&#39;squeeze_axes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;stripnull&#39;</span><span class="p">,</span>
    <span class="s1">&#39;transpose_axes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;update_kwargs&#39;</span><span class="p">,</span>
    <span class="s1">&#39;xml2dict&#39;</span><span class="p">,</span>
    <span class="c1"># deprecated</span>
    <span class="s1">&#39;imsave&#39;</span><span class="p">,</span>
    <span class="s1">&#39;_app_show&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">MutableMapping</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>

<span class="kn">import</span> <span class="nn">numpy</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">imagecodecs</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">imagecodecs</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># delay import of mmap, pprint, fractions, xml, lxml, matplotlib, tkinter,</span>
<span class="c1">#   logging, subprocess, multiprocessing, tempfile, zipfile, fnmatch</span>


<span class="k">def</span> <span class="nf">imread</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aszarr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return image data from TIFF file(s) as numpy array or zarr storage.</span>

<span class="sd">    Refer to the TiffFile and TiffSequence classes and their asarray</span>
<span class="sd">    functions for documentation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : str, path-like, binary stream, or sequence</span>
<span class="sd">        File name, seekable binary stream, glob pattern, or sequence of</span>
<span class="sd">        file names.</span>
<span class="sd">    aszarr : bool</span>
<span class="sd">        If True, return file sequences, series, or single pages as</span>
<span class="sd">        zarr storage instead of numpy array (experimental).</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        Parameters &#39;name&#39;, &#39;offset&#39;, &#39;size&#39;, and &#39;is_&#39; flags are passed to</span>
<span class="sd">        TiffFile or TiffSequence.imread.</span>
<span class="sd">        Parameters &#39;imread&#39;, &#39;container&#39;, &#39;sort&#39;, &#39;pattern&#39;, &#39;axesorder&#39;,</span>
<span class="sd">        and &#39;categories&#39; are passed to TiffSequence.</span>
<span class="sd">        Other parameters are passed to the asarray or aszarr functions.</span>
<span class="sd">        The first image series in the file is returned if no arguments are</span>
<span class="sd">        provided.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray or zarr storage</span>
<span class="sd">        Image data from the specified pages.</span>
<span class="sd">        Zarr storage instances must be closed after use.</span>
<span class="sd">        See TiffPage.asarray for operations that are applied (or not)</span>
<span class="sd">        to the raw data stored in the file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs_file</span> <span class="o">=</span> <span class="n">parse_kwargs</span><span class="p">(</span>
        <span class="n">kwargs</span><span class="p">,</span>
        <span class="s1">&#39;name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;offset&#39;</span><span class="p">,</span>
        <span class="s1">&#39;size&#39;</span><span class="p">,</span>
        <span class="c1"># private</span>
        <span class="s1">&#39;_multifile&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_useframes&#39;</span><span class="p">,</span>
        <span class="c1"># deprecated, ignored</span>
        <span class="c1"># TODO: remove</span>
        <span class="s1">&#39;fastij&#39;</span><span class="p">,</span>
        <span class="s1">&#39;movie&#39;</span><span class="p">,</span>
        <span class="s1">&#39;multifile&#39;</span><span class="p">,</span>
        <span class="s1">&#39;multifile_close&#39;</span><span class="p">,</span>
        <span class="c1"># is_flags</span>
        <span class="o">*</span><span class="p">(</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">key</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;is_&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">kwargs_seq</span> <span class="o">=</span> <span class="n">parse_kwargs</span><span class="p">(</span>
        <span class="n">kwargs</span><span class="p">,</span>
        <span class="s1">&#39;imread&#39;</span><span class="p">,</span>
        <span class="s1">&#39;container&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sort&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pattern&#39;</span><span class="p">,</span>
        <span class="s1">&#39;axesorder&#39;</span><span class="p">,</span>
        <span class="s1">&#39;categories&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pages&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO: remove</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;the &#39;pages&#39; and &#39;key&#39; parameters cannot be used together&quot;</span>
            <span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s1">&#39;&lt;tifffile.imread&gt; &#39;</span>
            <span class="s2">&quot;the &#39;pages&#39; parameter is deprecated since 2017.9.29. &quot;</span>
            <span class="s2">&quot;Use the &#39;key&#39; parameter&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;pages&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kwargs_seq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;container&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">files</span> <span class="ow">or</span> <span class="s1">&#39;?&#39;</span> <span class="ow">in</span> <span class="n">files</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no files found&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="s1">&#39;seek&#39;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">))</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="s1">&#39;seek&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">TiffFile</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">aszarr</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">tif</span><span class="o">.</span><span class="n">aszarr</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">TiffSequence</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_seq</span><span class="p">)</span> <span class="k">as</span> <span class="n">imseq</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">aszarr</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">imseq</span><span class="o">.</span><span class="n">aszarr</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">imseq</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_file</span><span class="p">)</span>


<div class="viewcode-block" id="imwrite"><a class="viewcode-back" href="../../apidoc/impy.utils.html#impy.utils.io.imwrite">[docs]</a><span class="k">def</span> <span class="nf">imwrite</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write numpy array to TIFF file.</span>

<span class="sd">    Refer to the TiffWriter class and its write function for documentation.</span>

<span class="sd">    A BigTIFF file is created if the data&#39;s size is larger than 4 GB minus</span>
<span class="sd">    32 MB (for metadata), and &#39;bigtiff&#39; is not specified, and &#39;imagej&#39; or</span>
<span class="sd">    &#39;truncate&#39; are not enabled.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : str, path-like, or binary stream</span>
<span class="sd">        File name or writable binary stream, such as an open file or BytesIO.</span>
<span class="sd">    data : array-like</span>
<span class="sd">        Input image. The last dimensions are assumed to be image depth,</span>
<span class="sd">        length, width, and samples.</span>
<span class="sd">        If None, an empty array of the specified shape and dtype is</span>
<span class="sd">        saved to file.</span>
<span class="sd">        Unless &#39;byteorder&#39; is specified in &#39;kwargs&#39;, the TIFF file byte order</span>
<span class="sd">        is determined from the data&#39;s dtype or the dtype argument.</span>
<span class="sd">    shape : tuple</span>
<span class="sd">        If &#39;data&#39; is None, shape of an empty array to save to the file.</span>
<span class="sd">    dtype : numpy.dtype</span>
<span class="sd">        If &#39;data&#39; is None, datatype of an empty array to save to the file.</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        Parameters &#39;append&#39;, &#39;byteorder&#39;, &#39;bigtiff&#39;, &#39;imagej&#39;, and &#39;ome&#39;,</span>
<span class="sd">        are passed to TiffWriter().</span>
<span class="sd">        Other parameters are passed to TiffWriter.write().</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    offset, bytecount : tuple or None</span>
<span class="sd">        If the &#39;returnoffset&#39; argument is True and the image data are written</span>
<span class="sd">        contiguously, return offset and bytecount of image data in the file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tifargs</span> <span class="o">=</span> <span class="n">parse_kwargs</span><span class="p">(</span>
        <span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="s1">&#39;bigtiff&#39;</span><span class="p">,</span> <span class="s1">&#39;byteorder&#39;</span><span class="p">,</span> <span class="s1">&#39;imagej&#39;</span><span class="p">,</span> <span class="s1">&#39;ome&#39;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">datasize</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="n">byteorder</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">byteorder</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">datasize</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">nbytes</span>
            <span class="n">byteorder</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">byteorder</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">datasize</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">byteorder</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bigsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;bigsize&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">25</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="s1">&#39;bigtiff&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tifargs</span>
        <span class="ow">and</span> <span class="n">datasize</span> <span class="o">&gt;</span> <span class="n">bigsize</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">tifargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;imagej&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">tifargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;truncate&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compression&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compress&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># TODO: remove deprecated</span>
    <span class="p">):</span>
        <span class="n">tifargs</span><span class="p">[</span><span class="s1">&#39;bigtiff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="s1">&#39;byteorder&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tifargs</span><span class="p">:</span>
        <span class="n">tifargs</span><span class="p">[</span><span class="s1">&#39;byteorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">byteorder</span>

    <span class="k">with</span> <span class="n">TiffWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">tifargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="memmap"><a class="viewcode-back" href="../../apidoc/impy.utils.html#impy.utils.io.memmap">[docs]</a><span class="k">def</span> <span class="nf">memmap</span><span class="p">(</span>
    <span class="n">filename</span><span class="p">,</span>
    <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">page</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">series</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return memory-mapped numpy array stored in TIFF file.</span>

<span class="sd">    Memory-mapping requires data stored in native byte order, without tiling,</span>
<span class="sd">    compression, predictors, etc.</span>
<span class="sd">    If &#39;shape&#39; and &#39;dtype&#39; are provided, existing files are overwritten or</span>
<span class="sd">    appended to depending on the &#39;append&#39; parameter.</span>
<span class="sd">    Otherwise the image data of a specified page or series in an existing</span>
<span class="sd">    file are memory-mapped. By default, the image data of the first</span>
<span class="sd">    series are memory-mapped.</span>
<span class="sd">    Call flush() to write any changes in the array to the file.</span>
<span class="sd">    Raise ValueError if the image data in the file are not memory-mappable.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str or path-like</span>
<span class="sd">        Name of the TIFF file which stores the array.</span>
<span class="sd">    shape : tuple</span>
<span class="sd">        Shape of the empty array.</span>
<span class="sd">    dtype : numpy.dtype</span>
<span class="sd">        Datatype of the empty array.</span>
<span class="sd">    page : int</span>
<span class="sd">        Index of the page which image data to memory-map.</span>
<span class="sd">    series, level : int</span>
<span class="sd">        Index of the page series and pyramid level which image data to</span>
<span class="sd">        memory-map.</span>
<span class="sd">    mode : {&#39;r+&#39;, &#39;r&#39;, &#39;c&#39;}</span>
<span class="sd">        The file open mode. Default is to open existing file for reading and</span>
<span class="sd">        writing (&#39;r+&#39;).</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        Additional parameters passed to imwrite() or TiffFile().</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.memmap</span>
<span class="sd">        Image data in TIFF file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># create a new, empty array</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">align</span><span class="o">=</span><span class="n">TIFF</span><span class="o">.</span><span class="n">ALLOCATIONGRANULARITY</span><span class="p">,</span>
            <span class="n">returnoffset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">imwrite</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO: fail before creating file or writing data</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;image data are not memory-mappable&#39;</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># use existing file</span>
        <span class="k">with</span> <span class="n">TiffFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">page</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">page</span><span class="o">.</span><span class="n">is_memmappable</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;image data are not memory-mappable&#39;</span><span class="p">)</span>
                <span class="n">offset</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">dtype</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">series</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="n">series</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">series</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;image data are not memory-mappable&#39;</span><span class="p">)</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">dtype</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">offset</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">+</span> <span class="n">dtype</span><span class="o">.</span><span class="n">char</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">lazyattr</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Attribute whose value is computed on first access.</span>

<span class="sd">    Lazyattrs are not thread-safe.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: replace with functools.cached_property? requires Python &gt;= 3.8</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="s1">&#39;__dict__&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize instance from decorated function.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__module__</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__qualname__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__qualname__</span>
        <span class="c1"># self.lock = threading.RLock()</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="c1"># with self.lock:</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">NotImplemented</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">instance</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">TiffFileError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception to indicate invalid TIFF structure.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">TiffWriter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Write numpy arrays to TIFF file.</span>

<span class="sd">    TiffWriter&#39;s main purpose is saving nD numpy array&#39;s as TIFF, not to</span>
<span class="sd">    create any possible TIFF format. Specifically, ExifIFD and GPSIFD tags</span>
<span class="sd">    are not supported.</span>

<span class="sd">    TiffWriter instances must be closed using the &#39;close&#39; method, which is</span>
<span class="sd">    automatically called when using the &#39;with&#39; context manager.</span>

<span class="sd">    TiffWriter instances are not thread-safe.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">file</span><span class="p">,</span>
        <span class="n">bigtiff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">byteorder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">imagej</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ome</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open TIFF file for writing.</span>

<span class="sd">        An empty TIFF file is created if the file does not exist, else the</span>
<span class="sd">        file is overwritten with an empty TIFF file unless &#39;append&#39;</span>
<span class="sd">        is true. Use &#39;bigtiff=True&#39; when creating files larger than 4 GB.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : path-like, binary stream, or FileHandle</span>
<span class="sd">            File name or writable binary stream, such as an open file</span>
<span class="sd">            or BytesIO.</span>
<span class="sd">        bigtiff : bool (optional)</span>
<span class="sd">            If True, the BigTIFF format is used.</span>
<span class="sd">        byteorder : {&#39;&lt;&#39;, &#39;&gt;&#39;, &#39;=&#39;, &#39;|&#39;} (optional)</span>
<span class="sd">            The endianness of the data in the file.</span>
<span class="sd">            By default, this is the system&#39;s native byte order.</span>
<span class="sd">        append : bool (optional)</span>
<span class="sd">            If True and &#39;file&#39; is an existing standard TIFF file, image data</span>
<span class="sd">            and tags are appended to the file. This does not scale well with</span>
<span class="sd">            the number of pages already in the file.</span>
<span class="sd">            Appending data may corrupt specifically formatted TIFF files</span>
<span class="sd">            such as OME-TIFF, LSM, STK, ImageJ, or FluoView.</span>
<span class="sd">        imagej : bool (optional)</span>
<span class="sd">            If True and not &#39;ome&#39;, write an ImageJ hyperstack compatible file.</span>
<span class="sd">            This format can handle data types uint8, uint16, or float32 and</span>
<span class="sd">            data shapes up to 6 dimensions in TZCYXS order.</span>
<span class="sd">            RGB images (S=3 or S=4) must be uint8.</span>
<span class="sd">            ImageJ&#39;s default byte order is big-endian but this implementation</span>
<span class="sd">            uses the system&#39;s native byte order by default.</span>
<span class="sd">            ImageJ hyperstacks do not support BigTIFF or compression.</span>
<span class="sd">            The ImageJ file format is undocumented.</span>
<span class="sd">            When using compression, use ImageJ&#39;s Bio-Formats import function.</span>
<span class="sd">        ome : bool (optional)</span>
<span class="sd">            If True, write an OME-TIFF compatible file. If None (default),</span>
<span class="sd">            the value is determined from the file name extension, the value of</span>
<span class="sd">            the &#39;description&#39; parameter in the first call of the write</span>
<span class="sd">            function, and the value of &#39;imagej&#39;.</span>
<span class="sd">            Refer to the OME model for restrictions of this format.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="c1"># determine if file is an existing TIFF file that can be extended</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">FileHandle</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">TiffFile</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">append</span> <span class="o">!=</span> <span class="s1">&#39;force&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tif</span><span class="o">.</span><span class="n">is_appendable</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                    <span class="s1">&#39;cannot append to file containing metadata&#39;</span>
                                <span class="p">)</span>
                            <span class="n">byteorder</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">byteorder</span>
                            <span class="n">bigtiff</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">is_bigtiff</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_ifdoffset</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">next_page_offset</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
                <span class="n">append</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">):</span>
            <span class="n">byteorder</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;little&#39;</span> <span class="k">else</span> <span class="s1">&#39;&gt;&#39;</span>
        <span class="k">elif</span> <span class="n">byteorder</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;invalid byteorder </span><span class="si">{</span><span class="n">byteorder</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">BIG_LE</span> <span class="k">if</span> <span class="n">bigtiff</span> <span class="k">else</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CLASSIC_LE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">BIG_BE</span> <span class="k">if</span> <span class="n">bigtiff</span> <span class="k">else</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CLASSIC_BE</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_colormap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># shape of data in consecutive pages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datadtype</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># data type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataoffset</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># offset to data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_databytecounts</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># byte counts per plane</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataoffsetstag</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># strip or tile offset tag code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptiontag</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># TiffTag for updating comment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subifds</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of subifds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subifdslevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># index of current subifd level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subifdsoffsets</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># offsets to offsets to subifds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nextifdoffsets</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># offsets to offset to next ifd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ifdindex</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># index of current ifd</span>

        <span class="c1"># normalized shape of data in consecutive pages</span>
        <span class="c1"># (pages, separate_samples, depth, length, width, contig_samples)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storedshape</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="n">FileHandle</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+b&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="n">FileHandle</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;MM&#39;</span><span class="p">}[</span><span class="n">byteorder</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">bigtiff</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;HHH&#39;</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mi">42</span><span class="p">))</span>
            <span class="c1"># first IFD</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ifdoffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tiff</span><span class="o">.</span><span class="n">offsetformat</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ome</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">ome</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ome</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ome</span> <span class="k">else</span> <span class="nb">bool</span><span class="p">(</span><span class="n">imagej</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ome</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">imagej</span> <span class="ow">and</span> <span class="n">bigtiff</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> writing nonconformant BigTIFF ImageJ&#39;</span><span class="p">,</span> <span class="ne">UserWarning</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filehandle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return file handle.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">photometric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">planarconfig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extrasamples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">volumetric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">tile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">contiguous</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">align</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">rowsperstrip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bitspersample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compression</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">predictor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">subsampling</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">jpegtables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">colormap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">subfiletype</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">software</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">subifds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">extratags</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">returnoffset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ijmetadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># deprecated: use metadata</span>
        <span class="n">compress</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># deprecated: use compression</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write numpy ndarray to a series of TIFF pages.</span>

<span class="sd">        The ND image data are written to a series of TIFF pages/IFDs.</span>
<span class="sd">        By default, metadata in JSON, ImageJ, or OME-XML format are written</span>
<span class="sd">        to the ImageDescription tag of the first page to describe the series</span>
<span class="sd">        such that the image data can later be read back as a ndarray of same</span>
<span class="sd">        shape.</span>

<span class="sd">        The data shape&#39;s last dimensions are assumed to be image depth,</span>
<span class="sd">        length (height), width, and samples.</span>
<span class="sd">        If a colormap is provided, the data&#39;s dtype must be uint8 or uint16</span>
<span class="sd">        and the data values are indices into the last dimension of the</span>
<span class="sd">        colormap.</span>
<span class="sd">        If &#39;shape&#39; and &#39;dtype&#39; are specified instead of &#39;data&#39;, an empty array</span>
<span class="sd">        is written. This option cannot be used with compression, predictors,</span>
<span class="sd">        packed integers, bilevel images, or multiple tiles.</span>
<span class="sd">        If &#39;shape&#39;, &#39;dtype&#39;, and &#39;tile&#39; are specified, &#39;data&#39; must be an</span>
<span class="sd">        iterable of all tiles in the image.</span>
<span class="sd">        If &#39;shape&#39;, &#39;dtype&#39;, and &#39;data&#39; are specified but not &#39;tile&#39;, &#39;data&#39;</span>
<span class="sd">        must be an iterable of all single planes in the image.</span>
<span class="sd">        Image data are written uncompressed in one strip per plane by default.</span>
<span class="sd">        Dimensions larger than 2 to 4 (depending on photometric mode, planar</span>
<span class="sd">        configuration, and volumetric mode) are flattened and written as</span>
<span class="sd">        separate pages.</span>
<span class="sd">        If the data size is zero, a single page with shape (0, 0) is written.</span>
<span class="sd">        The SampleFormat tag is derived from the data type or dtype.</span>

<span class="sd">        A UserWarning is logged if RGB colorspace is auto-detected. Specify</span>
<span class="sd">        the &#39;photometric&#39; parameter to avoid the warning.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : numpy.ndarray, iterable of numpy.ndarray, or None</span>
<span class="sd">            Input image or iterable of tiles or images.</span>
<span class="sd">            A copy of the image data is made if &#39;data&#39; is not a C-contiguous</span>
<span class="sd">            numpy array with the same byteorder as the TIFF file.</span>
<span class="sd">            Iterables must yield C-contiguous numpy array of TIFF byteorder.</span>
<span class="sd">            Iterable tiles must match &#39;dtype&#39; and the shape specified in</span>
<span class="sd">            &#39;tile&#39;. Incomplete tiles are zero-padded.</span>
<span class="sd">            Iterable images must match &#39;dtype&#39; and &#39;shape[1:]&#39;.</span>
<span class="sd">        shape : tuple or None</span>
<span class="sd">            Shape of the empty or iterable data to write.</span>
<span class="sd">            Use only if &#39;data&#39; is None or an iterable of tiles or images.</span>
<span class="sd">        dtype : numpy.dtype or None</span>
<span class="sd">            Datatype of the empty or iterable data to write.</span>
<span class="sd">            Use only if &#39;data&#39; is None or an iterable of tiles or images.</span>
<span class="sd">        photometric : {MINISBLACK, MINISWHITE, RGB, PALETTE, SEPARATED, CFA}</span>
<span class="sd">            The color space of the image data according to TIFF.PHOTOMETRIC.</span>
<span class="sd">            By default, this setting is inferred from the data shape, dtype,</span>
<span class="sd">            and the value of colormap. Always specify this parameter to avoid</span>
<span class="sd">            ambiguities.</span>
<span class="sd">            For CFA images, the CFARepeatPatternDim, CFAPattern, and other</span>
<span class="sd">            DNG or TIFF/EP tags must be specified in &#39;extratags&#39; to produce a</span>
<span class="sd">            valid file.</span>
<span class="sd">        planarconfig : {CONTIG, SEPARATE}</span>
<span class="sd">            Specifies if samples are stored interleaved or in separate planes.</span>
<span class="sd">            By default, this setting is inferred from the data shape.</span>
<span class="sd">            If this parameter is set, extra samples are used to store grayscale</span>
<span class="sd">            images.</span>
<span class="sd">            CONTIG: last dimension contains samples.</span>
<span class="sd">            SEPARATE: third (or fourth) last dimension contains samples.</span>
<span class="sd">        extrasamples : tuple of {UNSPECIFIED, ASSOCALPHA, UNASSALPHA}</span>
<span class="sd">            Defines the interpretation of extra components in pixels.</span>
<span class="sd">            UNSPECIFIED: no transparency information (default).</span>
<span class="sd">            ASSOCALPHA: single, true transparency with pre-multiplied color.</span>
<span class="sd">            UNASSALPHA: independent transparency masks.</span>
<span class="sd">        volumetric : bool</span>
<span class="sd">            If True, the SGI ImageDepth tag is used to write volumetric data</span>
<span class="sd">            in one page. The volumetric format is not officially specified,</span>
<span class="sd">            and few software can read it. OME and ImageJ formats are not</span>
<span class="sd">            compatible with volumetric storage.</span>
<span class="sd">        tile : tuple of int</span>
<span class="sd">            The shape ([depth,] length, width) of image tiles to write.</span>
<span class="sd">            If None (default), image data are written in strips.</span>
<span class="sd">            The tile length and width must be a multiple of 16.</span>
<span class="sd">            If a tile depth is provided, the SGI ImageDepth and TileDepth</span>
<span class="sd">            tags are used to write volumetric data.</span>
<span class="sd">            Tiles cannot be used to write contiguous series, except if tile</span>
<span class="sd">            matches the data shape.</span>
<span class="sd">        contiguous : bool</span>
<span class="sd">            If False (default), write data to a new series.</span>
<span class="sd">            If True and the data and parameters are compatible with previous</span>
<span class="sd">            written ones (same shape, no compression, etc.), the image data</span>
<span class="sd">            are stored contiguously after the previous one. In that case,</span>
<span class="sd">            &#39;photometric&#39;, &#39;planarconfig&#39;, and &#39;rowsperstrip&#39; are ignored.</span>
<span class="sd">            Metadata such as &#39;description&#39;, &#39;metadata&#39;, &#39;datetime&#39;, and</span>
<span class="sd">            &#39;extratags&#39; are written to the first page of a contiguous series</span>
<span class="sd">            only. Cannot be used with the OME or ImageJ formats.</span>
<span class="sd">        truncate : bool</span>
<span class="sd">            If True, only write the first page of a contiguous series if</span>
<span class="sd">            possible (uncompressed, contiguous, not tiled).</span>
<span class="sd">            Other TIFF readers will only be able to read part of the data.</span>
<span class="sd">            Cannot be used with the OME or ImageJ formats.</span>
<span class="sd">        align : int</span>
<span class="sd">            Byte boundary on which to align the image data in the file.</span>
<span class="sd">            Default 16. Use mmap.ALLOCATIONGRANULARITY for memory-mapped data.</span>
<span class="sd">            Following contiguous writes are not aligned.</span>
<span class="sd">        rowsperstrip : int</span>
<span class="sd">            The number of rows per strip. By default, strips are ~64 KB if</span>
<span class="sd">            compression is enabled, else rowsperstrip is set to the image</span>
<span class="sd">            length.</span>
<span class="sd">        bitspersample : int</span>
<span class="sd">            Number of bits per sample. By default, this is the number of</span>
<span class="sd">            bits of the data dtype. Different values for different samples</span>
<span class="sd">            are not supported. Unsigned integer data are packed into bytes</span>
<span class="sd">            as tightly as possible. Valid values are 1-8 for uint8, 9-16 for</span>
<span class="sd">            uint16 and 17-32 for uint32. Cannot be used with compression,</span>
<span class="sd">            contiguous series, or empty files.</span>
<span class="sd">        compression : str, (str, int), (str, int, dict)</span>
<span class="sd">            If None (default), data are written uncompressed.</span>
<span class="sd">            If a str, one of TIFF.COMPRESSION, e.g. &#39;JPEG&#39; or &#39;ZSTD&#39;.</span>
<span class="sd">            If a tuple, the first item is one of TIFF.COMPRESSION, the</span>
<span class="sd">            second item is the compression level, and the third item is a dict</span>
<span class="sd">            of arguments passed to the compression codec.</span>
<span class="sd">            Compression cannot be used to write contiguous series.</span>
<span class="sd">            Compressors may require certain data shapes, types or value ranges.</span>
<span class="sd">            For example, JPEG requires grayscale or RGB(A), uint8 or 12-bit</span>
<span class="sd">            uint16. JPEG compression is experimental. JPEG markers and TIFF</span>
<span class="sd">            tags may not match.</span>
<span class="sd">            Only a limited set of compression shemes are implemented.</span>
<span class="sd">        predictor : bool or TIFF.PREDICTOR</span>
<span class="sd">            If True, apply horizontal differencing or floating-point predictor</span>
<span class="sd">            before compression. Predictors are disabled for 64-bit integers.</span>
<span class="sd">        subsampling : {(1, 1), (2, 1), (2, 2), (4, 1)}</span>
<span class="sd">            The horizontal and vertical subsampling factors used for the</span>
<span class="sd">            chrominance components of images. The default is (2, 2).</span>
<span class="sd">            Currently applies to JPEG compression of RGB images only.</span>
<span class="sd">            Images are stored in YCbCr color space.</span>
<span class="sd">            Segment widths must be a multiple of 8 times the horizontal factor.</span>
<span class="sd">            Segment lengths and rowsperstrip must be a multiple of 8 times the</span>
<span class="sd">            vertical factor.</span>
<span class="sd">        jpegtables : bytes</span>
<span class="sd">            JPEG quantization and/or Huffman tables. Use for copying</span>
<span class="sd">            pre-compressed JPEG segments.</span>
<span class="sd">        colormap : numpy.ndarray</span>
<span class="sd">            RGB color values for the corresponding data value.</span>
<span class="sd">            Must be of shape (3, 2**(data.itemsize*8)) and dtype uint16.</span>
<span class="sd">        description : str or encoded bytes</span>
<span class="sd">            The subject of the image. Must be 7-bit ASCII. Cannot be used with</span>
<span class="sd">            the ImageJ or OME formats. Written with the first page of a series</span>
<span class="sd">            only.</span>
<span class="sd">        datetime : datetime, str, or bool</span>
<span class="sd">            Date and time of image creation in &#39;%Y:%m:%d %H:%M:%S&#39; format or</span>
<span class="sd">            datetime object. Else if True, the current date and time is used.</span>
<span class="sd">            Written with the first page of a series only.</span>
<span class="sd">        resolution : (float, float[, str]) or ((int, int), (int, int)[, str])</span>
<span class="sd">            X and Y resolutions in pixels per resolution unit as float or</span>
<span class="sd">            rational numbers. A third, optional parameter specifies the</span>
<span class="sd">            resolution unit, which must be None (default for ImageJ),</span>
<span class="sd">            &#39;INCH&#39; (default), or &#39;CENTIMETER&#39;.</span>
<span class="sd">        subfiletype : int</span>
<span class="sd">            Bitfield to indicate the kind of data. Set bit 0 if the image</span>
<span class="sd">            is a reduced-resolution version of another image. Set bit 1 if</span>
<span class="sd">            the image is part of a multi-page image. Set bit 2 if the image</span>
<span class="sd">            is transparency mask for another image (photometric must be</span>
<span class="sd">            MASK, SamplesPerPixel and BitsPerSample must be 1).</span>
<span class="sd">        software : str or bool</span>
<span class="sd">            Name of the software used to create the file.</span>
<span class="sd">            If None (default), &#39;tifffile.py&#39;. Must be 7-bit ASCII.</span>
<span class="sd">            Written with the first page of a series only.</span>
<span class="sd">        subifds : int</span>
<span class="sd">            Number of child IFDs. If greater than 0, the following &#39;subifds&#39;</span>
<span class="sd">            number of series are written as child IFDs of the current</span>
<span class="sd">            series. The number of IFDs written for each SubIFD level must match</span>
<span class="sd">            the number of IFDs written for the current series. All pages</span>
<span class="sd">            written to a certain SubIFD level of the current series must have</span>
<span class="sd">            the same hash. SubIFDs cannot be used with truncated or ImageJ</span>
<span class="sd">            files. SubIFDs in OME-TIFF files must be sub-resolutions of the</span>
<span class="sd">            main IFDs.</span>
<span class="sd">        metadata : dict</span>
<span class="sd">            Additional metadata describing the image data, written along with</span>
<span class="sd">            shape information in JSON, OME-XML, or ImageJ formats in</span>
<span class="sd">            ImageDescription or IJMetadata tags.</span>
<span class="sd">            If None, do not write an ImageDescription tag with shape in JSON</span>
<span class="sd">            format.</span>
<span class="sd">            If ImageJ format, values for keys &#39;Info&#39;, &#39;Labels&#39;, &#39;Ranges&#39;,</span>
<span class="sd">            &#39;LUTs&#39;, &#39;Plot&#39;, &#39;ROI&#39;, and &#39;Overlays&#39; are written in IJMetadata and</span>
<span class="sd">            IJMetadataByteCounts tags. Refer to the imagej_metadata_tag</span>
<span class="sd">            function for valid values.</span>
<span class="sd">            Refer to the OmeXml class for supported keys when writing OME-TIFF.</span>
<span class="sd">            Strings must be 7-bit ASCII.</span>
<span class="sd">            Written with the first page of a series only.</span>
<span class="sd">        extratags : sequence of tuples</span>
<span class="sd">            Additional tags as [(code, dtype, count, value, writeonce)].</span>

<span class="sd">            code : int</span>
<span class="sd">                The TIFF tag Id.</span>
<span class="sd">            dtype : int or str</span>
<span class="sd">                Data type of items in &#39;value&#39;. One of TIFF.DATATYPES.</span>
<span class="sd">            count : int</span>
<span class="sd">                Number of data values. Not used for string or bytes values.</span>
<span class="sd">            value : sequence</span>
<span class="sd">                &#39;Count&#39; values compatible with &#39;dtype&#39;.</span>
<span class="sd">                Bytes must contain count values of dtype packed as binary data.</span>
<span class="sd">            writeonce : bool</span>
<span class="sd">                If True, the tag is written to the first page of a series only.</span>

<span class="sd">        returnoffset : bool</span>
<span class="sd">            If True and the image data in the file are memory-mappable, return</span>
<span class="sd">            the offset and number of bytes of the image data in the file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        offset, bytecount : tuple or None</span>
<span class="sd">            If &#39;returnoffset&#39; is true and the image data in the file are</span>
<span class="sd">            memory-mappable, return the offset and number of bytes of the</span>
<span class="sd">            image data in the file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: refactor this function</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span>
        <span class="n">byteorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span><span class="o">.</span><span class="n">byteorder</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># empty</span>
            <span class="n">dataiter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">datashape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">datadtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(</span><span class="n">byteorder</span><span class="p">)</span>
            <span class="n">datadtypechar</span> <span class="o">=</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">char</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># iterable pages or tiles</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;__next__&#39;</span><span class="p">):</span>
                <span class="n">dataiter</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dataiter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">datashape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">datadtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(</span><span class="n">byteorder</span><span class="p">)</span>
            <span class="n">datadtypechar</span> <span class="o">=</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">char</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;__next__&#39;</span><span class="p">):</span>
            <span class="c1"># generator</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;generators require &#39;shape&#39; and &#39;dtype&#39; parameters&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># whole image data</span>
            <span class="c1"># must be C-contiguous numpy array of TIFF byteorder</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">datadtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(</span><span class="n">byteorder</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">datadtype</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s2"> ignoring &#39;dtype&#39; argument&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">shape</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s2"> ignoring &#39;shape&#39; argument&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span>
                <span class="p">)</span>
            <span class="n">dataiter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">datashape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">datadtype</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span>
            <span class="n">datadtypechar</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span>

        <span class="n">returnoffset</span> <span class="o">=</span> <span class="n">returnoffset</span> <span class="ow">and</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">isnative</span>

        <span class="k">if</span> <span class="n">compression</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">compress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO: remove</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;&lt;tifffile.TiffWriter.write&gt; the &#39;compress&#39; parameter is &quot;</span>
                <span class="s2">&quot;deprecated since 2020.9.30. Use the &#39;compression&#39; parameter&quot;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compress</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">))</span> <span class="ow">and</span> <span class="n">compress</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># ADOBE_DEFLATE</span>
                <span class="n">compression</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">compress</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">compress</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;invalid compression level </span><span class="si">{</span><span class="n">compress</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">compression</span> <span class="o">=</span> <span class="n">compress</span>
            <span class="k">del</span> <span class="n">compress</span>

        <span class="n">bilevel</span> <span class="o">=</span> <span class="n">datadtypechar</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span>
        <span class="k">if</span> <span class="n">bilevel</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">datashape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">2</span>
            <span class="n">datasize</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">datashape</span><span class="p">[:</span><span class="n">index</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">datashape</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">%</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">datasize</span> <span class="o">*=</span> <span class="n">datashape</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">//</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">datasize</span> <span class="o">*=</span> <span class="n">datashape</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">//</span> <span class="mi">8</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">datasize</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">datashape</span><span class="p">)</span> <span class="o">*</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span>

        <span class="k">if</span> <span class="n">datasize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">compression</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">bitspersample</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">truncate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">compression</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;NONE&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">):</span>
            <span class="n">compression</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">inputshape</span> <span class="o">=</span> <span class="n">datashape</span>

        <span class="n">packints</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">bitspersample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">bitspersample</span> <span class="o">!=</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="p">)</span>

        <span class="c1"># just append contiguous data if possible</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">contiguous</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">datashape</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datadtype</span> <span class="o">!=</span> <span class="n">datadtype</span>
                <span class="ow">or</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colormap</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="c1"># incompatible shape, dtype, or colormap</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_remaining_pages</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;the ImageJ format does not support &#39;</span>
                        <span class="s1">&#39;non-contiguous series&#39;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ome</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subifdslevel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># add image to OME-XML</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ome</span><span class="o">.</span><span class="n">addimage</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_datadtype</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span><span class="p">[</span>
                                <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span> <span class="p">:</span>
                            <span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_storedshape</span><span class="p">,</span>
                            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_image_description</span><span class="p">()</span>
                    <span class="c1"># description might have been appended to file</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subifds</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span> <span class="ow">or</span> <span class="n">truncate</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s1">&#39;SubIFDs cannot be used with truncated series&#39;</span>
                        <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_subifdslevel</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subifdslevel</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subifds</span><span class="p">:</span>
                        <span class="c1"># done with writing SubIFDs</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_nextifdoffsets</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_subifdsoffsets</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_subifdslevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_subifds</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ifdindex</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="n">subifds</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s1">&#39;SubIFDs in SubIFDs are not supported&#39;</span>
                        <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_colormap</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">elif</span> <span class="n">compression</span> <span class="ow">or</span> <span class="n">packints</span> <span class="ow">or</span> <span class="n">tile</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;contiguous cannot be used with compression, tiles, etc.&#39;</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># consecutive mode</span>
                <span class="c1"># write contiguous data, write IFDs/tags later</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">datashape</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write_empty</span><span class="p">(</span><span class="n">datasize</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">returnoffset</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">offset</span><span class="p">,</span> <span class="n">datasize</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ome</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ome</span> <span class="o">=</span> <span class="s1">&#39;.ome.tif&#39;</span> <span class="ow">in</span> <span class="n">fh</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ome</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ome</span> <span class="k">else</span> <span class="nb">bool</span><span class="p">(</span><span class="n">truncate</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span> <span class="ow">and</span> <span class="p">(</span><span class="n">compression</span> <span class="ow">or</span> <span class="n">packints</span> <span class="ow">or</span> <span class="n">tile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;truncate cannot be used with compression, packints, or tiles&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">datasize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># write single placeholder TiffPage for arrays with size=0</span>
            <span class="n">datashape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> writing zero size array to nonconformant TIFF&#39;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># TODO: reconsider this</span>
            <span class="c1"># raise ValueError(&#39;cannot save zero size array&#39;)</span>

        <span class="n">valueformat</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tiff</span><span class="o">.</span><span class="n">offsetsize</span><span class="si">}</span><span class="s1">s&#39;</span>
        <span class="n">tagnoformat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span><span class="o">.</span><span class="n">tagnoformat</span>
        <span class="n">offsetformat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span><span class="o">.</span><span class="n">offsetformat</span>
        <span class="n">offsetsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span><span class="o">.</span><span class="n">offsetsize</span>
        <span class="n">tagsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span><span class="o">.</span><span class="n">tagsize</span>

        <span class="n">MINISBLACK</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">MINISBLACK</span>
        <span class="n">MINISWHITE</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">MINISWHITE</span>
        <span class="n">RGB</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">RGB</span>
        <span class="n">YCBCR</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">YCBCR</span>
        <span class="n">PALETTE</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">PALETTE</span>
        <span class="n">CONTIG</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PLANARCONFIG</span><span class="o">.</span><span class="n">CONTIG</span>
        <span class="n">SEPARATE</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PLANARCONFIG</span><span class="o">.</span><span class="n">SEPARATE</span>

        <span class="c1"># parse input</span>
        <span class="k">if</span> <span class="n">photometric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">photometric</span> <span class="o">=</span> <span class="n">enumarg</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="p">,</span> <span class="n">photometric</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">planarconfig</span><span class="p">:</span>
            <span class="n">planarconfig</span> <span class="o">=</span> <span class="n">enumarg</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">PLANARCONFIG</span><span class="p">,</span> <span class="n">planarconfig</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">predictor</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">predictor</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">enumarg</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">PREDICTOR</span><span class="p">,</span> <span class="n">predictor</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">extrasamples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extrasamples_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extrasamples_</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">enumarg</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">EXTRASAMPLE</span><span class="p">,</span> <span class="n">es</span><span class="p">)</span> <span class="k">for</span> <span class="n">es</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">(</span><span class="n">extrasamples</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">compression</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compression</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compression</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">compressionargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">compression</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">compressionargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">compression</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">compression</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">compressionargs</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compression</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">compression</span> <span class="o">=</span> <span class="n">compression</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">compressionargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compression</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">compression</span> <span class="o">=</span> <span class="n">compression</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">compression</span> <span class="o">==</span> <span class="s1">&#39;ZLIB&#39;</span><span class="p">:</span>
                    <span class="n">compression</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># ADOBE_DEFLATE</span>
            <span class="n">compressiontag</span> <span class="o">=</span> <span class="n">enumarg</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">COMPRESSION</span><span class="p">,</span> <span class="n">compression</span><span class="p">)</span>
            <span class="n">compression</span> <span class="o">=</span> <span class="n">compressiontag</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compression</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">compressiontag</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">compression</span><span class="p">:</span>
            <span class="n">compressionargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">predictor</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">predictortag</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">predictor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">compressiontag</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="mi">7</span><span class="p">,</span>
                <span class="mi">33003</span><span class="p">,</span>
                <span class="mi">33004</span><span class="p">,</span>
                <span class="mi">33005</span><span class="p">,</span>
                <span class="mi">33007</span><span class="p">,</span>
                <span class="mi">34712</span><span class="p">,</span>
                <span class="mi">34892</span><span class="p">,</span>
                <span class="mi">34933</span><span class="p">,</span>
                <span class="mi">34934</span><span class="p">,</span>
                <span class="mi">50001</span><span class="p">,</span>
                <span class="mi">50002</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="c1"># disable predictor for JPEG, JPEG2000, WEBP, PNG, JPEGXR</span>
                <span class="n">predictor</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s1">&#39;iu&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">predictor</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># disable predictor for 64 bit</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">predictortag</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="n">predictor</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PREDICTORS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
                <span class="n">predictortag</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="n">predictor</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PREDICTORS</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cannot apply predictor to </span><span class="si">{</span><span class="n">datadtype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ome</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> not writing description to OME-TIFF&#39;</span><span class="p">,</span>
                    <span class="ne">UserWarning</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ome</span><span class="p">,</span> <span class="n">OmeXml</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ome</span> <span class="o">=</span> <span class="n">OmeXml</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">volumetric</span> <span class="ow">or</span> <span class="p">(</span><span class="n">tile</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;OME-TIFF does not support ImageDepth&#39;</span><span class="p">)</span>
            <span class="n">volumetric</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
            <span class="c1"># if tile is not None or predictor or compression:</span>
            <span class="c1">#     warnings.warn(</span>
            <span class="c1">#         f&#39;{self!r} the ImageJ format does not support &#39;</span>
            <span class="c1">#         &#39;tiles, predictors, compression&#39;</span>
            <span class="c1">#     )</span>
            <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> not writing description to ImageJ file&#39;</span><span class="p">,</span>
                    <span class="ne">UserWarning</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">datadtypechar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;BHhf&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;the ImageJ format does not support data type &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">datadtypechar</span><span class="si">!r}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">volumetric</span> <span class="ow">or</span> <span class="p">(</span><span class="n">tile</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;the ImageJ format does not support ImageDepth&#39;</span>
                <span class="p">)</span>
            <span class="n">volumetric</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ijrgb</span> <span class="o">=</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">RGB</span> <span class="k">if</span> <span class="n">photometric</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">datadtypechar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span>
                <span class="n">ijrgb</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ijshape</span> <span class="o">=</span> <span class="n">imagej_shape</span><span class="p">(</span>
                <span class="n">datashape</span><span class="p">,</span> <span class="n">ijrgb</span><span class="p">,</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">ijshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="n">photometric</span> <span class="o">=</span> <span class="n">RGB</span>
                <span class="k">if</span> <span class="n">datadtypechar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;the ImageJ format does not support &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;data type </span><span class="si">{</span><span class="n">datadtypechar</span><span class="si">!r}</span><span class="s1"> for RGB&#39;</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">photometric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">photometric</span> <span class="o">=</span> <span class="n">MINISBLACK</span>
                <span class="n">planarconfig</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">planarconfig</span> <span class="o">==</span> <span class="n">SEPARATE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;the ImageJ format does not support planar images&#39;</span>
                <span class="p">)</span>
            <span class="n">planarconfig</span> <span class="o">=</span> <span class="n">CONTIG</span> <span class="k">if</span> <span class="n">ijrgb</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># verify colormap and indices</span>
        <span class="k">if</span> <span class="n">colormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">datadtypechar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;BH&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid data dtype for palette mode&#39;</span><span class="p">)</span>
            <span class="n">colormap</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;H&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">colormap</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid color map shape&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_colormap</span> <span class="o">=</span> <span class="n">colormap</span>

        <span class="k">if</span> <span class="n">tile</span><span class="p">:</span>
            <span class="c1"># verify tile shape</span>
            <span class="n">tile</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tile</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span>
                <span class="ow">or</span> <span class="n">tile</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="mi">16</span>
                <span class="ow">or</span> <span class="n">tile</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">%</span> <span class="mi">16</span>
                <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tile</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid tile shape&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">volumetric</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">tile</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">tile</span>
            <span class="n">volumetric</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tile</span> <span class="o">=</span> <span class="p">()</span>
            <span class="n">volumetric</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">volumetric</span><span class="p">)</span>

        <span class="c1"># normalize data shape to 5D or 6D, depending on volume:</span>
        <span class="c1">#   (pages, separate_samples, [depth,] length, width, contig_samples)</span>
        <span class="n">storedshape</span> <span class="o">=</span> <span class="n">reshape_nd</span><span class="p">(</span>
            <span class="n">datashape</span><span class="p">,</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC_SAMPLES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">photometric</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">storedshape</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">storedshape</span><span class="p">)</span>

        <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">extrasamples</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">volumetric</span> <span class="ow">and</span> <span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">volumetric</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">colormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">photometric</span> <span class="o">=</span> <span class="n">PALETTE</span>
            <span class="n">planarconfig</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">photometric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">deprecate</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">photometric</span> <span class="o">=</span> <span class="n">MINISBLACK</span>
            <span class="k">if</span> <span class="n">bilevel</span><span class="p">:</span>
                <span class="n">photometric</span> <span class="o">=</span> <span class="n">MINISWHITE</span>
            <span class="k">elif</span> <span class="n">planarconfig</span> <span class="o">==</span> <span class="n">CONTIG</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                    <span class="n">photometric</span> <span class="o">=</span> <span class="n">RGB</span>
                    <span class="n">deprecate</span> <span class="o">=</span> <span class="n">datadtypechar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;BH&#39;</span>
            <span class="k">elif</span> <span class="n">planarconfig</span> <span class="o">==</span> <span class="n">SEPARATE</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">volumetric</span> <span class="ow">and</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                    <span class="n">photometric</span> <span class="o">=</span> <span class="n">RGB</span>
                    <span class="n">deprecate</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                    <span class="n">photometric</span> <span class="o">=</span> <span class="n">RGB</span>
                    <span class="n">deprecate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="n">photometric</span> <span class="o">=</span> <span class="n">RGB</span>
                <span class="n">planarconfig</span> <span class="o">=</span> <span class="n">CONTIG</span>
                <span class="n">deprecate</span> <span class="o">=</span> <span class="n">datadtypechar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;BH&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ome</span><span class="p">:</span>
                <span class="n">photometric</span> <span class="o">=</span> <span class="n">MINISBLACK</span>
                <span class="n">planarconfig</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">volumetric</span> <span class="ow">and</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="n">photometric</span> <span class="o">=</span> <span class="n">RGB</span>
                <span class="n">planarconfig</span> <span class="o">=</span> <span class="n">SEPARATE</span>
                <span class="n">deprecate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="n">photometric</span> <span class="o">=</span> <span class="n">RGB</span>
                <span class="n">planarconfig</span> <span class="o">=</span> <span class="n">SEPARATE</span>
                <span class="n">deprecate</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">deprecate</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">planarconfig</span> <span class="o">==</span> <span class="n">CONTIG</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;contiguous samples&#39;</span><span class="p">,</span> <span class="s2">&quot;parameter is&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s1">&#39;separate component planes&#39;</span><span class="p">,</span>
                        <span class="s2">&quot;and &#39;planarconfig&#39; parameters are&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&lt;tifffile.TiffWriter.write&gt; data with shape </span><span class="si">{</span><span class="n">datashape</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;and dtype &#39;</span><span class="si">{</span><span class="n">datadtype</span><span class="si">}</span><span class="s2">&#39; are stored as RGB with </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="s2">&quot; Future versions will store such data as MINISBLACK in &quot;</span>
                    <span class="s2">&quot;separate pages by default unless the &#39;photometric&#39; &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> specified.&quot;</span><span class="p">,</span>
                    <span class="ne">DeprecationWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">del</span> <span class="n">msg</span>
            <span class="k">del</span> <span class="n">deprecate</span>

        <span class="k">del</span> <span class="n">datashape</span>
        <span class="n">photometricsamples</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC_SAMPLES</span><span class="p">[</span><span class="n">photometric</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">planarconfig</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">3</span> <span class="k">if</span> <span class="n">volumetric</span> <span class="k">else</span> <span class="mi">2</span><span class="p">):</span>
            <span class="c1"># TODO: raise error?</span>
            <span class="n">planarconfig</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">photometricsamples</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">photometric</span> <span class="o">=</span> <span class="n">MINISBLACK</span>

        <span class="k">if</span> <span class="n">photometricsamples</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;not a </span><span class="si">{</span><span class="n">photometric</span><span class="si">!r}</span><span class="s1"> image&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">volumetric</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">planarconfig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">RGB</span><span class="p">:</span>
                    <span class="n">samples_</span> <span class="o">=</span> <span class="p">(</span><span class="n">photometricsamples</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># allow common alpha</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">samples_</span> <span class="o">=</span> <span class="p">(</span><span class="n">photometricsamples</span><span class="p">,)</span>
                <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">samples_</span><span class="p">:</span>
                    <span class="n">planarconfig</span> <span class="o">=</span> <span class="n">CONTIG</span>
                <span class="k">elif</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span> <span class="k">if</span> <span class="n">volumetric</span> <span class="k">else</span> <span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="n">samples_</span><span class="p">:</span>
                    <span class="n">planarconfig</span> <span class="o">=</span> <span class="n">SEPARATE</span>
                <span class="k">elif</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span> <span class="k">if</span> <span class="n">volumetric</span> <span class="k">else</span> <span class="o">-</span><span class="mi">3</span><span class="p">]:</span>
                    <span class="c1"># TODO: deprecated this?</span>
                    <span class="n">planarconfig</span> <span class="o">=</span> <span class="n">SEPARATE</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">planarconfig</span> <span class="o">=</span> <span class="n">CONTIG</span>
            <span class="k">if</span> <span class="n">planarconfig</span> <span class="o">==</span> <span class="n">CONTIG</span><span class="p">:</span>
                <span class="n">storedshape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[(</span><span class="o">-</span><span class="mi">4</span> <span class="k">if</span> <span class="n">volumetric</span> <span class="k">else</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="p">:]</span>
                <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">storedshape</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[(</span><span class="o">-</span><span class="mi">4</span> <span class="k">if</span> <span class="n">volumetric</span> <span class="k">else</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="p">:]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
                <span class="p">)</span>
                <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">samplesperpixel</span> <span class="o">&gt;</span> <span class="n">photometricsamples</span><span class="p">:</span>
                <span class="n">extrasamples</span> <span class="o">=</span> <span class="n">samplesperpixel</span> <span class="o">-</span> <span class="n">photometricsamples</span>

        <span class="k">elif</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">CFA</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid CFA image&#39;</span><span class="p">)</span>
            <span class="n">volumetric</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">planarconfig</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">storedshape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
            <span class="c1"># if all(et[0] != 50706 for et in extratags):</span>
            <span class="c1">#     raise ValueError(&#39;must specify DNG tags for CFA image&#39;)</span>

        <span class="k">elif</span> <span class="n">planarconfig</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span> <span class="k">if</span> <span class="n">volumetric</span> <span class="k">else</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">planarconfig</span> <span class="o">==</span> <span class="n">CONTIG</span><span class="p">:</span>
                <span class="n">storedshape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[(</span><span class="o">-</span><span class="mi">4</span> <span class="k">if</span> <span class="n">volumetric</span> <span class="k">else</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="p">:]</span>
                <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">storedshape</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[(</span><span class="o">-</span><span class="mi">4</span> <span class="k">if</span> <span class="n">volumetric</span> <span class="k">else</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="p">:]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
                <span class="p">)</span>
                <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">extrasamples</span> <span class="o">=</span> <span class="n">samplesperpixel</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">planarconfig</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># remove trailing 1s</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">volumetric</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">extrasamples_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">storedshape</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[(</span><span class="o">-</span><span class="mi">3</span> <span class="k">if</span> <span class="n">volumetric</span> <span class="k">else</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="p">:]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">storedshape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[(</span><span class="o">-</span><span class="mi">4</span> <span class="k">if</span> <span class="n">volumetric</span> <span class="k">else</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="p">:]</span>
                <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">extrasamples</span> <span class="o">=</span> <span class="n">samplesperpixel</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">subfiletype</span> <span class="o">&amp;</span> <span class="mb">0b100</span><span class="p">:</span>
            <span class="c1"># FILETYPE_MASK</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="n">bilevel</span> <span class="ow">and</span> <span class="n">samplesperpixel</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">photometric</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid SubfileType MASK&#39;</span><span class="p">)</span>
            <span class="n">photometric</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">MASK</span>

        <span class="n">packints</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">bilevel</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bitspersample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bitspersample</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;bitspersample </span><span class="si">{</span><span class="n">bitspersample</span><span class="si">}</span><span class="s1"> must be 1 for bilevel&#39;</span>
                <span class="p">)</span>
            <span class="n">bitspersample</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">compressiontag</span> <span class="o">==</span> <span class="mi">7</span> <span class="ow">and</span> <span class="n">datadtype</span> <span class="o">==</span> <span class="s1">&#39;uint16&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bitspersample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bitspersample</span> <span class="o">!=</span> <span class="mi">12</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;bitspersample </span><span class="si">{</span><span class="n">bitspersample</span><span class="si">}</span><span class="s1"> must be 12 for JPEG &#39;</span>
                    <span class="s1">&#39;compressed uint16&#39;</span>
                <span class="p">)</span>
            <span class="n">bitspersample</span> <span class="o">=</span> <span class="mi">12</span>  <span class="c1"># use 12-bit JPEG compression</span>
        <span class="k">elif</span> <span class="n">bitspersample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bitspersample</span> <span class="o">=</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">datadtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s1">&#39;u&#39;</span> <span class="ow">or</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">&gt;</span> <span class="mi">4</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="n">bitspersample</span> <span class="o">!=</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;bitspersample </span><span class="si">{</span><span class="n">bitspersample</span><span class="si">}</span><span class="s1"> does not match &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;dtype </span><span class="si">{</span><span class="n">datadtype</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">bitspersample</span> <span class="o">&gt;</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">16</span><span class="p">}[</span><span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">bitspersample</span> <span class="o">&lt;=</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;bitspersample </span><span class="si">{</span><span class="n">bitspersample</span><span class="si">}</span><span class="s1"> out of range of &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;dtype </span><span class="si">{</span><span class="n">datadtype</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">compression</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bitspersample</span> <span class="o">!=</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;bitspersample </span><span class="si">{</span><span class="n">bitspersample</span><span class="si">}</span><span class="s1"> cannot be used with &#39;</span>
                    <span class="s1">&#39;compression&#39;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">bitspersample</span> <span class="o">!=</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">packints</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># normalize storedshape to 6D</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">storedshape</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;length of storedshape </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">storedshape</span><span class="p">)</span><span class="si">}</span><span class="s1"> not in (5, 6)&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">storedshape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">storedshape</span> <span class="o">=</span> <span class="n">storedshape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">storedshape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">s0</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">product</span><span class="p">(</span><span class="n">inputshape</span><span class="p">)</span> <span class="o">//</span> <span class="n">s0</span>
            <span class="n">storedshape</span> <span class="o">=</span> <span class="p">(</span><span class="n">s0</span><span class="p">,)</span> <span class="o">+</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">storedshape</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># data is None or iterator</span>

        <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">PALETTE</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">samplesperpixel</span> <span class="o">!=</span> <span class="mi">1</span>
                <span class="ow">or</span> <span class="n">extrasamples</span>
                <span class="ow">or</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span>
                <span class="ow">or</span> <span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid data shape for palette mode&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">RGB</span> <span class="ow">and</span> <span class="n">samplesperpixel</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not a RGB image (samplesperpixel=2)&#39;</span><span class="p">)</span>

        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of (code, ifdentry, ifdvalue, writeonce)</span>

        <span class="k">if</span> <span class="n">tile</span><span class="p">:</span>
            <span class="n">tagbytecounts</span> <span class="o">=</span> <span class="mi">325</span>  <span class="c1"># TileByteCounts</span>
            <span class="n">tagoffsets</span> <span class="o">=</span> <span class="mi">324</span>  <span class="c1"># TileOffsets</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tagbytecounts</span> <span class="o">=</span> <span class="mi">279</span>  <span class="c1"># StripByteCounts</span>
            <span class="n">tagoffsets</span> <span class="o">=</span> <span class="mi">273</span>  <span class="c1"># StripOffsets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataoffsetstag</span> <span class="o">=</span> <span class="n">tagoffsets</span>

        <span class="k">def</span> <span class="nf">pack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;&lt;&gt;&#39;</span><span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="n">byteorder</span> <span class="o">+</span> <span class="n">fmt</span>
            <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">addtag</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">writeonce</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># compute ifdentry &amp; ifdvalue bytes from code, dtype, count, value</span>
            <span class="c1"># append (code, ifdentry, ifdvalue, writeonce) to tags list</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAGS</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">datatype</span> <span class="o">=</span> <span class="n">dtype</span>
                <span class="n">dataformat</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DATA_FORMATS</span><span class="p">[</span><span class="n">datatype</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dataformat</span> <span class="o">=</span> <span class="n">dtype</span>
                    <span class="k">if</span> <span class="n">dataformat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;&lt;&gt;&#39;</span><span class="p">:</span>
                        <span class="n">dataformat</span> <span class="o">=</span> <span class="n">dataformat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">datatype</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DATA_DTYPES</span><span class="p">[</span><span class="n">dataformat</span><span class="p">]</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unknown dtype </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
            <span class="k">del</span> <span class="n">dtype</span>

            <span class="n">rawcount</span> <span class="o">=</span> <span class="n">count</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># string</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="c1"># enforce 7-bit ASCII on Unicode strings</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">UnicodeEncodeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s1">&#39;TIFF strings must be 7-bit ASCII&#39;</span>
                        <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;TIFF strings must be 7-bit ASCII&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span>
                <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">270</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_descriptiontag</span> <span class="o">=</span> <span class="n">TiffTag</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>
                    <span class="p">)</span>
                    <span class="n">rawcount</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">rawcount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">rawcount</span> <span class="o">=</span> <span class="n">count</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># length of string without buffer</span>
                        <span class="n">rawcount</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">offsetsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rawcount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">rawcount</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">rawcount</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rawcount</span> <span class="o">=</span> <span class="n">count</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="c1"># packed binary data</span>
                <span class="n">itemsize</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">dataformat</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">%</span> <span class="n">itemsize</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid packed binary data&#39;</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">//</span> <span class="n">itemsize</span>
                <span class="n">rawcount</span> <span class="o">=</span> <span class="n">count</span>

            <span class="k">if</span> <span class="n">datatype</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>  <span class="c1"># rational</span>
                <span class="n">count</span> <span class="o">*=</span> <span class="mi">2</span>
                <span class="n">dataformat</span> <span class="o">=</span> <span class="n">dataformat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">ifdentry</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;HH&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">datatype</span><span class="p">),</span>
                <span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">rawcount</span><span class="p">),</span>
            <span class="p">]</span>

            <span class="n">ifdvalue</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">dataformat</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">offsetsize</span><span class="p">:</span>
                <span class="c1"># value(s) can be written directly</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">ifdentry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">valueformat</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ifdentry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">valueformat</span><span class="p">,</span> <span class="n">pack</span><span class="p">(</span><span class="n">dataformat</span><span class="p">,</span> <span class="n">value</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ifdentry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">pack</span><span class="p">(</span><span class="n">valueformat</span><span class="p">,</span> <span class="n">pack</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">count</span><span class="si">}{</span><span class="n">dataformat</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">))</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># use offset to value(s)</span>
                <span class="n">ifdentry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">ifdvalue</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">count</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;value.size != count&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="o">!=</span> <span class="n">dataformat</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;value.dtype.char != dtype&#39;</span><span class="p">)</span>
                    <span class="n">ifdvalue</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">ifdvalue</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">count</span><span class="si">}{</span><span class="n">dataformat</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ifdvalue</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="n">dataformat</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">code</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ifdentry</span><span class="p">),</span> <span class="n">ifdvalue</span><span class="p">,</span> <span class="n">writeonce</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">rational</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
            <span class="c1"># return numerator and denominator from float or two integers</span>
            <span class="kn">from</span> <span class="nn">fractions</span> <span class="kn">import</span> <span class="n">Fraction</span>  <span class="c1"># delayed import</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">Fraction</span><span class="o">.</span><span class="n">from_float</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">numerator</span><span class="p">,</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">as_integer_ratio</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c1"># Python 3.7</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="mi">4294967294</span><span class="p">)</span>
                <span class="n">numerator</span><span class="p">,</span> <span class="n">denominator</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">denominator</span>
            <span class="k">if</span> <span class="n">numerator</span> <span class="o">&gt;</span> <span class="mi">4294967295</span> <span class="ow">or</span> <span class="n">denominator</span> <span class="o">&gt;</span> <span class="mi">4294967295</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="mi">4294967295</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">numerator</span><span class="p">,</span> <span class="n">denominator</span><span class="p">)</span>
                <span class="n">numerator</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">numerator</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span>
                <span class="n">denominator</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">denominator</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">numerator</span><span class="p">,</span> <span class="n">denominator</span>

        <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># ImageDescription: user provided description</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">270</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">writeonce</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># write shape and metadata to ImageDescription</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span> <span class="k">else</span> <span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ome</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ome</span><span class="o">.</span><span class="n">images</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># rewritten later at end of file</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ijmetadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ijmetadata</span> <span class="o">=</span> <span class="n">parse_kwargs</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">,</span>
                    <span class="s1">&#39;Info&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Labels&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Ranges&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;LUTs&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Plot&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ROI&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Overlays&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Properties&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;info&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;labels&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ranges&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;luts&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;plot&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;roi&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;overlays&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;prop&#39;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: remove</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s1">&#39;&lt;tifffile.TiffWriter.write&gt; &#39;</span>
                    <span class="s2">&quot;the &#39;ijmetadata&#39; parameter is deprecated since 2020.5.5. &quot;</span>
                    <span class="s2">&quot;Use the &#39;metadata&#39; parameter&quot;</span><span class="p">,</span>
                    <span class="ne">DeprecationWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">imagej_metadata_tag</span><span class="p">(</span><span class="n">ijmetadata</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
                <span class="n">addtag</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">imagej_description</span><span class="p">(</span>
                <span class="n">inputshape</span><span class="p">,</span>
                <span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_colormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">description</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">64</span>  <span class="c1"># add buffer for in-place update</span>
        <span class="k">elif</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="n">metadata</span> <span class="o">==</span> <span class="p">{}:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">truncated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">json_description</span><span class="p">(</span><span class="n">inputshape</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">16</span>  <span class="c1"># add buffer for in-place update</span>
        <span class="c1"># elif metadata is None and self._truncate:</span>
        <span class="c1">#     raise ValueError(&#39;cannot truncate without writing metadata&#39;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">270</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">writeonce</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">description</span>

        <span class="k">if</span> <span class="n">software</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;tifffile.py&#39;</span>
        <span class="k">if</span> <span class="n">software</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">305</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">software</span><span class="p">,</span> <span class="n">writeonce</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datetime</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datetime</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">19</span> <span class="ow">or</span> <span class="n">datetime</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;:&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid datetime string&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y:%m:</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">datetime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y:%m:</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">306</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">writeonce</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">addtag</span><span class="p">(</span><span class="mi">259</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">compressiontag</span><span class="p">)</span>  <span class="c1"># Compression</span>
        <span class="k">if</span> <span class="n">compressiontag</span> <span class="o">==</span> <span class="mi">34887</span><span class="p">:</span>
            <span class="c1"># LERC without additional compression</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">50674</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">predictor</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">317</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">predictortag</span><span class="p">)</span>
        <span class="n">addtag</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># ImageWidth</span>
        <span class="n">addtag</span><span class="p">(</span><span class="mi">257</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># ImageLength</span>
        <span class="k">if</span> <span class="n">tile</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">322</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tile</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># TileWidth</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">323</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tile</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># TileLength</span>
        <span class="k">if</span> <span class="n">volumetric</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">32997</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>  <span class="c1"># ImageDepth</span>
            <span class="k">if</span> <span class="n">tile</span><span class="p">:</span>
                <span class="n">addtag</span><span class="p">(</span><span class="mi">32998</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># TileDepth</span>
        <span class="k">if</span> <span class="n">subfiletype</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">254</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">subfiletype</span><span class="p">)</span>  <span class="c1"># NewSubfileType</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">subifds</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subifds</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subifdslevel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subifds</span><span class="p">:</span>
                <span class="n">subifds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subifds</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_subifds</span> <span class="o">=</span> <span class="n">subifds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">subifds</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="c1"># allow TiffPage.subifds tuple</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_subifds</span> <span class="o">=</span> <span class="n">subifds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subifds</span><span class="p">)</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">330</span><span class="p">,</span> <span class="mi">18</span> <span class="k">if</span> <span class="n">offsetsize</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="k">else</span> <span class="mi">13</span><span class="p">,</span> <span class="n">subifds</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">subifds</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bilevel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;u&#39;</span><span class="p">:</span>
            <span class="n">sampleformat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">}[</span><span class="n">datadtype</span><span class="o">.</span><span class="n">kind</span><span class="p">]</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">339</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">samplesperpixel</span><span class="p">,</span> <span class="p">(</span><span class="n">sampleformat</span><span class="p">,)</span> <span class="o">*</span> <span class="n">samplesperpixel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">colormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">320</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">colormap</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">colormap</span><span class="p">)</span>
        <span class="n">addtag</span><span class="p">(</span><span class="mi">277</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">samplesperpixel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bilevel</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">planarconfig</span> <span class="ow">and</span> <span class="n">samplesperpixel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">284</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">planarconfig</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># PlanarConfiguration</span>
            <span class="n">addtag</span><span class="p">(</span>  <span class="c1"># BitsPerSample</span>
                <span class="mi">258</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">samplesperpixel</span><span class="p">,</span> <span class="p">(</span><span class="n">bitspersample</span><span class="p">,)</span> <span class="o">*</span> <span class="n">samplesperpixel</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">258</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bitspersample</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extrasamples</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">extrasamples_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">extrasamples</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">extrasamples_</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;wrong number of extrasamples &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">extrasamples</span><span class="si">}</span><span class="s1"> != </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">extrasamples_</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                <span class="n">addtag</span><span class="p">(</span><span class="mi">338</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">extrasamples</span><span class="p">,</span> <span class="n">extrasamples_</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">RGB</span> <span class="ow">and</span> <span class="n">extrasamples</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Unassociated alpha channel</span>
                <span class="n">addtag</span><span class="p">(</span><span class="mi">338</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Unspecified alpha channel</span>
                <span class="n">addtag</span><span class="p">(</span><span class="mi">338</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">extrasamples</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="n">extrasamples</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">jpegtables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">347</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jpegtables</span><span class="p">),</span> <span class="n">jpegtables</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">compressiontag</span> <span class="o">==</span> <span class="mi">7</span>
            <span class="ow">and</span> <span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="n">photometric</span> <span class="ow">in</span> <span class="p">(</span><span class="n">RGB</span><span class="p">,</span> <span class="n">YCBCR</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># JPEG compression with subsampling</span>
            <span class="c1"># TODO: use JPEGTables for multiple tiles or strips</span>
            <span class="k">if</span> <span class="n">subsampling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">subsampling</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">subsampling</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;invalid subsampling factors </span><span class="si">{</span><span class="n">subsampling</span><span class="si">!r}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
            <span class="n">maxsampling</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">subsampling</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span>
            <span class="k">if</span> <span class="n">tile</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">maxsampling</span> <span class="ow">or</span> <span class="n">tile</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">%</span> <span class="n">maxsampling</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tile shape not a multiple of </span><span class="si">{</span><span class="n">maxsampling</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extrasamples</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;JPEG subsampling requires RGB(A) images&#39;</span><span class="p">)</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">530</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">subsampling</span><span class="p">)</span>  <span class="c1"># YCbCrSubSampling</span>
            <span class="c1"># use PhotometricInterpretation YCBCR by default</span>
            <span class="n">outcolorspace</span> <span class="o">=</span> <span class="n">enumarg</span><span class="p">(</span>
                <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="p">,</span> <span class="n">compressionargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outcolorspace&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">compressionargs</span><span class="p">[</span><span class="s1">&#39;subsampling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subsampling</span>
            <span class="n">compressionargs</span><span class="p">[</span><span class="s1">&#39;colorspace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">photometric</span><span class="o">.</span><span class="n">name</span>
            <span class="n">compressionargs</span><span class="p">[</span><span class="s1">&#39;outcolorspace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outcolorspace</span><span class="o">.</span><span class="n">name</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">262</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">outcolorspace</span><span class="p">)</span>
            <span class="c1"># ReferenceBlackWhite is required for YCBCR</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">et</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">532</span> <span class="k">for</span> <span class="n">et</span> <span class="ow">in</span> <span class="n">extratags</span><span class="p">):</span>
                <span class="n">addtag</span><span class="p">(</span>
                    <span class="mi">532</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subsampling</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> cannot apply subsampling </span><span class="si">{</span><span class="n">subsampling</span><span class="si">!r}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
            <span class="n">subsampling</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">maxsampling</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">262</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">photometric</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># PhotometricInterpretation</span>
            <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">YCBCR</span><span class="p">:</span>
                <span class="c1"># YCbCrSubSampling and ReferenceBlackWhite</span>
                <span class="n">addtag</span><span class="p">(</span><span class="mi">530</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">et</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">532</span> <span class="k">for</span> <span class="n">et</span> <span class="ow">in</span> <span class="n">extratags</span><span class="p">):</span>
                    <span class="n">addtag</span><span class="p">(</span>
                        <span class="mi">532</span><span class="p">,</span>
                        <span class="mi">5</span><span class="p">,</span>
                        <span class="mi">6</span><span class="p">,</span>
                        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">)</span>
        <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">282</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rational</span><span class="p">(</span><span class="n">resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># XResolution</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">283</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rational</span><span class="p">(</span><span class="n">resolution</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># YResolution</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">unit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">enumarg</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">RESUNIT</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">296</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>  <span class="c1"># ResolutionUnit</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">282</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># XResolution</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">283</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># YResolution</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">296</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># ResolutionUnit</span>

        <span class="k">def</span> <span class="nf">bytecount_format</span><span class="p">(</span>
            <span class="n">bytecounts</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">offsetsize</span>
        <span class="p">):</span>
            <span class="c1"># return small bytecount format</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bytecounts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;Q&#39;</span><span class="p">}[</span><span class="n">size</span><span class="p">]</span>
            <span class="n">bytecount</span> <span class="o">=</span> <span class="n">bytecounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">compression</span><span class="p">:</span>
                <span class="n">bytecount</span> <span class="o">=</span> <span class="n">bytecount</span> <span class="o">*</span> <span class="mi">10</span>
            <span class="k">if</span> <span class="n">bytecount</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">16</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;H&#39;</span>
            <span class="k">if</span> <span class="n">bytecount</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;I&#39;</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;I&#39;</span>
            <span class="k">return</span> <span class="s1">&#39;Q&#39;</span>

        <span class="c1"># can save data array contiguous</span>
        <span class="n">contiguous</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="n">compression</span> <span class="ow">or</span> <span class="n">packints</span> <span class="ow">or</span> <span class="n">bilevel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tile</span><span class="p">:</span>
            <span class="c1"># one chunk per tile per plane</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">tiles</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">storedshape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">(</span><span class="n">storedshape</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">contiguous</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">contiguous</span>
                    <span class="ow">and</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tiles</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">storedshape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">(</span><span class="n">storedshape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="p">(</span><span class="n">storedshape</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">tile</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">contiguous</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">contiguous</span>
                    <span class="ow">and</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">tile</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="n">numtiles</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">tiles</span><span class="p">)</span> <span class="o">*</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">databytecounts</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">product</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span> <span class="o">*</span> <span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span>
            <span class="p">]</span> <span class="o">*</span> <span class="n">numtiles</span>
            <span class="n">bytecountformat</span> <span class="o">=</span> <span class="n">bytecount_format</span><span class="p">(</span><span class="n">databytecounts</span><span class="p">)</span>
            <span class="n">addtag</span><span class="p">(</span><span class="n">tagbytecounts</span><span class="p">,</span> <span class="n">bytecountformat</span><span class="p">,</span> <span class="n">numtiles</span><span class="p">,</span> <span class="n">databytecounts</span><span class="p">)</span>
            <span class="n">addtag</span><span class="p">(</span><span class="n">tagoffsets</span><span class="p">,</span> <span class="n">offsetformat</span><span class="p">,</span> <span class="n">numtiles</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">numtiles</span><span class="p">)</span>
            <span class="n">bytecountformat</span> <span class="o">=</span> <span class="n">bytecountformat</span> <span class="o">*</span> <span class="n">numtiles</span>
            <span class="k">if</span> <span class="n">contiguous</span> <span class="ow">or</span> <span class="n">dataiter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dataiter</span> <span class="o">=</span> <span class="n">iter_tiles</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">tile</span><span class="p">,</span> <span class="n">tiles</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">contiguous</span> <span class="ow">and</span> <span class="n">rowsperstrip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">databytecounts</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">product</span><span class="p">(</span><span class="n">storedshape</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span> <span class="o">*</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span>
            <span class="p">]</span> <span class="o">*</span> <span class="n">count</span>
            <span class="n">bytecountformat</span> <span class="o">=</span> <span class="n">bytecount_format</span><span class="p">(</span><span class="n">databytecounts</span><span class="p">)</span>
            <span class="n">addtag</span><span class="p">(</span><span class="n">tagbytecounts</span><span class="p">,</span> <span class="n">bytecountformat</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">databytecounts</span><span class="p">)</span>
            <span class="n">addtag</span><span class="p">(</span><span class="n">tagoffsets</span><span class="p">,</span> <span class="n">offsetformat</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">count</span><span class="p">)</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">278</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># RowsPerStrip</span>
            <span class="n">bytecountformat</span> <span class="o">=</span> <span class="n">bytecountformat</span> <span class="o">*</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">contiguous</span> <span class="ow">or</span> <span class="n">dataiter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dataiter</span> <span class="o">=</span> <span class="n">iter_images</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use rowsperstrip</span>
            <span class="n">rowsize</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span> <span class="o">*</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span>
            <span class="k">if</span> <span class="n">rowsperstrip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># compress ~64 KB chunks by default</span>
                <span class="c1"># TIFF-EP requires &lt;= 64 KB</span>
                <span class="k">if</span> <span class="n">compression</span><span class="p">:</span>
                    <span class="n">rowsperstrip</span> <span class="o">=</span> <span class="mi">65536</span> <span class="o">//</span> <span class="n">rowsize</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rowsperstrip</span> <span class="o">=</span> <span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">rowsperstrip</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">rowsperstrip</span> <span class="o">=</span> <span class="n">maxsampling</span>
            <span class="k">elif</span> <span class="n">rowsperstrip</span> <span class="o">&gt;</span> <span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">rowsperstrip</span> <span class="o">=</span> <span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">subsampling</span> <span class="ow">and</span> <span class="n">rowsperstrip</span> <span class="o">%</span> <span class="n">maxsampling</span><span class="p">:</span>
                <span class="n">rowsperstrip</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">rowsperstrip</span> <span class="o">/</span> <span class="n">maxsampling</span><span class="p">)</span> <span class="o">*</span> <span class="n">maxsampling</span>
                <span class="p">)</span>
            <span class="n">addtag</span><span class="p">(</span><span class="mi">278</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rowsperstrip</span><span class="p">)</span>  <span class="c1"># RowsPerStrip</span>

            <span class="n">numstrips1</span> <span class="o">=</span> <span class="p">(</span><span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">rowsperstrip</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">rowsperstrip</span>
            <span class="n">numstrips</span> <span class="o">=</span> <span class="n">numstrips1</span> <span class="o">*</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="c1"># TODO: save bilevel data with rowsperstrip</span>
            <span class="n">stripsize</span> <span class="o">=</span> <span class="n">rowsperstrip</span> <span class="o">*</span> <span class="n">rowsize</span>
            <span class="n">databytecounts</span> <span class="o">=</span> <span class="p">[</span><span class="n">stripsize</span><span class="p">]</span> <span class="o">*</span> <span class="n">numstrips</span>
            <span class="n">stripsize</span> <span class="o">-=</span> <span class="n">rowsize</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">numstrips1</span> <span class="o">*</span> <span class="n">rowsperstrip</span> <span class="o">-</span> <span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numstrips1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numstrips</span><span class="p">,</span> <span class="n">numstrips1</span><span class="p">):</span>
                <span class="n">databytecounts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">stripsize</span>
            <span class="n">bytecountformat</span> <span class="o">=</span> <span class="n">bytecount_format</span><span class="p">(</span><span class="n">databytecounts</span><span class="p">)</span>
            <span class="n">addtag</span><span class="p">(</span><span class="n">tagbytecounts</span><span class="p">,</span> <span class="n">bytecountformat</span><span class="p">,</span> <span class="n">numstrips</span><span class="p">,</span> <span class="n">databytecounts</span><span class="p">)</span>
            <span class="n">addtag</span><span class="p">(</span><span class="n">tagoffsets</span><span class="p">,</span> <span class="n">offsetformat</span><span class="p">,</span> <span class="n">numstrips</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">numstrips</span><span class="p">)</span>
            <span class="n">bytecountformat</span> <span class="o">=</span> <span class="n">bytecountformat</span> <span class="o">*</span> <span class="n">numstrips</span>

            <span class="k">if</span> <span class="n">contiguous</span> <span class="ow">or</span> <span class="n">dataiter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dataiter</span> <span class="o">=</span> <span class="n">iter_images</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">contiguous</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot write non-contiguous empty file&#39;</span><span class="p">)</span>

        <span class="c1"># add extra tags from user</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">extratags</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># TODO: check TIFFReadDirectoryCheckOrder warning in files containing</span>
        <span class="c1">#   multiple tags of same code</span>
        <span class="c1"># the entries in an IFD must be sorted in ascending order by tag code</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># define compress function</span>
        <span class="k">if</span> <span class="n">bilevel</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">compressiontag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">packbits</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">compressiontag</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">32773</span><span class="p">):</span>
                <span class="c1"># LZW, PackBits</span>
                <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">,</span>
                    <span class="n">compressor</span><span class="o">=</span><span class="n">TIFF</span><span class="o">.</span><span class="n">COMPRESSORS</span><span class="p">[</span><span class="n">compressiontag</span><span class="p">],</span>
                    <span class="n">kwargs</span><span class="o">=</span><span class="n">compressionargs</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">packbits</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">compressor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;cannot compress bilevel image&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">compression</span><span class="p">:</span>
            <span class="n">compressor</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">COMPRESSORS</span><span class="p">[</span><span class="n">compressiontag</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">compressiontag</span> <span class="o">==</span> <span class="mi">32773</span><span class="p">:</span>  <span class="c1"># PackBits</span>
                <span class="n">compressionargs</span><span class="p">[</span><span class="s1">&#39;axis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>

            <span class="k">if</span> <span class="n">subsampling</span><span class="p">:</span>
                <span class="c1"># JPEG with subsampling</span>
                <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">compressor</span><span class="o">=</span><span class="n">compressor</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">compressionargs</span>
                <span class="p">):</span>
                    <span class="k">return</span> <span class="n">compressor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">predictor</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">,</span>
                    <span class="n">predictor</span><span class="o">=</span><span class="n">predictor</span><span class="p">,</span>
                    <span class="n">compressor</span><span class="o">=</span><span class="n">compressor</span><span class="p">,</span>
                    <span class="n">kwargs</span><span class="o">=</span><span class="n">compressionargs</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">compressor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">compressionargs</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">compressor</span><span class="o">=</span><span class="n">compressor</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">compressionargs</span>
                <span class="p">):</span>
                    <span class="k">return</span> <span class="n">compressor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">compress</span> <span class="o">=</span> <span class="n">compressor</span>

        <span class="k">elif</span> <span class="n">packints</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bps</span><span class="o">=</span><span class="n">bitspersample</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">packints_encode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">compress</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">del</span> <span class="n">compression</span>

        <span class="n">fhpos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="p">(</span><span class="n">offsetsize</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span> <span class="ow">or</span> <span class="n">compress</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">fhpos</span> <span class="o">+</span> <span class="n">datasize</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data too large for standard TIFF file&#39;</span><span class="p">)</span>

        <span class="c1"># if not compressed or multi-tiled, write the first IFD and then</span>
        <span class="c1"># all data contiguously; else, write all IFDs and data interleaved</span>
        <span class="k">for</span> <span class="n">pageindex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">contiguous</span> <span class="k">else</span> <span class="n">storedshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="n">ifdpos</span> <span class="o">=</span> <span class="n">fhpos</span>
            <span class="k">if</span> <span class="n">ifdpos</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># location of IFD must begin on a word boundary</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">ifdpos</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subifdslevel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># update pointer at ifdoffset</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ifdoffset</span><span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">ifdpos</span><span class="p">))</span>

            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">ifdpos</span><span class="p">)</span>

            <span class="c1"># create IFD in memory</span>
            <span class="k">if</span> <span class="n">pageindex</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">subifdsoffsets</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">ifd</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">tagnoformat</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)))</span>
                <span class="n">tagoffset</span> <span class="o">=</span> <span class="n">ifd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">))</span>
                <span class="n">ifdoffset</span> <span class="o">=</span> <span class="n">ifd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>  <span class="c1"># offset to next IFD</span>
                <span class="c1"># write tag values and patch offsets in ifdentries</span>
                <span class="k">for</span> <span class="n">tagindex</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">tagoffset</span> <span class="o">+</span> <span class="n">tagindex</span> <span class="o">*</span> <span class="n">tagsize</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">offsetsize</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">ifd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">pos</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="c1"># tag value is expected to begin on word boundary</span>
                            <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                        <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">ifdpos</span> <span class="o">+</span> <span class="n">pos</span><span class="p">))</span>
                        <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                        <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="n">tagoffsets</span><span class="p">:</span>
                            <span class="n">dataoffsetsoffset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> <span class="n">pos</span>
                        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="n">tagbytecounts</span><span class="p">:</span>
                            <span class="n">databytecountsoffset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> <span class="n">pos</span>
                        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">270</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_descriptiontag</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">ifdpos</span> <span class="o">+</span> <span class="n">tagoffset</span> <span class="o">+</span> <span class="n">tagindex</span> <span class="o">*</span> <span class="n">tagsize</span>
                            <span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_descriptiontag</span><span class="o">.</span><span class="n">valueoffset</span> <span class="o">=</span> <span class="n">ifdpos</span> <span class="o">+</span> <span class="n">pos</span>
                        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">330</span><span class="p">:</span>
                            <span class="n">subifdsoffsets</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> <span class="n">pos</span>
                    <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="n">tagoffsets</span><span class="p">:</span>
                        <span class="n">dataoffsetsoffset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> <span class="kc">None</span>
                    <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="n">tagbytecounts</span><span class="p">:</span>
                        <span class="n">databytecountsoffset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> <span class="kc">None</span>
                    <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">270</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptiontag</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">ifdpos</span> <span class="o">+</span> <span class="n">tagoffset</span> <span class="o">+</span> <span class="n">tagindex</span> <span class="o">*</span> <span class="n">tagsize</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptiontag</span><span class="o">.</span><span class="n">valueoffset</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_descriptiontag</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">offsetsize</span> <span class="o">+</span> <span class="mi">4</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">330</span><span class="p">:</span>
                        <span class="n">subifdsoffsets</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> <span class="kc">None</span>
                <span class="n">ifdsize</span> <span class="o">=</span> <span class="n">ifd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ifdsize</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">ifdsize</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># write IFD later when strip/tile bytecounts and offsets are known</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">ifdsize</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_CUR</span><span class="p">)</span>

            <span class="c1"># write image data</span>
            <span class="n">dataoffset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">align</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">align</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="p">(</span><span class="n">align</span> <span class="o">-</span> <span class="p">(</span><span class="n">dataoffset</span> <span class="o">%</span> <span class="n">align</span><span class="p">))</span> <span class="o">%</span> <span class="n">align</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">skip</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_CUR</span><span class="p">)</span>
            <span class="n">dataoffset</span> <span class="o">+=</span> <span class="n">skip</span>
            <span class="k">if</span> <span class="n">contiguous</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write_empty</span><span class="p">(</span><span class="n">datasize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dataiter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pagedata</span> <span class="ow">in</span> <span class="n">dataiter</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pagedata</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">datadtype</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s1">&#39;dtype of iterable </span><span class="si">{</span><span class="n">pagedata</span><span class="o">.</span><span class="n">dtype</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;does not match dtype </span><span class="si">{</span><span class="n">datadtype</span><span class="si">!r}</span><span class="s1">&#39;</span>
                            <span class="p">)</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">pagedata</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">storedshape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tile</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">tileshape</span> <span class="o">=</span> <span class="n">tile</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tileshape</span> <span class="o">=</span> <span class="n">tile</span> <span class="o">+</span> <span class="p">(</span><span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],)</span>
                <span class="n">tilesize</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">tileshape</span><span class="p">)</span> <span class="o">*</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write_empty</span><span class="p">(</span><span class="n">numtiles</span> <span class="o">*</span> <span class="n">tilesize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">compress</span><span class="p">:</span>
                    <span class="n">isbytes</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">tileindex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">storedshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">product</span><span class="p">(</span><span class="n">tiles</span><span class="p">)):</span>
                        <span class="n">chunk</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">dataiter</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">chunk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">databytecounts</span><span class="p">[</span><span class="n">tileindex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">isbytes</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                            <span class="c1"># pre-compressed</span>
                            <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">chunk</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">!=</span> <span class="n">tilesize</span><span class="p">:</span>
                                <span class="n">chunk</span> <span class="o">=</span> <span class="n">pad_tile</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">tileshape</span><span class="p">,</span> <span class="n">datadtype</span><span class="p">)</span>
                            <span class="n">isbytes</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">chunk</span> <span class="o">=</span> <span class="n">compress</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                        <span class="n">databytecounts</span><span class="p">[</span><span class="n">tileindex</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tileindex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">storedshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">product</span><span class="p">(</span><span class="n">tiles</span><span class="p">)):</span>
                        <span class="n">chunk</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">dataiter</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">chunk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># databytecounts[tileindex] = 0  # not contiguous</span>
                            <span class="n">fh</span><span class="o">.</span><span class="n">write_empty</span><span class="p">(</span><span class="n">tilesize</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">chunk</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">!=</span> <span class="n">tilesize</span><span class="p">:</span>
                            <span class="n">chunk</span> <span class="o">=</span> <span class="n">pad_tile</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">tileshape</span><span class="p">,</span> <span class="n">datadtype</span><span class="p">)</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">compress</span><span class="p">:</span>
                <span class="c1"># write one strip per rowsperstrip</span>
                <span class="n">numstrips</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">rowsperstrip</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="p">)</span> <span class="o">//</span> <span class="n">rowsperstrip</span>
                <span class="n">stripindex</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">pagedata</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">dataiter</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">storedshape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">if</span> <span class="n">pagedata</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">datadtype</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;dtype of iterable </span><span class="si">{</span><span class="n">pagedata</span><span class="o">.</span><span class="n">dtype</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;does not match dtype </span><span class="si">{</span><span class="n">datadtype</span><span class="si">!r}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">pagedata</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">depth</span> <span class="ow">in</span> <span class="n">plane</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numstrips</span><span class="p">):</span>
                            <span class="n">strip</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span>
                                <span class="n">i</span> <span class="o">*</span> <span class="n">rowsperstrip</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rowsperstrip</span>
                            <span class="p">]</span>
                            <span class="n">strip</span> <span class="o">=</span> <span class="n">compress</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>
                            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>
                            <span class="n">databytecounts</span><span class="p">[</span><span class="n">stripindex</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>
                            <span class="n">stripindex</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pagedata</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">dataiter</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">storedshape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">if</span> <span class="n">pagedata</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">datadtype</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;dtype of iterable </span><span class="si">{</span><span class="n">pagedata</span><span class="o">.</span><span class="n">dtype</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;does not match dtype </span><span class="si">{</span><span class="n">datadtype</span><span class="si">!r}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">pagedata</span><span class="p">)</span>

            <span class="c1"># update strip/tile offsets</span>
            <span class="n">offset</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">dataoffsetsoffset</span>
            <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pos</span><span class="p">:</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">ifdpos</span> <span class="o">+</span> <span class="n">pos</span><span class="p">))</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">dataoffset</span>
                <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">databytecounts</span><span class="p">:</span>
                    <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>
                    <span class="n">offset</span> <span class="o">+=</span> <span class="n">size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">dataoffset</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">compress</span><span class="p">:</span>
                <span class="c1"># update strip/tile bytecounts</span>
                <span class="n">offset</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">databytecountsoffset</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">ifdpos</span> <span class="o">+</span> <span class="n">pos</span><span class="p">))</span>
                    <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">bytecountformat</span><span class="p">,</span> <span class="o">*</span><span class="n">databytecounts</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">subifdsoffsets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># update and save pointer to SubIFDs tag values if necessary</span>
                <span class="n">offset</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">subifdsoffsets</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                    <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">ifdpos</span> <span class="o">+</span> <span class="n">pos</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_subifdsoffsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ifdpos</span> <span class="o">+</span> <span class="n">pos</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_subifdsoffsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ifdpos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>

            <span class="n">fhpos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">ifdpos</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ifd</span><span class="o">.</span><span class="n">getbuffer</span><span class="p">())</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subifdslevel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ifdoffset</span> <span class="o">=</span> <span class="n">ifdpos</span> <span class="o">+</span> <span class="n">ifdoffset</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># update SubIFDs tag values</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_subifdsoffsets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ifdindex</span><span class="p">]</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subifdslevel</span> <span class="o">*</span> <span class="n">offsetsize</span>
                <span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">ifdpos</span><span class="p">))</span>

                <span class="c1"># update SubIFD chain offsets</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subifdslevel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_nextifdoffsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ifdpos</span> <span class="o">+</span> <span class="n">ifdoffset</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nextifdoffsets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ifdindex</span><span class="p">])</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">ifdpos</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_nextifdoffsets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ifdindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifdpos</span> <span class="o">+</span> <span class="n">ifdoffset</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ifdindex</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ifdindex</span> <span class="o">%=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subifdsoffsets</span><span class="p">)</span>

            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">fhpos</span><span class="p">)</span>

            <span class="c1"># remove tags that should be written only once</span>
            <span class="k">if</span> <span class="n">pageindex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_storedshape</span> <span class="o">=</span> <span class="n">storedshape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">inputshape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datadtype</span> <span class="o">=</span> <span class="n">datadtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataoffset</span> <span class="o">=</span> <span class="n">dataoffset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_databytecounts</span> <span class="o">=</span> <span class="n">databytecounts</span>

        <span class="k">if</span> <span class="n">contiguous</span><span class="p">:</span>
            <span class="c1"># write remaining IFDs/tags later</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="n">tags</span>
            <span class="c1"># return offset and size of image data</span>
            <span class="k">if</span> <span class="n">returnoffset</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dataoffset</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">databytecounts</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">overwrite_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Overwrite the value of the last ImageDescription tag.</span>

<span class="sd">        Can be used to write OME-XML after writing the image data.</span>
<span class="sd">        Ends a contiguous series.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptiontag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no ImageDescription tag found&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_remaining_pages</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptiontag</span><span class="o">.</span><span class="n">overwrite</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">erase</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptiontag</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_write_remaining_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write outstanding IFDs and tags to file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">pageno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storedshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">pageno</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dataoffset</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_databytecounts</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span>
        <span class="n">fhpos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fhpos</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fhpos</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">pack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span>
        <span class="n">offsetformat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span><span class="o">.</span><span class="n">offsetformat</span>
        <span class="n">offsetsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span><span class="o">.</span><span class="n">offsetsize</span>
        <span class="n">tagnoformat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span><span class="o">.</span><span class="n">tagnoformat</span>
        <span class="n">tagsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span><span class="o">.</span><span class="n">tagsize</span>
        <span class="n">dataoffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataoffset</span>
        <span class="n">pagedatasize</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_databytecounts</span><span class="p">)</span>
        <span class="n">subifdsoffsets</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># construct template IFD in memory</span>
        <span class="c1"># must patch offsets to next IFD and data before writing to file</span>
        <span class="n">ifd</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">tagnoformat</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">)))</span>
        <span class="n">tagoffset</span> <span class="o">=</span> <span class="n">ifd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">))</span>
        <span class="n">ifdoffset</span> <span class="o">=</span> <span class="n">ifd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>  <span class="c1"># offset to next IFD</span>
        <span class="c1"># tag values</span>
        <span class="k">for</span> <span class="n">tagindex</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">):</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">tagoffset</span> <span class="o">+</span> <span class="n">tagindex</span> <span class="o">*</span> <span class="n">tagsize</span> <span class="o">+</span> <span class="n">offsetsize</span> <span class="o">+</span> <span class="mi">4</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">ifd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># tag value is expected to begin on word boundary</span>
                    <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">fhpos</span> <span class="o">+</span> <span class="n">pos</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># struct.error</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> truncating ImageJ file&#39;</span><span class="p">,</span> <span class="ne">UserWarning</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">return</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data too large for non-BigTIFF file&#39;</span><span class="p">)</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataoffsetstag</span><span class="p">:</span>
                    <span class="c1"># save strip/tile offsets for later updates</span>
                    <span class="n">dataoffsetsoffset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> <span class="n">pos</span>
                <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">330</span><span class="p">:</span>
                    <span class="c1"># save subifds offsets for later updates</span>
                    <span class="n">subifdsoffsets</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> <span class="n">pos</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataoffsetstag</span><span class="p">:</span>
                <span class="n">dataoffsetsoffset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">330</span><span class="p">:</span>
                <span class="n">subifdsoffsets</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">ifdsize</span> <span class="o">=</span> <span class="n">ifd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ifdsize</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ifdsize</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># check if all IFDs fit in file</span>
        <span class="k">if</span> <span class="n">offsetsize</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="ow">and</span> <span class="n">fhpos</span> <span class="o">+</span> <span class="n">ifdsize</span> <span class="o">*</span> <span class="n">pageno</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">32</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> truncating ImageJ file&#39;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data too large for non-BigTIFF file&#39;</span><span class="p">)</span>

        <span class="c1"># assemble IFD chain in memory from IFD template</span>
        <span class="n">ifds</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">ifdsize</span> <span class="o">*</span> <span class="n">pageno</span><span class="p">))</span>
        <span class="n">ifdpos</span> <span class="o">=</span> <span class="n">fhpos</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pageno</span><span class="p">):</span>
            <span class="c1"># update strip/tile offsets in IFD</span>
            <span class="n">dataoffset</span> <span class="o">+=</span> <span class="n">pagedatasize</span>  <span class="c1"># offset to image data</span>
            <span class="n">offset</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">dataoffsetsoffset</span>
            <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">ifdpos</span> <span class="o">+</span> <span class="n">pos</span><span class="p">))</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">dataoffset</span>
                <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_databytecounts</span><span class="p">:</span>
                    <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>
                    <span class="n">offset</span> <span class="o">+=</span> <span class="n">size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">dataoffset</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">subifdsoffsets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">offset</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">subifdsoffsets</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_subifdsoffsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ifdpos</span> <span class="o">+</span> <span class="p">(</span><span class="n">pos</span> <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">offset</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subifdslevel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">subifdsoffsets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># update pointer to SubIFDs tag values if necessary</span>
                    <span class="n">offset</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">subifdsoffsets</span>
                    <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                        <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">ifdpos</span> <span class="o">+</span> <span class="n">pos</span><span class="p">))</span>

                <span class="c1"># update pointer at ifdoffset to point to next IFD in file</span>
                <span class="n">ifdpos</span> <span class="o">+=</span> <span class="n">ifdsize</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">ifdoffset</span><span class="p">)</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">ifdpos</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># update SubIFDs tag values in file</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_subifdsoffsets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ifdindex</span><span class="p">]</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subifdslevel</span> <span class="o">*</span> <span class="n">offsetsize</span>
                <span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">ifdpos</span><span class="p">))</span>

                <span class="c1"># update SubIFD chain</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subifdslevel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_nextifdoffsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ifdpos</span> <span class="o">+</span> <span class="n">ifdoffset</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nextifdoffsets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ifdindex</span><span class="p">])</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">ifdpos</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_nextifdoffsets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ifdindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifdpos</span> <span class="o">+</span> <span class="n">ifdoffset</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ifdindex</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ifdindex</span> <span class="o">%=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subifdsoffsets</span><span class="p">)</span>
                <span class="n">ifdpos</span> <span class="o">+=</span> <span class="n">ifdsize</span>

            <span class="c1"># write IFD entry</span>
            <span class="n">ifds</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ifd</span><span class="o">.</span><span class="n">getbuffer</span><span class="p">())</span>

        <span class="c1"># terminate IFD chain</span>
        <span class="n">ifdoffset</span> <span class="o">+=</span> <span class="n">ifdsize</span> <span class="o">*</span> <span class="p">(</span><span class="n">pageno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ifds</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">ifdoffset</span><span class="p">)</span>
        <span class="n">ifds</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="c1"># write IFD chain to file</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">fhpos</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ifds</span><span class="o">.</span><span class="n">getbuffer</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subifdslevel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># update file to point to new IFD chain</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ifdoffset</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">fhpos</span><span class="p">))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ifdoffset</span> <span class="o">=</span> <span class="n">fhpos</span> <span class="o">+</span> <span class="n">ifdoffset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataoffset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_databytecounts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># do not reset _storedshape, _datashape, _datadtype</span>

    <span class="k">def</span> <span class="nf">_write_image_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write metadata to ImageDescription tag.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptiontag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_descriptiontag</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ome</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subifdslevel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ome</span><span class="o">.</span><span class="n">addimage</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_datadtype</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span><span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span> <span class="p">:],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_storedshape</span><span class="p">,</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ome</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># description already up-to-date</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_descriptiontag</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>
        <span class="c1"># elif self._subifdslevel &gt;= 0:</span>
        <span class="c1">#     # don&#39;t write metadata to SubIFDs</span>
        <span class="c1">#     return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
            <span class="n">colormapped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">isrgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storedshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">imagej_description</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span><span class="p">,</span> <span class="n">isrgb</span><span class="p">,</span> <span class="n">colormapped</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">json_description</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptiontag</span><span class="o">.</span><span class="n">overwrite</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">erase</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptiontag</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_now</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return current date and time.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write remaining pages and close file handle.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_remaining_pages</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_image_description</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffWriter </span><span class="si">{</span><span class="n">snipstr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span><span class="si">!r}</span><span class="s1">&gt;&#39;</span>


<span class="k">class</span> <span class="nc">TiffFile</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Read image and metadata from TIFF file.</span>

<span class="sd">    TiffFile instances must be closed using the &#39;close&#39; method, which is</span>
<span class="sd">    automatically called when using the &#39;with&#39; context manager.</span>

<span class="sd">    TiffFile instances are not thread-safe.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    pages : TiffPages</span>
<span class="sd">        Sequence of TIFF pages in file.</span>
<span class="sd">    series : list of TiffPageSeries</span>
<span class="sd">        Sequences of closely related TIFF pages. These are computed</span>
<span class="sd">        from OME, LSM, ImageJ, etc. metadata or based on similarity</span>
<span class="sd">        of page properties such as shape, dtype, and compression.</span>
<span class="sd">    is_flag : bool</span>
<span class="sd">        If True, file is of a certain format.</span>
<span class="sd">        Flags are: bigtiff, uniform, shaped, ome, imagej, stk, lsm, fluoview,</span>
<span class="sd">        nih, vista, micromanager, metaseries, mdgel, mediacy, tvips, fei,</span>
<span class="sd">        sem, scn, svs, scanimage, andor, epics, ndpi, pilatus, qpi.</span>

<span class="sd">    All attributes are read-only.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">arg</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_multifile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">_useframes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize instance from file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arg : path_like or open file</span>
<span class="sd">            Name of file or open file object.</span>
<span class="sd">            The file objects are closed in TiffFile.close().</span>
<span class="sd">        mode : str (optional)</span>
<span class="sd">            File open mode in case &#39;arg&#39; is a file name. Must be &#39;rb&#39; or &#39;r+b&#39;.</span>
<span class="sd">            Default is &#39;rb&#39;.</span>
<span class="sd">        name : str (optional)</span>
<span class="sd">            Optional name of file in case &#39;arg&#39; is a file handle.</span>
<span class="sd">        offset : int (optional)</span>
<span class="sd">            Optional start position of embedded file. By default, this is</span>
<span class="sd">            the current file position.</span>
<span class="sd">        size : int (optional)</span>
<span class="sd">            Optional size of embedded file. By default, this is the number</span>
<span class="sd">            of bytes from the &#39;offset&#39; to the end of the file.</span>
<span class="sd">        kwargs : bool (optional)</span>
<span class="sd">            &#39;is_ome&#39;: If False, disable processing of OME-XML metadata.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c1"># TODO: remove; formally deprecated in 2020.10.1</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;fastij&#39;</span><span class="p">,</span> <span class="s1">&#39;movie&#39;</span><span class="p">,</span> <span class="s1">&#39;multifile&#39;</span><span class="p">,</span> <span class="s1">&#39;multifile_close&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffFile&gt; the </span><span class="si">{</span><span class="n">key</span><span class="si">!r}</span><span class="s1"> argument is ignored&#39;</span><span class="p">,</span>
                        <span class="ne">DeprecationWarning</span><span class="p">,</span>
                        <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;pages&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;the &#39;pages&#39; parameter is no longer supported.&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Use TiffFile.asarray(key=[...]) to read image data &quot;</span>
                    <span class="s2">&quot;from specific pages.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;is_&#39;</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">FILE_FLAGS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unexpected keyword argument: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="s1">&#39;r+b&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;invalid mode </span><span class="si">{</span><span class="n">mode</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">fh</span> <span class="o">=</span> <span class="n">FileHandle</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="n">fh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_multifile</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_multifile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">fh</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="p">}</span>  <span class="c1"># cache of TiffFile instances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decoders</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># cache of TiffPage.decode functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_parent</span>  <span class="c1"># OME master file</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">byteorder</span> <span class="o">=</span> <span class="p">{</span><span class="sa">b</span><span class="s1">&#39;II&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;MM&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;EP&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">}[</span><span class="n">header</span><span class="p">[:</span><span class="mi">2</span><span class="p">]]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;not a TIFF file </span><span class="si">{</span><span class="n">header</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">version</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">43</span><span class="p">:</span>
                <span class="c1"># BigTiff</span>
                <span class="n">offsetsize</span><span class="p">,</span> <span class="n">zero</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;HH&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">zero</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">offsetsize</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;invalid BigTIFF offset size </span><span class="si">{</span><span class="p">(</span><span class="n">offsetsize</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">BIG_BE</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">BIG_LE</span>
            <span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">42</span><span class="p">:</span>
                <span class="c1"># Classic TIFF</span>
                <span class="k">if</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CLASSIC_BE</span>
                <span class="k">elif</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_ndpi&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fh</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;ndpi&#39;</span><span class="p">):</span>
                    <span class="c1"># NDPI uses 64 bit IFD offsets</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">NDPI_LE</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CLASSIC_LE</span>
            <span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="mh">0x4E31</span><span class="p">:</span>
                <span class="c1"># NIFF</span>
                <span class="k">if</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span><span class="s1">&#39;invalid NIFF file&#39;</span><span class="p">)</span>
                <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> NIFF format not supported&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CLASSIC_LE</span>
            <span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="mh">0x55</span> <span class="ow">or</span> <span class="n">version</span> <span class="o">==</span> <span class="mh">0x4F52</span> <span class="ow">or</span> <span class="n">version</span> <span class="o">==</span> <span class="mh">0x5352</span><span class="p">:</span>
                <span class="c1"># Panasonic or Olympus RAW</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> RAW format 0x</span><span class="si">{</span><span class="n">version</span><span class="si">:</span><span class="s1">04X</span><span class="si">}</span><span class="s1"> not supported&#39;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CLASSIC_BE</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CLASSIC_LE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;invalid TIFF version </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># file handle is at offset to offset to first page</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pages</span> <span class="o">=</span> <span class="n">TiffPages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_lsm</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compression</span> <span class="o">!=</span> <span class="mi">1</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">compression</span> <span class="o">!=</span> <span class="mi">1</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lsm_load_pages</span><span class="p">()</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_scanimage</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_bigtiff</span><span class="p">:</span>
                <span class="c1"># ScanImage &lt;= 2015</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">_load_virtual_frames</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">log_warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> _load_virtual_frames failed with &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_philips</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_philips_load_pages</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">log_warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> _philips_load_pages failed with &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ndpi</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ndpi_load_pages</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">log_warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> _ndpi_load_pages failed with &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>

            <span class="k">elif</span> <span class="n">_useframes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">byteorder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span><span class="o">.</span><span class="n">byteorder</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filehandle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return file handle.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return name of file handle.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">fstat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return status of file handle as stat_result object.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># io.UnsupportedOperation</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close open file handle(s).&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">tif</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">squeeze</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">maxworkers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image data from selected TIFF page(s) as numpy array.</span>

<span class="sd">        By default, the data from the first series is returned.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : int, slice, or sequence of indices</span>
<span class="sd">            Defines which pages to return as array.</span>
<span class="sd">            If None (default), data from a series (default 0) is returned.</span>
<span class="sd">            If not None, data from the specified pages in the whole file</span>
<span class="sd">            (if &#39;series&#39; is None) or a specified series are returned as a</span>
<span class="sd">            stacked array.</span>
<span class="sd">            Requesting an array from multiple pages that are not compatible</span>
<span class="sd">            wrt. shape, dtype, compression etc. is undefined, i.e. may crash</span>
<span class="sd">            or return incorrect values.</span>
<span class="sd">        series : int or TiffPageSeries</span>
<span class="sd">            Defines which series of pages to return as array.</span>
<span class="sd">        level : int</span>
<span class="sd">            Defines which pyramid level of a series to return as array.</span>
<span class="sd">        squeeze : bool</span>
<span class="sd">            If True, all length-1 dimensions (except X and Y) are squeezed</span>
<span class="sd">            out from the array.</span>
<span class="sd">            If False, single pages are returned as 5D array (TiffPage.shaped).</span>
<span class="sd">            For series, the shape of the returned array also includes singlet</span>
<span class="sd">            dimensions specified in some file formats. E.g. ImageJ series, and</span>
<span class="sd">            most commonly also OME series, are returned in TZCYXS order.</span>
<span class="sd">            If None (default), all but &quot;shaped&quot; series are squeezed.</span>
<span class="sd">        out : numpy.ndarray, str, or file-like object</span>
<span class="sd">            Buffer where image data are saved.</span>
<span class="sd">            If None (default), a new array is created.</span>
<span class="sd">            If numpy.ndarray, a writable array of compatible dtype and shape.</span>
<span class="sd">            If &#39;memmap&#39;, directly memory-map the image data in the TIFF file</span>
<span class="sd">            if possible; else create a memory-mapped array in a temporary file.</span>
<span class="sd">            If str or open file, the file name or file object used to</span>
<span class="sd">            create a memory-map to an array stored in a binary file on disk.</span>
<span class="sd">        maxworkers : int or None</span>
<span class="sd">            Maximum number of threads to concurrently get data from multiple</span>
<span class="sd">            pages or compressed segments.</span>
<span class="sd">            If None (default), up to half the CPU cores are used.</span>
<span class="sd">            If 1, multi-threading is disabled.</span>
<span class="sd">            Reading data from file is limited to a single thread.</span>
<span class="sd">            Using multiple threads can significantly speed up this function</span>
<span class="sd">            if the bottleneck is decoding compressed data, e.g. in case of</span>
<span class="sd">            large LZW compressed LSM files or JPEG compressed tiled slides.</span>
<span class="sd">            If the bottleneck is I/O or pure Python code, using multiple</span>
<span class="sd">            threads might be detrimental.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Image data from the specified pages.</span>
<span class="sd">            See TiffPage.asarray for operations that are applied (or not)</span>
<span class="sd">            to the raw data stored in the file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">series</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">series</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="n">series</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">series</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">pages</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">series</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">_getlist</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="p">[</span><span class="n">pages</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="p">[</span><span class="n">pages</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;key must be an int, slice, or sequence&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pages</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no pages selected&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">series</span> <span class="ow">and</span> <span class="n">series</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span>
            <span class="n">typecode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">+</span> <span class="n">series</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_memmappable</span>
                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;memmap&#39;</span>
            <span class="p">):</span>
                <span class="c1"># direct mapping</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="n">squeeze</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">memmap_array</span><span class="p">(</span>
                    <span class="n">typecode</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">series</span><span class="o">.</span><span class="n">offset</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># read into output</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="n">squeeze</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">create_output</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">series</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span>
                    <span class="n">typecode</span><span class="p">,</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">maxworkers</span><span class="o">=</span><span class="n">maxworkers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">stack_pages</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">maxworkers</span><span class="o">=</span><span class="n">maxworkers</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="n">squeeze</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">log_warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;asarray failed to reshape </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                    <span class="c1"># try series of expected shapes</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">shape</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># revert to generic shape</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">squeeze</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">squeeze</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="k">if</span> <span class="n">squeeze</span> <span class="k">else</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shaped</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">squeeze</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">squeeze</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span>
                <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="k">if</span> <span class="n">squeeze</span> <span class="k">else</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shaped</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">aszarr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image data from selected TIFF page(s) as zarr storage.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;empty zarr arrays not supported&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">series</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">aszarr</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">series</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="n">series</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">series</span><span class="o">.</span><span class="n">aszarr</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">pages</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">pages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">aszarr</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;key must be an integer index&#39;</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return related pages as TiffPageSeries.</span>

<span class="sd">        Side effect: after calling this function, TiffFile.pages might contain</span>
<span class="sd">        TiffPage and TiffFrame instances.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">useframes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span>
        <span class="n">keyframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">index</span>
        <span class="n">series</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s1">&#39;shaped&#39;</span><span class="p">,</span>
            <span class="s1">&#39;lsm&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ome&#39;</span><span class="p">,</span>
            <span class="s1">&#39;imagej&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fluoview&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stk&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sis&#39;</span><span class="p">,</span>
            <span class="s1">&#39;svs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;scn&#39;</span><span class="p">,</span>
            <span class="s1">&#39;qpi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ndpi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bif&#39;</span><span class="p">,</span>
            <span class="s1">&#39;scanimage&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mdgel&#39;</span><span class="p">,</span>  <span class="c1"># adds second page to cache</span>
            <span class="s1">&#39;uniform&#39;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;is_&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">series</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_series_&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">series</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;ome&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_imagej</span><span class="p">:</span>
                    <span class="c1"># try ImageJ series if OME series fails.</span>
                    <span class="c1"># clear pages cache since _series_ome() might leave some</span>
                    <span class="c1"># frames without keyframe</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>
                    <span class="k">continue</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="n">useframes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="n">keyframe</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">series</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_series_generic</span><span class="p">()</span>

        <span class="c1"># remove empty series, e.g. in MD Gel files</span>
        <span class="c1"># series = [s for s in series if product(s.shape) &gt; 0]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">_series_uniform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all images in file as single series.&quot;&quot;&quot;</span>
        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">validate</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">is_scanimage</span> <span class="ow">or</span> <span class="n">page</span><span class="o">.</span><span class="n">is_nih</span><span class="p">)</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">_getlist</span><span class="p">(</span><span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">),)</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">is_nih</span><span class="p">:</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;NIHImage&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;Uniform&#39;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">TiffPageSeries</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_series_generic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in file.</span>

<span class="sd">        A series is a sequence of TiffPages with the same hash.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">_clear</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">pages</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">pages</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>

        <span class="n">series</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seriesdict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">addpage</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
            <span class="c1"># add page to seriesdict</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>  <span class="c1"># or product(page.shape) == 0:</span>
                <span class="k">return</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">hash</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">seriesdict</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">seriesdict</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">offset</span> <span class="o">==</span> <span class="n">page</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span>
                        <span class="k">break</span>  <span class="c1"># remove duplicate page</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">seriesdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">seriesdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">page</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
            <span class="n">addpage</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">subifds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">subifds</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                        <span class="n">subifd</span> <span class="o">=</span> <span class="n">TiffPage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="n">log_warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> generic series failed with &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">addpage</span><span class="p">(</span><span class="n">subifd</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="n">seriesdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">),)</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span>
            <span class="k">if</span> <span class="s1">&#39;S&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
                <span class="n">axes</span> <span class="o">+=</span> <span class="s1">&#39;S&#39;</span>
            <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">TiffPageSeries</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;Generic&#39;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_uniform</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">pyramidize_series</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">_series_shaped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in &quot;shaped&quot; file.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">reshape</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">truncated</span><span class="p">):</span>
            <span class="c1"># append TiffPageSeries to series</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">axes</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">),)</span> <span class="o">+</span> <span class="n">shape</span>
                    <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;Q&#39;</span> <span class="o">+</span> <span class="n">axes</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">resize</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">reshape</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span> <span class="ow">and</span> <span class="n">resize</span> <span class="o">&gt;</span> <span class="n">size</span> <span class="ow">and</span> <span class="n">resize</span> <span class="o">%</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">truncated</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">truncated</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;Q&#39;</span> <span class="o">+</span> <span class="n">axes</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">resize</span> <span class="o">//</span> <span class="n">size</span><span class="p">,)</span> <span class="o">+</span> <span class="n">shape</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">reshape_axes</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">reshape</span><span class="p">)</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">reshape</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> shaped series failed with &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
            <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">TiffPageSeries</span><span class="p">(</span>
                    <span class="n">pages</span><span class="p">,</span>
                    <span class="n">shape</span><span class="p">,</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                    <span class="n">axes</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;Shaped&#39;</span><span class="p">,</span>
                    <span class="n">truncated</span><span class="o">=</span><span class="n">truncated</span><span class="p">,</span>
                    <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">detect_series</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">series</span><span class="p">,</span> <span class="n">issubifds</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">lenpages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>
            <span class="n">keyframe</span> <span class="o">=</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">reshape</span> <span class="o">=</span> <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">lenpages</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">issubifds</span><span class="p">:</span>
                    <span class="n">keyframe</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># new keyframe; start of new series</span>
                    <span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="n">index</span>
                    <span class="n">keyframe</span> <span class="o">=</span> <span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">is_shaped</span><span class="p">:</span>
                    <span class="n">log_warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                        <span class="s1">&#39;invalid shaped series metadata or corrupted file&#39;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="c1"># read metadata</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">json_description_metadata</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">is_shaped</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">reshape</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
                <span class="n">truncated</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">subifds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span>
                <span class="n">truncated</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;truncated&#39;</span><span class="p">,</span> <span class="n">truncated</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;axes&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
                    <span class="n">axes</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;axes&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">reshape</span><span class="p">):</span>
                        <span class="n">shape</span> <span class="o">=</span> <span class="n">reshape</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">log_warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> shaped series axes do not match shape&#39;</span>
                        <span class="p">)</span>
                <span class="c1"># skip pages if possible</span>
                <span class="n">spages</span> <span class="o">=</span> <span class="p">[</span><span class="n">keyframe</span><span class="p">]</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">reshape</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">npages</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">product</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">npages</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">mod</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">mod</span><span class="p">:</span>
                    <span class="n">log_warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                        <span class="s1">&#39;shaped series shape does not match page shape&#39;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">npages</span> <span class="o">&lt;=</span> <span class="n">lenpages</span> <span class="o">-</span> <span class="n">index</span><span class="p">:</span>
                    <span class="n">size</span> <span class="o">*=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">_dtype</span><span class="o">.</span><span class="n">itemsize</span>
                    <span class="k">if</span> <span class="n">truncated</span><span class="p">:</span>
                        <span class="n">npages</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="n">keyframe</span><span class="o">.</span><span class="n">is_final</span>
                        <span class="ow">and</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">pages</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span>
                        <span class="ow">and</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">subifds</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="n">truncated</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># must read all pages for series</span>
                        <span class="n">truncated</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="n">npages</span><span class="p">):</span>
                            <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                            <span class="n">page</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="n">keyframe</span>
                            <span class="n">spages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
                <span class="n">append</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">spages</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">reshape</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">truncated</span><span class="p">)</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="n">npages</span>

                <span class="c1"># create series from SubIFDs</span>
                <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">subifds</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">subifds</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">subifds</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spages</span><span class="p">):</span>
                            <span class="c1"># if page.subifds is not None:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">subifds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">subifd</span> <span class="o">=</span> <span class="n">TiffPage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
                                    <span class="n">keysubifd</span> <span class="o">=</span> <span class="n">subifd</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">subifd</span> <span class="o">=</span> <span class="n">TiffFrame</span><span class="p">(</span>
                                        <span class="bp">self</span><span class="p">,</span>
                                        <span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                                        <span class="n">keyframe</span><span class="o">=</span><span class="n">keysubifd</span><span class="p">,</span>
                                    <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                                <span class="n">log_warning</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> shaped series failed with &#39;</span>
                                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span>
                                <span class="p">)</span>
                                <span class="k">return</span> <span class="kc">None</span>
                            <span class="n">subifds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subifd</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">subifds</span><span class="p">:</span>
                            <span class="n">series</span> <span class="o">=</span> <span class="n">detect_series</span><span class="p">(</span><span class="n">subifds</span><span class="p">,</span> <span class="n">series</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">series</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">series</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">detect_series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">series</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_uniform</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">pyramidize_series</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">isreduced</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">_series_imagej</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in ImageJ file.&quot;&quot;&quot;</span>
        <span class="c1"># ImageJ&#39;s dimension order is TZCYXS</span>
        <span class="c1"># TODO: fix loading of color, composite, or palette images</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagej_metadata</span>

        <span class="k">def</span> <span class="nf">is_virtual</span><span class="p">():</span>
            <span class="c1"># ImageJ virtual hyperstacks store all image metadata in the first</span>
            <span class="c1"># page and image data are stored contiguously before the second</span>
            <span class="c1"># page, if any</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">page</span><span class="o">.</span><span class="n">is_final</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">images</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">offset</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">count</span> <span class="o">!=</span> <span class="n">product</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">page</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">//</span> <span class="mi">8</span>
                <span class="ow">or</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">count</span> <span class="o">*</span> <span class="n">images</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">size</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="c1"># check that next page is stored after data</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">count</span> <span class="o">*</span> <span class="n">images</span> <span class="o">&gt;</span> <span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">isvirtual</span> <span class="o">=</span> <span class="n">is_virtual</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">):</span>
            <span class="n">log_warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> ImageJ series metadata invalid or corrupted file&#39;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">isvirtual</span><span class="p">:</span>
            <span class="c1"># no need to read other pages</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="p">[</span><span class="n">page</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[:]</span>

        <span class="n">images</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">))</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;frames&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slices&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;channels&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;TZC&#39;</span>

        <span class="n">remain</span> <span class="o">=</span> <span class="n">images</span> <span class="o">//</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remain</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">log_warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> ImageJ series contains unidentified dimension&#39;</span>
            <span class="p">)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">remain</span><span class="p">,)</span> <span class="o">+</span> <span class="n">shape</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span> <span class="o">+</span> <span class="n">axes</span>

        <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">shaped</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># planar storage, S == C, saved by Bio-Formats</span>
            <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">shaped</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">channels</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> ImageJ series number of channels </span><span class="si">{</span><span class="n">channels</span><span class="si">}</span><span class="s1"> &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;does not match separate samples </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">shaped</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">axes</span> <span class="o">+=</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">page</span><span class="o">.</span><span class="n">shaped</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">channels</span> <span class="ow">and</span> <span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># keep contig storage, C = 1</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">axes</span> <span class="o">+=</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">+=</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">axes</span> <span class="o">+=</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span>

        <span class="k">if</span> <span class="s1">&#39;S&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
            <span class="n">axes</span> <span class="o">+=</span> <span class="s1">&#39;S&#39;</span>
        <span class="c1"># assert axes.endswith(&#39;TZCYXS&#39;), axes</span>

        <span class="n">truncated</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">isvirtual</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="o">!=</span> <span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">page</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">//</span> <span class="mi">8</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_uniform</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">TiffPageSeries</span><span class="p">(</span>
                <span class="n">pages</span><span class="p">,</span>
                <span class="n">shape</span><span class="p">,</span>
                <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="n">axes</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;ImageJ&#39;</span><span class="p">,</span>
                <span class="n">truncated</span><span class="o">=</span><span class="n">truncated</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_series_scanimage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in ScanImage file.&quot;&quot;&quot;</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">_getlist</span><span class="p">(</span><span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">framedata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanimage_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FrameData&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="s1">&#39;SI.hChannels.channelSave&#39;</span> <span class="ow">in</span> <span class="n">framedata</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">channels</span> <span class="o">=</span> <span class="n">framedata</span><span class="p">[</span><span class="s1">&#39;SI.hChannels.channelSave&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># channelSave is a list</span>
                    <span class="n">channels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="c1"># channelSave is an int</span>
                    <span class="n">channels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
                <span class="c1"># slices = framedata.get(</span>
                <span class="c1">#    &#39;SI.hStackManager.actualNumSlices&#39;,</span>
                <span class="c1">#     framedata.get(&#39;SI.hStackManager.numSlices&#39;, None),</span>
                <span class="c1"># )</span>
                <span class="c1"># if slices is None:</span>
                <span class="c1">#     raise ValueError(&#39;unable to determine numSlices&#39;)</span>
                <span class="n">slices</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">frames</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">framedata</span><span class="p">[</span><span class="s1">&#39;SI.hStackManager.framesPerSlice&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># framesPerSlice is inf</span>
                    <span class="n">slices</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">%</span> <span class="n">channels</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unable to determine framesPerSlice&#39;</span><span class="p">)</span>
                    <span class="n">frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">//</span> <span class="n">channels</span>
                <span class="k">if</span> <span class="n">slices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">slices</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="n">frames</span> <span class="o">*</span> <span class="n">channels</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">slices</span><span class="p">,</span> <span class="n">frames</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;ZTC&#39;</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> ScanImage series failed with&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>

        <span class="c1"># TODO: older versions of ScanImage store non-varying frame data in</span>
        <span class="c1"># the ImageDescription tag. Candidates are scanimage.SI5.channelsSave,</span>
        <span class="c1"># scanimage.SI5.stackNumSlices, scanimage.SI5.acqNumFrames</span>
        <span class="c1"># scanimage.SI4., state.acq.numberOfFrames, state.acq.numberOfFrames...</span>

        <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">),)</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">TiffPageSeries</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;ScanImage&#39;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_series_fluoview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in FluoView file.&quot;&quot;&quot;</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">_getlist</span><span class="p">(</span><span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">mm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluoview_metadata</span>
        <span class="n">mmhd</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">mm</span><span class="p">[</span><span class="s1">&#39;Dimensions&#39;</span><span class="p">]))</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">MM_DIMENSIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s1">&#39;Q&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mmhd</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mmhd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_uniform</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">TiffPageSeries</span><span class="p">(</span>
                <span class="n">pages</span><span class="p">,</span>
                <span class="n">shape</span><span class="p">,</span>
                <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="n">axes</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">mm</span><span class="p">[</span><span class="s1">&#39;ImageName&#39;</span><span class="p">],</span>
                <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;FluoView&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_series_mdgel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in MD Gel file.&quot;&quot;&quot;</span>
        <span class="c1"># only a single page, scaled according to metadata in second page</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">md</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdgel_metadata</span>
        <span class="k">if</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;FileTag&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">128</span><span class="p">):</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;ScalePixel&#39;</span><span class="p">]</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># rational</span>
            <span class="k">if</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;FileTag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># squary root data format</span>
                <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">scale</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_uniform</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">TiffPageSeries</span><span class="p">(</span>
                <span class="p">[</span><span class="n">page</span><span class="p">],</span>
                <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="n">dtype</span><span class="p">,</span>
                <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;MDGel&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_series_ndpi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return pyramidal image series in NDPI file.&quot;&quot;&quot;</span>
        <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_series_generic</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">series</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;NDPI&#39;</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;Z&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">is_pyramidal</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">65427</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Baseline&#39;</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name</span>
                <span class="k">continue</span>
            <span class="n">mag</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">65421</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mag</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Macro&#39;</span>
                <span class="k">elif</span> <span class="n">mag</span> <span class="o">==</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Map&#39;</span>
        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">_series_sis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in Olympus SIS file.&quot;&quot;&quot;</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">_getlist</span><span class="p">(</span><span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lenpages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sis_metadata</span>
        <span class="k">if</span> <span class="s1">&#39;shape&#39;</span> <span class="ow">in</span> <span class="n">md</span> <span class="ow">and</span> <span class="s1">&#39;axes&#39;</span> <span class="ow">in</span> <span class="n">md</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;axes&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">lenpages</span><span class="p">,)</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_uniform</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">TiffPageSeries</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;SIS&#39;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_series_qpi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in PerkinElmer QPI file.&quot;&quot;&quot;</span>
        <span class="n">series</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>

        <span class="c1"># Baseline</span>
        <span class="c1"># TODO: get name from ImageDescription XML</span>
        <span class="n">ifds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span> <span class="o">+</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">pshape</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">pshape</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">ifds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ifds</span><span class="p">),)</span> <span class="o">+</span> <span class="n">pshape</span>
        <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">TiffPageSeries</span><span class="p">(</span>
                <span class="n">ifds</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Baseline&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;QPI&#39;</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
            <span class="c1"># Thumbnail</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">TiffPageSeries</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">page</span><span class="p">],</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Thumbnail&#39;</span><span class="p">,</span>
                    <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;QPI&#39;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_tiled</span><span class="p">:</span>
            <span class="c1"># Resolutions</span>
            <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
                <span class="n">pshape</span> <span class="o">=</span> <span class="p">(</span><span class="n">pshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pshape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                <span class="n">ifds</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
                    <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">pshape</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">ifds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
                    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ifds</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pages</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ifds</span><span class="p">),)</span> <span class="o">+</span> <span class="n">pshape</span>
                <span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TiffPageSeries</span><span class="p">(</span>
                        <span class="n">ifds</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Resolution&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;QPI&#39;</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_pyramidal</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
            <span class="c1"># Macro</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">TiffPageSeries</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">page</span><span class="p">],</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Macro&#39;</span><span class="p">,</span>
                    <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;QPI&#39;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Label</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TiffPageSeries</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">page</span><span class="p">],</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Label&#39;</span><span class="p">,</span>
                        <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;QPI&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_uniform</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">_series_svs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in Aperio SVS file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_tiled</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">series</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_uniform</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>

        <span class="c1"># Baseline</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">TiffPageSeries</span><span class="p">(</span>
                <span class="p">[</span><span class="n">page</span><span class="p">],</span>
                <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Baseline&#39;</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;SVS&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Thumbnail</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">series</span>
        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">TiffPageSeries</span><span class="p">(</span>
                <span class="p">[</span><span class="n">page</span><span class="p">],</span>
                <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Thumbnail&#39;</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;SVS&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Resolutions</span>
        <span class="c1"># TODO: resolutions not by two</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">page</span><span class="o">.</span><span class="n">is_tiled</span> <span class="ow">or</span> <span class="n">page</span><span class="o">.</span><span class="n">is_reduced</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">TiffPageSeries</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">page</span><span class="p">],</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Resolution&#39;</span><span class="p">,</span>
                    <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;SVS&#39;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Label, Macro; subfiletype 1, 9</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Label&#39;</span><span class="p">,</span> <span class="s1">&#39;Macro&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">TiffPageSeries</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">page</span><span class="p">],</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;SVS&#39;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">_series_scn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return pyramidal image series in Leica SCN file.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: support collections</span>
        <span class="kn">from</span> <span class="nn">xml.etree</span> <span class="kn">import</span> <span class="n">ElementTree</span> <span class="k">as</span> <span class="n">etree</span>  <span class="c1"># delayed import</span>

        <span class="n">scnxml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">description</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">scnxml</span><span class="p">)</span>

        <span class="n">series</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_uniform</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;collection&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">collection</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pixels</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pixels</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;pixels&#39;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">resolutions</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">dimension</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dimension</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;dimension&#39;</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sizeZ&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                                <span class="s1">&#39;SCN series: Z-Stacks not supported. &#39;</span>
                                <span class="s1">&#39;Please submit a sample file.&#39;</span>
                            <span class="p">)</span>
                        <span class="n">sizex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dimension</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;sizeX&#39;</span><span class="p">])</span>
                        <span class="n">sizey</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dimension</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;sizeY&#39;</span><span class="p">])</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dimension</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dimension</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dimension</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">ifd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dimension</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;ifd&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resolutions</span><span class="p">:</span>
                            <span class="n">level</span> <span class="o">=</span> <span class="n">resolutions</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">level</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]:</span>
                                <span class="n">level</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
                            <span class="k">if</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="n">level</span><span class="p">[</span><span class="s1">&#39;sizez&#39;</span><span class="p">]:</span>
                                <span class="n">level</span><span class="p">[</span><span class="s1">&#39;sizez&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
                            <span class="n">level</span><span class="p">[</span><span class="s1">&#39;ifds&#39;</span><span class="p">][(</span><span class="n">c</span><span class="p">,</span> <span class="n">z</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ifd</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">resolutions</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">sizey</span><span class="p">,</span> <span class="n">sizex</span><span class="p">],</span>
                                <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span>
                                <span class="s1">&#39;sizez&#39;</span><span class="p">:</span> <span class="n">z</span><span class="p">,</span>
                                <span class="s1">&#39;ifds&#39;</span><span class="p">:</span> <span class="p">{(</span><span class="n">c</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span> <span class="n">ifd</span><span class="p">},</span>
                            <span class="p">}</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">resolutions</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">levels</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">resolutions</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="p">[</span><span class="s1">&#39;sizez&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;CZ&#39;</span>

                        <span class="n">ifds</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">ifd</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;ifds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                            <span class="n">ifds</span><span class="p">[</span><span class="n">c</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">ifd</span><span class="p">]</span>

                        <span class="n">axes</span> <span class="o">+=</span> <span class="n">ifds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span>
                        <span class="n">shape</span> <span class="o">+=</span> <span class="n">ifds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                        <span class="n">dtype</span> <span class="o">=</span> <span class="n">ifds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>

                        <span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">TiffPageSeries</span><span class="p">(</span>
                                <span class="n">ifds</span><span class="p">,</span>
                                <span class="n">shape</span><span class="p">,</span>
                                <span class="n">dtype</span><span class="p">,</span>
                                <span class="n">axes</span><span class="p">,</span>
                                <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;SCN&#39;</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">_series_bif</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in Ventana/Roche BIF file.&quot;&quot;&quot;</span>
        <span class="n">series</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">baseline</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_uniform</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">description</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Label&#39;</span><span class="p">:</span>
                <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TiffPageSeries</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">page</span><span class="p">],</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Label&#39;</span><span class="p">,</span>
                        <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;BIF&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">page</span><span class="o">.</span><span class="n">description</span> <span class="o">==</span> <span class="s1">&#39;Thumbnail&#39;</span>
                <span class="ow">or</span> <span class="n">page</span><span class="o">.</span><span class="n">description</span><span class="p">[:</span><span class="mi">11</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Probability&#39;</span>
            <span class="p">):</span>
                <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TiffPageSeries</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">page</span><span class="p">],</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Thumbnail&#39;</span><span class="p">,</span>
                        <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;BIF&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;level&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
                <span class="c1"># TODO: is this necessary?</span>
                <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TiffPageSeries</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">page</span><span class="p">],</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Unknown&#39;</span><span class="p">,</span>
                        <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;BIF&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">baseline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">baseline</span> <span class="o">=</span> <span class="n">TiffPageSeries</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">page</span><span class="p">],</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Baseline&#39;</span><span class="p">,</span>
                    <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;BIF&#39;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">series</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">baseline</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">baseline</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TiffPageSeries</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">page</span><span class="p">],</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Resolution&#39;</span><span class="p">,</span>
                        <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;SVS&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> BIF series tiles are not stiched&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">_series_ome</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in OME-TIFF file(s).&quot;&quot;&quot;</span>
        <span class="c1"># xml.etree found to be faster than lxml</span>
        <span class="kn">from</span> <span class="nn">xml.etree</span> <span class="kn">import</span> <span class="n">ElementTree</span> <span class="k">as</span> <span class="n">etree</span>  <span class="c1"># delayed import</span>

        <span class="n">omexml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">description</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">omexml</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">etree</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="c1"># TODO: test badly encoded OME-XML</span>
            <span class="n">log_warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> OME series failed with &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">omexml</span> <span class="o">=</span> <span class="n">omexml</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
                <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">omexml</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="n">keyframe</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">root_uuid</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;UUID&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">root_uuid</span><span class="p">:</span> <span class="bp">self</span><span class="p">}</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">dirname</span>
        <span class="n">moduloref</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">modulo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">series</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;BinaryOnly&#39;</span><span class="p">):</span>
                <span class="c1"># TODO: load OME-XML from master or companion file</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> OME series is BinaryOnly, &#39;</span>
                    <span class="s1">&#39;not an OME-TIFF master file &#39;</span>
                <span class="p">)</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;StructuredAnnotations&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">annot</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">annot</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span>
                        <span class="s1">&#39;modulo&#39;</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">modulo</span><span class="p">[</span><span class="n">annot</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mod</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">annot</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">modul</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">along</span> <span class="ow">in</span> <span class="n">modul</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">along</span><span class="o">.</span><span class="n">tag</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Along&#39;</span><span class="p">):</span>
                                    <span class="k">continue</span>
                                <span class="n">axis</span> <span class="o">=</span> <span class="n">along</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">newaxis</span> <span class="o">=</span> <span class="n">along</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">)</span>
                                <span class="n">newaxis</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">AXES_LABELS</span><span class="p">[</span><span class="n">newaxis</span><span class="p">]</span>
                                <span class="k">if</span> <span class="s1">&#39;Start&#39;</span> <span class="ow">in</span> <span class="n">along</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                                    <span class="n">step</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">along</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Step&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                                    <span class="n">start</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">along</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Start&#39;</span><span class="p">])</span>
                                    <span class="n">stop</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">along</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;End&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">step</span>
                                    <span class="n">labels</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
                                        <span class="n">label</span><span class="o">.</span><span class="n">text</span>
                                        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">along</span>
                                        <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Label&#39;</span><span class="p">)</span>
                                    <span class="p">]</span>
                                <span class="n">mod</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Image&#39;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">annot</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">annot</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;AnnotationRef&#39;</span><span class="p">):</span>
                    <span class="n">annotationref</span> <span class="o">=</span> <span class="n">annot</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">annotationref</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">attr</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">pixels</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pixels</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">pixels</span><span class="o">.</span><span class="n">attrib</span>
                <span class="c1"># dtype = attr.get(&#39;PixelType&#39;, None)</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;DimensionOrder&#39;</span><span class="p">]))</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;Size&#39;</span> <span class="o">+</span> <span class="n">ax</span><span class="p">])</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
                <span class="n">ifds</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">spp</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># samples per pixel</span>
                <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Channel&#39;</span><span class="p">):</span>
                        <span class="n">attr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">attrib</span>
                        <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                            <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">spp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SamplesPerPixel&#39;</span><span class="p">,</span> <span class="n">spp</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">spp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="c1"># correct channel dimension for spp</span>
                                <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span>
                                    <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">spp</span> <span class="k">if</span> <span class="n">ax</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span> <span class="k">else</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
                                <span class="p">]</span>
                        <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SamplesPerPixel&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="n">spp</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s1">&#39;OME series cannot handle differing &#39;</span>
                                <span class="s1">&#39;SamplesPerPixel&#39;</span>
                            <span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;TiffData&#39;</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="n">attr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">attrib</span>
                    <span class="n">ifd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;IFD&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NumPlanes&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="k">if</span> <span class="s1">&#39;IFD&#39;</span> <span class="ow">in</span> <span class="n">attr</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PlaneCount&#39;</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;First&#39;</span> <span class="o">+</span> <span class="n">ax</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c1"># ImageJ produces invalid ome-xml when cropping</span>
                        <span class="n">log_warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                            <span class="s1">&#39;OME series contains invalid TiffData index&#39;</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">uuid</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;UUID&#39;</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">root_uuid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">uuid</span><span class="o">.</span><span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># no global UUID, use this file</span>
                            <span class="n">root_uuid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">text</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">root_uuid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">uuid</span><span class="o">.</span><span class="n">text</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multifile</span><span class="p">:</span>
                                <span class="c1"># abort reading multifile OME series</span>
                                <span class="c1"># and fall back to generic series</span>
                                <span class="k">return</span> <span class="p">[]</span>
                            <span class="n">fname</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;FileName&#39;</span><span class="p">]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">tif</span> <span class="o">=</span> <span class="n">TiffFile</span><span class="p">(</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="n">_parent</span><span class="o">=</span><span class="bp">self</span>
                                <span class="p">)</span>
                                <span class="n">tif</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">tif</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">tif</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">tif</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="n">keyframe</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                                <span class="n">log_warning</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> OME series failed to read &#39;</span>
                                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fname</span><span class="si">!r}</span><span class="s1">&#39;</span>
                                <span class="p">)</span>
                                <span class="c1"># assume that size is same as in previous file</span>
                                <span class="c1"># if no NumPlanes or PlaneCount are given</span>
                                <span class="n">size</span> <span class="o">=</span> <span class="n">num</span> <span class="k">if</span> <span class="n">num</span> <span class="k">else</span> <span class="n">size</span>  <span class="c1"># noqa: undefined</span>
                                <span class="n">ifds</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">ifds</span><span class="p">)))</span>
                                <span class="k">break</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">text</span><span class="p">]</span> <span class="o">=</span> <span class="n">tif</span>
                            <span class="n">tif</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">text</span><span class="p">]</span><span class="o">.</span><span class="n">pages</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">size</span> <span class="o">=</span> <span class="n">num</span> <span class="k">if</span> <span class="n">num</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>
                            <span class="n">ifds</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">ifds</span><span class="p">)))</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
                                <span class="n">ifds</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">ifd</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                            <span class="n">log_warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                                <span class="s1">&#39;OME series contains index out of range&#39;</span>
                            <span class="p">)</span>
                        <span class="c1"># only process first UUID</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># no uuid found</span>
                        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">size</span> <span class="o">=</span> <span class="n">num</span> <span class="k">if</span> <span class="n">num</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>
                            <span class="n">ifds</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">ifds</span><span class="p">)))</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
                                <span class="n">ifds</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">ifd</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                            <span class="n">log_warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                                <span class="s1">&#39;OME series contains index out of range&#39;</span>
                            <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">ifds</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ifds</span><span class="p">):</span>
                    <span class="c1"># skip images without data</span>
                    <span class="k">continue</span>

                <span class="c1"># find a keyframe</span>
                <span class="n">keyframe</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">ifd</span> <span class="ow">in</span> <span class="n">ifds</span><span class="p">:</span>
                    <span class="c1"># try find a TiffPage</span>
                    <span class="k">if</span> <span class="n">ifd</span> <span class="ow">and</span> <span class="n">ifd</span> <span class="o">==</span> <span class="n">ifd</span><span class="o">.</span><span class="n">keyframe</span><span class="p">:</span>
                        <span class="n">keyframe</span> <span class="o">=</span> <span class="n">ifd</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">keyframe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># reload a TiffPage from file</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">keyframe</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ifds</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">keyframe</span><span class="p">:</span>
                            <span class="n">isclosed</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">closed</span>
                            <span class="k">if</span> <span class="n">isclosed</span><span class="p">:</span>
                                <span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
                            <span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">index</span>
                            <span class="n">keyframe</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">keyframe</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                            <span class="n">ifds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyframe</span>
                            <span class="k">if</span> <span class="n">isclosed</span><span class="p">:</span>
                                <span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="k">break</span>

                <span class="c1"># does the series spawn multiple files</span>
                <span class="n">multifile</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">ifd</span> <span class="ow">in</span> <span class="n">ifds</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ifd</span> <span class="ow">and</span> <span class="n">ifd</span><span class="o">.</span><span class="n">parent</span> <span class="o">!=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
                        <span class="n">multifile</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="n">spp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">shape</span> <span class="o">+=</span> <span class="p">[</span><span class="n">spp</span><span class="p">]</span>
                        <span class="n">axes</span> <span class="o">+=</span> <span class="s1">&#39;S&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">spp</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
                        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;S&#39;</span> <span class="o">+</span> <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
                <span class="k">if</span> <span class="s1">&#39;S&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">:</span>
                    <span class="n">shape</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">axes</span> <span class="o">+=</span> <span class="s1">&#39;S&#39;</span>

                <span class="c1"># there might be more pages in the file than referenced in XML</span>
                <span class="c1"># e.g. Nikon-cell011.ome.tif</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">//</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ifds</span><span class="p">):</span>
                    <span class="n">log_warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;OME series expected </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1"> frames, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ifds</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                    <span class="n">ifds</span> <span class="o">=</span> <span class="n">ifds</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>

                <span class="c1"># FIXME: this implementation assumes the last dimensions are</span>
                <span class="c1"># stored in TIFF pages. Apparently that is not always the case.</span>
                <span class="c1"># E.g. TCX (20000, 2, 500) is stored in 2 pages of (20000, 500)</span>
                <span class="c1"># in &#39;Image 7.ome_h00.tiff&#39;.</span>
                <span class="c1"># For now, verify that shapes of keyframe and series match.</span>
                <span class="c1"># If not, skip series.</span>
                <span class="n">squeezed</span> <span class="o">=</span> <span class="n">squeeze_axes</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">axes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">squeezed</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="p">:]):</span>
                    <span class="n">log_warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> OME series &#39;</span>
                        <span class="s1">&#39;cannot handle discontiguous storage (</span><span class="si">%s</span><span class="s1"> != </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span>
                        <span class="n">keyframe</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                        <span class="nb">tuple</span><span class="p">(</span><span class="n">squeezed</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="p">:]),</span>
                    <span class="p">)</span>
                    <span class="k">del</span> <span class="n">ifds</span>
                    <span class="k">continue</span>

                <span class="c1"># set keyframe on all IFDs</span>
                <span class="n">keyframes</span> <span class="o">=</span> <span class="p">{</span><span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">keyframe</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ifds</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">fh</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
                    <span class="k">if</span> <span class="n">fh</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keyframes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">!=</span> <span class="n">page</span><span class="p">:</span>
                            <span class="c1"># reload TiffPage from file</span>
                            <span class="n">isclosed</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">closed</span>
                            <span class="k">if</span> <span class="n">isclosed</span><span class="p">:</span>
                                <span class="n">fh</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
                            <span class="n">page</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">index</span>
                            <span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">page</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                            <span class="n">ifds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
                            <span class="k">if</span> <span class="n">isclosed</span><span class="p">:</span>
                                <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">keyframes</span><span class="p">[</span><span class="n">fh</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
                    <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">!=</span> <span class="n">page</span><span class="p">:</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">fh</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

                <span class="n">moduloref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annotationref</span><span class="p">)</span>
                <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TiffPageSeries</span><span class="p">(</span>
                        <span class="n">ifds</span><span class="p">,</span>
                        <span class="n">shape</span><span class="p">,</span>
                        <span class="n">keyframe</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                        <span class="n">axes</span><span class="p">,</span>
                        <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">multifile</span><span class="o">=</span><span class="n">multifile</span><span class="p">,</span>
                        <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;OME&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">del</span> <span class="n">ifds</span>

        <span class="k">for</span> <span class="n">serie</span><span class="p">,</span> <span class="n">annotationref</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">moduloref</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">annotationref</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modulo</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">serie</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">serie</span><span class="o">.</span><span class="n">get_axes</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="p">(</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="ow">in</span> <span class="n">modulo</span><span class="p">[</span><span class="n">annotationref</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">size</span><span class="p">:</span>
                    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">newaxis</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//=</span> <span class="n">size</span>
                    <span class="n">shape</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">axis</span> <span class="o">+</span> <span class="n">newaxis</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">serie</span><span class="o">.</span><span class="n">set_shape_axes</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span>

        <span class="c1"># pyramids</span>
        <span class="k">for</span> <span class="n">serie</span> <span class="ow">in</span> <span class="n">series</span><span class="p">:</span>
            <span class="n">keyframe</span> <span class="o">=</span> <span class="n">serie</span><span class="o">.</span><span class="n">keyframe</span>
            <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">subifds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># TODO: support multi-file pyramids; must re-open/close</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> OME series cannot read multi-file pyramids&#39;</span>
                <span class="p">)</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">subifds</span><span class="p">)):</span>
                <span class="n">keyframe</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">ifds</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">serie</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ifds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">subifds</span><span class="p">[</span><span class="n">level</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">==</span> <span class="n">page</span><span class="p">:</span>
                        <span class="n">ifd</span> <span class="o">=</span> <span class="n">keyframe</span> <span class="o">=</span> <span class="n">TiffPage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">keyframe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;no keyframe&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ifd</span> <span class="o">=</span> <span class="n">TiffFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">keyframe</span><span class="o">=</span><span class="n">keyframe</span><span class="p">)</span>
                    <span class="n">ifds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ifd</span><span class="p">)</span>
                <span class="c1"># fix shape</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">serie</span><span class="o">.</span><span class="n">axes</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ax</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span>
                        <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">imagewidth</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">ax</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>
                        <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">imagelength</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">serie</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="c1"># add series</span>
                <span class="n">serie</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TiffPageSeries</span><span class="p">(</span>
                        <span class="n">ifds</span><span class="p">,</span>
                        <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span>
                        <span class="n">keyframe</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                        <span class="n">serie</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                        <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;level </span><span class="si">{</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;OME&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_uniform</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">_series_stk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return series in STK file.&quot;&quot;&quot;</span>
        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stk_metadata</span>
        <span class="n">planes</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;NumberPlanes&#39;</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">planes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;ZDistance&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">planes</span><span class="p">,)</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;Z&#39;</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;TimeCreated&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">planes</span><span class="p">,)</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: determine other/combinations of dimensions</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">planes</span><span class="p">,)</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_uniform</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">TiffPageSeries</span><span class="p">(</span>
            <span class="p">[</span><span class="n">page</span><span class="p">],</span>
            <span class="n">shape</span><span class="p">,</span>
            <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">axes</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">truncated</span><span class="o">=</span><span class="n">planes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;STK&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">series</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_series_lsm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return main and thumbnail series in LSM file.&quot;&quot;&quot;</span>
        <span class="n">lsmi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsm_metadata</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO_SCANTYPE</span><span class="p">[</span><span class="n">lsmi</span><span class="p">[</span><span class="s1">&#39;ScanType&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">photometric</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># RGB; more than one channel</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;XY&#39;</span><span class="p">,</span> <span class="s1">&#39;XYC&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lsmi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DimensionP&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">+=</span> <span class="s1">&#39;P&#39;</span>
        <span class="k">if</span> <span class="n">lsmi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DimensionM&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">+=</span> <span class="s1">&#39;M&#39;</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">lsmi</span><span class="p">[</span><span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO_DIMENSIONS</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">)</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">lsmi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">_getlist</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">series</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">TiffPageSeries</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;LSM&#39;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">is_reduced</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">_getlist</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">dtype</span>
            <span class="n">cp</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">cp</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cp</span> <span class="o">*=</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;SYX&#39;</span>
            <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">TiffPageSeries</span><span class="p">(</span>
                    <span class="n">pages</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;LSMreduced&#39;</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_uniform</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">_lsm_load_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load and fix all pages from LSM file.&quot;&quot;&quot;</span>
        <span class="c1"># cache all pages to preserve corrected values</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># use first and second page as keyframes</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># load remaining pages as frames</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="n">keyframe</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># fix offsets and bytecounts first</span>
        <span class="c1"># TODO: fix multiple conversions between lists and tuples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lsm_fix_strip_offsets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lsm_fix_strip_bytecounts</span><span class="p">()</span>
        <span class="c1"># assign keyframes for data and thumbnail series</span>
        <span class="n">keyframe</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">[::</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">page</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="n">keyframe</span>
        <span class="n">keyframe</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">page</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="n">keyframe</span>

    <span class="k">def</span> <span class="nf">_lsm_fix_strip_offsets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unwrap strip offsets for LSM files greater than 4 GB.</span>

<span class="sd">        Each series and position require separate unwrapping (undocumented).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="n">npages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>
        <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">axes</span>

        <span class="c1"># find positions</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">series</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;PM&#39;</span><span class="p">:</span>
                <span class="n">positions</span> <span class="o">*=</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># make time axis first</span>
        <span class="k">if</span> <span class="n">positions</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ntimes</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
                    <span class="n">ntimes</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">ntimes</span><span class="p">:</span>
                <span class="n">div</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">npages</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">positions</span> <span class="o">*</span> <span class="n">ntimes</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mod</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;mod != 0&#39;</span><span class="p">)</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">ntimes</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npages</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># images of reduced page might be stored first</span>
        <span class="k">if</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># unwrap offsets</span>
        <span class="n">wrap</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">previousoffset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
            <span class="n">dataoffsets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">currentoffset</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">currentoffset</span> <span class="o">&lt;</span> <span class="n">previousoffset</span><span class="p">:</span>
                    <span class="n">wrap</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span>
                <span class="n">dataoffsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentoffset</span> <span class="o">+</span> <span class="n">wrap</span><span class="p">)</span>
                <span class="n">previousoffset</span> <span class="o">=</span> <span class="n">currentoffset</span>
            <span class="n">page</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dataoffsets</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lsm_fix_strip_bytecounts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set databytecounts to size of compressed data.</span>

<span class="sd">        The StripByteCounts tag in LSM files contains the number of bytes</span>
<span class="sd">        for the uncompressed data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="k">if</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compression</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># sort pages by first strip offset</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">npages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">index</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">dataoffsets</span>
            <span class="n">bytecounts</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">databytecounts</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npages</span><span class="p">:</span>
                <span class="n">lastoffset</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># LZW compressed strips might be longer than uncompressed</span>
                <span class="n">lastoffset</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">offsets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">bytecounts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">size</span>
                <span class="p">)</span>
            <span class="n">bytecounts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bytecounts</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bytecounts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">bytecounts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">offsets</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">bytecounts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastoffset</span> <span class="o">-</span> <span class="n">offsets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">page</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bytecounts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ndpi_load_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load and fix pages from NDPI slide file if CaptureMode &gt; 6.</span>

<span class="sd">        If the value of the CaptureMode tag is greater than 6, change the</span>
<span class="sd">        attributes of the TiffPages that are part of the pyramid to match</span>
<span class="sd">        16-bit grayscale data. TiffTags are not corrected.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="n">capturemode</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">65441</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">capturemode</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">capturemode</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">pages</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
            <span class="n">mag</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">65421</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mag</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">mag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">page</span><span class="o">.</span><span class="n">photometric</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">MINISBLACK</span>
                <span class="n">page</span><span class="o">.</span><span class="n">samplesperpixel</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">page</span><span class="o">.</span><span class="n">sampleformat</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">page</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">=</span> <span class="mi">16</span>
                <span class="n">page</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;uint16&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">shaped</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">shaped</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">shaped</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">_philips_load_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load and fix all pages from Philips slide file.</span>

<span class="sd">        The imagewidth and imagelength values of all tiled pages are corrected</span>
<span class="sd">        using the DICOM_PIXEL_SPACING attributes of the XML formatted</span>
<span class="sd">        description of the first page.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">xml.etree</span> <span class="kn">import</span> <span class="n">ElementTree</span> <span class="k">as</span> <span class="n">etree</span>  <span class="c1"># delayed import</span>

        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>
        <span class="n">npages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>

        <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

        <span class="n">imagewidth</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imagewidth</span>
        <span class="n">imagelength</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imagelength</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;Attribute&#39;</span>
                <span class="ow">or</span> <span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;DICOM_PIXEL_SPACING&#39;</span>
            <span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">sizes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">imagelength</span> <span class="o">*=</span> <span class="n">h</span>
                <span class="n">imagewidth</span> <span class="o">*=</span> <span class="n">w</span>
                <span class="n">sizes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">imagelength</span> <span class="o">/</span> <span class="n">h</span><span class="p">)),</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">imagewidth</span> <span class="o">/</span> <span class="n">w</span><span class="p">)),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npages</span> <span class="ow">and</span> <span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tilewidth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Label, Macro</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">npages</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">page</span><span class="o">.</span><span class="n">imagewidth</span> <span class="o">=</span> <span class="n">imagewidth</span>
            <span class="n">page</span><span class="o">.</span><span class="n">imagelength</span> <span class="o">=</span> <span class="n">imagelength</span>
            <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">shaped</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">page</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">page</span><span class="o">.</span><span class="n">shaped</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">page</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">page</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">)</span>
            <span class="n">page</span><span class="o">.</span><span class="n">shaped</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">page</span><span class="o">.</span><span class="n">shaped</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">)</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">shaped</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
            <span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return &#39;is_flag&#39; attributes from first page.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">FILE_FLAGS</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s1"> object has no attribute </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffFile </span><span class="si">{</span><span class="n">snipstr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span><span class="si">!r}</span><span class="s1">&gt;&#39;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">79</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string containing information about TiffFile.</span>

<span class="sd">        The detail parameter specifies the level of detail returned:</span>

<span class="sd">        0: file only.</span>
<span class="sd">        1: all series, first page of series and its tags.</span>
<span class="sd">        2: large tag values and file metadata.</span>
<span class="sd">        3: all pages.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;TiffFile &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
            <span class="n">format_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
            <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">byteorder_isnative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">byteorder</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">{</span><span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="s1">&#39;little-endian&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;big-endian&#39;</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">byteorder</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_bigtiff</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;BigTiff&#39;</span><span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span><span class="si">}</span><span class="s1"> Pages&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">)</span><span class="si">}</span><span class="s1"> Series&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">)</span><span class="si">}</span><span class="s1"> Files&#39;</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;   &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">snipstr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">width</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">detail</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">info</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span>
        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">detail</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TiffPage</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">TiffPage</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
                    <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">TiffPage</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">keyframe</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">closed</span>  <span class="c1"># avoid warning</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">TiffPage</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">detail</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_metadata&#39;</span><span class="p">):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_metadata&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_METADATA</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                                <span class="n">pformat</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">detail</span> <span class="o">*</span> <span class="mi">24</span><span class="p">),</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return set of file flags, a potentially expensive operation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">FILE_FLAGS</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;is_&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_bigtiff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if file has BigTIFF format.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiff</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">43</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_mdgel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if file has MD Gel format.&quot;&quot;&quot;</span>
        <span class="c1"># side effect: add second page, if exists, to cache</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ismdgel</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_mdgel</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">is_mdgel</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">ismdgel</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_uniform</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">ismdgel</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_uniform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if file contains a uniform series of pages.&quot;&quot;&quot;</span>
        <span class="c1"># the hashes of IFDs 0, 7, and -1 are the same</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">subifds</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">is_scanimage</span> <span class="ow">or</span> <span class="n">page</span><span class="o">.</span><span class="n">is_nih</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">useframes</span> <span class="o">=</span> <span class="n">pages</span><span class="o">.</span><span class="n">useframes</span>
            <span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">hash</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">aspage</span><span class="p">()</span><span class="o">.</span><span class="n">hash</span> <span class="o">!=</span> <span class="n">h</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="n">useframes</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_appendable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if pages can be appended to file without corrupting.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: check other formats</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_ome</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_lsm</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stk</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_imagej</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fluoview</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_micromanager</span>
        <span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">shaped_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return tifffile metadata from JSON descriptions as dicts.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shaped</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">json_description_metadata</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_shaped</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;shaped&#39;</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ome_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return OME XML.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ome</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># return xml2dict(self.pages[0].description)[&#39;OME&#39;]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">description</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scn_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return Leica SCN XML.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_scn</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">description</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">philips_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return Philips DP XML.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_philips</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">description</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lsm_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return LSM metadata from CZ_LSMINFO tag as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_lsm</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">34412</span><span class="p">)</span>  <span class="c1"># CZ_LSMINFO</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">stk_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return STK metadata from UIC tags as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stk</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;PlaneDescriptions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># result[&#39;plane_descriptions&#39;] = stk_description_metadata(</span>
            <span class="c1">#    page.image_description)</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">33629</span><span class="p">)</span>  <span class="c1"># UIC2tag</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;NumberPlanes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tag</span><span class="o">.</span><span class="n">count</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">33628</span><span class="p">)</span>  <span class="c1"># UIC1tag</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">33630</span><span class="p">)</span>  <span class="c1"># UIC3tag</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># wavelengths</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">33631</span><span class="p">)</span>  <span class="c1"># UIC4tag</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># override UIC1 tags</span>
        <span class="n">uic2tag</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">33629</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uic2tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ZDistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uic2tag</span><span class="p">[</span><span class="s1">&#39;ZDistance&#39;</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;TimeCreated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uic2tag</span><span class="p">[</span><span class="s1">&#39;TimeCreated&#39;</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;TimeModified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uic2tag</span><span class="p">[</span><span class="s1">&#39;TimeModified&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;DatetimeCreated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">julian_datetime</span><span class="p">(</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                            <span class="n">uic2tag</span><span class="p">[</span><span class="s1">&#39;DateCreated&#39;</span><span class="p">],</span> <span class="n">uic2tag</span><span class="p">[</span><span class="s1">&#39;TimeCreated&#39;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">],</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;DatetimeModified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">julian_datetime</span><span class="p">(</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                            <span class="n">uic2tag</span><span class="p">[</span><span class="s1">&#39;DateModified&#39;</span><span class="p">],</span> <span class="n">uic2tag</span><span class="p">[</span><span class="s1">&#39;TimeModified&#39;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">],</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> STK metadata failed with &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">imagej_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return consolidated ImageJ metadata as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_imagej</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">imagej_description_metadata</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">is_imagej</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">50839</span><span class="p">)</span>  <span class="c1"># IJMetadata</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">fluoview_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return consolidated FluoView metadata as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fluoview</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">34361</span><span class="p">)</span>  <span class="c1"># MM_Header</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="c1"># TODO: read stamps from all pages</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">34362</span><span class="p">)</span>  <span class="c1"># MM_Stamp</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Stamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># skip parsing image description; not reliable</span>
        <span class="c1"># try:</span>
        <span class="c1">#     t = fluoview_description_metadata(page.image_description)</span>
        <span class="c1">#     if t is not None:</span>
        <span class="c1">#         result[&#39;ImageDescription&#39;] = t</span>
        <span class="c1"># except Exception as exc:</span>
        <span class="c1">#     log_warning(</span>
        <span class="c1">#         f&#39;{self!r} fluoview_description_metadata failed with&#39;</span>
        <span class="c1">#         f&#39;{exc.__class__.__name__}: {exc}&#39;</span>
        <span class="c1">#     )</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nih_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return NIH Image metadata from NIHImageHeader tag as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_nih</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">43314</span><span class="p">)</span>  <span class="c1"># NIHImageHeader</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fei_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return FEI metadata from SFEG or HELIOS tags as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fei</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span>
        <span class="k">return</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">34680</span><span class="p">,</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">34682</span><span class="p">))</span>  <span class="c1"># FEI_SFEG, FEI_HELIOS</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sem_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return SEM metadata from CZ_SEM tag as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sem</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">34118</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sis_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return Olympus SIS metadata from SIS and INI tags as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sis</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">33471</span><span class="p">))</span>  <span class="c1"># OlympusINI</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">33560</span><span class="p">))</span>  <span class="c1"># OlympusSIS</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">mdgel_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return consolidated metadata from MD GEL tags as dict.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
            <span class="k">if</span> <span class="mi">33445</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>  <span class="c1"># MDFileTag</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">33445</span><span class="p">,</span> <span class="mi">33453</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAGS</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">andor_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return Andor tags as dict.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">andor_tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">epics_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return EPICS areaDetector tags as dict.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">epics_tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tvips_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return TVIPS tag as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tvips</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">37706</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">metaseries_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return MetaSeries metadata from image description as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_metaseries</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">metaseries_description_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">pilatus_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return Pilatus metadata from image description as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_pilatus</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">pilatus_description_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">micromanager_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return MicroManager non-TIFF settings from file as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_micromanager</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># from file header</span>
        <span class="k">return</span> <span class="n">read_micromanager_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">scanimage_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return ScanImage non-varying frame and ROI metadata as dict.</span>

<span class="sd">        The returned dict may be empty or contain &#39;FrameData&#39;, &#39;RoiGroups&#39;,</span>
<span class="sd">        and &#39;version&#39; keys.</span>

<span class="sd">        The varying frame data can be found in the ImageDescription tags.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_scanimage</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">framedata</span><span class="p">,</span> <span class="n">roidata</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">read_scanimage_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;FrameData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">framedata</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">roidata</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">geotiff_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return GeoTIFF metadata from first page as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_geotiff</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">geotiff_tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eer_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return EER metadata from first page as XML.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_eer</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">65001</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">TiffPages</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Sequence of TIFF image file directories (IFD chain).</span>

<span class="sd">    Instances of TiffPages have a state (cache, keyframe, etc.) and are not</span>
<span class="sd">    thread-safe.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize instance and read first TiffPage from file.</span>

<span class="sd">        If arg is a TiffFile, the file position must be at an offset to an</span>
<span class="sd">        offset to a TiffPage. If arg is a TiffPage, page offsets are read</span>
<span class="sd">        from the SubIFDs tag.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># cache of TiffPages, TiffFrames, or their offsets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># True if offsets to all pages were read</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># True if all pages were read into cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tiffpage</span> <span class="o">=</span> <span class="n">TiffPage</span>  <span class="c1"># class used for reading pages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># page that is currently used as keyframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># do not cache frames or pages (if not keyframe)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nextpageoffset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">),)</span>
        <span class="k">elif</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">TiffFile</span><span class="p">):</span>
            <span class="c1"># read offset to first page from current file position</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">arg</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nextpageoffset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">tiff</span><span class="o">.</span><span class="n">offsetformat</span><span class="p">,</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">tiff</span><span class="o">.</span><span class="n">offsetsize</span><span class="p">),</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s1"> contains no pages&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="mi">330</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="c1"># use offsets from SubIFDs tag</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">parent</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="mi">330</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s1"> contains invalid SubIFDs&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">fh</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> invalid offset to first page </span><span class="si">{</span><span class="n">offset</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>

        <span class="n">pageindex</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>

        <span class="c1"># read and cache first page</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">TiffPage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">pageindex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="o">=</span> <span class="n">page</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nextpageoffset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># offsets from SubIFDs tag</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">offsets</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if pages/frames are currently being cached.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>

    <span class="nd">@cache</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enable or disable caching of pages/frames. Clear cache if False.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">useframes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if currently using TiffFrame (True) or TiffPage (False).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tiffpage</span> <span class="o">==</span> <span class="n">TiffFrame</span> <span class="ow">and</span> <span class="n">TiffFrame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TiffPage</span>

    <span class="nd">@useframes</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">useframes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set to use TiffFrame (True) or TiffPage (False).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tiffpage</span> <span class="o">=</span> <span class="n">TiffFrame</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="n">TiffPage</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return current keyframe.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span>

    <span class="nd">@keyframe</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set current keyframe. Load TiffPage from file if necessary.&quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">%=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">index</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">TiffPage</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="o">=</span> <span class="n">page</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">TiffFrame</span><span class="p">):</span>
                <span class="c1"># remove existing TiffFrame</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">offset</span>
        <span class="c1"># load TiffPage from file</span>
        <span class="n">tiffpage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tiffpage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tiffpage</span> <span class="o">=</span> <span class="n">TiffPage</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tiffpage</span> <span class="o">=</span> <span class="n">tiffpage</span>
        <span class="c1"># always cache keyframes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">next_page_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return offset where offset to a new page can be stored.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nextpageoffset</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aspage</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return specified page from cache or file.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span> <span class="n">aspage</span><span class="o">=</span><span class="n">aspage</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyframe</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read all remaining pages from file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pages</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
        <span class="k">if</span> <span class="n">keyframe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keyframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
                <span class="n">pageindex</span> <span class="o">=</span> <span class="n">i</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="p">,)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
                <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tiffpage</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">pageindex</span><span class="p">,</span> <span class="n">keyframe</span><span class="o">=</span><span class="n">keyframe</span>
                <span class="p">)</span>
                <span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_load_virtual_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate virtual TiffFrames.&quot;&quot;&quot;</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;pages already loaded&#39;</span><span class="p">)</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data not contiguous&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pages</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">pages</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">delta</span> <span class="ow">or</span> <span class="n">pages</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="n">pages</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">delta</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;page offsets not equidistant&#39;</span><span class="p">)</span>
            <span class="n">page1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">hash</span><span class="p">)</span>
            <span class="n">offsetoffset</span> <span class="o">=</span> <span class="n">page1</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">page1</span><span class="o">.</span><span class="n">offset</span>
            <span class="k">if</span> <span class="n">offsetoffset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">offsetoffset</span> <span class="o">&gt;</span> <span class="n">delta</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;page offsets not equidistant&#39;</span><span class="p">)</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="p">[</span><span class="n">page</span><span class="p">,</span> <span class="n">page1</span><span class="p">]</span>
            <span class="n">filesize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">delta</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="n">page1</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span> <span class="n">filesize</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">pageindex</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">2</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">pageindex</span> <span class="o">*</span> <span class="n">delta</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">d</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">)</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">31</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pageindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">+</span> <span class="p">(</span><span class="n">pageindex</span><span class="p">,)</span>
                <span class="n">pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TiffFrame</span><span class="p">(</span>
                        <span class="n">parent</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                        <span class="n">index</span><span class="o">=</span><span class="n">pageindex</span><span class="p">,</span>
                        <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span>
                        <span class="n">offsets</span><span class="o">=</span><span class="n">offsets</span><span class="p">,</span>
                        <span class="n">bytecounts</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">databytecounts</span><span class="p">,</span>
                        <span class="n">keyframe</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pages</span> <span class="o">=</span> <span class="n">pages</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="mi">2147483648</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> _load_virtual_frames failed with &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">)&#39;</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fully</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete all but first page from cache. Set keyframe to first page.&quot;&quot;&quot;</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pages</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fully</span><span class="p">:</span>
            <span class="c1"># delete all but first TiffPage/TiffFrame</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">page</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pages</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">offset</span>
        <span class="k">elif</span> <span class="n">TiffFrame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TiffPage</span><span class="p">:</span>
            <span class="c1"># delete only TiffFrames</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">TiffFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="n">page</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">maxpages</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Seek file to offset of page specified by index.&quot;&quot;&quot;</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="n">lenpages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lenpages</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;index out of range&#39;</span><span class="p">)</span>

        <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
        <span class="k">if</span> <span class="n">fh</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;seek of closed file&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="ow">or</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">lenpages</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">page</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">page</span><span class="o">.</span><span class="n">offset</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">tiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">tiff</span>
        <span class="n">offsetformat</span> <span class="o">=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">offsetformat</span>
        <span class="n">offsetsize</span> <span class="o">=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">offsetsize</span>
        <span class="n">tagnoformat</span> <span class="o">=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">tagnoformat</span>
        <span class="n">tagnosize</span> <span class="o">=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">tagnosize</span>
        <span class="n">tagsize</span> <span class="o">=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">tagsize</span>
        <span class="n">unpack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span>

        <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">page</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">page</span><span class="o">.</span><span class="n">offset</span>

        <span class="k">if</span> <span class="n">maxpages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maxpages</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">22</span>
        <span class="k">while</span> <span class="n">lenpages</span> <span class="o">&lt;</span> <span class="n">maxpages</span><span class="p">:</span>
            <span class="c1"># read offsets to pages from file until index is reached</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="c1"># skip tags</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tagno</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">tagnoformat</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tagnosize</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">tagno</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;suspicious number of tags </span><span class="si">{</span><span class="n">tagno</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> corrupted tag list of page &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lenpages</span><span class="si">}</span><span class="s1"> @</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
                <span class="k">del</span> <span class="n">pages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">lenpages</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nextpageoffset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">tagnosize</span> <span class="o">+</span> <span class="n">tagno</span> <span class="o">*</span> <span class="n">tagsize</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nextpageoffset</span><span class="p">)</span>

            <span class="c1"># read offset to next page</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">offsetsize</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> invalid offset to page &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lenpages</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1"> @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_nextpageoffset</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">fh</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> invalid page offset </span><span class="si">{</span><span class="n">offset</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

            <span class="n">pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="n">lenpages</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">lenpages</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># detect some circular references</span>
            <span class="k">if</span> <span class="n">lenpages</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">offset</span> <span class="o">==</span> <span class="p">(</span><span class="n">p</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">p</span><span class="o">.</span><span class="n">offset</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span><span class="s1">&#39;invalid circular IFD reference&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">lenpages</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;index out of range&#39;</span><span class="p">)</span>

        <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">page</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">page</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">useframes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return specified pages as list of TiffPages or TiffFrames.</span>

<span class="sd">        The first item is a TiffPage, and is used as a keyframe for</span>
<span class="sd">        following TiffFrames.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">getitem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span>
        <span class="n">_useframes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">useframes</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">31</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">))))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="c1"># return single TiffPage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">getitem</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="n">_useframes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;key must be an integer, slice, or iterable&#39;</span><span class="p">)</span>

        <span class="c1"># use first page as keyframe</span>
        <span class="n">keyframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
            <span class="n">validate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span><span class="o">.</span><span class="n">hash</span>
        <span class="k">if</span> <span class="n">useframes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="p">[</span><span class="n">getitem</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">pages</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># restore state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="o">=</span> <span class="n">keyframe</span>
            <span class="k">if</span> <span class="n">useframes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="n">_useframes</span>

        <span class="k">return</span> <span class="n">pages</span>

    <span class="k">def</span> <span class="nf">_getitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aspage</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return specified page from cache or file.&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>

        <span class="k">if</span> <span class="n">key</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">%=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;index </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> out of range(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="n">tiffpage</span> <span class="o">=</span> <span class="n">TiffPage</span> <span class="k">if</span> <span class="n">aspage</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tiffpage</span>

        <span class="k">if</span> <span class="n">key</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">aspage</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">validate</span> <span class="o">!=</span> <span class="n">page</span><span class="o">.</span><span class="n">hash</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;page hash mismatch&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">page</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="n">TiffPage</span><span class="p">,</span> <span class="n">tiffpage</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">validate</span> <span class="o">!=</span> <span class="n">page</span><span class="o">.</span><span class="n">hash</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;page hash mismatch&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">page</span>

        <span class="n">pageindex</span> <span class="o">=</span> <span class="n">key</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">+</span> <span class="p">(</span><span class="n">key</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">tiffpage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">pageindex</span><span class="p">,</span> <span class="n">keyframe</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">validate</span> <span class="o">!=</span> <span class="n">page</span><span class="o">.</span><span class="n">hash</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;page hash mismatch&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">or</span> <span class="n">cache</span><span class="p">:</span>
            <span class="n">pages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
        <span class="k">return</span> <span class="n">page</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return specified page(s).&quot;&quot;&quot;</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="n">getitem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">getitem</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">31</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">getitem</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)))]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">getitem</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;key must be an integer, slice, or iterable&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return iterator over all pages.&quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if file contains any pages.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of pages in file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffPages @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="si">}</span><span class="s1">&gt;&#39;</span>


<span class="k">class</span> <span class="nc">TiffPage</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;TIFF image file directory (IFD).</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    index : int or tuple of int</span>
<span class="sd">        Index of the page in file.</span>
<span class="sd">    dtype : numpy.dtype or None</span>
<span class="sd">        Data type (native byte order) of the image in IFD.</span>
<span class="sd">    shape : tuple of int</span>
<span class="sd">        Dimensions of the image in IFD, as returned by asarray.</span>
<span class="sd">    axes : str</span>
<span class="sd">        Axes label codes for each dimension in shape:</span>
<span class="sd">        &#39;S&#39; sample,</span>
<span class="sd">        &#39;X&#39; width,</span>
<span class="sd">        &#39;Y&#39; length,</span>
<span class="sd">        &#39;Z&#39; depth,</span>
<span class="sd">    tags : TiffTags</span>
<span class="sd">        Multidict like interface to tags in IFD.</span>
<span class="sd">    colormap : numpy.ndarray</span>
<span class="sd">        Color look up table, if exists.</span>
<span class="sd">    shaped : tuple of int</span>
<span class="sd">        Normalized 5-dimensional shape of the image in IFD:</span>
<span class="sd">        0 : separate samplesperpixel or 1.</span>
<span class="sd">        1 : imagedepth Z or 1.</span>
<span class="sd">        2 : imagelength Y.</span>
<span class="sd">        3 : imagewidth X.</span>
<span class="sd">        4 : contig samplesperpixel or 1.</span>

<span class="sd">    All attributes are read-only.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># default properties; will be updated from tags</span>
    <span class="n">subfiletype</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">imagewidth</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">imagelength</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">imagedepth</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">tilewidth</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tilelength</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tiledepth</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">bitspersample</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">sampleformat</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">rowsperstrip</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">compression</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">planarconfig</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">fillorder</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">photometric</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">extrasamples</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">subsampling</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">subifds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">jpegtables</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">jpegheader</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># NDPI only</span>
    <span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">description1</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">nodata</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">keyframe</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize instance from file.</span>

<span class="sd">        The file handle position must be at offset to a valid IFD.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shaped</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">TiffTags</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="p">()</span>

        <span class="n">tiff</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">tiff</span>

        <span class="c1"># read TIFF IFD structure and its tags from file</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>  <span class="c1"># offset to this IFD</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tagno</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">tagnoformat</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">tagnosize</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tagno</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;suspicious number of tags </span><span class="si">{</span><span class="n">tagno</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;corrup tag list at offset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="n">tagoffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">tiff</span><span class="o">.</span><span class="n">tagnosize</span>  <span class="c1"># fh.tell()</span>
        <span class="n">tagsize</span> <span class="o">=</span> <span class="n">tagsize_</span> <span class="o">=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">tagsize</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tagsize</span> <span class="o">*</span> <span class="n">tagno</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tagsize</span> <span class="o">*</span> <span class="n">tagno</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span><span class="s1">&#39;corrupted IFD structure&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tiff</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">42</span> <span class="ow">and</span> <span class="n">tiff</span><span class="o">.</span><span class="n">offsetsize</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="c1"># patch offsets/values for 64-bit NDPI file</span>
            <span class="n">tagsize</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_CUR</span><span class="p">)</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">tagno</span><span class="p">)</span>  <span class="c1"># high bits</span>
            <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">12</span> <span class="p">:</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">12</span><span class="p">]</span> <span class="o">+</span> <span class="n">ext</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="p">:</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tagno</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">tagindex</span> <span class="o">=</span> <span class="o">-</span><span class="n">tagsize</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tagno</span><span class="p">):</span>
            <span class="n">tagindex</span> <span class="o">+=</span> <span class="n">tagsize</span>
            <span class="n">tagdata</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">tagindex</span> <span class="p">:</span> <span class="n">tagindex</span> <span class="o">+</span> <span class="n">tagsize</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">TiffTag</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span>
                    <span class="n">parent</span><span class="p">,</span> <span class="n">tagoffset</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">tagsize_</span><span class="p">,</span> <span class="n">tagdata</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">TiffFileError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># found in FIBICS</span>

        <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_ATTRIBUTES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="mi">270</span> <span class="ow">or</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">305</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="c1"># wrong string type for software or description</span>
                <span class="k">continue</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">270</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">description1</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subfiletype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>  <span class="c1"># SubfileType</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subfiletype</span> <span class="o">=</span> <span class="mb">0b1</span>  <span class="c1"># reduced image</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subfiletype</span> <span class="o">=</span> <span class="mb">0b10</span>  <span class="c1"># multi-page</span>

        <span class="c1"># consolidate private tags; remove them from self.tags</span>
        <span class="c1"># if self.is_andor:</span>
        <span class="c1">#     self.andor_tags</span>
        <span class="c1"># elif self.is_epics:</span>
        <span class="c1">#     self.epics_tags</span>
        <span class="c1"># elif self.is_ndpi:</span>
        <span class="c1">#     self.ndpi_tags</span>
        <span class="c1"># if self.is_sis and 34853 in tags:</span>
        <span class="c1">#     # TODO: can&#39;t change tag.name</span>
        <span class="c1">#     tags[34853].name = &#39;OlympusSIS2&#39;</span>

        <span class="c1"># dataoffsets and databytecounts</span>
        <span class="c1"># TileOffsets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">324</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># StripOffsets</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">273</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># JPEGInterchangeFormat et al.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">513</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="o">=</span> <span class="p">()</span>
                    <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> missing data offset tag&#39;</span><span class="p">)</span>
        <span class="c1"># TileByteCounts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">325</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># StripByteCounts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">279</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># JPEGInterchangeFormatLength et al.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">514</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imagewidth</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagelength</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span>
        <span class="p">):</span>
            <span class="c1"># dimensions may be missing in some RAW formats</span>
            <span class="c1"># read dimensions from assumed JPEG encoded segment</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">(</span>
                    <span class="n">precision</span><span class="p">,</span>
                    <span class="n">imagelength</span><span class="p">,</span>
                    <span class="n">imagewidth</span><span class="p">,</span>
                    <span class="n">samplesperpixel</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="n">jpeg_shape</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4096</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imagelength</span> <span class="o">=</span> <span class="n">imagelength</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imagewidth</span> <span class="o">=</span> <span class="n">imagewidth</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span> <span class="o">=</span> <span class="n">samplesperpixel</span>
                <span class="k">if</span> <span class="mi">258</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">=</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">precision</span> <span class="o">&lt;=</span> <span class="mi">8</span> <span class="k">else</span> <span class="mi">16</span>
                <span class="k">if</span> <span class="mi">262</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span> <span class="ow">and</span> <span class="n">samplesperpixel</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">photometric</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># YCbCr</span>
                <span class="k">if</span> <span class="mi">259</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># OJPEG</span>
                <span class="k">if</span> <span class="mi">278</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rowsperstrip</span> <span class="o">=</span> <span class="n">imagelength</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="c1"># OJPEG hack. See libtiff v4.2.0 tif_dirread.c#L4082</span>
            <span class="k">if</span> <span class="mi">262</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="c1"># PhotometricInterpretation missing</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">photometric</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># YCbCr</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">photometric</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># RGB -&gt; YCbCr</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">photometric</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="k">if</span> <span class="mi">258</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="c1"># BitsPerSample missing</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="k">if</span> <span class="mi">277</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="c1"># SamplesPerPixel missing</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">photometric</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">photometric</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_lsm</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">is_lsm</span><span class="p">):</span>
            <span class="c1"># correct non standard LSM bitspersample tags</span>
            <span class="n">tags</span><span class="p">[</span><span class="mi">258</span><span class="p">]</span><span class="o">.</span><span class="n">_fix_lsm_bitspersample</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># work around bug in LSM510 software</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_vista</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">is_vista</span><span class="p">):</span>
            <span class="c1"># ISS Vista writes wrong ImageDepth tag</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imagedepth</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stk</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">33629</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># UIC2tag</span>
                <span class="c1"># read UIC1tag again now that plane count is known</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">33628</span><span class="p">)</span>  <span class="c1"># UIC1tag</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">valueoffset</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tag</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">read_uic1tag</span><span class="p">(</span>
                        <span class="n">fh</span><span class="p">,</span>
                        <span class="n">tiff</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span>
                        <span class="n">tag</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                        <span class="n">tag</span><span class="o">.</span><span class="n">count</span><span class="p">,</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">tags</span><span class="p">[</span><span class="mi">33629</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">,</span>  <span class="c1"># UIC2tag</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">log_warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> read_uic1tag failed with &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>

        <span class="n">tag</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">50839</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># decode IJMetadata tag</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tag</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">imagej_metadata</span><span class="p">(</span>
                    <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">tags</span><span class="p">[</span><span class="mi">50838</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>  <span class="c1"># IJMetadataByteCounts</span>
                    <span class="n">tiff</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> imagej_metadata failed with &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>

        <span class="c1"># BitsPerSample</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">258</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># bitspersample was set by ojpeg hack</span>
            <span class="k">elif</span> <span class="n">tags</span><span class="p">[</span><span class="mi">258</span><span class="p">]</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># LSM might list more items than samplesperpixel</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># SampleFormat</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">339</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tags</span><span class="p">[</span><span class="mi">339</span><span class="p">]</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sampleformat</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sampleformat</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sampleformat</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="mi">322</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>  <span class="c1"># TileWidth</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rowsperstrip</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="mi">257</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>  <span class="c1"># ImageLength</span>
            <span class="k">if</span> <span class="mi">278</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span> <span class="ow">or</span> <span class="n">tags</span><span class="p">[</span><span class="mi">278</span><span class="p">]</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># RowsPerStrip</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rowsperstrip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagelength</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rowsperstrip</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rowsperstrip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagelength</span><span class="p">)</span>
            <span class="c1"># self.stripsperimage = int(math.floor(</span>
            <span class="c1">#    float(self.imagelength + self.rowsperstrip - 1) /</span>
            <span class="c1">#    self.rowsperstrip))</span>

        <span class="c1"># determine dtype</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">SAMPLE_DTYPES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sampleformat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span><span class="p">),</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">dtype</span>

        <span class="c1"># determine shape of data</span>
        <span class="n">imagelength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagelength</span>
        <span class="n">imagewidth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagewidth</span>
        <span class="n">imagedepth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedepth</span>
        <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">photometric</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">samplesperpixel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># PHOTOMETRIC.RGB</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shaped</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="n">imagedepth</span><span class="p">,</span>
                    <span class="n">imagelength</span><span class="p">,</span>
                    <span class="n">imagewidth</span><span class="p">,</span>
                    <span class="n">samplesperpixel</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">imagedepth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">,</span> <span class="n">samplesperpixel</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;YXS&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">imagedepth</span><span class="p">,</span>
                        <span class="n">imagelength</span><span class="p">,</span>
                        <span class="n">imagewidth</span><span class="p">,</span>
                        <span class="n">samplesperpixel</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;ZYXS&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shaped</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">samplesperpixel</span><span class="p">,</span>
                    <span class="n">imagedepth</span><span class="p">,</span>
                    <span class="n">imagelength</span><span class="p">,</span>
                    <span class="n">imagewidth</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">imagedepth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">samplesperpixel</span><span class="p">,</span> <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;SYX&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">samplesperpixel</span><span class="p">,</span>
                        <span class="n">imagedepth</span><span class="p">,</span>
                        <span class="n">imagelength</span><span class="p">,</span>
                        <span class="n">imagewidth</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;SZYX&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shaped</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imagedepth</span><span class="p">,</span> <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">imagedepth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;YX&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">imagedepth</span><span class="p">,</span> <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;ZYX&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">//</span> <span class="mi">8</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> missing ByteCounts tag&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">imagelength</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowsperstrip</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_lsm</span><span class="p">:</span>
            <span class="c1"># fix incorrect number of strip bytecounts and offsets</span>
            <span class="n">maxstrips</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span>
                    <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">imagelength</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowsperstrip</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowsperstrip</span>
                <span class="p">)</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedepth</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">maxstrips</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span>
            <span class="k">if</span> <span class="n">maxstrips</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span><span class="p">):</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> incorrect StripByteCounts count &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span><span class="p">)</span><span class="si">}</span><span class="s1"> != </span><span class="si">{</span><span class="n">maxstrips</span><span class="si">}</span><span class="s1">)&#39;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span><span class="p">[:</span><span class="n">maxstrips</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">maxstrips</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">):</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> incorrect StripOffsets count &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">)</span><span class="si">}</span><span class="s1"> != </span><span class="si">{</span><span class="n">maxstrips</span><span class="si">}</span><span class="s1">)&#39;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[:</span><span class="n">maxstrips</span><span class="p">]</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">42113</span><span class="p">)</span>  <span class="c1"># GDAL_NODATA</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pytype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodata</span> <span class="o">=</span> <span class="n">pytype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">mcustarts</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">65426</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mcustarts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ndpi</span><span class="p">:</span>
            <span class="c1"># use NDPI JPEG McuStarts as tile offsets</span>
            <span class="n">high</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">65432</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># McuStartsHighBytes</span>
                <span class="n">high</span> <span class="o">=</span> <span class="n">high</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint64&#39;</span><span class="p">)</span>
                <span class="n">high</span> <span class="o">&lt;&lt;=</span> <span class="mi">32</span>
                <span class="n">mcustarts</span> <span class="o">=</span> <span class="n">mcustarts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint64&#39;</span><span class="p">)</span>
                <span class="n">mcustarts</span> <span class="o">+=</span> <span class="n">high</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">jpegheader</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">mcustarts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tilelength</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">jpegheader</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="n">ndpi_jpeg_tile</span><span class="p">(</span><span class="n">jpegheader</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> ndpi_jpeg_tile failed with &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">mcustarts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">mcustarts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">mcustarts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="o">=</span> <span class="p">(</span><span class="n">mcustarts</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return decoded segment, its shape, and indices in image.</span>

<span class="sd">        The decode function is implemeted as a closure.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : bytes</span>
<span class="sd">            Encoded bytes of a segment (aka strile, strip or tile)</span>
<span class="sd">            or None for empty segments.</span>
<span class="sd">        index : int</span>
<span class="sd">            The index of the segment in the Offsets and Bytecount tag values.</span>
<span class="sd">        jpegtables : bytes or None</span>
<span class="sd">            For JPEG compressed segments only, the value of the JPEGTables tag</span>
<span class="sd">            if any.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        segment : numpy.ndarray</span>
<span class="sd">            Decoded segment or None for empty segments.</span>
<span class="sd">        indices : tuple of int</span>
<span class="sd">            The position of the segment in the image array of normalized shape:</span>
<span class="sd">            (separate sample, depth, length, width, contig sample).</span>
<span class="sd">        shape : tuple of int</span>
<span class="sd">            The shape of the segment: (depth, length, width, contig samples).</span>
<span class="sd">            The shape of strips depends on their linear index.</span>

<span class="sd">        Raises ValueError or NotImplementedError if decoding is not supported.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_decoders</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_decoders</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">cache</span><span class="p">(</span><span class="n">decode</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_decoders</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">]</span> <span class="o">=</span> <span class="n">decode</span>
            <span class="k">return</span> <span class="n">decode</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;data type not supported &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;(SampleFormat </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sampleformat</span><span class="si">}</span><span class="s1">, &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span><span class="si">}</span><span class="s1">-bit)&#39;</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">cache</span><span class="p">(</span><span class="n">decode</span><span class="p">)</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shaped</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;empty image&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">cache</span><span class="p">(</span><span class="n">decode</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">decompress</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">decompress</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DECOMPRESSORS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">cache</span><span class="p">(</span><span class="n">decode</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">unpredict</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unpredict</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">UNPREDICTORS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">cache</span><span class="p">(</span><span class="n">decode</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">339</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="mi">339</span><span class="p">]</span>  <span class="c1"># SampleFormat</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>

                <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;sample formats do not match </span><span class="si">{</span><span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>

                <span class="k">return</span> <span class="n">cache</span><span class="p">(</span><span class="n">decode</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_subsampled</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="p">):</span>

            <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;chroma subsampling not supported&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">cache</span><span class="p">(</span><span class="n">decode</span><span class="p">)</span>

        <span class="c1"># normalize segments shape to [depth, length, length, contig]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tiled</span><span class="p">:</span>
            <span class="n">stshape</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tiledepth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilelength</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stshape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowsperstrip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagewidth</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">stshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span>
        <span class="n">stshape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">stshape</span><span class="p">)</span>

        <span class="n">stdepth</span><span class="p">,</span> <span class="n">stlength</span><span class="p">,</span> <span class="n">stwidth</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">stshape</span>
        <span class="n">imdepth</span><span class="p">,</span> <span class="n">imlength</span><span class="p">,</span> <span class="n">imwidth</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shaped</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tiled</span><span class="p">:</span>

            <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">imwidth</span> <span class="o">+</span> <span class="n">stwidth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">stwidth</span>
            <span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">imlength</span> <span class="o">+</span> <span class="n">stlength</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">stlength</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">imdepth</span> <span class="o">+</span> <span class="n">stdepth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">stdepth</span>

            <span class="k">def</span> <span class="nf">indices</span><span class="p">(</span><span class="n">tileindex</span><span class="p">):</span>
                <span class="c1"># return indices and shape of tile in image array</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">tileindex</span> <span class="o">//</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">length</span> <span class="o">*</span> <span class="n">depth</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">tileindex</span> <span class="o">//</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">length</span><span class="p">))</span> <span class="o">%</span> <span class="n">depth</span> <span class="o">*</span> <span class="n">stdepth</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">tileindex</span> <span class="o">//</span> <span class="n">width</span><span class="p">)</span> <span class="o">%</span> <span class="n">length</span> <span class="o">*</span> <span class="n">stlength</span><span class="p">,</span>
                        <span class="n">tileindex</span> <span class="o">%</span> <span class="n">width</span> <span class="o">*</span> <span class="n">stwidth</span><span class="p">,</span>
                        <span class="mi">0</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">stshape</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">def</span> <span class="nf">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
                <span class="c1"># return reshaped tile</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">data</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">:</span>
                    <span class="c1"># decompression / unpacking might return too many bytes</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">size</span><span class="p">:</span>
                    <span class="c1"># complete tile</span>
                    <span class="c1"># data might be non-contiguous; cannot reshape inplace</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># data fills remaining space</span>
                    <span class="c1"># found in some JPEG/PNG compressed tiles</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                            <span class="p">(</span>
                                <span class="nb">min</span><span class="p">(</span><span class="n">imdepth</span> <span class="o">-</span> <span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                <span class="nb">min</span><span class="p">(</span><span class="n">imlength</span> <span class="o">-</span> <span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                <span class="nb">min</span><span class="p">(</span><span class="n">imwidth</span> <span class="o">-</span> <span class="n">indices</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                <span class="n">samples</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c1"># incomplete tile; see gdal issue #1179</span>
                        <span class="n">log_warning</span><span class="p">(</span>
                            <span class="s1">&#39;&lt;tifffile.TiffPage.decode&gt; &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;incomplete tile </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="p">)</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                        <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                        <span class="n">t</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>

            <span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodata</span><span class="p">):</span>
                <span class="c1"># pad tile to shape</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">shape</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">shape</span>
                <span class="n">padwidth</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">padwidth</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="n">nodata</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># strips</span>
            <span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">imlength</span> <span class="o">+</span> <span class="n">stlength</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">stlength</span>

            <span class="k">def</span> <span class="nf">indices</span><span class="p">(</span><span class="n">stripindex</span><span class="p">):</span>
                <span class="c1"># return indices and shape of strip in image array</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">stripindex</span> <span class="o">//</span> <span class="p">(</span><span class="n">length</span> <span class="o">*</span> <span class="n">imdepth</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">stripindex</span> <span class="o">//</span> <span class="n">length</span><span class="p">)</span> <span class="o">%</span> <span class="n">imdepth</span> <span class="o">*</span> <span class="n">stdepth</span><span class="p">,</span>
                    <span class="n">stripindex</span> <span class="o">%</span> <span class="n">length</span> <span class="o">*</span> <span class="n">stlength</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">stdepth</span><span class="p">,</span>
                    <span class="nb">min</span><span class="p">(</span><span class="n">stlength</span><span class="p">,</span> <span class="n">imlength</span> <span class="o">-</span> <span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="n">stwidth</span><span class="p">,</span>
                    <span class="n">samples</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">indices</span><span class="p">,</span> <span class="n">shape</span>

            <span class="k">def</span> <span class="nf">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
                <span class="c1"># return reshaped strip</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">data</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">:</span>
                    <span class="c1"># decompression / unpacking might return too many bytes</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">size</span><span class="p">:</span>
                    <span class="c1"># expected size</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># should not happen, but try different length</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="c1"># raise RuntimeError(</span>
                    <span class="c1">#     f&#39;invalid strip shape {data.shape} or size {size}&#39;</span>
                    <span class="c1"># )</span>
                <span class="k">return</span> <span class="n">data</span>

            <span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodata</span><span class="p">):</span>
                <span class="c1"># pad strip length to rowsperstrip</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stlength</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">shape</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">shape</span>
                <span class="n">padwidth</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">stlength</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">padwidth</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="n">nodata</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">34892</span><span class="p">,</span> <span class="mi">33007</span><span class="p">):</span>
            <span class="c1"># JPEG needs special handling</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillorder</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> disabling LSB2MSB for JPEG&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unpredict</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> disabling predictor for JPEG&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">28672</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>  <span class="c1"># SonyRawFileType</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> SonyRawFileType might need additional &#39;</span>
                    <span class="s1">&#39;unpacking (see issue #95)&#39;</span>
                <span class="p">)</span>

            <span class="n">colorspace</span><span class="p">,</span> <span class="n">outcolorspace</span> <span class="o">=</span> <span class="n">jpeg_decode_colorspace</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">photometric</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrasamples</span>
            <span class="p">)</span>

            <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">segmentindex</span><span class="p">,</span>
                <span class="n">jpegtables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">jpegheader</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">_fullsize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">bitspersample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span><span class="p">,</span>
                <span class="n">colorspace</span><span class="o">=</span><span class="n">colorspace</span><span class="p">,</span>
                <span class="n">outcolorspace</span><span class="o">=</span><span class="n">outcolorspace</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="c1"># return decoded segment, its shape, and indices in image</span>
                <span class="n">index</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">indices</span><span class="p">(</span><span class="n">segmentindex</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_fullsize</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">pad</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">shape</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">jpeg_decode</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">,</span>
                    <span class="n">bitspersample</span><span class="o">=</span><span class="n">bitspersample</span><span class="p">,</span>
                    <span class="n">tables</span><span class="o">=</span><span class="n">jpegtables</span><span class="p">,</span>
                    <span class="n">header</span><span class="o">=</span><span class="n">jpegheader</span><span class="p">,</span>
                    <span class="n">colorspace</span><span class="o">=</span><span class="n">colorspace</span><span class="p">,</span>
                    <span class="n">outcolorspace</span><span class="o">=</span><span class="n">outcolorspace</span><span class="p">,</span>
                    <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_fullsize</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">pad</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">shape</span>

            <span class="k">return</span> <span class="n">cache</span><span class="p">(</span><span class="n">decode</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="mi">33003</span><span class="p">,</span>
            <span class="mi">33004</span><span class="p">,</span>
            <span class="mi">33005</span><span class="p">,</span>
            <span class="mi">34712</span><span class="p">,</span>
            <span class="mi">34933</span><span class="p">,</span>
            <span class="mi">34934</span><span class="p">,</span>
            <span class="mi">22610</span><span class="p">,</span>
            <span class="mi">50001</span><span class="p">,</span>
            <span class="mi">50002</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="c1"># JPEG2000, WEBP, PNG, JPEGXR</span>
            <span class="c1"># presume codecs always return correct dtype, native byte order...</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillorder</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;disabling LSB2MSB for compression </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">unpredict</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;disabling predictor for compression </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>

            <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">segmentindex</span><span class="p">,</span> <span class="n">jpegtables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_fullsize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="c1"># return decoded segment, its shape, and indices in image</span>
                <span class="n">index</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">indices</span><span class="p">(</span><span class="n">segmentindex</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_fullsize</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">pad</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">shape</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_fullsize</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">pad</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">shape</span>

            <span class="k">return</span> <span class="n">cache</span><span class="p">(</span><span class="n">decode</span><span class="p">)</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="o">.</span><span class="n">char</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampleformat</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="c1"># complex integer</span>
            <span class="k">if</span> <span class="n">unpredict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s1">&#39;unpredicting complex integers not supported&#39;</span>
                <span class="p">)</span>

            <span class="n">itype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">byteorder</span><span class="si">}</span><span class="s1">i</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">//</span> <span class="mi">16</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="n">ftype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">byteorder</span><span class="si">}</span><span class="s1">f</span><span class="si">{</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">//</span> <span class="mi">2</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

            <span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="c1"># return complex integer as numpy.complex</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">itype</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">ftype</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">):</span>
            <span class="c1"># regular data types</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">*</span> <span class="n">stwidth</span> <span class="o">*</span> <span class="n">samples</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data and sample size mismatch&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># PREDICTOR.FLOATINGPOINT</span>
                <span class="c1"># floating-point horizontal differencing decoder needs</span>
                <span class="c1"># raw byte order</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="o">.</span><span class="n">char</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="c1"># return numpy array from buffer</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># read only numpy array</span>
                    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># e.g. LZW strips may be missing EOI</span>
                    <span class="n">bps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">//</span> <span class="mi">8</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="n">bps</span><span class="p">)</span> <span class="o">*</span> <span class="n">bps</span>
                    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">size</span><span class="p">],</span> <span class="n">dtype</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="c1"># e.g. RGB 565</span>
            <span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="c1"># return numpy array from packed integers</span>
                <span class="k">return</span> <span class="n">unpack_rgb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">==</span> <span class="mi">24</span> <span class="ow">and</span> <span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
            <span class="c1"># float24</span>
            <span class="k">if</span> <span class="n">unpredict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># floatpred_decode requires numpy.float24, which does not exist</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;unpredicting float24 not supported&#39;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">byteorder</span><span class="p">):</span>
                <span class="c1"># return numpy.float32 array from float24</span>
                <span class="k">return</span> <span class="n">float24_decode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># bilevel and packed integers</span>
            <span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="c1"># return numpy array from packed integers</span>
                <span class="k">return</span> <span class="n">packints_decode</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span><span class="p">,</span> <span class="n">stwidth</span> <span class="o">*</span> <span class="n">samples</span>
                <span class="p">)</span>

        <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">segmentindex</span><span class="p">,</span> <span class="n">jpegtables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_fullsize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># return decoded segment, its shape, and indices in image</span>
            <span class="n">index</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">indices</span><span class="p">(</span><span class="n">segmentindex</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_fullsize</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">pad</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">shape</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillorder</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">bitorder_decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">decompress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># TODO: calculate correct size for packed integers</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">size</span> <span class="o">*</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unpredict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># unpredict is faster with native byte order</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">unpredict</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_fullsize</span><span class="p">:</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">pad</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">shape</span>

        <span class="k">return</span> <span class="n">cache</span><span class="p">(</span><span class="n">decode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">segments</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxworkers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_fullsize</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return iterator over decoded segments in TiffPage.</span>

<span class="sd">        See the decode function for return values.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keyframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span>  <span class="c1"># self or keyframe</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
        <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">lock</span>
        <span class="k">if</span> <span class="n">_fullsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_fullsize</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">is_tiled</span>

        <span class="n">decodeargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_fullsize&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_fullsize</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">compression</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">34892</span><span class="p">,</span> <span class="mi">33007</span><span class="p">):</span>  <span class="c1"># JPEG</span>
            <span class="n">decodeargs</span><span class="p">[</span><span class="s1">&#39;jpegtables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jpegtables</span>
            <span class="n">decodeargs</span><span class="p">[</span><span class="s1">&#39;jpegheader&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">jpegheader</span>

        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">decodeargs</span><span class="o">=</span><span class="n">decodeargs</span><span class="p">,</span> <span class="n">keyframe</span><span class="o">=</span><span class="n">keyframe</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">decodeargs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span>
                <span class="n">args</span><span class="p">,</span> <span class="n">decodeargs</span><span class="o">=</span><span class="n">decodeargs</span><span class="p">,</span> <span class="n">keyframe</span><span class="o">=</span><span class="n">keyframe</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">decodeargs</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">maxworkers</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">maxworkers</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">maxworkers</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">maxworkers</span>
        <span class="k">if</span> <span class="n">maxworkers</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_segments</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span><span class="p">,</span>
                <span class="n">lock</span><span class="o">=</span><span class="n">lock</span><span class="p">,</span>
                <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
                <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">yield</span> <span class="n">decode</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># reduce memory overhead by processing chunks of up to</span>
            <span class="c1"># ~64 MB of segments because ThreadPoolExecutor.map is not</span>
            <span class="c1"># collecting iterables lazily</span>
            <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">maxworkers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">segments</span> <span class="ow">in</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_segments</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span><span class="p">,</span>
                    <span class="n">lock</span><span class="o">=</span><span class="n">lock</span><span class="p">,</span>
                    <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
                    <span class="n">flat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="k">yield from</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">decode</span><span class="p">,</span> <span class="n">segments</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxworkers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read image data from file and return as numpy array.</span>

<span class="sd">        Raise ValueError if format is not supported.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        out : numpy.ndarray, str, or file-like object</span>
<span class="sd">            Buffer where image data are saved.</span>
<span class="sd">            If None (default), a new array is created.</span>
<span class="sd">            If numpy.ndarray, a writable array of compatible dtype and shape.</span>
<span class="sd">            If &#39;memmap&#39;, directly memory-map the image data in the TIFF file</span>
<span class="sd">            if possible; else create a memory-mapped array in a temporary file.</span>
<span class="sd">            If str or open file, the file name or file object used to</span>
<span class="sd">            create a memory-map to an array stored in a binary file on disk.</span>
<span class="sd">        squeeze : bool</span>
<span class="sd">            If True (default), all length-1 dimensions (except X and Y) are</span>
<span class="sd">            squeezed out from the array.</span>
<span class="sd">            If False, the shape of the returned array is the normalized</span>
<span class="sd">            5-dimensional shape (TiffPage.shaped).</span>
<span class="sd">        lock : {RLock, NullContext}</span>
<span class="sd">            A reentrant lock used to synchronize seeks and reads from file.</span>
<span class="sd">            If None (default), the lock of the parent&#39;s filehandle is used.</span>
<span class="sd">        maxworkers : int or None</span>
<span class="sd">            Maximum number of threads to concurrently decode strips or tiles.</span>
<span class="sd">            If None (default), up to half the CPU cores are used.</span>
<span class="sd">            See remarks in TiffFile.asarray.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Numpy array of decompressed, unpredicted, and unpacked image data</span>
<span class="sd">            read from Strip/Tile Offsets/ByteCounts, formatted according to</span>
<span class="sd">            shape and dtype metadata found in tags and parameters.</span>
<span class="sd">            Photometric conversion, pre-multiplied alpha, orientation, and</span>
<span class="sd">            colorimetry corrections are not applied. Specifically, CMYK images</span>
<span class="sd">            are not converted to RGB, MinIsWhite images are not inverted,</span>
<span class="sd">            and color palettes are not applied. Exception are YCbCr JPEG</span>
<span class="sd">            compressed images, which are converted to RGB.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keyframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span>  <span class="c1"># self or keyframe</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">shaped</span> <span class="ow">or</span> <span class="n">product</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">shaped</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span><span class="s1">&#39;missing data offset&#39;</span><span class="p">)</span>

        <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
        <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">lock</span>
        <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">closed</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">closed</span>
            <span class="k">if</span> <span class="n">closed</span><span class="p">:</span>
                <span class="c1"># this is an inefficient resort in case a user calls</span>
                <span class="c1"># asarray of a TiffPage or TiffFrame with a closed FileHandle.</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> reading array from closed file&#39;</span><span class="p">,</span> <span class="ne">UserWarning</span>
                <span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;memmap&#39;</span>
            <span class="ow">and</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">is_memmappable</span>
        <span class="p">):</span>
            <span class="c1"># direct memory map array in file</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">memmap_array</span><span class="p">(</span>
                    <span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">+</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">_dtype</span><span class="o">.</span><span class="n">char</span><span class="p">,</span>
                    <span class="n">keyframe</span><span class="o">.</span><span class="n">shaped</span><span class="p">,</span>
                    <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">:</span>
            <span class="c1"># read contiguous bytes to array</span>
            <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">is_subsampled</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;chroma subsampling not supported&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">create_output</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">shaped</span><span class="p">,</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">_dtype</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span>
                    <span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">+</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">_dtype</span><span class="o">.</span><span class="n">char</span><span class="p">,</span>
                    <span class="n">product</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">shaped</span><span class="p">),</span>
                    <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">fillorder</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">bitorder_decode</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">predictor</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># predictors without compression</span>
                <span class="n">unpredict</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">UNPREDICTORS</span><span class="p">[</span><span class="n">keyframe</span><span class="o">.</span><span class="n">predictor</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">predictor</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">unpredict</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># floatpred cannot decode in-place</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">unpredict</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
                    <span class="n">result</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">out</span>

        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">keyframe</span><span class="o">.</span><span class="n">jpegheader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">keyframe</span> <span class="ow">is</span> <span class="bp">self</span>
            <span class="ow">and</span> <span class="mi">273</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>  <span class="c1"># striped ...</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tiled</span>  <span class="c1"># but reported as tiled</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagewidth</span> <span class="o">&lt;=</span> <span class="mi">65500</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagelength</span> <span class="o">&lt;=</span> <span class="mi">65500</span>
        <span class="p">):</span>
            <span class="c1"># decode the whole NDPI JPEG strip</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="mi">273</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># StripOffsets</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="mi">279</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># StripByteCounts</span>
            <span class="n">decompress</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DECOMPRESSORS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">decompress</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">bitspersample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span>
            <span class="p">)</span>
            <span class="k">del</span> <span class="n">data</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># decode individual strips or tiles</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">create_output</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">shaped</span><span class="p">,</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">_dtype</span><span class="p">)</span>
            <span class="n">keyframe</span><span class="o">.</span><span class="n">decode</span>  <span class="c1"># init TiffPage.decode function</span>

            <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">decoderesult</span><span class="p">,</span> <span class="n">keyframe</span><span class="o">=</span><span class="n">keyframe</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">):</span>
                <span class="c1"># copy decoded segments to output array</span>
                <span class="n">segment</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">decoderesult</span>
                <span class="k">if</span> <span class="n">segment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">segment</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">nodata</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">segment</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span>
                        <span class="p">:</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">imagedepth</span> <span class="o">-</span> <span class="n">d</span><span class="p">,</span>
                        <span class="p">:</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">imagelength</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span>
                        <span class="p">:</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">imagewidth</span> <span class="o">-</span> <span class="n">w</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="n">result</span><span class="p">[</span>
                    <span class="n">s</span><span class="p">,</span> <span class="n">d</span> <span class="p">:</span> <span class="n">d</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span> <span class="p">:</span> <span class="n">l</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">w</span> <span class="p">:</span> <span class="n">w</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">segment</span>
                <span class="c1"># except IndexError:</span>
                <span class="c1">#     pass  # corrupted file e.g. with too many strips</span>

            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
                <span class="n">lock</span><span class="o">=</span><span class="n">lock</span><span class="p">,</span>
                <span class="n">maxworkers</span><span class="o">=</span><span class="n">maxworkers</span><span class="p">,</span>
                <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">_fullsize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">pass</span>

        <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">shaped</span>
        <span class="k">if</span> <span class="n">squeeze</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;failed to reshape </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">keyframe</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">closed</span><span class="p">:</span>
            <span class="c1"># TODO: close file if an exception occurred above</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">aszarr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image data as zarr storage.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ZarrTiffStore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">asrgb</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">uint8</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">colormap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image data as RGB(A).</span>

<span class="sd">        Work in progress.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">keyframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span>  <span class="c1"># self or keyframe</span>

        <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">photometric</span> <span class="o">==</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">PALETTE</span><span class="p">:</span>
            <span class="n">colormap</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">colormap</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">colormap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">bitspersample</span>
                <span class="ow">or</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;BH&#39;</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot apply colormap&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">uint8</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">colormap</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
                    <span class="n">colormap</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span>
                <span class="n">colormap</span> <span class="o">=</span> <span class="n">colormap</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">apply_colormap</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">colormap</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">photometric</span> <span class="o">==</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">RGB</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">extrasamples</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">EXTRASAMPLE</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">exs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">extrasamples</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">exs</span> <span class="ow">in</span> <span class="n">alpha</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">i</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">i</span><span class="p">]]</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="c1"># TODO: convert to uint8?</span>

        <span class="k">elif</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">photometric</span> <span class="o">==</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">MINISBLACK</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">elif</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">photometric</span> <span class="o">==</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">MINISWHITE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">elif</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">photometric</span> <span class="o">==</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">SEPARATED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_gettags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of (code, TiffTag).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
            <span class="k">if</span> <span class="n">codes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tag</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="n">codes</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_nextifd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return offset to next IFD from file.&quot;&quot;&quot;</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
        <span class="n">tiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">tiff</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">tagno</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">tagnoformat</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">tagnosize</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">tiff</span><span class="o">.</span><span class="n">tagnosize</span> <span class="o">+</span> <span class="n">tagno</span> <span class="o">*</span> <span class="n">tiff</span><span class="o">.</span><span class="n">tagsize</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">offsetsize</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">aspage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return self.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return keyframe, self.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@keyframe</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set keyframe, NOP.&quot;&quot;&quot;</span>
        <span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of array dimensions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of elements in array.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nbytes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of bytes in array.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">colormap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return colormap as numpy array.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">transferfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return transferfunction as numpy array.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return shape of tiles or stripes.&quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiledepth</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tiledepth</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tiled</span><span class="p">:</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tilelength</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">rowsperstrip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagewidth</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return shape of chunked image.&quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tiled</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedepth</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imagedepth</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiledepth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiledepth</span>
                <span class="p">)</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imagelength</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilelength</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilelength</span>
            <span class="p">)</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imagewidth</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedepth</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imagedepth</span><span class="p">)</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imagelength</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowsperstrip</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowsperstrip</span>
            <span class="p">)</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return checksum to identify pages in same series.</span>

<span class="sd">        Pages with the same hash can use the same decode function.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shaped</span>
            <span class="o">+</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tilelength</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tiledepth</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sampleformat</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rowsperstrip</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fillorder</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">extrasamples</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">photometric</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return sequence of sub-pages, SubIFDs.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="mi">330</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">()</span>
        <span class="k">return</span> <span class="n">TiffPages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">maxworkers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return maximum number of threads for decoding segments.</span>

<span class="sd">        Return 0 to disable multi-threading also for stacking pages.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="mi">6</span><span class="p">,</span>
            <span class="mi">7</span><span class="p">,</span>
            <span class="mi">33003</span><span class="p">,</span>
            <span class="mi">33004</span><span class="p">,</span>
            <span class="mi">33005</span><span class="p">,</span>
            <span class="mi">33007</span><span class="p">,</span>
            <span class="mi">34712</span><span class="p">,</span>
            <span class="mi">34892</span><span class="p">,</span>
            <span class="mi">34933</span><span class="p">,</span>
            <span class="mi">34934</span><span class="p">,</span>
            <span class="mi">22610</span><span class="p">,</span>
            <span class="mi">50001</span><span class="p">,</span>
            <span class="mi">50002</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="c1"># image codecs</span>
            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">MAXWORKERS</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">))</span>
        <span class="n">bytecount</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="k">if</span> <span class="n">bytecount</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">:</span>
            <span class="c1"># disable multi-threading for small segments</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillorder</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">bytecount</span> <span class="o">&lt;</span> <span class="mi">16384</span><span class="p">:</span>
                <span class="c1"># disable multi-threading for small LZW compressed segments</span>
                <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillorder</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imagecodecs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">MAXWORKERS</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">2</span>  <span class="c1"># optimum for large number of uncompressed tiles</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_contiguous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return offset and size of contiguous data, else None.</span>

<span class="sd">        Excludes prediction and fill_order.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampleformat</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="mi">322</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>  <span class="c1"># TileWidth</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imagewidth</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagelength</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilelength</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span> <span class="o">%</span> <span class="mi">16</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilelength</span> <span class="o">%</span> <span class="mi">16</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="mi">32997</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>  <span class="c1"># ImageDepth</span>
                <span class="ow">and</span> <span class="mi">32998</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>  <span class="c1"># TileDepth</span>
                <span class="ow">and</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imagelength</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilelength</span>
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedepth</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiledepth</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span>
        <span class="n">bytecounts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bytecounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stk</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_lsm</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">sum</span><span class="p">(</span><span class="n">bytecounts</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">bytecounts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">bytecounts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">offsets</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">sum</span><span class="p">(</span><span class="n">bytecounts</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_final</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if page&#39;s image data are stored in final form.</span>

<span class="sd">        Excludes byte-swapping.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillorder</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_subsampled</span>
        <span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_memmappable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if page&#39;s image data in file can be memory-mapped.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">is_file</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_final</span>
            <span class="c1"># and (self.bitspersample == 8 or self.parent.isnative)</span>
            <span class="c1"># aligned?</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffPage </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s1"> @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="si">}</span><span class="s1">&gt;&#39;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">79</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string containing information about TiffPage.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TiffFrame</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;memmappable&#39;</span><span class="p">,</span> <span class="s1">&#39;final&#39;</span><span class="p">,</span> <span class="s1">&#39;contiguous&#39;</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;is_&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="k">break</span>

        <span class="k">def</span> <span class="nf">tostr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="o">!=</span> <span class="n">skip</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

        <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s1">&#39;x&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
                <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">TIFF</span><span class="o">.</span><span class="n">SAMPLEFORMAT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sampleformat</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">i</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span>
                        <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">photometric</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="s1">&#39;REDUCED&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_reduced</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;MASK&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mask</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;TILED&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tiled</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                        <span class="n">tostr</span><span class="p">(</span><span class="s1">&#39;compression&#39;</span><span class="p">),</span>
                        <span class="n">tostr</span><span class="p">(</span><span class="s1">&#39;planarconfig&#39;</span><span class="p">),</span>
                        <span class="n">tostr</span><span class="p">(</span><span class="s1">&#39;predictor&#39;</span><span class="p">),</span>
                        <span class="n">tostr</span><span class="p">(</span><span class="s1">&#39;fillorder&#39;</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">attr</span><span class="p">,)</span>
                    <span class="k">if</span> <span class="n">i</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span>
        <span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;TiffPage </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s1"> @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">info</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">detail</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">info</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">detail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">detail</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ndpi&#39;</span><span class="p">,):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_tags&#39;</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">attr</span><span class="p">:</span>
                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                            <span class="n">pformat</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">detail</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
        <span class="k">if</span> <span class="n">detail</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;DATA</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">asarray</span><span class="p">(),</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">detail</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return set of flags.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">FILE_FLAGS</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;is_&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">andor_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return consolidated metadata from Andor tags as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_andor</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="mi">4864</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>  <span class="c1"># AndorId</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>  <span class="c1"># list(self.tags.values()):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">code</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="mi">4864</span> <span class="o">&lt;</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="mi">5031</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="n">name</span>
            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span>
            <span class="c1"># del self.tags[code]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">epics_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return consolidated metadata from EPICS areaDetector tags as dict.</span>

<span class="sd">        Use epics_datetime() to get a datetime object from the epicsTSSec and</span>
<span class="sd">        epicsTSNsec tags.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_epics</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>  <span class="c1"># list(self.tags.values()):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">code</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="mi">65000</span> <span class="o">&lt;=</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="mi">65500</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">65000</span><span class="p">:</span>
                <span class="c1"># not a POSIX timestamp</span>
                <span class="c1"># https://github.com/bluesky/area-detector-handlers/issues/20</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;timeStamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">65001</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;uniqueID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">65002</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;epicsTSSec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">65003</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;epicsTSNsec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="c1"># del self.tags[code]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">ndpi_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return consolidated metadata from Hamamatsu NDPI as dict.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: parse 65449 ini style comments</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ndpi</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Make&#39;</span><span class="p">,</span> <span class="s1">&#39;Model&#39;</span><span class="p">,</span> <span class="s1">&#39;Software&#39;</span><span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">NDPI_TAGS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                <span class="c1"># del tags[code]</span>
        <span class="k">if</span> <span class="s1">&#39;McuStarts&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">mcustarts</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;McuStarts&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;McuStartsHighBytes&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">high</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;McuStartsHighBytes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint64&#39;</span><span class="p">)</span>
                <span class="n">high</span> <span class="o">&lt;&lt;=</span> <span class="mi">32</span>
                <span class="n">mcustarts</span> <span class="o">=</span> <span class="n">mcustarts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint64&#39;</span><span class="p">)</span>
                <span class="n">mcustarts</span> <span class="o">+=</span> <span class="n">high</span>
                <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;McuStartsHighBytes&#39;</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;McuStarts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcustarts</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">geotiff_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return consolidated metadata from GeoTIFF tags as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_geotiff</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

        <span class="n">gkd</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">34735</span><span class="p">)</span>  <span class="c1"># GeoKeyDirectoryTag</span>
        <span class="k">if</span> <span class="n">gkd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">gkd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">gkd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> invalid GeoKeyDirectoryTag&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;KeyDirectoryVersion&#39;</span><span class="p">:</span> <span class="n">gkd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;KeyRevision&#39;</span><span class="p">:</span> <span class="n">gkd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;KeyRevisionMinor&#39;</span><span class="p">:</span> <span class="n">gkd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="c1"># &#39;NumberOfKeys&#39;: gkd[3],</span>
        <span class="p">}</span>
        <span class="c1"># deltags = [&#39;GeoKeyDirectoryTag&#39;]</span>
        <span class="n">geokeys</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">GEO_KEYS</span>
        <span class="n">geocodes</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">GEO_CODES</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">gkd</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">keyid</span><span class="p">,</span> <span class="n">tagid</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">gkd</span><span class="p">[</span>
                    <span class="mi">4</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">4</span> <span class="p">:</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">8</span>
                <span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> corrupted GeoKeyDirectoryTag &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">)&#39;</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">tagid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">offset</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="n">tagid</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">count</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">TiffFileError</span><span class="p">:</span>
                    <span class="n">log_warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> corrupted GeoKeyDirectoryTag </span><span class="si">{</span><span class="n">tagid</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">log_warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> GeoKeyDirectoryTag </span><span class="si">{</span><span class="n">tagid</span><span class="si">}</span><span class="s1"> not found&#39;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">tagid</span> <span class="o">==</span> <span class="mi">34737</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;|&#39;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">keyid</span> <span class="ow">in</span> <span class="n">geocodes</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">geocodes</span><span class="p">[</span><span class="n">keyid</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">geokeys</span><span class="p">(</span><span class="n">keyid</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">keyid</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">33920</span><span class="p">)</span>  <span class="c1"># IntergraphMatrixTag</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;IntergraphMatrix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">33550</span><span class="p">)</span>  <span class="c1"># ModelPixelScaleTag</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ModelPixelScale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">33922</span><span class="p">)</span>  <span class="c1"># ModelTiepointTag</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ModelTiepoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">34264</span><span class="p">)</span>  <span class="c1"># ModelTransformationTag</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ModelTransformation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># if 33550 in tags and 33922 in tags:</span>
        <span class="c1">#     sx, sy, sz = tags[33550].value  # ModelPixelScaleTag</span>
        <span class="c1">#     tiepoints = tags[33922].value  # ModelTiepointTag</span>
        <span class="c1">#     transforms = []</span>
        <span class="c1">#     for tp in range(0, len(tiepoints), 6):</span>
        <span class="c1">#         i, j, k, x, y, z = tiepoints[tp : tp + 6]</span>
        <span class="c1">#         transforms.append(</span>
        <span class="c1">#             [</span>
        <span class="c1">#                 [sx, 0.0, 0.0, x - i * sx],</span>
        <span class="c1">#                 [0.0, -sy, 0.0, y + j * sy],</span>
        <span class="c1">#                 [0.0, 0.0, sz, z - k * sz],</span>
        <span class="c1">#                 [0.0, 0.0, 0.0, 1.0],</span>
        <span class="c1">#             ]</span>
        <span class="c1">#         )</span>
        <span class="c1">#     if len(tiepoints) == 6:</span>
        <span class="c1">#         transforms = transforms[0]</span>
        <span class="c1">#     result[&#39;ModelTransformation&#39;] = transforms</span>

        <span class="n">rpcc</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">valueof</span><span class="p">(</span><span class="mi">50844</span><span class="p">)</span>  <span class="c1"># RPCCoefficientTag</span>
        <span class="k">if</span> <span class="n">rpcc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;RPCCoefficient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;ERR_BIAS&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;ERR_RAND&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;LINE_OFF&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="s1">&#39;SAMP_OFF&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                <span class="s1">&#39;LAT_OFF&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                <span class="s1">&#39;LONG_OFF&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                <span class="s1">&#39;HEIGHT_OFF&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                <span class="s1">&#39;LINE_SCALE&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                <span class="s1">&#39;SAMP_SCALE&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
                <span class="s1">&#39;LAT_SCALE&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
                <span class="s1">&#39;LONG_SCALE&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
                <span class="s1">&#39;HEIGHT_SCALE&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
                <span class="s1">&#39;LINE_NUM_COEFF&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">33</span><span class="p">],</span>
                <span class="s1">&#39;LINE_DEN_COEFF &#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">33</span><span class="p">:</span><span class="mi">53</span><span class="p">],</span>
                <span class="s1">&#39;SAMP_NUM_COEFF&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">53</span><span class="p">:</span><span class="mi">73</span><span class="p">],</span>
                <span class="s1">&#39;SAMP_DEN_COEFF&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">73</span><span class="p">:],</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_reduced</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page is reduced image of another image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subfiletype</span> <span class="o">&amp;</span> <span class="mb">0b1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_multipage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page is part of multi-page image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subfiletype</span> <span class="o">&amp;</span> <span class="mb">0b10</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page is transparency mask for another image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subfiletype</span> <span class="o">&amp;</span> <span class="mb">0b100</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_mrc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page is part of Mixed Raster Content.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subfiletype</span> <span class="o">&amp;</span> <span class="mb">0b1000</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_tiled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains tiled image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="c1"># return 322 in self.tags  # TileWidth</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_subsampled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains chroma subsampled image.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsampling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsampling</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">==</span> <span class="mi">7</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">photometric</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_imagej</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return ImageJ description if exists, else None.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description1</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">description</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ImageJ=&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">description</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_shaped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return description containing array shape if exists, else None.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description1</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span> <span class="ow">or</span> <span class="s1">&#39;&quot;mibi.&#39;</span> <span class="ow">in</span> <span class="n">description</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">description</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;{&#39;</span> <span class="ow">and</span> <span class="s1">&#39;&quot;shape&quot;:&#39;</span> <span class="ow">in</span> <span class="n">description</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">description</span>
            <span class="k">if</span> <span class="n">description</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shape=&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">description</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_mdgel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains MDFileTag tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">33445</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>  <span class="c1"># MDFileTag</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_mediacy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains Media Cybernetics Id tag.&quot;&quot;&quot;</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">50288</span><span class="p">)</span>  <span class="c1"># MC_Id</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;MC TIFF&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_stk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains UIC1Tag tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">33628</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_lsm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains CZ_LSMINFO tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">34412</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_fluoview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains FluoView MM_STAMP tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">34362</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_nih</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains NIHImageHeader tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">43314</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_volumetric</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains SGI ImageDepth tag with value &gt; 1.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedepth</span> <span class="o">&gt;</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_vista</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Software tag is &#39;ISS Vista&#39;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;ISS Vista&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_metaseries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains MDS MetaSeries metadata in ImageDescription tag.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">!=</span> <span class="s1">&#39;MetaSeries&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>
        <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;MetaData&gt;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&lt;/MetaData&gt;&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_ome</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains OME-XML in ImageDescription tag.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;OME&gt;&#39;</span>  <span class="c1"># and [:13] == &#39;&lt;?xml version&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_scn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains Leica SCN XML in ImageDescription tag.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;&lt;/scn&gt;&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_micromanager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains MicroManagerMetadata tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">51123</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_andor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains Andor Technology tags 4864-5030.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">4864</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_pilatus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains Pilatus tags.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TVX TIFF&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;# &#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_epics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains EPICS areaDetector tags.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">==</span> <span class="s1">&#39;EPICS areaDetector&#39;</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;EPICS areaDetector&#39;</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_tvips</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains TVIPS metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">37706</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_fei</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains FEI_SFEG or FEI_HELIOS tags.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">34680</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">or</span> <span class="mi">34682</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_sem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains CZ_SEM tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">34118</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_svs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains Aperio metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Aperio &#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_bif</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains Ventana metadata.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">700</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="c1"># avoid reading XMP tag from file at this point</span>
                <span class="c1"># b&#39;&lt;iScan&#39; in self.tags[700].value[:4096]</span>
                <span class="s1">&#39;Ventana&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">[:</span><span class="mi">17</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ScanOutputManager&#39;</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">==</span> <span class="s1">&#39;Label Image&#39;</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">==</span> <span class="s1">&#39;Label_Image&#39;</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">==</span> <span class="s1">&#39;Probability_Image&#39;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_scanimage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains ScanImage metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SI.&#39;</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;state.&#39;</span>
            <span class="ow">or</span> <span class="s1">&#39;scanimage.SI&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">[</span><span class="o">-</span><span class="mi">256</span><span class="p">:]</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_qpi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains PerkinElmer tissue images metadata.&quot;&quot;&quot;</span>
        <span class="c1"># The ImageDescription tag contains XML with a top-level</span>
        <span class="c1"># &lt;PerkinElmer-QPI-ImageDescription&gt; element</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">[:</span><span class="mi">15</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PerkinElmer-QPI&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_geotiff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains GeoTIFF metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">34735</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>  <span class="c1"># GeoKeyDirectoryTag</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_tiffep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains TIFF/EP metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">37398</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>  <span class="c1"># TIFF/EPStandardID</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_sis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains Olympus SIS metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">33560</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">or</span> <span class="mi">33471</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_ndpi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains NDPI metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">65420</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span> <span class="mi">271</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_philips</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains Philips DP metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Philips DP&#39;</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">[</span><span class="o">-</span><span class="mi">13</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;&lt;/DataObject&gt;&#39;</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_eer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains EER metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">is_bigtiff</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">65000</span><span class="p">,</span> <span class="mi">65001</span><span class="p">)</span>
            <span class="ow">and</span> <span class="mi">65001</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">TiffFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Lightweight TIFF image file directory (IFD).</span>

<span class="sd">    Only a limited number of tag values are read from file.</span>
<span class="sd">    Other tag values are assumed to be identical with a specified TiffPage</span>
<span class="sd">    instance, the keyframe.</span>

<span class="sd">    TiffFrame is intended to reduce resource usage and speed up reading image</span>
<span class="sd">    data from file, not for introspection of metadata.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;index&#39;</span><span class="p">,</span>
        <span class="s1">&#39;parent&#39;</span><span class="p">,</span>
        <span class="s1">&#39;offset&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataoffsets&#39;</span><span class="p">,</span>
        <span class="s1">&#39;databytecounts&#39;</span><span class="p">,</span>
        <span class="s1">&#39;subifds&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jpegtables&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_keyframe&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">is_mdgel</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">pages</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1"># tags = {}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">,</span>
        <span class="n">index</span><span class="p">,</span>
        <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">keyframe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">offsets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bytecounts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize TiffFrame from file or values.</span>

<span class="sd">        The file handle position must be at the offset to a valid IFD.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subifds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jpegtables</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="p">()</span>

        <span class="k">if</span> <span class="n">offsets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># initialize &quot;virtual frame&quot; from offsets and bytecounts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="o">=</span> <span class="n">offsets</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="n">bytecounts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="o">=</span> <span class="n">keyframe</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keyframe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="mi">273</span><span class="p">,</span> <span class="mi">279</span><span class="p">,</span> <span class="mi">324</span><span class="p">,</span> <span class="mi">325</span><span class="p">,</span> <span class="mi">330</span><span class="p">,</span> <span class="mi">347</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">:</span>
            <span class="c1"># use databytecounts from keyframe</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="mi">256</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">324</span><span class="p">,</span> <span class="mi">330</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">databytecounts</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="mi">256</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">279</span><span class="p">,</span> <span class="mi">324</span><span class="p">,</span> <span class="mi">325</span><span class="p">,</span> <span class="mi">330</span><span class="p">,</span> <span class="mi">347</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gettags</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">273</span> <span class="ow">or</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">324</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">279</span> <span class="ow">or</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">325</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">330</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subifds</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">347</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jpegtables</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">256</span> <span class="ow">and</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">imagewidth</span> <span class="o">!=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;incompatible keyframe&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">:</span>
            <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> is missing required tags&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="n">keyframe</span>

    <span class="k">def</span> <span class="nf">_gettags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of (code, TiffTag) from file.&quot;&quot;&quot;</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
        <span class="n">tiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">tiff</span>
        <span class="n">unpack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="n">NullContext</span><span class="p">()</span> <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lock</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tagno</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">tagnoformat</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">tagnosize</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">tagno</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;suspicious number of tags </span><span class="si">{</span><span class="n">tagno</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span><span class="s1">&#39;corrupted tag list&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

            <span class="n">tagoffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">tiff</span><span class="o">.</span><span class="n">tagnosize</span>  <span class="c1"># fh.tell()</span>
            <span class="n">tagsize</span> <span class="o">=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">tagsize</span>
            <span class="n">tagindex</span> <span class="o">=</span> <span class="o">-</span><span class="n">tagsize</span>
            <span class="n">codeformat</span> <span class="o">=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">tagformat1</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">tagbytes</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tagsize</span> <span class="o">*</span> <span class="n">tagno</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tagno</span><span class="p">):</span>
                <span class="n">tagindex</span> <span class="o">+=</span> <span class="n">tagsize</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">codeformat</span><span class="p">,</span> <span class="n">tagbytes</span><span class="p">[</span><span class="n">tagindex</span> <span class="p">:</span> <span class="n">tagindex</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">codes</span> <span class="ow">and</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tag</span> <span class="o">=</span> <span class="n">TiffTag</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                        <span class="n">tagoffset</span> <span class="o">+</span> <span class="n">tagindex</span><span class="p">,</span>
                        <span class="n">tagbytes</span><span class="p">[</span><span class="n">tagindex</span> <span class="p">:</span> <span class="n">tagindex</span> <span class="o">+</span> <span class="n">tagsize</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">TiffFileError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">code</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">tags</span>

    <span class="k">def</span> <span class="nf">_nextifd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return offset to next IFD from file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TiffPage</span><span class="o">.</span><span class="n">_nextifd</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">aspage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return TiffPage from file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot return virtual frame as page&#39;</span><span class="p">)</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
        <span class="n">closed</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">closed</span>
        <span class="k">if</span> <span class="n">closed</span><span class="p">:</span>
            <span class="c1"># this is an inefficient resort in case a user calls aspage</span>
            <span class="c1"># of a TiffFrame with a closed FileHandle.</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> reading TiffPage from closed file&#39;</span><span class="p">,</span> <span class="ne">UserWarning</span>
            <span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">TiffPage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">closed</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">page</span>

    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read image data from file and return as numpy array.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TiffPage</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">aszarr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image data as zarr storage.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TiffPage</span><span class="o">.</span><span class="n">aszarr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">asrgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read image data from file and return RGB image as numpy array.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TiffPage</span><span class="o">.</span><span class="n">asrgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return iterator over decoded segments in TiffFrame.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TiffPage</span><span class="o">.</span><span class="n">segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return keyframe.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span>

    <span class="nd">@keyframe</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set keyframe.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="o">==</span> <span class="n">keyframe</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;cannot reset keyframe&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;incompatible keyframe&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">databytecounts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="o">=</span> <span class="n">keyframe</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_contiguous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return offset and size of contiguous data, else None.&quot;&quot;&quot;</span>
        <span class="c1"># if self._keyframe is None:</span>
        <span class="c1">#     raise RuntimeError(&#39;keyframe not set&#39;)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_memmappable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if page&#39;s image data in file can be memory-mapped.&quot;&quot;&quot;</span>
        <span class="c1"># if self._keyframe is None:</span>
        <span class="c1">#     raise RuntimeError(&#39;keyframe not set&#39;)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span><span class="o">.</span><span class="n">is_memmappable</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return checksum to identify pages in same series.&quot;&quot;&quot;</span>
        <span class="c1"># if self._keyframe is None:</span>
        <span class="c1">#     raise RuntimeError(&#39;keyframe not set&#39;)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span><span class="o">.</span><span class="n">hash</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return attribute from keyframe.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">FRAME_ATTRS</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="c1"># this error could be raised because an AttributeError was</span>
        <span class="c1"># raised inside a @property function</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s1"> object has no attribute </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffFrame </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s1"> @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="si">}</span><span class="s1">&gt;&#39;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">79</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string containing information about TiffFrame.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">s</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="s1">&#39;x&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">TiffPage</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span> <span class="o">-</span> <span class="mi">11</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">detail</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">of</span> <span class="o">=</span> <span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span> <span class="o">-</span> <span class="mi">9</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">detail</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">bc</span> <span class="o">=</span> <span class="n">pformat</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span> <span class="o">-</span> <span class="mi">13</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">detail</span> <span class="o">-</span> <span class="mi">3</span>
            <span class="p">)</span>
            <span class="n">info</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Keyframe </span><span class="si">{</span><span class="n">kf</span><span class="si">}</span><span class="se">\n</span><span class="s1"> Offsets </span><span class="si">{</span><span class="n">of</span><span class="si">}</span><span class="se">\n</span><span class="s1"> Bytecounts </span><span class="si">{</span><span class="n">bc</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;TiffFrame </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s1"> @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">info</span><span class="si">}</span><span class="s1">&#39;</span>


<span class="k">class</span> <span class="nc">TiffTag</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;TIFF tag structure.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : string</span>
<span class="sd">        Name of tag, TIFF.TAGS[code].</span>
<span class="sd">    code : int</span>
<span class="sd">        Decimal code of tag.</span>
<span class="sd">    dtype : int</span>
<span class="sd">        Datatype of tag data. One of TIFF.DATATYPES.</span>
<span class="sd">    count : int</span>
<span class="sd">        Number of values.</span>
<span class="sd">    value : various types</span>
<span class="sd">        Tag data as Python object.</span>
<span class="sd">    valueoffset : int</span>
<span class="sd">        Location of value in file.</span>
<span class="sd">    offset : int</span>
<span class="sd">        Location of tag structure in file.</span>
<span class="sd">    parent : TiffFile or TiffWriter</span>
<span class="sd">        Reference to parent TIFF file.</span>

<span class="sd">    All attributes are read-only.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;parent&#39;</span><span class="p">,</span>
        <span class="s1">&#39;offset&#39;</span><span class="p">,</span>
        <span class="s1">&#39;code&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dtype&#39;</span><span class="p">,</span>
        <span class="s1">&#39;count&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_value&#39;</span><span class="p">,</span>
        <span class="s1">&#39;valueoffset&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">valueoffset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize TiffTag instance from values.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valueoffset</span> <span class="o">=</span> <span class="n">valueoffset</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DATATYPES</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromfile</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return TiffTag instance read from file.&quot;&quot;&quot;</span>
        <span class="n">tiff</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">tiff</span>

        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">tagsize</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>

        <span class="n">valueoffset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">tiff</span><span class="o">.</span><span class="n">tagsize</span> <span class="o">-</span> <span class="n">tiff</span><span class="o">.</span><span class="n">tagoffsetthreshold</span>
        <span class="n">code</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">tagformat1</span><span class="p">,</span> <span class="n">header</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">count</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">tagformat2</span><span class="p">,</span> <span class="n">header</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">valueformat</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DATA_FORMATS</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffTag </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1"> @</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s1">&gt; &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;invalid data type </span><span class="si">{</span><span class="n">dtype</span><span class="si">!r}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">log_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">valuesize</span> <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">valueformat</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">valuesize</span> <span class="o">&gt;</span> <span class="n">tiff</span><span class="o">.</span><span class="n">tagoffsetthreshold</span>
            <span class="ow">or</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_READERS</span>  <span class="c1"># TODO: only works with offsets?</span>
        <span class="p">):</span>
            <span class="n">valueoffset</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_LOAD</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">TiffTag</span><span class="o">.</span><span class="n">_read_value</span><span class="p">(</span>
                    <span class="n">parent</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">valueoffset</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">valueoffset</span> <span class="o">&lt;</span> <span class="mi">8</span>
                <span class="ow">or</span> <span class="n">valueoffset</span> <span class="o">+</span> <span class="n">valuesize</span> <span class="o">&gt;</span> <span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">size</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffTag </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1"> @</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s1">&gt; &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;invalid value offset </span><span class="si">{</span><span class="n">valueoffset</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">log_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_LOAD</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">TiffTag</span><span class="o">.</span><span class="n">_read_value</span><span class="p">(</span>
                    <span class="n">parent</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">valueoffset</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="c1"># BYTES, ASCII, UNDEFINED</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span><span class="n">valuesize</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">tiff</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">42</span>
            <span class="ow">and</span> <span class="n">tiff</span><span class="o">.</span><span class="n">offsetsize</span> <span class="o">==</span> <span class="mi">8</span>
            <span class="ow">and</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">dtype</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00\x00\x00</span><span class="s1">&#39;</span>
        <span class="p">):</span>
            <span class="c1"># NDPI LONG or IFD</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;Q&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">tiff</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span> <span class="n">count</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">valueformat</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">valueformat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">value</span><span class="p">[:</span><span class="n">valuesize</span><span class="p">])</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">TiffTag</span><span class="o">.</span><span class="n">_process_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">valueoffset</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_read_value</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">valueoffset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read tag value from file.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">valueformat</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DATA_FORMATS</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffTag </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1"> @</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s1">&gt; &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;invalid data type </span><span class="si">{</span><span class="n">dtype</span><span class="si">!r}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

        <span class="n">fh</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
        <span class="n">tiff</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">tiff</span>

        <span class="n">valuesize</span> <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">valueformat</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">valueoffset</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">valueoffset</span> <span class="o">&lt;</span> <span class="mi">8</span>
            <span class="ow">or</span> <span class="n">valueoffset</span> <span class="o">+</span> <span class="n">valuesize</span> <span class="o">&gt;</span> <span class="n">fh</span><span class="o">.</span><span class="n">size</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffTag </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1"> @</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s1">&gt; &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;invalid value offset </span><span class="si">{</span><span class="n">valueoffset</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
        <span class="c1"># if valueoffset % 2:</span>
        <span class="c1">#     log_warning(</span>
        <span class="c1">#         f&#39;&lt;tifffile.TiffTag {code} @{offset}&gt; &#39;</span>
        <span class="c1">#         &#39;value does not begin on word boundary&#39;</span>
        <span class="c1">#     )</span>

        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">valueoffset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_READERS</span><span class="p">:</span>
            <span class="n">readfunc</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_READERS</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">readfunc</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">tiff</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">tiff</span><span class="o">.</span><span class="n">offsetsize</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="c1"># BYTES, ASCII, UNDEFINED</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">valuesize</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="n">valuesize</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffTag </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1"> @</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s1">&gt; &#39;</span>
                    <span class="s1">&#39;could not read all values&#39;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_TUPLE</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">read_numpy</span><span class="p">(</span>
                <span class="n">fh</span><span class="p">,</span> <span class="n">tiff</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">tiff</span><span class="o">.</span><span class="n">offsetsize</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">tiff</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span> <span class="n">count</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">valueformat</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">valueformat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">valuesize</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_process_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process tag value. .&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># BYTE</span>
            <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">7</span>  <span class="c1"># UNDEFINED</span>
            <span class="ow">or</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_READERS</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># TIFF ASCII fields can contain multiple strings,</span>
            <span class="c1">#   each terminated with a NUL</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffTag </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1"> @</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s1">&gt; &#39;</span>
                    <span class="s1">&#39;coercing invalid ASCII to bytes&#39;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_ENUM</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_ENUM</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">259</span><span class="p">,</span> <span class="mi">317</span><span class="p">):</span>  <span class="c1"># ignore compression/predictor</span>
                    <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffTag </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1"> @</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s1">&gt; </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_TUPLE</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return value of tag. Load from file if necessary.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># print(</span>
            <span class="c1">#     f&#39;_read_value {self.code} {TIFF.TAGS.get(self.code)} &#39;</span>
            <span class="c1">#     f&#39;{self.dtype}[{self.count}] @{self.valueoffset} &#39;</span>
            <span class="c1"># )</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
            <span class="k">with</span> <span class="n">fh</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="n">closed</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">closed</span>
                <span class="k">if</span> <span class="n">closed</span><span class="p">:</span>
                    <span class="c1"># this is an inefficient resort in case a user delay loads</span>
                    <span class="c1"># tag values from a TiffPage with a closed FileHandle.</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> reading value from closed file&#39;</span><span class="p">,</span> <span class="ne">UserWarning</span>
                    <span class="p">)</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">TiffTag</span><span class="o">.</span><span class="n">_read_value</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">valueoffset</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">closed</span><span class="p">:</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">TiffTag</span><span class="o">.</span><span class="n">_process_value</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

    <span class="nd">@value</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtype_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;TYPE</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return name of tag from TIFF.TAGS registry.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAGS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dataformat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return data type as Python struct format.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DATA_FORMATS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">valuebytecount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return size of value in file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">*</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">DATA_FORMATS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_astuple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return tag code, dtype, count, and encoded value.</span>

<span class="sd">        The encoded value is read from file if necessary.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: make this method public</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataformat</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DATA_FORMATS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>
            <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">dataformat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">tiff</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">dataformat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">tiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">tiff</span>
                <span class="k">if</span> <span class="n">tiff</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">42</span> <span class="ow">and</span> <span class="n">tiff</span><span class="o">.</span><span class="n">offsetsize</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                        <span class="s1">&#39;cannot read from NDPI &gt; 4 GB files&#39;</span>
                    <span class="p">)</span>
                <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valueoffset</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">))</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">overwrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">_arg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">erase</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write new tag value to file and return new TiffTag instance.</span>

<span class="sd">        The value must be compatible with the struct.pack formats in</span>
<span class="sd">        TIFF.DATA_FORMATS.</span>

<span class="sd">        The new packed value is appended to the file if it is longer than the</span>
<span class="sd">        old value. The old value is zeroed. The file position is left where it</span>
<span class="sd">        was.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">valueoffset</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cannot rewrite tag at offset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="si">}</span><span class="s1"> &lt; 8&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;filehandle&#39;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">_arg</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;&lt;tifffile.TiffTag.overwrite&gt; passing a TiffFile instance is &#39;</span>
                <span class="s1">&#39;deprecated and no longer required since 2021.7.30.&#39;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
        <span class="n">tiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">tiff</span>

        <span class="k">if</span> <span class="n">tiff</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">42</span> <span class="ow">and</span> <span class="n">tiff</span><span class="o">.</span><span class="n">offsetsize</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="c1"># TODO: support patching NDPI &gt; 4 GB files</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;cannot patch NDPI &gt; 4 GB files&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dataformat</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DATA_FORMATS</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dataformat</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">dataformat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;&lt;&gt;&#39;</span><span class="p">:</span>
                    <span class="n">dataformat</span> <span class="o">=</span> <span class="n">dataformat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DATA_DTYPES</span><span class="p">[</span><span class="n">dataformat</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unknown dtype </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># strings</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="c1"># enforce 7-bit ASCII on Unicode strings</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">UnicodeEncodeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;TIFF strings must be 7-bit ASCII&#39;</span>
                    <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;TIFF strings must be 7-bit ASCII&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="c1"># pre-packed binary data</span>
            <span class="n">dtsize</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">dataformat</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">%</span> <span class="n">dtsize</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid packed binary data&#39;</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">//</span> <span class="n">dtsize</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,)</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid RATIONAL value&#39;</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">//=</span> <span class="mi">2</span>  <span class="c1"># rational</span>

        <span class="n">packedvalue</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">{}{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">tiff</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span> <span class="n">count</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">dataformat</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dataformat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="o">*</span><span class="n">value</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">newsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">packedvalue</span><span class="p">)</span>
        <span class="n">oldsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">*</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">DATA_FORMATS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">])</span>
        <span class="n">valueoffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valueoffset</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
                <span class="c1"># rewrite data type</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">oldsize</span> <span class="o">&lt;=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">tagoffsetthreshold</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">newsize</span> <span class="o">&lt;=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">tagoffsetthreshold</span><span class="p">:</span>
                    <span class="c1"># inline -&gt; inline: overwrite</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">tagformat2</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">packedvalue</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># inline -&gt; separate: append to file</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>
                    <span class="n">valueoffset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">valueoffset</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="c1"># value offset must begin on a word boundary</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">valueoffset</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">packedvalue</span><span class="p">)</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
                            <span class="n">tiff</span><span class="o">.</span><span class="n">tagformat2</span><span class="p">,</span>
                            <span class="n">count</span><span class="p">,</span>
                            <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">valueoffset</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">newsize</span> <span class="o">&lt;=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">tagoffsetthreshold</span><span class="p">:</span>
                <span class="c1"># separate -&gt; inline: erase old value</span>
                <span class="n">valueoffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">tiff</span><span class="o">.</span><span class="n">offsetsize</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">tagformat2</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">packedvalue</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">erase</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valueoffset</span><span class="p">)</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="n">oldsize</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">newsize</span> <span class="o">&lt;=</span> <span class="n">oldsize</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">valueoffset</span> <span class="o">+</span> <span class="n">oldsize</span> <span class="o">==</span> <span class="n">fh</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="c1"># separate -&gt; separate smaller: overwrite, erase remaining</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valueoffset</span><span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">packedvalue</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">erase</span> <span class="ow">and</span> <span class="n">oldsize</span> <span class="o">-</span> <span class="n">newsize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">oldsize</span> <span class="o">-</span> <span class="n">newsize</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># separate -&gt; separate larger: erase old value, append to file</span>
                <span class="k">if</span> <span class="n">erase</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valueoffset</span><span class="p">)</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="n">oldsize</span><span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>
                <span class="n">valueoffset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">valueoffset</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># value offset must begin on a word boundary</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">valueoffset</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">packedvalue</span><span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
                        <span class="n">tiff</span><span class="o">.</span><span class="n">tagformat2</span><span class="p">,</span>
                        <span class="n">count</span><span class="p">,</span>
                        <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">valueoffset</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>  <span class="c1"># must restore file position</span>

        <span class="k">return</span> <span class="n">TiffTag</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
            <span class="n">dtype</span><span class="p">,</span>
            <span class="n">count</span><span class="p">,</span>
            <span class="n">value</span><span class="p">,</span>
            <span class="n">valueoffset</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fix_lsm_bitspersample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Correct LSM bitspersample tag.</span>

<span class="sd">        Old LSM writers may use a separate region for two 16-bit values,</span>
<span class="sd">        although they fit into the tag value element of the tag.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">!=</span> <span class="mi">258</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># TODO: test this case; need example file</span>
        <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1"> correcting LSM bitspersample tag&#39;</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;HH&#39;</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valueoffset</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valueoffset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;HH&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffTag </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s1"> @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="si">}</span><span class="s1">&gt;&#39;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">79</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string containing information about TiffTag.&quot;&quot;&quot;</span>
        <span class="n">height</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">detail</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">detail</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype_name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s1">]&#39;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">TAGS</span><span class="o">.</span><span class="n">getall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="p">()))</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s1"> @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;TiffTag </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s1"> @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">valueoffset</span><span class="si">}</span><span class="s1"> &#39;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">width</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="k">except</span> <span class="n">TiffFileError</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;CORRUPT&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">enumstr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">pformat</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">enumstr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">pformat</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">detail</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[:</span><span class="n">width</span><span class="p">]</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">width</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">line</span>


<span class="k">class</span> <span class="nc">TiffTags</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Multidict like interface to TiffTag instances in TiffPage.</span>

<span class="sd">    Differences to a regular dict:</span>

<span class="sd">    * values are instances of TiffTag.</span>
<span class="sd">    * keys are TiffTag.code (int).</span>
<span class="sd">    * multiple values can be stored per key.</span>
<span class="sd">    * can be indexed with TiffTag.name (str), although slower than by key.</span>
<span class="sd">    * iter() returns values instead of keys.</span>
<span class="sd">    * values() and items() contain all values sorted by offset stored in file.</span>
<span class="sd">    * len() returns the number of all values.</span>
<span class="sd">    * get() takes an optional index argument.</span>
<span class="sd">    * some functions are not implemented, e.g. update, setdefault, pop.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_dict&#39;</span><span class="p">,</span> <span class="s1">&#39;_list&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize empty instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a tag.&quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">code</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">code</span><span class="p">:</span> <span class="n">tag</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return new view of all codes.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all tags in order they are stored in file.&quot;&quot;&quot;</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all (code, tag) pairs in order tags are stored in file.&quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">valueof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return value of tag if exists, else default.&quot;&quot;&quot;</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span>
        <span class="k">except</span> <span class="n">TiffFileError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>  <span class="c1"># corrupted tag</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return tag of code or name if exists, else default.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tags</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tag</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">getall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of all tags of code or name if exists, else default.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tags</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">for</span> <span class="n">tags</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">result</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="n">default</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return first tag of code or name. Raise KeyError if not found.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tag</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a tag.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete all tags of code or name.&quot;&quot;&quot;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">tags</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">del</span> <span class="n">tags</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tags</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">tags</span><span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">code</span><span class="p">]</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if tag is in map.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">item</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return iterator over all tags.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of tags.&quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">size</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffTags @0x</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">:</span><span class="s1">016X</span><span class="si">}</span><span class="s1">&gt;&#39;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">79</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string with information about TiffTags.&quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tlines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vlines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">tlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">[:</span><span class="n">width</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">detail</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">width</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># delay load failed or closed file</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">detail</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">tag</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">273</span><span class="p">,</span> <span class="mi">279</span><span class="p">,</span> <span class="mi">324</span><span class="p">,</span> <span class="mi">325</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">pformat</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">detail</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">pformat</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">detail</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">vlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">tag</span><span class="o">.</span><span class="n">dtype_name</span><span class="si">}</span><span class="s1">[</span><span class="si">{</span><span class="n">tag</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s1">]</span><span class="se">\n</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tlines</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">detail</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">vlines</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vlines</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TiffTagRegistry</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Registry of TIFF tag codes and names.</span>

<span class="sd">    The registry allows to look up tag codes and names by indexing with names</span>
<span class="sd">    and codes respectively.</span>
<span class="sd">    One tag code may be registered with several names, e.g. 34853 is used for</span>
<span class="sd">    GPSTag or OlympusSIS2.</span>
<span class="sd">    Different tag codes may be registered with the same name, e.g. 37387 and</span>
<span class="sd">    41483 are both named FlashEnergy.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_dict&#39;</span><span class="p">,</span> <span class="s1">&#39;_list&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add codes and names from sequence or dict to registry.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">TiffTagRegistry</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">_list</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add code and name to registry.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">code</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">code</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all registry items as (code, name).&quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return first code/name if exists, else default.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">getall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of all codes/names if exists, else default.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="n">default</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return first code/name. Raise KeyError if not found.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete all tags of code or name.&quot;&quot;&quot;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if code or name is in registry.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return iterator over all items in registry.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of registered tags.&quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffTagRegistry @0x</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">:</span><span class="s1">016X</span><span class="si">}</span><span class="s1">&gt;&#39;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string with information about TiffTags.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;TiffTagRegistry(((</span><span class="se">\n</span><span class="s1">  </span><span class="si">{}</span><span class="se">\n</span><span class="s1">))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s1">)&#39;</span> <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">TiffPageSeries</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Series of TIFF pages with compatible shape and data type (same hash).</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    pages : list of TiffPage, TiffFrame, or None</span>
<span class="sd">        Sequence of TiffPages or TiffFrame in series.</span>
<span class="sd">        May be None if pages or files of pages are missing in the series.</span>
<span class="sd">        The file handles of TiffPages or TiffFrames may not be open.</span>
<span class="sd">    keyframe : TiffPage</span>
<span class="sd">        A key frame of the series.</span>
<span class="sd">    dtype : numpy.dtype</span>
<span class="sd">        Data type (native byte order) of the image array in series.</span>
<span class="sd">    shape : tuple</span>
<span class="sd">        Dimensions of the image array in series.</span>
<span class="sd">    axes : str</span>
<span class="sd">        Labels of axes in shape. See TIFF.AXES_LABELS.</span>
<span class="sd">    offset : int or None</span>
<span class="sd">        Position of image data in file if memory-mappable, else None.</span>
<span class="sd">    levels : list of TiffPageSeries</span>
<span class="sd">        Pyramid levels. levels[0] is &#39;self&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pages</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">kind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">truncated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">multifile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span> <span class="o">=</span> <span class="n">pages</span>  <span class="c1"># might contain only first of contiguous pages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_shape_axes</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">squeeze</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span> <span class="k">if</span> <span class="n">kind</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">keyframe</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pages</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_multifile</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">multifile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="k">elif</span> <span class="n">pages</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">truncated</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">//</span> <span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_shape_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set shape and axes.&quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
        <span class="c1"># expanded shape according to metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shape_expanded</span> <span class="o">=</span> <span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_axes_expanded</span> <span class="o">=</span> <span class="n">axes</span>
        <span class="c1"># squeezed shape and axes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shape_squeezed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_squeezed</span> <span class="o">=</span> <span class="n">squeeze_axes</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span>
        <span class="c1"># default shape and axes returned by asarray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape_squeezed</span> <span class="k">if</span> <span class="n">squeeze</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape_expanded</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_squeezed</span> <span class="k">if</span> <span class="n">squeeze</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_expanded</span>

    <span class="k">def</span> <span class="nf">get_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return default, squeezed, or expanded shape.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">squeeze</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape_squeezed</span> <span class="k">if</span> <span class="n">squeeze</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape_expanded</span>

    <span class="k">def</span> <span class="nf">get_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return default, squeezed, or expanded axes.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">squeeze</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_squeezed</span> <span class="k">if</span> <span class="n">squeeze</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_expanded</span>

    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image data from series of TIFF pages as numpy array.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">aszarr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image data from series of TIFF pages as zarr storage.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZarrTiffStore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return offset to series data in file, if any.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">page</span><span class="o">.</span><span class="n">is_final</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pos</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">!=</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">is_imagej</span> <span class="ow">or</span> <span class="n">page</span><span class="o">.</span><span class="n">is_shaped</span> <span class="ow">or</span> <span class="n">page</span><span class="o">.</span><span class="n">is_stk</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span>
        <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># truncated files</span>
            <span class="k">return</span> <span class="n">offset</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">offset</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_pyramidal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if series contains several levels.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of array dimensions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of elements in array.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return sequence of all pages in series.&quot;&quot;&quot;</span>
        <span class="c1"># a workaround to keep the old interface working</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_getitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return specified page of series from cache or file.&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">%=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">key</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return specified page(s).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_len</span><span class="p">))]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;key must be an integer, slice, or iterable&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return iterator over pages in series.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">pages</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_len</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">pages</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of pages in series.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffPageSeries </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s1">&gt;&#39;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string with information about TiffPageSeries.&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">s</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">snipstr</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;x&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span>
                <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span><span class="si">}</span><span class="s1"> Levels&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_pyramidal</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s1"> Pages&#39;</span><span class="p">,</span>
                <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;TiffPageSeries </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">&#39;</span>


<span class="k">class</span> <span class="nc">ZarrStore</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Zarr storage base class.</span>

<span class="sd">    ZarrStore instances must be closed using the &#39;close&#39; method, which is</span>
<span class="sd">    automatically called when using the &#39;with&#39; context manager.</span>

<span class="sd">    https://zarr.readthedocs.io/en/stable/spec/v2.html</span>
<span class="sd">    https://forum.image.sc/t/multiscale-arrays-v0-1/37930</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunkmode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize ZarrStore.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fillvalue</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">fillvalue</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fillvalue</span>
        <span class="k">if</span> <span class="n">chunkmode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chunkmode</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CHUNKMODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chunkmode</span> <span class="o">=</span> <span class="n">enumarg</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">CHUNKMODE</span><span class="p">,</span> <span class="n">chunkmode</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close ZarrStore.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flush ZarrStore.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">PermissionError</span><span class="p">(</span><span class="s1">&#39;ZarrStore is read-only&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear ZarrStore.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">PermissionError</span><span class="p">(</span><span class="s1">&#39;ZarrStore is read-only&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return keys in ZarrStore.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return items in ZarrStore.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return values in ZarrStore.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">PermissionError</span><span class="p">(</span><span class="s1">&#39;ZarrStore is read-only&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">PermissionError</span><span class="p">(</span><span class="s1">&#39;ZarrStore is read-only&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return chunk from file.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_multiscales</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if ZarrStore is multiscales.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;multiscales&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">[</span><span class="s1">&#39;.zattrs&#39;</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_empty_chunk</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">fillvalue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return empty chunk.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fillvalue</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">fillvalue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="n">chunk</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">fillvalue</span>
        <span class="k">return</span> <span class="n">chunk</span>  <span class="c1"># .tobytes()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return dtype as string with native byte order.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">byteorder</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">byteorder</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;big&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">}[</span><span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">byteorder</span> <span class="o">+</span> <span class="n">dtype</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_json</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Serialize obj to a JSON formatted string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="n">obj</span><span class="p">,</span>
            <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return value which is serializable to JSON.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s1">&#39;ui&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">&#39;NaN&#39;</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isposinf</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">&#39;Infinity&#39;</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isneginf</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">&#39;-Infinity&#39;</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_value</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_value</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">()</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_ndindex</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">chunks</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return iterator over all chunk index strings.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
        <span class="n">chunked</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">i</span> <span class="o">//</span> <span class="n">j</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">j</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">chunks</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="n">chunked</span><span class="p">):</span>
            <span class="k">yield</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ZarrTiffStore</span><span class="p">(</span><span class="n">ZarrStore</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Zarr storage interface to image data in TiffPage or TiffPageSeries.</span>

<span class="sd">    ZarrTiffStore instances are using a TiffFile instance for reading and</span>
<span class="sd">    decoding chunks. Therefore ZarrTiffStore instances cannot be pickled.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">arg</span><span class="p">,</span>
        <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">chunkmode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fillvalue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">zattrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lock</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">squeeze</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">maxworkers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_openfiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize Zarr storage.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arg : TiffPage or TiffPageSeries</span>
<span class="sd">            The TiffPage or TiffPageSeries instance to wrap as a zarr store.</span>
<span class="sd">        level : int (optional)</span>
<span class="sd">            Specifies a pyramidal level to wrap.</span>
<span class="sd">        chunkmode : {0, 2} (optional)</span>
<span class="sd">            Specifies to use strips/tiles (0, the default) or whole page data</span>
<span class="sd">            (2) as chunks.</span>
<span class="sd">        fillvalue : number (optional)</span>
<span class="sd">            Value to use for missing chunks of the Zarr store. Default: 0.</span>
<span class="sd">        zattrs : dict (optional)</span>
<span class="sd">            Additional attributes to store in .zattrs.</span>
<span class="sd">        lock : {RLock, NullContext} (optional)</span>
<span class="sd">            A reentrant lock used to synchronize seeks and reads from file.</span>
<span class="sd">            If None (default), the lock of the parent&#39;s filehandle is used.</span>
<span class="sd">        squeeze : bool (optional)</span>
<span class="sd">            Squeeze shape of TiffPageSeries.</span>
<span class="sd">        maxworkers : int or None</span>
<span class="sd">            Maximum number of threads to concurrently decode strips or tiles</span>
<span class="sd">            if chunkmode=2.  If None (default), up to half the CPU cores are</span>
<span class="sd">            used. See remarks in TiffFile.asarray.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fillvalue</span><span class="o">=</span><span class="n">fillvalue</span><span class="p">,</span> <span class="n">chunkmode</span><span class="o">=</span><span class="n">chunkmode</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunkmode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_chunkmode</span><span class="si">!r}</span><span class="s1"> not implemented&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_maxworkers</span> <span class="o">=</span> <span class="n">maxworkers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_squeeze</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">squeeze</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">bool</span><span class="p">(</span><span class="n">squeeze</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;transform&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;levels&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">TiffPageSeries</span><span class="p">([</span><span class="n">arg</span><span class="p">])])</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">level</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">filehandle</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">lock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filecache</span> <span class="o">=</span> <span class="n">FileCache</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">_openfiles</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="n">lock</span><span class="p">)</span>

        <span class="n">zattrs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">zattrs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="n">zattrs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># multiscales</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">[</span><span class="s1">&#39;.zgroup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_json</span><span class="p">({</span><span class="s1">&#39;zarr_format&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">[</span><span class="s1">&#39;.zattrs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_json</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s1">&#39;multiscales&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;datasets&#39;</span><span class="p">:</span> <span class="p">[</span>
                                <span class="p">{</span><span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)}</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">))</span>
                            <span class="p">],</span>
                            <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">{},</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="c1"># &#39;type&#39;: &#39;gaussian&#39;,</span>
                            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;0.1&#39;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">],</span>
                    <span class="o">**</span><span class="n">zattrs</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">):</span>
                <span class="n">series</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">decode</span>  <span class="c1"># cache decode function</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="n">squeeze</span><span class="p">)</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">dtype</span>
                <span class="k">if</span> <span class="n">fillvalue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fillvalue</span> <span class="o">=</span> <span class="n">fillvalue</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">nodata</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunkmode</span><span class="p">:</span>
                    <span class="n">chunks</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">chunks</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">chunks</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s1">/.zarray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_json</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;zarr_format&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">,</span>
                        <span class="s1">&#39;chunks&#39;</span><span class="p">:</span> <span class="n">ZarrTiffStore</span><span class="o">.</span><span class="n">_chunks</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">shape</span><span class="p">),</span>
                        <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">),</span>
                        <span class="s1">&#39;compressor&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;fill_value&#39;</span><span class="p">:</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_value</span><span class="p">(</span><span class="n">fillvalue</span><span class="p">,</span> <span class="n">dtype</span><span class="p">),</span>
                        <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">series</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">decode</span>  <span class="c1"># cache decode function</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="n">squeeze</span><span class="p">)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">dtype</span>
            <span class="k">if</span> <span class="n">fillvalue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fillvalue</span> <span class="o">=</span> <span class="n">fillvalue</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">nodata</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunkmode</span><span class="p">:</span>
                <span class="n">chunks</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chunks</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">chunks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">[</span><span class="s1">&#39;.zattrs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_json</span><span class="p">(</span><span class="n">zattrs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">[</span><span class="s1">&#39;.zarray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_json</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s1">&#39;zarr_format&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">,</span>
                    <span class="s1">&#39;chunks&#39;</span><span class="p">:</span> <span class="n">ZarrTiffStore</span><span class="o">.</span><span class="n">_chunks</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">shape</span><span class="p">),</span>
                    <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">),</span>
                    <span class="s1">&#39;compressor&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;fill_value&#39;</span><span class="p">:</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_value</span><span class="p">(</span><span class="n">fillvalue</span><span class="p">,</span> <span class="n">dtype</span><span class="p">),</span>
                    <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close ZarrTiffStore.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_filecache&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filecache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">write_fsspec</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">arg</span><span class="p">,</span>
        <span class="n">url</span><span class="p">,</span>
        <span class="n">groupname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compressors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_append</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write fsspec ReferenceFileSystem as JSON to file.</span>

<span class="sd">        Url is the remote location of the TIFF file without the file name(s).</span>

<span class="sd">        Raise ValueError if TIFF store can not be represented as</span>
<span class="sd">        ReferenceFileSystem due to features that are not supported by zarr,</span>
<span class="sd">        numcodecs, or imagecodecs:</span>

<span class="sd">        * compressors, e.g. CCITT</span>
<span class="sd">        * filters, e.g. bitorder reversal, packed integers</span>
<span class="sd">        * dtypes, e.g. float24</span>
<span class="sd">        * JPEGTables in multi-page files</span>
<span class="sd">        * incomplete chunks, e.g. if imagelength % rowsperstrip != 0</span>

<span class="sd">        Files containing incomplete tiles may fail at runtime.</span>

<span class="sd">        https://github.com/intake/fsspec-reference-maker</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">compressors</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;zlib&#39;</span><span class="p">,</span>
            <span class="mi">32946</span><span class="p">:</span> <span class="s1">&#39;zlib&#39;</span><span class="p">,</span>
            <span class="mi">34925</span><span class="p">:</span> <span class="s1">&#39;lzma&#39;</span><span class="p">,</span>
            <span class="mi">50000</span><span class="p">:</span> <span class="s1">&#39;zstd&#39;</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_lzw&#39;</span><span class="p">,</span>
            <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_jpeg&#39;</span><span class="p">,</span>
            <span class="mi">22610</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_jpegxr&#39;</span><span class="p">,</span>  <span class="c1"># NDPI</span>
            <span class="mi">32773</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_packbits&#39;</span><span class="p">,</span>
            <span class="mi">33003</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_jpeg2k&#39;</span><span class="p">,</span>
            <span class="mi">33004</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_jpeg2k&#39;</span><span class="p">,</span>
            <span class="mi">33005</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_jpeg2k&#39;</span><span class="p">,</span>
            <span class="mi">33007</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_jpeg&#39;</span><span class="p">,</span>  <span class="c1"># ALT_JPG</span>
            <span class="mi">34712</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_jpeg2k&#39;</span><span class="p">,</span>
            <span class="mi">34887</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_lerc&#39;</span><span class="p">,</span>
            <span class="mi">34892</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_jpeg&#39;</span><span class="p">,</span>  <span class="c1"># DNG lossy</span>
            <span class="mi">34933</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_png&#39;</span><span class="p">,</span>
            <span class="mi">34934</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_jpegxr&#39;</span><span class="p">,</span>  <span class="c1"># ZIF</span>
            <span class="mi">50001</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_webp&#39;</span><span class="p">,</span>
            <span class="mi">50002</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_jpegxl&#39;</span><span class="p">,</span>
            <span class="o">**</span><span class="p">({}</span> <span class="k">if</span> <span class="n">compressors</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">compressors</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">series</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="n">errormsg</span> <span class="o">=</span> <span class="s1">&#39; not supported by the fsspec ReferenceFileSystem&#39;</span>
            <span class="n">keyframe</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">keyframe</span>
            <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">compression</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compressors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyframe</span><span class="o">.</span><span class="n">compression</span><span class="si">!r}</span><span class="s1"> is&#39;</span> <span class="o">+</span> <span class="n">errormsg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">fillorder</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyframe</span><span class="o">.</span><span class="n">fillorder</span><span class="si">!r}</span><span class="s1"> is&#39;</span> <span class="o">+</span> <span class="n">errormsg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">sampleformat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
                <span class="c1"># TODO: support float24 and cint via filters?</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyframe</span><span class="o">.</span><span class="n">sampleformat</span><span class="si">!r}</span><span class="s1"> is&#39;</span> <span class="o">+</span> <span class="n">errormsg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">bitspersample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="mi">8</span><span class="p">,</span>
                <span class="mi">16</span><span class="p">,</span>
                <span class="mi">32</span><span class="p">,</span>
                <span class="mi">64</span><span class="p">,</span>
                <span class="mi">128</span><span class="p">,</span>
            <span class="p">)</span> <span class="ow">and</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">compression</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="mi">7</span><span class="p">,</span>
                <span class="mi">33007</span><span class="p">,</span>
                <span class="mi">34892</span><span class="p">,</span>
            <span class="p">):</span>  <span class="c1"># JPEG</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;BitsPerSample </span><span class="si">{</span><span class="n">keyframe</span><span class="o">.</span><span class="n">bitspersample</span><span class="si">}</span><span class="s1"> is&#39;</span> <span class="o">+</span> <span class="n">errormsg</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunkmode</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">is_tiled</span>
                <span class="ow">and</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">imagelength</span> <span class="o">%</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">rowsperstrip</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;incomplete chunks are&#39;</span> <span class="o">+</span> <span class="n">errormsg</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunkmode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">is_final</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_chunkmode</span><span class="si">!r}</span><span class="s1"> is&#39;</span> <span class="o">+</span> <span class="n">errormsg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">jpegtables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;JPEGTables in multi-page files are&#39;</span> <span class="o">+</span> <span class="n">errormsg</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="n">url</span> <span class="ow">and</span> <span class="n">url</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>

        <span class="k">if</span> <span class="n">groupname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">groupname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="n">groupname</span> <span class="ow">and</span> <span class="n">groupname</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">groupname</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>

        <span class="n">byteorder</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;big&#39;</span> <span class="k">else</span> <span class="s1">&#39;&gt;&#39;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">!=</span> <span class="n">byteorder</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="n">byteorder</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">refs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_append</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot append to version 1&#39;</span><span class="p">)</span>
            <span class="n">refs</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">refs</span><span class="p">[</span><span class="s1">&#39;templates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">refs</span><span class="p">[</span><span class="s1">&#39;gen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">templates</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_multifile</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;u</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="n">templates</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;{{</span><span class="si">%s</span><span class="s1">}}&#39;</span> <span class="o">%</span> <span class="n">key</span>
                    <span class="n">refs</span><span class="p">[</span><span class="s1">&#39;templates&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="n">fname</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">name</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;u&#39;</span>
                <span class="n">templates</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;{{</span><span class="si">%s</span><span class="s1">}}&#39;</span> <span class="o">%</span> <span class="n">key</span>
                <span class="n">refs</span><span class="p">[</span><span class="s1">&#39;templates&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="n">fname</span>

            <span class="n">refs</span><span class="p">[</span><span class="s1">&#39;refs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refzarr</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">refzarr</span> <span class="o">=</span> <span class="n">refs</span>

        <span class="k">if</span> <span class="n">groupname</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_append</span><span class="p">:</span>
            <span class="c1"># TODO: support nested groups</span>
            <span class="n">refzarr</span><span class="p">[</span><span class="s1">&#39;.zgroup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_json</span><span class="p">({</span><span class="s1">&#39;zarr_format&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;.zarray&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">keyframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">keyframe</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">codec_id</span> <span class="o">=</span> <span class="n">compressors</span><span class="p">[</span><span class="n">keyframe</span><span class="o">.</span><span class="n">compression</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">codec_id</span> <span class="o">==</span> <span class="s1">&#39;imagecodecs_jpeg&#39;</span><span class="p">:</span>
                    <span class="c1"># TODO: handle JPEG colorspaces</span>
                    <span class="n">tables</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">jpegtables</span>
                    <span class="k">if</span> <span class="n">tables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">base64</span>

                        <span class="n">tables</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">jpegheader</span>
                    <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">base64</span>

                        <span class="n">header</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                    <span class="n">colorspace_jpeg</span><span class="p">,</span> <span class="n">colorspace_data</span> <span class="o">=</span> <span class="n">jpeg_decode_colorspace</span><span class="p">(</span>
                        <span class="n">keyframe</span><span class="o">.</span><span class="n">photometric</span><span class="p">,</span>
                        <span class="n">keyframe</span><span class="o">.</span><span class="n">planarconfig</span><span class="p">,</span>
                        <span class="n">keyframe</span><span class="o">.</span><span class="n">extrasamples</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">value</span><span class="p">[</span><span class="s1">&#39;compressor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">codec_id</span><span class="p">,</span>
                        <span class="s1">&#39;tables&#39;</span><span class="p">:</span> <span class="n">tables</span><span class="p">,</span>
                        <span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">,</span>
                        <span class="s1">&#39;bitspersample&#39;</span><span class="p">:</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">bitspersample</span><span class="p">,</span>
                        <span class="s1">&#39;colorspace_jpeg&#39;</span><span class="p">:</span> <span class="n">colorspace_jpeg</span><span class="p">,</span>
                        <span class="s1">&#39;colorspace_data&#39;</span><span class="p">:</span> <span class="n">colorspace_data</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="k">elif</span> <span class="n">codec_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">value</span><span class="p">[</span><span class="s1">&#39;compressor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">codec_id</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">predictor</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># predictors need access to chunk shape and dtype</span>
                    <span class="c1"># requires imagecodecs &gt; 2021.8.26 to read</span>
                    <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">predictor</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">34892</span><span class="p">,</span> <span class="mi">34893</span><span class="p">):</span>
                        <span class="n">filter_id</span> <span class="o">=</span> <span class="s1">&#39;imagecodecs_delta&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">filter_id</span> <span class="o">=</span> <span class="s1">&#39;imagecodecs_floatpred&#39;</span>
                    <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">predictor</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">dist</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">predictor</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">34892</span><span class="p">,</span> <span class="mi">34894</span><span class="p">):</span>
                        <span class="n">dist</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dist</span> <span class="o">=</span> <span class="mi">4</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">keyframe</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span>
                        <span class="ow">and</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">samplesperpixel</span> <span class="o">&gt;</span> <span class="mi">1</span>
                    <span class="p">):</span>
                        <span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">value</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">filter_id</span><span class="p">,</span>
                            <span class="s1">&#39;axis&#39;</span><span class="p">:</span> <span class="n">axis</span><span class="p">,</span>
                            <span class="s1">&#39;dist&#39;</span><span class="p">:</span> <span class="n">dist</span><span class="p">,</span>
                            <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;chunks&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">],</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">value</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">byteorder</span> <span class="o">+</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_json</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="n">refzarr</span><span class="p">[</span><span class="n">groupname</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">):</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">refs</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;}&quot;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;}&quot;&#39;</span><span class="p">)</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span>
        <span class="k">elif</span> <span class="n">_append</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">refs</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">refs</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;.zarray&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
                <span class="n">chunks</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;chunks&#39;</span><span class="p">]</span>
                <span class="n">level</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">chunkindex</span> <span class="ow">in</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_ndindex</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">chunks</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">level</span> <span class="o">+</span> <span class="n">chunkindex</span>
                    <span class="n">keyframe</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytecount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">page</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunkmode</span> <span class="ow">and</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">offset</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">bytecount</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">nbytes</span>
                    <span class="k">if</span> <span class="n">offset</span> <span class="ow">and</span> <span class="n">bytecount</span><span class="p">:</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">name</span>
                        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">fname</span> <span class="o">=</span> <span class="n">templates</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}{</span><span class="n">fname</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;,</span><span class="se">\n</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s1">&quot;</span><span class="si">{</span><span class="n">groupname</span><span class="si">}{</span><span class="n">key</span><span class="si">}</span><span class="s1">&quot;: &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;[&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1">&quot;, </span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">bytecount</span><span class="si">}</span><span class="s1">]&#39;</span>
                        <span class="p">)</span>

        <span class="c1"># TODO: support nested groups</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> }</span><span class="se">\n</span><span class="s1">}&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">_append</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">}&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">):</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_getitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return chunk from file.&quot;&quot;&quot;</span>
        <span class="n">keyframe</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">chunkindex</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytecount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunkmode</span><span class="p">:</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">chunks</span>

        <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">bytecount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_empty_chunk</span><span class="p">(</span>
                <span class="n">chunks</span><span class="p">,</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillvalue</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">chunk</span>

        <span class="n">fh</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunkmode</span> <span class="ow">and</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filecache</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                <span class="n">lock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_filecache</span><span class="o">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">maxworkers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_maxworkers</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filecache</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">chunk</span>

        <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filecache</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytecount</span><span class="p">)</span>

        <span class="n">decodeargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_fullsize&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">jpegtables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">decodeargs</span><span class="p">[</span><span class="s1">&#39;jpegtables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">jpegtables</span>
        <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">jpegheader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">decodeargs</span><span class="p">[</span><span class="s1">&#39;jpegheader&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">jpegheader</span>

        <span class="n">chunk</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">chunkindex</span><span class="p">,</span> <span class="o">**</span><span class="n">decodeargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">chunk</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">product</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">chunk</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s1"> != </span><span class="si">{</span><span class="n">product</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chunk</span>  <span class="c1"># .tobytes()</span>

    <span class="k">def</span> <span class="nf">_parse_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return keyframe, page, index, offset, and bytecount from key.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># multiscales</span>
            <span class="n">level</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">level</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">keyframe</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">keyframe</span>
        <span class="n">pageindex</span><span class="p">,</span> <span class="n">chunkindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">series</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pageindex</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># truncated ImageJ, STK, or shaped</span>
            <span class="k">if</span> <span class="n">series</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;truncated series is not contiguous&#39;</span><span class="p">)</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">keyframe</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">chunkindex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">pageindex</span> <span class="o">*</span> <span class="n">page</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">page</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="n">chunkindex</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunkmode</span><span class="p">:</span>
                <span class="n">bytecount</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
                <span class="k">return</span> <span class="n">page</span><span class="o">.</span><span class="n">keyframe</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">chunkindex</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytecount</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunkmode</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filecache</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">pageindex</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">keyframe</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">page</span><span class="o">.</span><span class="n">keyframe</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filecache</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">pageindex</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">keyframe</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">chunkindex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="n">chunkindex</span><span class="p">]</span>
        <span class="n">bytecount</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">databytecounts</span><span class="p">[</span><span class="n">chunkindex</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">page</span><span class="o">.</span><span class="n">keyframe</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">chunkindex</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytecount</span>

    <span class="k">def</span> <span class="nf">_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">series</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return page and strile indices from zarr chunk index.&quot;&quot;&quot;</span>
        <span class="n">keyframe</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">keyframe</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_squeeze</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunkmode</span><span class="p">:</span>
            <span class="n">chunked</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chunked</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">chunked</span>
        <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">p</span> <span class="o">*=</span> <span class="n">s</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">frames_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
                <span class="n">strile_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
                <span class="n">frames_chunked</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
                <span class="n">strile_chunked</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>  <span class="c1"># updated later</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strile_chunked</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
            <span class="n">strile_chunked</span> <span class="o">=</span> <span class="n">chunked</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get strile_chunked including singleton dimensions</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">strile_indices</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">strile_chunked</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">strile_chunked</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunked</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">strile_chunked</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;shape does not match page shape&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">assert</span> <span class="n">product</span><span class="p">(</span><span class="n">strile_chunked</span><span class="p">)</span> <span class="o">==</span> <span class="n">product</span><span class="p">(</span><span class="n">chunked</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">frameindex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span><span class="n">frames_indices</span><span class="p">,</span> <span class="n">frames_chunked</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frameindex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strile_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">strileindex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span><span class="n">strile_indices</span><span class="p">,</span> <span class="n">strile_chunked</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strileindex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">frameindex</span><span class="p">,</span> <span class="n">strileindex</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_chunks</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return chunks with same length as shape.&quot;&quot;&quot;</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">()</span>  <span class="c1"># empty array</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="n">ndim</span>
        <span class="n">newchunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">ndim</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">newchunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">chunks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">newchunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">chunks</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>  <span class="c1"># both 1</span>
                <span class="n">newchunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">newchunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">chunks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">newchunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ndim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">newchunks</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="c1"># assert ndim == len(newchunks)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">newchunks</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.ZarrTiffStore @0x</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">:</span><span class="s1">016X</span><span class="si">}</span><span class="s1">&gt;&#39;</span>


<span class="k">class</span> <span class="nc">ZarrFileSequenceStore</span><span class="p">(</span><span class="n">ZarrStore</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Zarr storage interface to image data in FileSequence.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">arg</span><span class="p">,</span>
        <span class="n">fillvalue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">chunkmode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">chunkshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">axestiled</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">zattrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize Zarr storage from FileSequence.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arg: FileSequence</span>
<span class="sd">            FileSequence instance to wrap as zarr store. Files in containers</span>
<span class="sd">            are not supported.</span>
<span class="sd">        fillvalue : number (optional)</span>
<span class="sd">            Default value to use for missing chunks of the Zarr store.</span>
<span class="sd">            Default: 0.</span>
<span class="sd">        chunkmode: {0, 3} (optional)</span>
<span class="sd">            Currently only one chunk per file is supported.</span>
<span class="sd">        chunkshape : tuple of int (optional)</span>
<span class="sd">            Shape of the chunk in each file.</span>
<span class="sd">            Must match `arg.imread(file, **kwargs).shape`.</span>
<span class="sd">        dtype : numpy.dtype (optional)</span>
<span class="sd">            Data type of the chunk in each file.</span>
<span class="sd">            Must match `arg.imread(file, **kwargs).dtype`.</span>
<span class="sd">        axestiled: dict (optional)</span>
<span class="sd">           Defines the axes to be tiled. Map stacked sequence axis to</span>
<span class="sd">           chunk axis.</span>
<span class="sd">        zattrs : dict</span>
<span class="sd">            Additional attributes to store in .zattrs.</span>
<span class="sd">        kwargs: dict</span>
<span class="sd">            Additional parameters passed to the FileSequence.imread function.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If chunkshape or dtype are None (default), their values are determined</span>
<span class="sd">        by reading the first file using `arg.imread(arg.files[0], **kwargs)`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fillvalue</span><span class="o">=</span><span class="n">fillvalue</span><span class="p">,</span> <span class="n">chunkmode</span><span class="o">=</span><span class="n">chunkmode</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunkmode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;invalid chunkmode </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_chunkmode</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">FileSequence</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;not a FileSequence&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">_container</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;cannot open container as zarr storage&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imread</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">imread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># TODO: cache MRU number chunks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commonpath</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">commonpath</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">chunkshape</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chunks</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">shape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chunks</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">chunkshape</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tiled</span> <span class="o">=</span> <span class="n">TiledSequence</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunks</span><span class="p">,</span> <span class="n">axestiled</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tiled</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">indices</span><span class="p">),</span> <span class="n">arg</span><span class="o">.</span><span class="n">files</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">chunk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tiled</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]))]</span> <span class="o">=</span> <span class="n">chunk</span>

        <span class="n">zattrs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">zattrs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="n">zattrs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">[</span><span class="s1">&#39;.zattrs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_json</span><span class="p">(</span><span class="n">zattrs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">[</span><span class="s1">&#39;.zarray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_json</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s1">&#39;zarr_format&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tiled</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="s1">&#39;chunks&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tiled</span><span class="o">.</span><span class="n">chunks</span><span class="p">,</span>
                <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">),</span>
                <span class="s1">&#39;compressor&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;fill_value&#39;</span><span class="p">:</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_value</span><span class="p">(</span><span class="n">fillvalue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">),</span>
                <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return chunk from file.&quot;&quot;&quot;</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">indices</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_empty_chunk</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_chunks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillvalue</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imread</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">)</span>  <span class="c1"># .tobytes()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunk</span>
        <span class="k">return</span> <span class="n">chunk</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear chunk cache.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">write_fsspec</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">arg</span><span class="p">,</span>
        <span class="n">url</span><span class="p">,</span>
        <span class="n">groupname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">codec_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_append</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write fsspec ReferenceFileSystem as JSON to file.</span>

<span class="sd">        Url is the remote location of the files without the file names.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">codec_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imread</span> <span class="o">==</span> <span class="n">imread</span><span class="p">:</span>
            <span class="n">codec_id</span> <span class="o">=</span> <span class="s1">&#39;tifffile&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;imagecodecs.&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imread</span><span class="o">.</span><span class="vm">__module__</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_imread</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;imread&#39;</span>
                <span class="ow">or</span> <span class="s1">&#39;codec&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;can not determine codec_id&#39;</span><span class="p">)</span>
            <span class="n">codec</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;codec&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">codec</span><span class="p">):</span>
                <span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">codec_id</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;avif&#39;</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_avif&#39;</span><span class="p">,</span>
                <span class="s1">&#39;gif&#39;</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_gif&#39;</span><span class="p">,</span>
                <span class="s1">&#39;jpeg&#39;</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_jpeg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;jpeg8&#39;</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_jpeg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;jpeg12&#39;</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_jpeg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;jpeg2k&#39;</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_jpeg2k&#39;</span><span class="p">,</span>
                <span class="s1">&#39;jpegls&#39;</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_jpegls&#39;</span><span class="p">,</span>
                <span class="s1">&#39;jpegxl&#39;</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_jpegxl&#39;</span><span class="p">,</span>
                <span class="s1">&#39;jpegxr&#39;</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_jpegxr&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ljpeg&#39;</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_ljpeg&#39;</span><span class="p">,</span>
                <span class="c1"># &#39;npy&#39;: &#39;imagecodecs_npy&#39;,</span>
                <span class="s1">&#39;png&#39;</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_png&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tiff&#39;</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_tiff&#39;</span><span class="p">,</span>
                <span class="s1">&#39;webp&#39;</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_webp&#39;</span><span class="p">,</span>
                <span class="s1">&#39;zfp&#39;</span><span class="p">:</span> <span class="s1">&#39;imagecodecs_zfp&#39;</span><span class="p">,</span>
            <span class="p">}[</span><span class="n">codec</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;can not determine codec_id&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="n">url</span> <span class="ow">and</span> <span class="n">url</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>

        <span class="k">if</span> <span class="n">groupname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">groupname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="n">groupname</span> <span class="ow">and</span> <span class="n">groupname</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">groupname</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>

        <span class="n">refs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_append</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot append when using version 1&#39;</span><span class="p">)</span>
            <span class="n">refs</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">refs</span><span class="p">[</span><span class="s1">&#39;templates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="n">url</span><span class="p">}</span>
            <span class="n">refs</span><span class="p">[</span><span class="s1">&#39;gen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">refs</span><span class="p">[</span><span class="s1">&#39;refs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refzarr</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;{{u}}&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">refzarr</span> <span class="o">=</span> <span class="n">refs</span>

        <span class="k">if</span> <span class="n">groupname</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_append</span><span class="p">:</span>
            <span class="n">refzarr</span><span class="p">[</span><span class="s1">&#39;.zgroup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_json</span><span class="p">({</span><span class="s1">&#39;zarr_format&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;.zarray&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="c1"># TODO: make kwargs serializable</span>
                <span class="n">value</span><span class="p">[</span><span class="s1">&#39;compressor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">codec_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">_json</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">refzarr</span><span class="p">[</span><span class="n">groupname</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">):</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">refs</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;}&quot;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;}&quot;&#39;</span><span class="p">)</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span>
        <span class="k">elif</span> <span class="n">_append</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">refs</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">refs</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commonpath</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;.zarray&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="n">prefix</span><span class="p">:]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">)</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;,</span><span class="se">\n</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s1">&quot;</span><span class="si">{</span><span class="n">groupname</span><span class="si">}{</span><span class="n">index</span><span class="si">}</span><span class="s1">&quot;: [&quot;</span><span class="si">{</span><span class="n">url</span><span class="si">}{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot;]&#39;</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> }</span><span class="se">\n</span><span class="s1">}&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">_append</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">}&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">):</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.ZarrFileSequenceStore @0x</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">:</span><span class="s1">016X</span><span class="si">}</span><span class="s1">&gt;&#39;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return information about instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s1">&#39;shape: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tiled</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="s1">&#39;chunks: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tiled</span><span class="o">.</span><span class="n">chunks</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="sa">f</span><span class="s1">&#39;dtype: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;fillvalue: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_fillvalue</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">FileSequence</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Series of files containing array data of compatible shape and type.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    files : list</span>
<span class="sd">        List of file names.</span>
<span class="sd">    shape : tuple</span>
<span class="sd">        Shape of file series. Excludes shape of chunks in files.</span>
<span class="sd">    axes : str</span>
<span class="sd">        One letter labels of axes in shape.</span>
<span class="sd">    labels : tuple of str</span>
<span class="sd">        Labels of axes in shape.</span>
<span class="sd">    indices : tuple of tuples</span>
<span class="sd">        ND indices of files in shape.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">imread</span><span class="p">,</span>
        <span class="n">files</span><span class="p">,</span>
        <span class="n">container</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">parse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize instance from multiple files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        imread : function or class</span>
<span class="sd">            Array read function or class with asarray function returning numpy</span>
<span class="sd">            array from single file.</span>
<span class="sd">        files : str, path-like, or sequence thereof</span>
<span class="sd">            Glob filename pattern or sequence of file names. Default: \*.</span>
<span class="sd">            Binary streams are not supported.</span>
<span class="sd">        container : str or container instance (optional)</span>
<span class="sd">            Name or open instance of ZIP file in which files are stored.</span>
<span class="sd">        sort : function (optional)</span>
<span class="sd">            Sort function used to sort file names when &#39;files&#39; is a pattern.</span>
<span class="sd">            The default (None) is the natural_sorted function.</span>
<span class="sd">            If False, disable sorting.</span>
<span class="sd">        parse : func (optional)</span>
<span class="sd">            Parse function used to parse the sequence of sorted file names to</span>
<span class="sd">            axes labels, shape, chunk indices, and filtered file names.</span>
<span class="sd">            The default (None) is the parse_filenames function if kwargs</span>
<span class="sd">            contains &#39;pattern&#39;.</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Additional arguments passed to the parse function.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
        <span class="k">if</span> <span class="n">sort</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sort</span> <span class="o">=</span> <span class="n">natural_sorted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span> <span class="o">=</span> <span class="n">container</span>
        <span class="k">if</span> <span class="n">container</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">fnmatch</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)):</span>
                <span class="kn">import</span> <span class="nn">zipfile</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_container</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid container&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">namelist</span><span class="p">(),</span> <span class="n">files</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">fspath</span><span class="p">(</span><span class="n">files</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">fspath</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no files found&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">imread</span><span class="p">,</span> <span class="s1">&#39;asarray&#39;</span><span class="p">):</span>
            <span class="c1"># redefine imread to use asarray from imread class</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">imread</span><span class="o">.</span><span class="n">asarray</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid imread function&#39;</span><span class="p">)</span>
            <span class="n">_imread_</span> <span class="o">=</span> <span class="n">imread</span>

            <span class="k">def</span> <span class="nf">imread</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">_imread_</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">handle</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">imread</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid imread function&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">container</span><span class="p">:</span>
            <span class="c1"># redefine imread to read from container</span>
            <span class="n">_imread_</span> <span class="o">=</span> <span class="n">imread</span>

            <span class="k">def</span> <span class="nf">imread</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle1</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">handle1</span><span class="o">.</span><span class="n">read</span><span class="p">())</span> <span class="k">as</span> <span class="n">handle2</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">_imread_</span><span class="p">(</span><span class="n">handle2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">parse</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pattern&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">parse</span> <span class="o">=</span> <span class="n">parse_filenames</span>

        <span class="k">if</span> <span class="n">parse</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">labels</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">files</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;failed to parse file names&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">i</span><span class="p">,)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">imread</span> <span class="o">=</span> <span class="n">imread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">files_missing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of empty chunks.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string with information about file FileSequence.&quot;&quot;&quot;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_container</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">file</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;files: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">files_missing</span><span class="si">}</span><span class="s1"> missing)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;shape: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)),</span>
                <span class="s1">&#39;labels: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)),</span>
                <span class="c1"># f&#39;axes: {self.axes}&#39;,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.FileSequence @0x</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">:</span><span class="s1">016X</span><span class="si">}</span><span class="s1">&gt;&#39;</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># deprecated</span>
        <span class="n">axestiled</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ioworkers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read image data from files and return as numpy array.</span>

<span class="sd">        Raise IndexError or ValueError if array shapes do not match.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : int or str (optional, deprecated)</span>
<span class="sd">            Index or name of single file to read.</span>
<span class="sd">        axestiled: dict (optional)</span>
<span class="sd">           Defines the axes to be tiled. Map stacked sequence axis to</span>
<span class="sd">           chunk axis.</span>
<span class="sd">        ioworkers : int  (optional)</span>
<span class="sd">            Maximum number of threads to execute the array read function</span>
<span class="sd">            asynchronously. Default: 1.</span>
<span class="sd">            If None, default to the number of processors multiplied by 5.</span>
<span class="sd">            Using threads can significantly improve runtime when</span>
<span class="sd">            reading many small files from a network share.</span>
<span class="sd">        out : numpy.ndarray, str, or file-like object (optional)</span>
<span class="sd">            Buffer where image data are saved.</span>
<span class="sd">            If None (default), a new array is created.</span>
<span class="sd">            If numpy.ndarray, a writable array of compatible dtype and shape.</span>
<span class="sd">            If &#39;memmap&#39;, create a memory-mapped array in a temporary file.</span>
<span class="sd">            If str or open file, the file name or file object used to</span>
<span class="sd">            create a memory-map to an array stored in a binary file on disk.</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Additional parameters passed to the array read function.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;&lt;tifffile.FileSequence.asarray&gt; &quot;</span>
                <span class="s2">&quot;the &#39;file&#39; parameter is deprecated since 2021.10.12.&quot;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">file</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ioworkers</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">ioworkers</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ioworkers</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">multiprocessing</span>

            <span class="n">ioworkers</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">axestiled</span><span class="p">:</span>
            <span class="n">tiled</span> <span class="o">=</span> <span class="n">TiledSequence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">axestiled</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">create_output</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">tiled</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
                <span class="c1"># read single image from file into result</span>
                <span class="c1"># if index is None:</span>
                <span class="c1">#     return</span>
                <span class="n">result</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ioworkers</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">tiled</span><span class="o">.</span><span class="n">slices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span>
                <span class="p">):</span>
                    <span class="n">func</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">ioworkers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                        <span class="n">func</span><span class="p">,</span> <span class="n">tiled</span><span class="o">.</span><span class="n">slices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span>
                    <span class="p">):</span>
                        <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">create_output</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
                <span class="c1"># read single image from file into result</span>
                <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span>

            <span class="k">if</span> <span class="n">ioworkers</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">):</span>
                    <span class="n">func</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">ioworkers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">):</span>
                        <span class="k">pass</span>

            <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">aszarr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image data from files as zarr storage.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ZarrFileSequenceStore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">commonpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return longest common sub-path of each file in sequence.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">commonpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">commonpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">commonpath</span>


<span class="k">class</span> <span class="nc">TiffSequence</span><span class="p">(</span><span class="n">FileSequence</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Series of TIFF files.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imread</span><span class="o">=</span><span class="n">imread</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize instance from multiple TIFF files.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">imread</span><span class="p">,</span> <span class="s1">&#39;*.tif&#39;</span> <span class="k">if</span> <span class="n">files</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">files</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.TiffSequence @0x</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">:</span><span class="s1">016X</span><span class="si">}</span><span class="s1">&gt;&#39;</span>


<span class="k">class</span> <span class="nc">TiledSequence</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Tiled Sequence.</span>

<span class="sd">    Transform a sequence of stacked chunks to tiled chunks.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    shape : tuple of int</span>
<span class="sd">        Shape of the tiled sequence.</span>
<span class="sd">    chunks : tuple of int</span>
<span class="sd">        Shape of the chunks in the tiled sequence.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; ts = TiledSequence((1, 2), (3, 4), {1: 0})</span>
<span class="sd">    &gt;&gt;&gt; ts.shape</span>
<span class="sd">    (1, 6, 4)</span>
<span class="sd">    &gt;&gt;&gt; ts.chunks</span>
<span class="sd">    (1, 3, 4)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stackshape</span><span class="p">,</span> <span class="n">chunkshape</span><span class="p">,</span> <span class="n">axestiled</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize from shape of stacked sequence and axes to be tiled.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stackshape : tuple of int</span>
<span class="sd">            Shape of the stacked sequence excluding chunks.</span>
<span class="sd">        chunkshape : tuple of int</span>
<span class="sd">            Shape of the chunks excluding stack axes.</span>
<span class="sd">        axestiled: dict (optional)</span>
<span class="sd">           Defines the axes to be tiled. Map stacked sequence axis to</span>
<span class="sd">           chunk axis.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stackdims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stackshape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunkdims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunkshape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stackshape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">stackshape</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">chunkshape</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">axestiled</span><span class="p">:</span>
            <span class="n">axestiled</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">axestiled</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span> <span class="ow">in</span> <span class="n">axestiled</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">axestiled</span><span class="p">[</span><span class="n">ax0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stackdims</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axestiled</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">axestiled</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>

            <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stackshape</span><span class="p">)</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stackdims</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">chunkshape</span><span class="p">)</span>
            <span class="n">used</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axestiled</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ax0</span> <span class="ow">in</span> <span class="n">used</span> <span class="ow">or</span> <span class="n">ax1</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;duplicate axis&#39;</span><span class="p">)</span>
                <span class="n">used</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ax0</span><span class="p">)</span>
                <span class="n">used</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span>
                <span class="n">shape</span><span class="p">[</span><span class="n">ax1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">stackshape</span><span class="p">[</span><span class="n">ax0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axestiled</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">shape</span><span class="p">[</span><span class="n">ax0</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">chunks</span><span class="p">[</span><span class="n">ax0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axestiled</span> <span class="o">=</span> <span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stackshape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stackdims</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">chunkshape</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return iterator over chunk indices of tiled sequence.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        indices : sequence of tuple of int</span>
<span class="sd">            Indices of chunks in the stacked sequence.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chunkindex</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunkdims</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">yield</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stackdims</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="si">}</span><span class="s1"> != </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_stackdims</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="n">chunkindex</span>
                <span class="k">for</span> <span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axestiled</span><span class="p">:</span>
                    <span class="n">index</span><span class="p">[</span><span class="n">ax1</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="n">ax0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axestiled</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">index</span><span class="p">[</span><span class="n">ax0</span><span class="p">]</span>
                <span class="k">yield</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">slices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return iterator over slices of chunks in tiled sequence.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        indices : sequence of tuple of int</span>
<span class="sd">            Indices of chunks in the stacked sequence.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chunkslice</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunkdims</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">yield</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stackdims</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="n">chunkslice</span>
                <span class="k">for</span> <span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axestiled</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stackshape</span><span class="p">[</span><span class="n">ax1</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="n">ax0</span><span class="p">]</span> <span class="o">*</span> <span class="n">j</span>
                    <span class="n">index</span><span class="p">[</span><span class="n">ax1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axestiled</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">index</span><span class="p">[</span><span class="n">ax0</span><span class="p">]</span>
                <span class="k">yield</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_tiled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_axestiled</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FileHandle</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Binary file handle.</span>

<span class="sd">    A limited, special purpose file handle that can:</span>

<span class="sd">    * handle embedded files (e.g. for LSM within LSM files)</span>
<span class="sd">    * re-open closed files (for multi-file formats, such as OME-TIFF)</span>
<span class="sd">    * read and write numpy arrays and records from file like objects</span>

<span class="sd">    Only &#39;rb&#39;, &#39;r+b&#39;, and &#39;wb&#39; modes are supported. Concurrently reading and</span>
<span class="sd">    writing of the same stream is untested.</span>

<span class="sd">    When initialized from another file handle, do not use it unless this</span>
<span class="sd">    FileHandle is closed.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of the file.</span>
<span class="sd">    path : str</span>
<span class="sd">        Absolute path to file.</span>
<span class="sd">    size : int</span>
<span class="sd">        Size of file in bytes.</span>
<span class="sd">    is_file : bool</span>
<span class="sd">        If True, file has a fileno and can be memory-mapped.</span>

<span class="sd">    All attributes are read-only.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;_fh&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_file&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_mode&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_dir&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_lock&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_offset&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_size&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_close&#39;</span><span class="p">,</span>
        <span class="s1">&#39;is_file&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize file handle from file name or another file handle.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : str, path-like, binary stream, or FileHandle</span>
<span class="sd">            File name or seekable binary stream, such as an open file</span>
<span class="sd">            or BytesIO.</span>
<span class="sd">        mode : str</span>
<span class="sd">            File open mode in case &#39;file&#39; is a file name. Must be &#39;rb&#39;, &#39;r+b&#39;,</span>
<span class="sd">            or &#39;wb&#39;. Default is &#39;rb&#39;.</span>
<span class="sd">        name : str</span>
<span class="sd">            Optional name of file in case &#39;file&#39; is a binary stream.</span>
<span class="sd">        offset : int</span>
<span class="sd">            Optional start position of embedded file. By default, this is</span>
<span class="sd">            the current file position.</span>
<span class="sd">        size : int</span>
<span class="sd">            Optional size of embedded file. By default, this is the number</span>
<span class="sd">            of bytes from the &#39;offset&#39; to the end of the file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="n">file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="s1">&#39;rb&#39;</span> <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">NullContext</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open or re-open file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># file is open</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># file name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="n">FileHandle</span><span class="p">):</span>
            <span class="c1"># FileHandle</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">_fh</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">_offset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">:</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">_name</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">_mode</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;FileHandle has wrong mode&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">_mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">_dir</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="s1">&#39;seek&#39;</span><span class="p">):</span>
            <span class="c1"># binary stream: open file, BytesIO</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;binary stream is not seekable&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;Unnamed binary stream&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">mode</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;the first parameter must be a file name, &#39;</span>
                <span class="s1">&#39;seekable binary stream, or FileHandle&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_file</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_file</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_close</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return file&#39;s current position.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span>

    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set file&#39;s current position.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">whence</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">whence</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read &#39;size&#39; bytes from file, or until EOF is reached.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readinto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read up to len(b) bytes into b and return number of bytes read.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bytestring</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write bytes to file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bytestring</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flush write buffers if applicable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">memmap_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return numpy.memmap of data stored in file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_file</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot memory-map file without fileno&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return numpy array from file in native byte order.&quot;&quot;&quot;</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out</span><span class="o">.</span><span class="n">nbytes</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">nbytes</span> <span class="o">//</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nbytes</span> <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out</span>

        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">!=</span> <span class="n">nbytes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;size mismatch&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">nbytes</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">result</span><span class="o">.</span><span class="n">shape</span>
            <span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">nbytes</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="n">nbytes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;failed to read </span><span class="si">{</span><span class="n">nbytes</span><span class="si">}</span><span class="s1"> bytes, got </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">isnative</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dtype</span><span class="o">.</span><span class="n">isnative</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">byteswap</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">isnative</span> <span class="o">!=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">isnative</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">byteswap</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">&#39;flush&#39;</span><span class="p">):</span>
                <span class="n">out</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">read_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return numpy record from file.&quot;&quot;&quot;</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rec</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">//</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">sequence</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span> <span class="o">*</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
            <span class="c1"># data = bytearray(size)</span>
            <span class="c1"># n = self._fh.readinto(data)</span>
            <span class="c1"># data = data[:n]</span>
            <span class="c1"># TODO: record is not writable</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">shape</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">record</span>

    <span class="k">def</span> <span class="nf">write_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append size bytes to file. Position must be at end of file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_CUR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write numpy array to binary file.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># writing non-contiguous arrays is very slow</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># numpy can&#39;t write to BytesIO</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">read_segments</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">offsets</span><span class="p">,</span>
        <span class="n">bytecounts</span><span class="p">,</span>
        <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">lock</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">buffersize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return iterator over segments read from file and their indices.</span>

<span class="sd">        The purpose of this function is to</span>

<span class="sd">        * reduce small or random reads</span>
<span class="sd">        * reduce acquiring reentrant locks</span>
<span class="sd">        * synchronize seeks and reads</span>
<span class="sd">        * limit the size of segments read into memory at once</span>
<span class="sd">          (ThreadPoolExecutor.map is not collecting iterables lazily).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        offsets, bytecounts : sequence of int</span>
<span class="sd">            offsets and bytecounts of the segments to read from file.</span>
<span class="sd">        indices : sequence of int</span>
<span class="sd">            Indices of the segments in the image. Default: range(len(offsets)).</span>
<span class="sd">        sort : bool</span>
<span class="sd">            If True (default), segments are read from file in the order of</span>
<span class="sd">            their offsets.</span>
<span class="sd">        lock:</span>
<span class="sd">            A reentrant lock used to synchronize seeks and reads.</span>
<span class="sd">        buffersize : int</span>
<span class="sd">            Approximate number of bytes to read from file in one pass.</span>
<span class="sd">            Default: 64 MB.</span>
<span class="sd">        flat : bool</span>
<span class="sd">            If True (default), return an iterator over individual</span>
<span class="sd">            (segment, index) tuples. Else return an iterator over a list</span>
<span class="sd">            of (segment, index) tuples that were acquired in one pass.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        items : (bytes, int) or [(bytes, int)]</span>
<span class="sd">            Iterator over individual or lists of (segment, index) tuples.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Cythonize this?</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">bytecounts</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">offsets</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span>
                <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offsets</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">bytecounts</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="k">if</span> <span class="n">flat</span> <span class="k">else</span> <span class="p">[(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">)]</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span>
        <span class="k">if</span> <span class="n">buffersize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">buffersize</span> <span class="o">=</span> <span class="mi">67108864</span>  <span class="c1"># 2 ** 26, 64 MB</span>

        <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">segments</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bytecounts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">segments</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bytecounts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="n">segments</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">segments</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">iscontig</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytecount</span> <span class="o">=</span> <span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">nextoffset</span> <span class="o">=</span> <span class="n">segments</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">bytecount</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">nextoffset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">bytecount</span> <span class="o">!=</span> <span class="n">nextoffset</span><span class="p">:</span>
                <span class="n">iscontig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>

        <span class="n">seek</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seek</span>
        <span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">read</span>

        <span class="k">if</span> <span class="n">iscontig</span><span class="p">:</span>
            <span class="c1"># consolidate reads</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">bytecount</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">bytecount</span> <span class="o">&lt;</span> <span class="n">buffersize</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">o</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">offset</span> <span class="o">=</span> <span class="n">o</span>
                        <span class="n">bytecount</span> <span class="o">+=</span> <span class="n">b</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                        <span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">bytecount</span><span class="p">)</span>
                <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytecount</span> <span class="o">=</span> <span class="n">segments</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">bytecount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">stop</span> <span class="o">+=</span> <span class="n">bytecount</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">],</span> <span class="n">index</span><span class="p">))</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="n">stop</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">flat</span><span class="p">:</span>
                    <span class="k">yield from</span> <span class="n">result</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">result</span>
            <span class="k">return</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">buffersize</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytecount</span> <span class="o">=</span> <span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">bytecount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">read</span><span class="p">(</span><span class="n">bytecount</span><span class="p">),</span> <span class="n">index</span><span class="p">))</span>
                        <span class="c1"># buffer = bytearray(bytecount)</span>
                        <span class="c1"># n = fh.readinto(buffer)</span>
                        <span class="c1"># data.append(buffer[:n])</span>
                        <span class="n">size</span> <span class="o">+=</span> <span class="n">bytecount</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">flat</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">result</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return attribute from underlying file object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;&lt;tifffile.FileHandle&gt; &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> not implemented for embedded files&#39;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.FileHandle </span><span class="si">{</span><span class="n">snipstr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span><span class="si">!r}</span><span class="s1">&gt;&#39;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string with information about FileHandle.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="s1">&#39;FileHandle&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s1"> bytes&#39;</span><span class="p">,</span>
                <span class="s1">&#39;closed&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="k">else</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dirname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return current lock instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span>

    <span class="nd">@lock</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">,</span> <span class="n">NullContext</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="n">NullContext</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if a RLock is used.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">,</span> <span class="n">NullContext</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FileCache</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Keep FileHandles open.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="s1">&#39;keep&#39;</span><span class="p">,</span> <span class="s1">&#39;past&#39;</span><span class="p">,</span> <span class="s1">&#39;lock&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize open file cache.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">past</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># FIFO of opened files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># refcounts of opened file handles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># files to keep open</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">NullContext</span><span class="p">()</span> <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of open files.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filehandle</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open file, re-open if necessary.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filehandle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filehandle</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">filehandle</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                <span class="n">filehandle</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filehandle</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">past</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filehandle</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filehandle</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">keep</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filehandle</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">past</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filehandle</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filehandle</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close least recently used open files.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filehandle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filehandle</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trim</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close all opened files if not in use when opened first.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">filehandle</span><span class="p">,</span> <span class="n">refcount</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">filehandle</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep</span><span class="p">:</span>
                    <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filehandle</span><span class="p">]</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">past</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">past</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">filehandle</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filehandle</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytecount</span><span class="p">,</span> <span class="n">whence</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return bytes read from binary file.&quot;&quot;&quot;</span>
        <span class="c1"># this function is more efficient than</span>
        <span class="c1"># filecache.open(filehandle)</span>
        <span class="c1"># with lock:</span>
        <span class="c1">#     filehandle.seek()</span>
        <span class="c1">#     data = filehandle.read()</span>
        <span class="c1"># filecache.close(filehandle)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">filehandle</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span>
            <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filehandle</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                    <span class="n">filehandle</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filehandle</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filehandle</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">keep</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filehandle</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">past</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filehandle</span><span class="p">)</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">filehandle</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">bytecount</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_trim</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_trim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Trim file cache.&quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">past</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">filehandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">past</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">filehandle</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filehandle</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filehandle</span><span class="p">]</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">past</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="n">size</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.FileCache @0x</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">:</span><span class="s1">016X</span><span class="si">}</span><span class="s1">&gt;&#39;</span>


<span class="k">class</span> <span class="nc">NullContext</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Null context manager.</span>

<span class="sd">    &gt;&gt;&gt; with NullContext():</span>
<span class="sd">    ...     pass</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__slots</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;NullContext()&#39;</span>


<span class="k">class</span> <span class="nc">Timer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Stopwatch for timing execution speed.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;started&#39;</span><span class="p">,</span> <span class="s1">&#39;stopped&#39;</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">)</span>

    <span class="n">clock</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">started</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize timer and print message.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">started</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">started</span> <span class="o">=</span> <span class="n">Timer</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span> <span class="o">=</span> <span class="n">started</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start timer and return current time.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span> <span class="o">=</span> <span class="n">Timer</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return duration of timer till start.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span> <span class="o">=</span> <span class="n">Timer</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>

    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print duration from timer start till last stop or now.&quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return duration from timer start till last stop or now as string.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># not stopped</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">Timer</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">duration</span><span class="p">))</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;0:0010203040506070809&#39;</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;:&#39;</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span><span class="si">}</span><span class="s1"> s&#39;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Timer(started=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="si">}</span><span class="s1">)&#39;</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">OmeXmlError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception to indicate invalid OME-XML or unsupported cases.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">OmeXml</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;OME-TIFF XML.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new instance.</span>

<span class="sd">        Creator : str (optional)</span>
<span class="sd">            Name of the creating application. Default &#39;tifffile.py&#39;.</span>
<span class="sd">        UUID : str (optional)</span>
<span class="sd">            Unique identifier.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;OME&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;OME&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ifd</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># TODO: parse other OME elements from metadata</span>
        <span class="c1">#   Project</span>
        <span class="c1">#   Dataset</span>
        <span class="c1">#   Folder</span>
        <span class="c1">#   Experiment</span>
        <span class="c1">#   Plate</span>
        <span class="c1">#   Screen</span>
        <span class="c1">#   Experimenter</span>
        <span class="c1">#   ExperimenterGroup</span>
        <span class="c1">#   Instrument</span>
        <span class="c1">#   StructuredAnnotations</span>
        <span class="c1">#   ROI</span>
        <span class="k">if</span> <span class="s1">&#39;UUID&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;UUID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid1</span>  <span class="c1"># noqa: delayed import</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid1</span><span class="p">())</span>
        <span class="n">creator</span> <span class="o">=</span> <span class="n">OmeXml</span><span class="o">.</span><span class="n">_attribute</span><span class="p">(</span>
            <span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;Creator&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;tifffile.py </span><span class="si">{</span><span class="n">__version__</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="s1">&#39;http://www.openmicroscopy.org/Schemas/OME/2016-06&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">{declaration}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;&lt;OME xmlns=&quot;</span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;xsi:schemaLocation=&quot;</span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s1">/ome.xsd&quot; &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;UUID=&quot;urn:uuid:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&quot; </span><span class="si">{</span><span class="n">creator</span><span class="si">}</span><span class="s1">&gt;&#39;</span>
            <span class="s1">&#39;</span><span class="si">{images}</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="si">{annotations}</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="si">{elements}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;&lt;/OME&gt;&#39;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">addimage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">storedshape</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add image to OME-XML.</span>

<span class="sd">        The OME model can handle up to 9 dimensional images for selected</span>
<span class="sd">        axes orders. Refer to the OME-XML specification for details.</span>
<span class="sd">        Non-TZCYXS (modulo) dimensions must be after a TZC dimension or</span>
<span class="sd">        require an unused TZC dimension.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dtype : numpy.dtype</span>
<span class="sd">            Data type of image array.</span>
<span class="sd">        shape : tuple</span>
<span class="sd">            Shape of image array.</span>
<span class="sd">        storedshape: tuple</span>
<span class="sd">            Normalized shape describing how the image array is stored in TIFF:</span>
<span class="sd">            (pages, separate_samples, depth, length, width, contig_samples).</span>
<span class="sd">        axes : str (optional)</span>
<span class="sd">            Axes labels for each dimension in shape.</span>
<span class="sd">            By default, axes are matched to the shape in reverse order of</span>
<span class="sd">            TZC(S)YX(S) based on storedshape.</span>
<span class="sd">            The following axes codes are supported: &#39;S&#39; sample, &#39;X&#39; width,</span>
<span class="sd">            &#39;Y&#39; length, &#39;Z&#39; depth, &#39;C&#39; channel, &#39;T&#39; time, &#39;A&#39; angle, &#39;P&#39; phase,</span>
<span class="sd">            &#39;R&#39; tile, &#39;H&#39; lifetime, &#39;E&#39; lambda, &#39;Q&#39; other.</span>
<span class="sd">        metadata : miscellaneous (optional)</span>
<span class="sd">            Additional OME-XML attributes or elements to be stored.</span>
<span class="sd">            Image/Pixels: Name, AcquisitionDate, Description,</span>
<span class="sd">            PhysicalSizeX, PhysicalSizeXUnit, PhysicalSizeY, PhysicalSizeYUnit,</span>
<span class="sd">            PhysicalSizeZ, PhysicalSizeZUnit, TimeIncrement, TimeIncrementUnit.</span>
<span class="sd">            Per Plane: DeltaTUnit, ExposureTime, ExposureTimeUnit,</span>
<span class="sd">            PositionX, PositionXUnit, PositionY, PositionYUnit, PositionZ,</span>
<span class="sd">            PositionZUnit.</span>
<span class="sd">            Per Channel: Name, AcquisitionMode, Color, ContrastMethod,</span>
<span class="sd">            EmissionWavelength, EmissionWavelengthUnit, ExcitationWavelength,</span>
<span class="sd">            ExcitationWavelengthUnit, Fluor, IlluminationType, NDFilter,</span>
<span class="sd">            PinholeSize, PinholeSizeUnit, PockelCellSetting.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>

        <span class="c1"># get Image and Pixels metadata</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OME&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Image&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="c1"># multiple images</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;Pixels&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="c1"># merge with Image</span>
            <span class="k">if</span> <span class="s1">&#39;ID&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;Pixels&#39;</span><span class="p">]:</span>
                <span class="k">del</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;Pixels&#39;</span><span class="p">][</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;Pixels&#39;</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;Pixels&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;int8&#39;</span><span class="p">:</span> <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
                <span class="s1">&#39;int16&#39;</span><span class="p">:</span> <span class="s1">&#39;int16&#39;</span><span class="p">,</span>
                <span class="s1">&#39;int32&#39;</span><span class="p">:</span> <span class="s1">&#39;int32&#39;</span><span class="p">,</span>
                <span class="s1">&#39;uint8&#39;</span><span class="p">:</span> <span class="s1">&#39;uint8&#39;</span><span class="p">,</span>
                <span class="s1">&#39;uint16&#39;</span><span class="p">:</span> <span class="s1">&#39;uint16&#39;</span><span class="p">,</span>
                <span class="s1">&#39;uint32&#39;</span><span class="p">:</span> <span class="s1">&#39;uint32&#39;</span><span class="p">,</span>
                <span class="s1">&#39;float32&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
                <span class="s1">&#39;float64&#39;</span><span class="p">:</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span>
                <span class="s1">&#39;complex64&#39;</span><span class="p">:</span> <span class="s1">&#39;complex&#39;</span><span class="p">,</span>
                <span class="s1">&#39;complex128&#39;</span><span class="p">:</span> <span class="s1">&#39;double-complex&#39;</span><span class="p">,</span>
                <span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="s1">&#39;bit&#39;</span><span class="p">,</span>
            <span class="p">}[</span><span class="n">dtype</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OmeXmlError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;data type </span><span class="si">{</span><span class="n">dtype</span><span class="si">!r}</span><span class="s1"> not supported&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dtype</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OmeXmlError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;metadata Pixels Type </span><span class="si">{</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;does not match array dtype </span><span class="si">{</span><span class="n">dtype</span><span class="si">!r}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">planecount</span><span class="p">,</span> <span class="n">separate</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">contig</span> <span class="o">=</span> <span class="n">storedshape</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OmeXmlError</span><span class="p">(</span><span class="s1">&#39;ImageDepth not supported&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">separate</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">contig</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid stored shape&#39;</span><span class="p">)</span>

        <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">)</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OmeXmlError</span><span class="p">(</span><span class="s1">&#39;empty arrays not supported&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># get axes from shape, stored shape, and DimensionOrder</span>
            <span class="k">if</span> <span class="n">contig</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;YXS&#39;</span>
                <span class="n">samples</span> <span class="o">=</span> <span class="n">contig</span>
            <span class="k">elif</span> <span class="n">separate</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">ndim</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;SYX&#39;</span>
                <span class="n">samples</span> <span class="o">=</span> <span class="n">separate</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;YX&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">ndim</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">6</span> <span class="k">if</span> <span class="s1">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">axes</span> <span class="k">else</span> <span class="mi">5</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">OmeXmlError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ndim</span><span class="si">}</span><span class="s1"> dimensions not supported&#39;</span><span class="p">)</span>
            <span class="n">hiaxes</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DimensionOrder&#39;</span><span class="p">,</span> <span class="s1">&#39;XYCZT&#39;</span><span class="p">)[:</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">hiaxes</span><span class="p">[(</span><span class="mi">6</span> <span class="k">if</span> <span class="s1">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">axes</span> <span class="k">else</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">ndim</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">axes</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># validate axes against shape and stored shape</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;axes do not match shape&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;YX&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">axes</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;YXS&#39;</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">OmeXmlError</span><span class="p">(</span><span class="s1">&#39;dimensions must end with YX or YXS&#39;</span><span class="p">)</span>
            <span class="n">unique</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ax</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;TZCYXSAPRHEQ&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">OmeXmlError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dimension </span><span class="si">{</span><span class="n">ax</span><span class="si">!r}</span><span class="s1"> not supported&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">OmeXmlError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;multiple </span><span class="si">{</span><span class="n">ax</span><span class="si">!r}</span><span class="s1"> dimensions&#39;</span><span class="p">)</span>
                <span class="n">unique</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">9</span> <span class="k">if</span> <span class="s1">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">axes</span> <span class="k">else</span> <span class="mi">8</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">OmeXmlError</span><span class="p">(</span><span class="s1">&#39;more than 8 dimensions not supported&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">contig</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">samples</span> <span class="o">=</span> <span class="n">contig</span>
                <span class="k">if</span> <span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;dimensions do not match stored shape&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;axes do not match stored shape&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">contig</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">width</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;shape does not match stored shape&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">separate</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">samples</span> <span class="o">=</span> <span class="n">separate</span>
                <span class="k">if</span> <span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;dimensions do not match stored shape&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;axes do not match stored shape&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">separate</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">length</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;shape does not match stored shape&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="n">axes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)]</span> <span class="o">!=</span> <span class="n">width</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="n">axes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)]</span> <span class="o">!=</span> <span class="n">length</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;shape does not match stored shape&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="n">hiaxes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[:</span> <span class="nb">min</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">),</span> <span class="n">axes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hiaxes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[:</span> <span class="n">axes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)]</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">ax</span> <span class="ow">in</span> <span class="s1">&#39;APRHEQ&#39;</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">hiaxes</span><span class="p">):</span>
            <span class="c1"># modulo axes</span>
            <span class="n">modulo</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">dimorder</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">axestype</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="s1">&#39;angle&#39;</span><span class="p">,</span>
                <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="s1">&#39;phase&#39;</span><span class="p">,</span>
                <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="s1">&#39;tile&#39;</span><span class="p">,</span>
                <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="s1">&#39;lifetime&#39;</span><span class="p">,</span>
                <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="s1">&#39;lambda&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="s1">&#39;other&#39;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hiaxes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ax</span> <span class="ow">in</span> <span class="s1">&#39;APRHEQ&#39;</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">hiaxes</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">in</span> <span class="s1">&#39;TZC&#39;</span><span class="p">:</span>
                        <span class="c1"># use previous axis</span>
                        <span class="n">modulo</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">axestype</span><span class="p">[</span><span class="n">ax</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># use next unused axis</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s1">&#39;TZC&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dimorder</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modulo</span><span class="p">:</span>
                                <span class="n">modulo</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">axestype</span><span class="p">[</span><span class="n">ax</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                <span class="n">dimorder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                                <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># TODO: support any order of axes, e.g. APRTZC</span>
                            <span class="k">raise</span> <span class="n">OmeXmlError</span><span class="p">(</span><span class="s1">&#39;more than 3 modulo dimensions&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dimorder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">hiaxes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dimorder</span><span class="p">)</span>

            <span class="c1"># TODO: use user-specified start, stop, step, or labels</span>
            <span class="n">moduloalong</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&lt;ModuloAlong</span><span class="si">{</span><span class="n">ax</span><span class="si">}</span><span class="s1"> Type=&quot;</span><span class="si">{</span><span class="n">axtype</span><span class="si">}</span><span class="s1">&quot; Start=&quot;0&quot; End=&quot;</span><span class="si">{</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s1">&quot;/&gt;&#39;</span>
                <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">axtype</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="ow">in</span> <span class="n">modulo</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">annotationref</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;AnnotationRef ID=&quot;Annotation:</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&quot;/&gt;&#39;</span>
            <span class="n">annotations</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&lt;XMLAnnotation ID=&quot;Annotation:</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
                <span class="s1">&#39;Namespace=&quot;openmicroscopy.org/omero/dimension/modulo&quot;&gt;&#39;</span>
                <span class="s1">&#39;&lt;Value&gt;&#39;</span>
                <span class="s1">&#39;&lt;Modulo namespace=&#39;</span>
                <span class="s1">&#39;&quot;http://www.openmicroscopy.org/Schemas/Additions/2011-09&quot;&gt;&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">moduloalong</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="s1">&#39;&lt;/Modulo&gt;&#39;</span>
                <span class="s1">&#39;&lt;/Value&gt;&#39;</span>
                <span class="s1">&#39;&lt;/XMLAnnotation&gt;&#39;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modulo</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">annotationref</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">hiaxes</span> <span class="o">=</span> <span class="n">hiaxes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dimorder</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DimensionOrder&#39;</span><span class="p">,</span> <span class="s1">&#39;XYCZT&#39;</span><span class="p">),</span>
            <span class="s1">&#39;XYCZT&#39;</span><span class="p">,</span>
            <span class="s1">&#39;XYZCT&#39;</span><span class="p">,</span>
            <span class="s1">&#39;XYZTC&#39;</span><span class="p">,</span>
            <span class="s1">&#39;XYCTZ&#39;</span><span class="p">,</span>
            <span class="s1">&#39;XYTCZ&#39;</span><span class="p">,</span>
            <span class="s1">&#39;XYTZC&#39;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">hiaxes</span> <span class="ow">in</span> <span class="n">dimorder</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OmeXmlError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dimension order </span><span class="si">{</span><span class="n">axes</span><span class="si">!r}</span><span class="s1"> not supported&#39;</span><span class="p">)</span>

        <span class="n">dimsizes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">dimorder</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="n">axes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ax</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span>
                <span class="n">sizec</span> <span class="o">=</span> <span class="n">size</span>
                <span class="n">size</span> <span class="o">*=</span> <span class="n">samples</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">modulo</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">*=</span> <span class="n">modulo</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dimsizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39; Size</span><span class="si">{</span><span class="n">ax</span><span class="si">}</span><span class="s1">=&quot;</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dimorder</span><span class="p">,</span> <span class="n">dimsizes</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># verify DimensionOrder in metadata is compatible</span>
        <span class="k">if</span> <span class="s1">&#39;DimensionOrder&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">omedimorder</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;DimensionOrder&#39;</span><span class="p">]</span>
            <span class="n">omedimorder</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">ax</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">omedimorder</span> <span class="k">if</span> <span class="n">dimsizes</span><span class="p">[</span><span class="n">dimorder</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ax</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">hiaxes</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">omedimorder</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">OmeXmlError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;metadata DimensionOrder does not match </span><span class="si">{</span><span class="n">axes</span><span class="si">!r}</span><span class="s1">&#39;</span>
                <span class="p">)</span>

        <span class="c1"># verify metadata Size values match shape</span>
        <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dimorder</span><span class="p">,</span> <span class="n">dimsizes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Size</span><span class="si">{</span><span class="n">ax</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">size</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">OmeXmlError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;metadata Size</span><span class="si">{</span><span class="n">ax</span><span class="si">}</span><span class="s1"> does not match </span><span class="si">{</span><span class="n">shape</span><span class="si">!r}</span><span class="s1">&#39;</span>
                <span class="p">)</span>

        <span class="n">dimsizes</span><span class="p">[</span><span class="n">dimorder</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)]</span> <span class="o">//=</span> <span class="n">samples</span>
        <span class="k">if</span> <span class="n">planecount</span> <span class="o">!=</span> <span class="n">product</span><span class="p">(</span><span class="n">dimsizes</span><span class="p">[</span><span class="mi">2</span><span class="p">:]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;shape does not match stored shape&#39;</span><span class="p">)</span>

        <span class="n">planes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">planeattributes</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Plane&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">planeattributes</span><span class="p">:</span>
            <span class="n">cztorder</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dimorder</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="s1">&#39;CZT&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">planecount</span><span class="p">):</span>
                <span class="n">attributes</span> <span class="o">=</span> <span class="n">OmeXml</span><span class="o">.</span><span class="n">_attributes</span><span class="p">(</span>
                    <span class="n">planeattributes</span><span class="p">,</span>
                    <span class="n">p</span><span class="p">,</span>
                    <span class="s1">&#39;DeltaTUnit&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ExposureTime&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ExposureTimeUnit&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;PositionX&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;PositionXUnit&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;PositionY&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;PositionYUnit&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;PositionZ&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;PositionZUnit&#39;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">unraveled</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">dimsizes</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
                <span class="n">c</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">unraveled</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cztorder</span><span class="p">)</span>
                <span class="n">planes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;&lt;Plane TheC=&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&quot; TheZ=&quot;</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s1">&quot; TheT=&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&quot;</span><span class="si">{</span><span class="n">attributes</span><span class="si">}</span><span class="s1">/&gt;&#39;</span>
                <span class="p">)</span>
                <span class="c1"># TODO: if possible, verify c, z, t match planeattributes</span>
        <span class="n">planes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">planes</span><span class="p">)</span>

        <span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sizec</span><span class="p">):</span>
            <span class="n">lightpath</span> <span class="o">=</span> <span class="s1">&#39;&lt;LightPath/&gt;&#39;</span>
            <span class="c1"># TODO: use LightPath elements from metadata</span>
            <span class="c1">#    &#39;AnnotationRef&#39;,</span>
            <span class="c1">#    &#39;DichroicRef&#39;,</span>
            <span class="c1">#    &#39;EmissionFilterRef&#39;,</span>
            <span class="c1">#    &#39;ExcitationFilterRef&#39;</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">OmeXml</span><span class="o">.</span><span class="n">_attributes</span><span class="p">(</span>
                <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Channel&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="n">c</span><span class="p">,</span>
                <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
                <span class="s1">&#39;AcquisitionMode&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Color&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ContrastMethod&#39;</span><span class="p">,</span>
                <span class="s1">&#39;EmissionWavelength&#39;</span><span class="p">,</span>
                <span class="s1">&#39;EmissionWavelengthUnit&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ExcitationWavelength&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ExcitationWavelengthUnit&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Fluor&#39;</span><span class="p">,</span>
                <span class="s1">&#39;IlluminationType&#39;</span><span class="p">,</span>
                <span class="s1">&#39;NDFilter&#39;</span><span class="p">,</span>
                <span class="s1">&#39;PinholeSize&#39;</span><span class="p">,</span>
                <span class="s1">&#39;PinholeSizeUnit&#39;</span><span class="p">,</span>
                <span class="s1">&#39;PockelCellSetting&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&lt;Channel ID=&quot;Channel:</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;SamplesPerPixel=&quot;</span><span class="si">{</span><span class="n">samples</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attributes</span><span class="si">}</span><span class="s1">&gt;&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lightpath</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="s1">&#39;&lt;/Channel&gt;&#39;</span>
            <span class="p">)</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>

        <span class="c1"># TODO: support more Image elements</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="n">OmeXml</span><span class="o">.</span><span class="n">_elements</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;AcquisitionDate&#39;</span><span class="p">,</span> <span class="s1">&#39;Description&#39;</span><span class="p">)</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">OmeXml</span><span class="o">.</span><span class="n">_attribute</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Image</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">OmeXml</span><span class="o">.</span><span class="n">_attributes</span><span class="p">(</span>
            <span class="n">metadata</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;SignificantBits&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PhysicalSizeX&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PhysicalSizeXUnit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PhysicalSizeY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PhysicalSizeYUnit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PhysicalSizeZ&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PhysicalSizeZUnit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;TimeIncrement&#39;</span><span class="p">,</span>
            <span class="s1">&#39;TimeIncrementUnit&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">separate</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">contig</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">interleaved</span> <span class="o">=</span> <span class="s1">&#39;false&#39;</span> <span class="k">if</span> <span class="n">separate</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;true&#39;</span>
            <span class="n">interleaved</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; Interleaved=&quot;</span><span class="si">{</span><span class="n">interleaved</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">interleaved</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;&lt;Image ID=&quot;Image:</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&gt;&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">elements</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;&lt;Pixels ID=&quot;Pixels:</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;DimensionOrder=&quot;</span><span class="si">{</span><span class="n">dimorder</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;Type=&quot;</span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sizes</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">interleaved</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attributes</span><span class="si">}</span><span class="s1">&gt;&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">channels</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;&lt;TiffData IFD=&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ifd</span><span class="si">}</span><span class="s1">&quot; PlaneCount=&quot;</span><span class="si">{</span><span class="n">planecount</span><span class="si">}</span><span class="s1">&quot;/&gt;&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">planes</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;&lt;/Pixels&gt;&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">annotationref</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;&lt;/Image&gt;&#39;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ifd</span> <span class="o">+=</span> <span class="n">planecount</span>

    <span class="k">def</span> <span class="nf">tostring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">declaration</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return OME-XML string.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: support other top-level elements</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
        <span class="n">images</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">annotations</span><span class="p">:</span>
            <span class="n">annotations</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&lt;StructuredAnnotations&gt;</span><span class="si">{</span><span class="n">annotations</span><span class="si">}</span><span class="s1">&lt;/StructuredAnnotations&gt;&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">declaration</span><span class="p">:</span>
            <span class="n">declaration</span> <span class="o">=</span> <span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">declaration</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">declaration</span><span class="o">=</span><span class="n">declaration</span><span class="p">,</span>
            <span class="n">images</span><span class="o">=</span><span class="n">images</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="n">annotations</span><span class="p">,</span>
            <span class="n">elements</span><span class="o">=</span><span class="n">elements</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">xml</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.OmeXml @0x</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">:</span><span class="s1">016X</span><span class="si">}</span><span class="s1">&gt;&#39;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return OME-XML string.&quot;&quot;&quot;</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>  <span class="c1"># noqa: delayed import</span>

            <span class="n">parser</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">XMLParser</span><span class="p">(</span><span class="n">remove_blank_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span>
            <span class="n">xml</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span>
                <span class="n">tree</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&lt;tiffile.OmeXml.__str__&gt; </span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">xml</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_escape</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return escaped string of value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;&amp;amp;&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;&amp;gt;&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;&amp;lt;&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;amp;&#39;</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;gt;&#39;</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_element</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return XML formatted element if name in metadata.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&gt;</span><span class="si">{</span><span class="n">OmeXml</span><span class="o">.</span><span class="n">_escape</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">&lt;/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&gt;&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_elements</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return XML formatted elements.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="p">(</span><span class="n">OmeXml</span><span class="o">.</span><span class="n">_element</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">elements</span> <span class="k">if</span> <span class="n">e</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_attribute</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return XML formatted attribute if name in metadata.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s1"> is not a list or tuple&#39;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">=&quot;</span><span class="si">{</span><span class="n">OmeXml</span><span class="o">.</span><span class="n">_escape</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_attributes</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">index_</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return XML formatted attributes.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">index_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="p">(</span><span class="n">OmeXml</span><span class="o">.</span><span class="n">_attribute</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">index_</span><span class="p">]</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="p">(</span><span class="n">OmeXml</span><span class="o">.</span><span class="n">_attribute</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">OmeXml</span><span class="o">.</span><span class="n">_attribute</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index_</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="k">if</span> <span class="n">a</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_reference</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return XML formatted reference element.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> ID=&quot;</span><span class="si">{</span><span class="n">OmeXml</span><span class="o">.</span><span class="n">_escape</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;/&gt;&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">omexml</span><span class="p">,</span> <span class="n">omexsd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">assert_</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">_schema</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Return if OME-XML is valid according to XMLSchema.</span>

<span class="sd">        If &#39;assert_&#39; is True, raise an AssertionError if validation fails.</span>

<span class="sd">        On first run, this function takes several seconds to download and</span>
<span class="sd">        parse the 2016-06 OME XMLSchema.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>  <span class="c1"># noqa: delay import</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">_schema</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">omexsd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">omexsd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;ome.xsd&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">omexsd</span><span class="p">):</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">omexsd</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                        <span class="n">omexsd</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">urllib.request</span>  <span class="c1"># noqa: delay import</span>

                    <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span>
                        <span class="s1">&#39;https://www.openmicroscopy.org/&#39;</span>
                        <span class="s1">&#39;Schemas/OME/2016-06/ome.xsd&#39;</span>
                    <span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                        <span class="n">omexsd</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">omexsd</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&lt;?xml&#39;</span><span class="p">):</span>
                <span class="n">omexsd</span> <span class="o">=</span> <span class="n">omexsd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_schema</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">etree</span><span class="o">.</span><span class="n">XMLSchema</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">omexsd</span><span class="o">.</span><span class="n">decode</span><span class="p">()))</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># raise</span>
                <span class="n">_schema</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_schema</span> <span class="ow">and</span> <span class="n">_schema</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">omexml</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;?xml&#39;</span><span class="p">):</span>
                <span class="n">omexml</span> <span class="o">=</span> <span class="n">omexml</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">omexml</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">assert_</span><span class="p">:</span>
                <span class="n">_schema</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">assert_</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">_schema</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">LazyConst</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class whose attributes are computed on first access from its methods.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span> <span class="o">=</span> <span class="bp">cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__qualname__</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__qualname__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># decorated class will be pickled by name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="o">.</span><span class="vm">__qualname__</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="c1"># another thread set attribute while awaiting lock</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span> <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="k">else</span> <span class="n">func</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__module__&#39;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;__module__&#39;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span>
                        <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__qualname__&#39;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;__qualname__&#39;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># __doc__</span>
                <span class="c1"># __annotations__</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="nd">@LazyConst</span>
<span class="k">class</span> <span class="nc">TIFF</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Namespace for module constants.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">CLASSIC_LE</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">ClassicTiffLe</span><span class="p">:</span>
            <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
            <span class="n">version</span> <span class="o">=</span> <span class="mi">42</span>
            <span class="n">byteorder</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span>
            <span class="n">offsetsize</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">offsetformat</span> <span class="o">=</span> <span class="s1">&#39;&lt;I&#39;</span>
            <span class="n">tagnosize</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">tagnoformat</span> <span class="o">=</span> <span class="s1">&#39;&lt;H&#39;</span>
            <span class="n">tagsize</span> <span class="o">=</span> <span class="mi">12</span>
            <span class="n">tagformat1</span> <span class="o">=</span> <span class="s1">&#39;&lt;HH&#39;</span>
            <span class="n">tagformat2</span> <span class="o">=</span> <span class="s1">&#39;&lt;I4s&#39;</span>
            <span class="n">tagoffsetthreshold</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="k">return</span> <span class="n">ClassicTiffLe</span>

    <span class="k">def</span> <span class="nf">CLASSIC_BE</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">ClassicTiffBe</span><span class="p">:</span>
            <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
            <span class="n">version</span> <span class="o">=</span> <span class="mi">42</span>
            <span class="n">byteorder</span> <span class="o">=</span> <span class="s1">&#39;&gt;&#39;</span>
            <span class="n">offsetsize</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">offsetformat</span> <span class="o">=</span> <span class="s1">&#39;&gt;I&#39;</span>
            <span class="n">tagnosize</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">tagnoformat</span> <span class="o">=</span> <span class="s1">&#39;&gt;H&#39;</span>
            <span class="n">tagsize</span> <span class="o">=</span> <span class="mi">12</span>
            <span class="n">tagformat1</span> <span class="o">=</span> <span class="s1">&#39;&gt;HH&#39;</span>
            <span class="n">tagformat2</span> <span class="o">=</span> <span class="s1">&#39;&gt;I4s&#39;</span>
            <span class="n">tagoffsetthreshold</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="k">return</span> <span class="n">ClassicTiffBe</span>

    <span class="k">def</span> <span class="nf">BIG_LE</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">BigTiffLe</span><span class="p">:</span>
            <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
            <span class="n">version</span> <span class="o">=</span> <span class="mi">43</span>
            <span class="n">byteorder</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span>
            <span class="n">offsetsize</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="n">offsetformat</span> <span class="o">=</span> <span class="s1">&#39;&lt;Q&#39;</span>
            <span class="n">tagnosize</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="n">tagnoformat</span> <span class="o">=</span> <span class="s1">&#39;&lt;Q&#39;</span>
            <span class="n">tagsize</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="n">tagformat1</span> <span class="o">=</span> <span class="s1">&#39;&lt;HH&#39;</span>
            <span class="n">tagformat2</span> <span class="o">=</span> <span class="s1">&#39;&lt;Q8s&#39;</span>
            <span class="n">tagoffsetthreshold</span> <span class="o">=</span> <span class="mi">8</span>

        <span class="k">return</span> <span class="n">BigTiffLe</span>

    <span class="k">def</span> <span class="nf">BIG_BE</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">BigTiffBe</span><span class="p">:</span>
            <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
            <span class="n">version</span> <span class="o">=</span> <span class="mi">43</span>
            <span class="n">byteorder</span> <span class="o">=</span> <span class="s1">&#39;&gt;&#39;</span>
            <span class="n">offsetsize</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="n">offsetformat</span> <span class="o">=</span> <span class="s1">&#39;&gt;Q&#39;</span>
            <span class="n">tagnosize</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="n">tagnoformat</span> <span class="o">=</span> <span class="s1">&#39;&gt;Q&#39;</span>
            <span class="n">tagsize</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="n">tagformat1</span> <span class="o">=</span> <span class="s1">&#39;&gt;HH&#39;</span>
            <span class="n">tagformat2</span> <span class="o">=</span> <span class="s1">&#39;&gt;Q8s&#39;</span>
            <span class="n">tagoffsetthreshold</span> <span class="o">=</span> <span class="mi">8</span>

        <span class="k">return</span> <span class="n">BigTiffBe</span>

    <span class="k">def</span> <span class="nf">NDPI_LE</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">NdpiTiffLe</span><span class="p">:</span>
            <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
            <span class="n">version</span> <span class="o">=</span> <span class="mi">42</span>
            <span class="n">byteorder</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span>
            <span class="n">offsetsize</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># NDPI uses 8 bytes IFD and tag offsets</span>
            <span class="n">offsetformat</span> <span class="o">=</span> <span class="s1">&#39;&lt;Q&#39;</span>
            <span class="n">tagnosize</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">tagnoformat</span> <span class="o">=</span> <span class="s1">&#39;&lt;H&#39;</span>
            <span class="n">tagsize</span> <span class="o">=</span> <span class="mi">12</span>  <span class="c1"># 16 after patching</span>
            <span class="n">tagformat1</span> <span class="o">=</span> <span class="s1">&#39;&lt;HH&#39;</span>
            <span class="n">tagformat2</span> <span class="o">=</span> <span class="s1">&#39;&lt;I8s&#39;</span>  <span class="c1"># after patching</span>
            <span class="n">tagoffsetthreshold</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="k">return</span> <span class="n">NdpiTiffLe</span>

    <span class="k">def</span> <span class="nf">TAGS</span><span class="p">():</span>
        <span class="c1"># TIFF tag codes and names from TIFF6, TIFF/EP, EXIF, and other specs</span>
        <span class="c1"># TODO: divide into baseline, exif, private, ... tags</span>
        <span class="k">return</span> <span class="n">TiffTagRegistry</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;ProcessingSoftware&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">254</span><span class="p">,</span> <span class="s1">&#39;NewSubfileType&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="s1">&#39;SubfileType&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="s1">&#39;ImageWidth&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">257</span><span class="p">,</span> <span class="s1">&#39;ImageLength&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">258</span><span class="p">,</span> <span class="s1">&#39;BitsPerSample&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">259</span><span class="p">,</span> <span class="s1">&#39;Compression&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">262</span><span class="p">,</span> <span class="s1">&#39;PhotometricInterpretation&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">263</span><span class="p">,</span> <span class="s1">&#39;Thresholding&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">264</span><span class="p">,</span> <span class="s1">&#39;CellWidth&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">265</span><span class="p">,</span> <span class="s1">&#39;CellLength&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">266</span><span class="p">,</span> <span class="s1">&#39;FillOrder&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">269</span><span class="p">,</span> <span class="s1">&#39;DocumentName&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">270</span><span class="p">,</span> <span class="s1">&#39;ImageDescription&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">271</span><span class="p">,</span> <span class="s1">&#39;Make&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">272</span><span class="p">,</span> <span class="s1">&#39;Model&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">273</span><span class="p">,</span> <span class="s1">&#39;StripOffsets&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">274</span><span class="p">,</span> <span class="s1">&#39;Orientation&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">277</span><span class="p">,</span> <span class="s1">&#39;SamplesPerPixel&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">278</span><span class="p">,</span> <span class="s1">&#39;RowsPerStrip&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">279</span><span class="p">,</span> <span class="s1">&#39;StripByteCounts&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">280</span><span class="p">,</span> <span class="s1">&#39;MinSampleValue&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">281</span><span class="p">,</span> <span class="s1">&#39;MaxSampleValue&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">282</span><span class="p">,</span> <span class="s1">&#39;XResolution&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">283</span><span class="p">,</span> <span class="s1">&#39;YResolution&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">284</span><span class="p">,</span> <span class="s1">&#39;PlanarConfiguration&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">285</span><span class="p">,</span> <span class="s1">&#39;PageName&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">286</span><span class="p">,</span> <span class="s1">&#39;XPosition&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">287</span><span class="p">,</span> <span class="s1">&#39;YPosition&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">288</span><span class="p">,</span> <span class="s1">&#39;FreeOffsets&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">289</span><span class="p">,</span> <span class="s1">&#39;FreeByteCounts&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">290</span><span class="p">,</span> <span class="s1">&#39;GrayResponseUnit&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">291</span><span class="p">,</span> <span class="s1">&#39;GrayResponseCurve&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">292</span><span class="p">,</span> <span class="s1">&#39;T4Options&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">293</span><span class="p">,</span> <span class="s1">&#39;T6Options&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">296</span><span class="p">,</span> <span class="s1">&#39;ResolutionUnit&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">297</span><span class="p">,</span> <span class="s1">&#39;PageNumber&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;ColorResponseUnit&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">301</span><span class="p">,</span> <span class="s1">&#39;TransferFunction&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">305</span><span class="p">,</span> <span class="s1">&#39;Software&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">306</span><span class="p">,</span> <span class="s1">&#39;DateTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">315</span><span class="p">,</span> <span class="s1">&#39;Artist&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">316</span><span class="p">,</span> <span class="s1">&#39;HostComputer&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">317</span><span class="p">,</span> <span class="s1">&#39;Predictor&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">318</span><span class="p">,</span> <span class="s1">&#39;WhitePoint&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">319</span><span class="p">,</span> <span class="s1">&#39;PrimaryChromaticities&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">320</span><span class="p">,</span> <span class="s1">&#39;ColorMap&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">321</span><span class="p">,</span> <span class="s1">&#39;HalftoneHints&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">322</span><span class="p">,</span> <span class="s1">&#39;TileWidth&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">323</span><span class="p">,</span> <span class="s1">&#39;TileLength&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">324</span><span class="p">,</span> <span class="s1">&#39;TileOffsets&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">325</span><span class="p">,</span> <span class="s1">&#39;TileByteCounts&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">326</span><span class="p">,</span> <span class="s1">&#39;BadFaxLines&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">327</span><span class="p">,</span> <span class="s1">&#39;CleanFaxData&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">328</span><span class="p">,</span> <span class="s1">&#39;ConsecutiveBadFaxLines&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">330</span><span class="p">,</span> <span class="s1">&#39;SubIFDs&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">332</span><span class="p">,</span> <span class="s1">&#39;InkSet&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">333</span><span class="p">,</span> <span class="s1">&#39;InkNames&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">334</span><span class="p">,</span> <span class="s1">&#39;NumberOfInks&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">336</span><span class="p">,</span> <span class="s1">&#39;DotRange&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">337</span><span class="p">,</span> <span class="s1">&#39;TargetPrinter&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">338</span><span class="p">,</span> <span class="s1">&#39;ExtraSamples&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">339</span><span class="p">,</span> <span class="s1">&#39;SampleFormat&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">340</span><span class="p">,</span> <span class="s1">&#39;SMinSampleValue&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">341</span><span class="p">,</span> <span class="s1">&#39;SMaxSampleValue&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">342</span><span class="p">,</span> <span class="s1">&#39;TransferRange&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">343</span><span class="p">,</span> <span class="s1">&#39;ClipPath&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">344</span><span class="p">,</span> <span class="s1">&#39;XClipPathUnits&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">345</span><span class="p">,</span> <span class="s1">&#39;YClipPathUnits&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">346</span><span class="p">,</span> <span class="s1">&#39;Indexed&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">347</span><span class="p">,</span> <span class="s1">&#39;JPEGTables&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">351</span><span class="p">,</span> <span class="s1">&#39;OPIProxy&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;GlobalParametersIFD&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="s1">&#39;ProfileType&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">402</span><span class="p">,</span> <span class="s1">&#39;FaxProfile&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s1">&#39;CodingMethods&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s1">&#39;VersionYear&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">405</span><span class="p">,</span> <span class="s1">&#39;ModeNumber&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">433</span><span class="p">,</span> <span class="s1">&#39;Decode&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">434</span><span class="p">,</span> <span class="s1">&#39;DefaultImageColor&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">435</span><span class="p">,</span> <span class="s1">&#39;T82Options&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">437</span><span class="p">,</span> <span class="s1">&#39;JPEGTables&#39;</span><span class="p">),</span>  <span class="c1"># 347</span>
                <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="s1">&#39;JPEGProc&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">513</span><span class="p">,</span> <span class="s1">&#39;JPEGInterchangeFormat&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">514</span><span class="p">,</span> <span class="s1">&#39;JPEGInterchangeFormatLength&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">515</span><span class="p">,</span> <span class="s1">&#39;JPEGRestartInterval&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">517</span><span class="p">,</span> <span class="s1">&#39;JPEGLosslessPredictors&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">518</span><span class="p">,</span> <span class="s1">&#39;JPEGPointTransforms&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">519</span><span class="p">,</span> <span class="s1">&#39;JPEGQTables&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">520</span><span class="p">,</span> <span class="s1">&#39;JPEGDCTables&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">521</span><span class="p">,</span> <span class="s1">&#39;JPEGACTables&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">529</span><span class="p">,</span> <span class="s1">&#39;YCbCrCoefficients&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">530</span><span class="p">,</span> <span class="s1">&#39;YCbCrSubSampling&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">531</span><span class="p">,</span> <span class="s1">&#39;YCbCrPositioning&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">532</span><span class="p">,</span> <span class="s1">&#39;ReferenceBlackWhite&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">559</span><span class="p">,</span> <span class="s1">&#39;StripRowCounts&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">700</span><span class="p">,</span> <span class="s1">&#39;XMP&#39;</span><span class="p">),</span>  <span class="c1"># XMLPacket</span>
                <span class="p">(</span><span class="mi">769</span><span class="p">,</span> <span class="s1">&#39;GDIGamma&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">770</span><span class="p">,</span> <span class="s1">&#39;ICCProfileDescriptor&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">771</span><span class="p">,</span> <span class="s1">&#39;SRGBRenderingIntent&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="s1">&#39;ImageTitle&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">999</span><span class="p">,</span> <span class="s1">&#39;USPTO_Miscellaneous&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4864</span><span class="p">,</span> <span class="s1">&#39;AndorId&#39;</span><span class="p">),</span>  <span class="c1"># TODO, Andor Technology 4864 - 5030</span>
                <span class="p">(</span><span class="mi">4869</span><span class="p">,</span> <span class="s1">&#39;AndorTemperature&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4876</span><span class="p">,</span> <span class="s1">&#39;AndorExposureTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4878</span><span class="p">,</span> <span class="s1">&#39;AndorKineticCycleTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4879</span><span class="p">,</span> <span class="s1">&#39;AndorAccumulations&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4881</span><span class="p">,</span> <span class="s1">&#39;AndorAcquisitionCycleTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4882</span><span class="p">,</span> <span class="s1">&#39;AndorReadoutTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4884</span><span class="p">,</span> <span class="s1">&#39;AndorPhotonCounting&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4885</span><span class="p">,</span> <span class="s1">&#39;AndorEmDacLevel&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4890</span><span class="p">,</span> <span class="s1">&#39;AndorFrames&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4896</span><span class="p">,</span> <span class="s1">&#39;AndorHorizontalFlip&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4897</span><span class="p">,</span> <span class="s1">&#39;AndorVerticalFlip&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4898</span><span class="p">,</span> <span class="s1">&#39;AndorClockwise&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4899</span><span class="p">,</span> <span class="s1">&#39;AndorCounterClockwise&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4904</span><span class="p">,</span> <span class="s1">&#39;AndorVerticalClockVoltage&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4905</span><span class="p">,</span> <span class="s1">&#39;AndorVerticalShiftSpeed&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4907</span><span class="p">,</span> <span class="s1">&#39;AndorPreAmpSetting&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4908</span><span class="p">,</span> <span class="s1">&#39;AndorCameraSerial&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4911</span><span class="p">,</span> <span class="s1">&#39;AndorActualTemperature&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4912</span><span class="p">,</span> <span class="s1">&#39;AndorBaselineClamp&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4913</span><span class="p">,</span> <span class="s1">&#39;AndorPrescans&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4914</span><span class="p">,</span> <span class="s1">&#39;AndorModel&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4915</span><span class="p">,</span> <span class="s1">&#39;AndorChipSizeX&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4916</span><span class="p">,</span> <span class="s1">&#39;AndorChipSizeY&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4944</span><span class="p">,</span> <span class="s1">&#39;AndorBaselineOffset&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4966</span><span class="p">,</span> <span class="s1">&#39;AndorSoftwareVersion&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">18246</span><span class="p">,</span> <span class="s1">&#39;Rating&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">18247</span><span class="p">,</span> <span class="s1">&#39;XP_DIP_XML&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">18248</span><span class="p">,</span> <span class="s1">&#39;StitchInfo&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">18249</span><span class="p">,</span> <span class="s1">&#39;RatingPercent&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">20481</span><span class="p">,</span> <span class="s1">&#39;ResolutionXUnit&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20482</span><span class="p">,</span> <span class="s1">&#39;ResolutionYUnit&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20483</span><span class="p">,</span> <span class="s1">&#39;ResolutionXLengthUnit&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20484</span><span class="p">,</span> <span class="s1">&#39;ResolutionYLengthUnit&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20485</span><span class="p">,</span> <span class="s1">&#39;PrintFlags&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20486</span><span class="p">,</span> <span class="s1">&#39;PrintFlagsVersion&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20487</span><span class="p">,</span> <span class="s1">&#39;PrintFlagsCrop&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20488</span><span class="p">,</span> <span class="s1">&#39;PrintFlagsBleedWidth&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20489</span><span class="p">,</span> <span class="s1">&#39;PrintFlagsBleedWidthScale&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20490</span><span class="p">,</span> <span class="s1">&#39;HalftoneLPI&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20491</span><span class="p">,</span> <span class="s1">&#39;HalftoneLPIUnit&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20492</span><span class="p">,</span> <span class="s1">&#39;HalftoneDegree&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20493</span><span class="p">,</span> <span class="s1">&#39;HalftoneShape&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20494</span><span class="p">,</span> <span class="s1">&#39;HalftoneMisc&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20495</span><span class="p">,</span> <span class="s1">&#39;HalftoneScreen&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20496</span><span class="p">,</span> <span class="s1">&#39;JPEGQuality&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20497</span><span class="p">,</span> <span class="s1">&#39;GridSize&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20498</span><span class="p">,</span> <span class="s1">&#39;ThumbnailFormat&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20499</span><span class="p">,</span> <span class="s1">&#39;ThumbnailWidth&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20500</span><span class="p">,</span> <span class="s1">&#39;ThumbnailHeight&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20501</span><span class="p">,</span> <span class="s1">&#39;ThumbnailColorDepth&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20502</span><span class="p">,</span> <span class="s1">&#39;ThumbnailPlanes&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20503</span><span class="p">,</span> <span class="s1">&#39;ThumbnailRawBytes&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20504</span><span class="p">,</span> <span class="s1">&#39;ThumbnailSize&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20505</span><span class="p">,</span> <span class="s1">&#39;ThumbnailCompressedSize&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20506</span><span class="p">,</span> <span class="s1">&#39;ColorTransferFunction&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20507</span><span class="p">,</span> <span class="s1">&#39;ThumbnailData&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">20512</span><span class="p">,</span> <span class="s1">&#39;ThumbnailImageWidth&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20513</span><span class="p">,</span> <span class="s1">&#39;ThumbnailImageHeight&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20514</span><span class="p">,</span> <span class="s1">&#39;ThumbnailBitsPerSample&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20515</span><span class="p">,</span> <span class="s1">&#39;ThumbnailCompression&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">20516</span><span class="p">,</span> <span class="s1">&#39;ThumbnailPhotometricInterp&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20517</span><span class="p">,</span> <span class="s1">&#39;ThumbnailImageDescription&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20518</span><span class="p">,</span> <span class="s1">&#39;ThumbnailEquipMake&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20519</span><span class="p">,</span> <span class="s1">&#39;ThumbnailEquipModel&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20520</span><span class="p">,</span> <span class="s1">&#39;ThumbnailStripOffsets&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20521</span><span class="p">,</span> <span class="s1">&#39;ThumbnailOrientation&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20522</span><span class="p">,</span> <span class="s1">&#39;ThumbnailSamplesPerPixel&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20523</span><span class="p">,</span> <span class="s1">&#39;ThumbnailRowsPerStrip&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20524</span><span class="p">,</span> <span class="s1">&#39;ThumbnailStripBytesCount&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20525</span><span class="p">,</span> <span class="s1">&#39;ThumbnailResolutionX&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">20526</span><span class="p">,</span> <span class="s1">&#39;ThumbnailResolutionY&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">20527</span><span class="p">,</span> <span class="s1">&#39;ThumbnailPlanarConfig&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20528</span><span class="p">,</span> <span class="s1">&#39;ThumbnailResolutionUnit&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">20529</span><span class="p">,</span> <span class="s1">&#39;ThumbnailTransferFunction&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">20530</span><span class="p">,</span> <span class="s1">&#39;ThumbnailSoftwareUsed&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20531</span><span class="p">,</span> <span class="s1">&#39;ThumbnailDateTime&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20532</span><span class="p">,</span> <span class="s1">&#39;ThumbnailArtist&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20533</span><span class="p">,</span> <span class="s1">&#39;ThumbnailWhitePoint&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20534</span><span class="p">,</span> <span class="s1">&#39;ThumbnailPrimaryChromaticities&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20535</span><span class="p">,</span> <span class="s1">&#39;ThumbnailYCbCrCoefficients&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20536</span><span class="p">,</span> <span class="s1">&#39;ThumbnailYCbCrSubsampling&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20537</span><span class="p">,</span> <span class="s1">&#39;ThumbnailYCbCrPositioning&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">20538</span><span class="p">,</span> <span class="s1">&#39;ThumbnailRefBlackWhite&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20539</span><span class="p">,</span> <span class="s1">&#39;ThumbnailCopyRight&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20545</span><span class="p">,</span> <span class="s1">&#39;InteroperabilityIndex&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">20546</span><span class="p">,</span> <span class="s1">&#39;InteroperabilityVersion&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">20624</span><span class="p">,</span> <span class="s1">&#39;LuminanceTable&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">20625</span><span class="p">,</span> <span class="s1">&#39;ChrominanceTable&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">20736</span><span class="p">,</span> <span class="s1">&#39;FrameDelay&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20737</span><span class="p">,</span> <span class="s1">&#39;LoopCount&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20738</span><span class="p">,</span> <span class="s1">&#39;GlobalPalette&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20739</span><span class="p">,</span> <span class="s1">&#39;IndexBackground&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20740</span><span class="p">,</span> <span class="s1">&#39;IndexTransparent&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20752</span><span class="p">,</span> <span class="s1">&#39;PixelUnit&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20753</span><span class="p">,</span> <span class="s1">&#39;PixelPerUnitX&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20754</span><span class="p">,</span> <span class="s1">&#39;PixelPerUnitY&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">20755</span><span class="p">,</span> <span class="s1">&#39;PaletteHistogram&#39;</span><span class="p">),</span>  <span class="c1"># GDI+</span>
                <span class="p">(</span><span class="mi">28672</span><span class="p">,</span> <span class="s1">&#39;SonyRawFileType&#39;</span><span class="p">),</span>  <span class="c1"># Sony ARW</span>
                <span class="p">(</span><span class="mi">28722</span><span class="p">,</span> <span class="s1">&#39;VignettingCorrParams&#39;</span><span class="p">),</span>  <span class="c1"># Sony ARW</span>
                <span class="p">(</span><span class="mi">28725</span><span class="p">,</span> <span class="s1">&#39;ChromaticAberrationCorrParams&#39;</span><span class="p">),</span>  <span class="c1"># Sony ARW</span>
                <span class="p">(</span><span class="mi">28727</span><span class="p">,</span> <span class="s1">&#39;DistortionCorrParams&#39;</span><span class="p">),</span>  <span class="c1"># Sony ARW</span>
                <span class="c1"># Private tags &gt;= 32768</span>
                <span class="p">(</span><span class="mi">32781</span><span class="p">,</span> <span class="s1">&#39;ImageID&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">32931</span><span class="p">,</span> <span class="s1">&#39;WangTag1&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">32932</span><span class="p">,</span> <span class="s1">&#39;WangAnnotation&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">32933</span><span class="p">,</span> <span class="s1">&#39;WangTag3&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">32934</span><span class="p">,</span> <span class="s1">&#39;WangTag4&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">32953</span><span class="p">,</span> <span class="s1">&#39;ImageReferencePoints&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">32954</span><span class="p">,</span> <span class="s1">&#39;RegionXformTackPoint&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">32955</span><span class="p">,</span> <span class="s1">&#39;WarpQuadrilateral&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">32956</span><span class="p">,</span> <span class="s1">&#39;AffineTransformMat&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">32995</span><span class="p">,</span> <span class="s1">&#39;Matteing&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">32996</span><span class="p">,</span> <span class="s1">&#39;DataType&#39;</span><span class="p">),</span>  <span class="c1"># use SampleFormat</span>
                <span class="p">(</span><span class="mi">32997</span><span class="p">,</span> <span class="s1">&#39;ImageDepth&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">32998</span><span class="p">,</span> <span class="s1">&#39;TileDepth&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33300</span><span class="p">,</span> <span class="s1">&#39;ImageFullWidth&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33301</span><span class="p">,</span> <span class="s1">&#39;ImageFullLength&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33302</span><span class="p">,</span> <span class="s1">&#39;TextureFormat&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33303</span><span class="p">,</span> <span class="s1">&#39;TextureWrapModes&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33304</span><span class="p">,</span> <span class="s1">&#39;FieldOfViewCotangent&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33305</span><span class="p">,</span> <span class="s1">&#39;MatrixWorldToScreen&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33306</span><span class="p">,</span> <span class="s1">&#39;MatrixWorldToCamera&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33405</span><span class="p">,</span> <span class="s1">&#39;Model2&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33421</span><span class="p">,</span> <span class="s1">&#39;CFARepeatPatternDim&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33422</span><span class="p">,</span> <span class="s1">&#39;CFAPattern&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33423</span><span class="p">,</span> <span class="s1">&#39;BatteryLevel&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33424</span><span class="p">,</span> <span class="s1">&#39;KodakIFD&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33434</span><span class="p">,</span> <span class="s1">&#39;ExposureTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33437</span><span class="p">,</span> <span class="s1">&#39;FNumber&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33432</span><span class="p">,</span> <span class="s1">&#39;Copyright&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33445</span><span class="p">,</span> <span class="s1">&#39;MDFileTag&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33446</span><span class="p">,</span> <span class="s1">&#39;MDScalePixel&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33447</span><span class="p">,</span> <span class="s1">&#39;MDColorTable&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33448</span><span class="p">,</span> <span class="s1">&#39;MDLabName&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33449</span><span class="p">,</span> <span class="s1">&#39;MDSampleInfo&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33450</span><span class="p">,</span> <span class="s1">&#39;MDPrepDate&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33451</span><span class="p">,</span> <span class="s1">&#39;MDPrepTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33452</span><span class="p">,</span> <span class="s1">&#39;MDFileUnits&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33465</span><span class="p">,</span> <span class="s1">&#39;NiffRotation&#39;</span><span class="p">),</span>  <span class="c1"># NIFF</span>
                <span class="p">(</span><span class="mi">33466</span><span class="p">,</span> <span class="s1">&#39;NiffNavyCompression&#39;</span><span class="p">),</span>  <span class="c1"># NIFF</span>
                <span class="p">(</span><span class="mi">33467</span><span class="p">,</span> <span class="s1">&#39;NiffTileIndex&#39;</span><span class="p">),</span>  <span class="c1"># NIFF</span>
                <span class="p">(</span><span class="mi">33471</span><span class="p">,</span> <span class="s1">&#39;OlympusINI&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33550</span><span class="p">,</span> <span class="s1">&#39;ModelPixelScaleTag&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33560</span><span class="p">,</span> <span class="s1">&#39;OlympusSIS&#39;</span><span class="p">),</span>  <span class="c1"># see also 33471 and 34853</span>
                <span class="p">(</span><span class="mi">33589</span><span class="p">,</span> <span class="s1">&#39;AdventScale&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33590</span><span class="p">,</span> <span class="s1">&#39;AdventRevision&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33628</span><span class="p">,</span> <span class="s1">&#39;UIC1tag&#39;</span><span class="p">),</span>  <span class="c1"># Metamorph  Universal Imaging Corp STK</span>
                <span class="p">(</span><span class="mi">33629</span><span class="p">,</span> <span class="s1">&#39;UIC2tag&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33630</span><span class="p">,</span> <span class="s1">&#39;UIC3tag&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33631</span><span class="p">,</span> <span class="s1">&#39;UIC4tag&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33723</span><span class="p">,</span> <span class="s1">&#39;IPTCNAA&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33858</span><span class="p">,</span> <span class="s1">&#39;ExtendedTagsOffset&#39;</span><span class="p">),</span>  <span class="c1"># DEFF points IFD with tags</span>
                <span class="p">(</span><span class="mi">33918</span><span class="p">,</span> <span class="s1">&#39;IntergraphPacketData&#39;</span><span class="p">),</span>  <span class="c1"># INGRPacketDataTag</span>
                <span class="p">(</span><span class="mi">33919</span><span class="p">,</span> <span class="s1">&#39;IntergraphFlagRegisters&#39;</span><span class="p">),</span>  <span class="c1"># INGRFlagRegisters</span>
                <span class="p">(</span><span class="mi">33920</span><span class="p">,</span> <span class="s1">&#39;IntergraphMatrixTag&#39;</span><span class="p">),</span>  <span class="c1"># IrasBTransformationMatrix</span>
                <span class="p">(</span><span class="mi">33921</span><span class="p">,</span> <span class="s1">&#39;INGRReserved&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33922</span><span class="p">,</span> <span class="s1">&#39;ModelTiepointTag&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">33923</span><span class="p">,</span> <span class="s1">&#39;LeicaMagic&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34016</span><span class="p">,</span> <span class="s1">&#39;Site&#39;</span><span class="p">),</span>  <span class="c1"># 34016..34032 ANSI IT8 TIFF/IT</span>
                <span class="p">(</span><span class="mi">34017</span><span class="p">,</span> <span class="s1">&#39;ColorSequence&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34018</span><span class="p">,</span> <span class="s1">&#39;IT8Header&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34019</span><span class="p">,</span> <span class="s1">&#39;RasterPadding&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34020</span><span class="p">,</span> <span class="s1">&#39;BitsPerRunLength&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34021</span><span class="p">,</span> <span class="s1">&#39;BitsPerExtendedRunLength&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34022</span><span class="p">,</span> <span class="s1">&#39;ColorTable&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34023</span><span class="p">,</span> <span class="s1">&#39;ImageColorIndicator&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34024</span><span class="p">,</span> <span class="s1">&#39;BackgroundColorIndicator&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34025</span><span class="p">,</span> <span class="s1">&#39;ImageColorValue&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34026</span><span class="p">,</span> <span class="s1">&#39;BackgroundColorValue&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34027</span><span class="p">,</span> <span class="s1">&#39;PixelIntensityRange&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34028</span><span class="p">,</span> <span class="s1">&#39;TransparencyIndicator&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34029</span><span class="p">,</span> <span class="s1">&#39;ColorCharacterization&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34030</span><span class="p">,</span> <span class="s1">&#39;HCUsage&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34031</span><span class="p">,</span> <span class="s1">&#39;TrapIndicator&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34032</span><span class="p">,</span> <span class="s1">&#39;CMYKEquivalent&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34118</span><span class="p">,</span> <span class="s1">&#39;CZ_SEM&#39;</span><span class="p">),</span>  <span class="c1"># Zeiss SEM</span>
                <span class="p">(</span><span class="mi">34152</span><span class="p">,</span> <span class="s1">&#39;AFCP_IPTC&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34232</span><span class="p">,</span> <span class="s1">&#39;PixelMagicJBIGOptions&#39;</span><span class="p">),</span>  <span class="c1"># EXIF, also TI FrameCount</span>
                <span class="p">(</span><span class="mi">34263</span><span class="p">,</span> <span class="s1">&#39;JPLCartoIFD&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34122</span><span class="p">,</span> <span class="s1">&#39;IPLAB&#39;</span><span class="p">),</span>  <span class="c1"># number of images</span>
                <span class="p">(</span><span class="mi">34264</span><span class="p">,</span> <span class="s1">&#39;ModelTransformationTag&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34306</span><span class="p">,</span> <span class="s1">&#39;WB_GRGBLevels&#39;</span><span class="p">),</span>  <span class="c1"># Leaf MOS</span>
                <span class="p">(</span><span class="mi">34310</span><span class="p">,</span> <span class="s1">&#39;LeafData&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34361</span><span class="p">,</span> <span class="s1">&#39;MM_Header&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34362</span><span class="p">,</span> <span class="s1">&#39;MM_Stamp&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34363</span><span class="p">,</span> <span class="s1">&#39;MM_Unknown&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34377</span><span class="p">,</span> <span class="s1">&#39;ImageResources&#39;</span><span class="p">),</span>  <span class="c1"># Photoshop</span>
                <span class="p">(</span><span class="mi">34386</span><span class="p">,</span> <span class="s1">&#39;MM_UserBlock&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34412</span><span class="p">,</span> <span class="s1">&#39;CZ_LSMINFO&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34665</span><span class="p">,</span> <span class="s1">&#39;ExifTag&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34675</span><span class="p">,</span> <span class="s1">&#39;InterColorProfile&#39;</span><span class="p">),</span>  <span class="c1"># ICCProfile</span>
                <span class="p">(</span><span class="mi">34680</span><span class="p">,</span> <span class="s1">&#39;FEI_SFEG&#39;</span><span class="p">),</span>  <span class="c1">#</span>
                <span class="p">(</span><span class="mi">34682</span><span class="p">,</span> <span class="s1">&#39;FEI_HELIOS&#39;</span><span class="p">),</span>  <span class="c1">#</span>
                <span class="p">(</span><span class="mi">34683</span><span class="p">,</span> <span class="s1">&#39;FEI_TITAN&#39;</span><span class="p">),</span>  <span class="c1">#</span>
                <span class="p">(</span><span class="mi">34687</span><span class="p">,</span> <span class="s1">&#39;FXExtensions&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34688</span><span class="p">,</span> <span class="s1">&#39;MultiProfiles&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34689</span><span class="p">,</span> <span class="s1">&#39;SharedData&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34690</span><span class="p">,</span> <span class="s1">&#39;T88Options&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34710</span><span class="p">,</span> <span class="s1">&#39;MarCCD&#39;</span><span class="p">),</span>  <span class="c1"># offset to MarCCD header</span>
                <span class="p">(</span><span class="mi">34732</span><span class="p">,</span> <span class="s1">&#39;ImageLayer&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34735</span><span class="p">,</span> <span class="s1">&#39;GeoKeyDirectoryTag&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34736</span><span class="p">,</span> <span class="s1">&#39;GeoDoubleParamsTag&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34737</span><span class="p">,</span> <span class="s1">&#39;GeoAsciiParamsTag&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34750</span><span class="p">,</span> <span class="s1">&#39;JBIGOptions&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34821</span><span class="p">,</span> <span class="s1">&#39;PIXTIFF&#39;</span><span class="p">),</span>  <span class="c1"># ? Pixel Translations Inc</span>
                <span class="p">(</span><span class="mi">34850</span><span class="p">,</span> <span class="s1">&#39;ExposureProgram&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34852</span><span class="p">,</span> <span class="s1">&#39;SpectralSensitivity&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34853</span><span class="p">,</span> <span class="s1">&#39;GPSTag&#39;</span><span class="p">),</span>  <span class="c1"># GPSIFD  also OlympusSIS2</span>
                <span class="p">(</span><span class="mi">34853</span><span class="p">,</span> <span class="s1">&#39;OlympusSIS2&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34855</span><span class="p">,</span> <span class="s1">&#39;ISOSpeedRatings&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34855</span><span class="p">,</span> <span class="s1">&#39;PhotographicSensitivity&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34856</span><span class="p">,</span> <span class="s1">&#39;OECF&#39;</span><span class="p">),</span>  <span class="c1"># optoelectric conversion factor</span>
                <span class="p">(</span><span class="mi">34857</span><span class="p">,</span> <span class="s1">&#39;Interlace&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34858</span><span class="p">,</span> <span class="s1">&#39;TimeZoneOffset&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34859</span><span class="p">,</span> <span class="s1">&#39;SelfTimerMode&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34864</span><span class="p">,</span> <span class="s1">&#39;SensitivityType&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34865</span><span class="p">,</span> <span class="s1">&#39;StandardOutputSensitivity&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34866</span><span class="p">,</span> <span class="s1">&#39;RecommendedExposureIndex&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34867</span><span class="p">,</span> <span class="s1">&#39;ISOSpeed&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34868</span><span class="p">,</span> <span class="s1">&#39;ISOSpeedLatitudeyyy&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34869</span><span class="p">,</span> <span class="s1">&#39;ISOSpeedLatitudezzz&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34908</span><span class="p">,</span> <span class="s1">&#39;HylaFAXFaxRecvParams&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34909</span><span class="p">,</span> <span class="s1">&#39;HylaFAXFaxSubAddress&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34910</span><span class="p">,</span> <span class="s1">&#39;HylaFAXFaxRecvTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34911</span><span class="p">,</span> <span class="s1">&#39;FaxDcs&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34929</span><span class="p">,</span> <span class="s1">&#39;FedexEDR&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34954</span><span class="p">,</span> <span class="s1">&#39;LeafSubIFD&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34959</span><span class="p">,</span> <span class="s1">&#39;Aphelion1&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34960</span><span class="p">,</span> <span class="s1">&#39;Aphelion2&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">34961</span><span class="p">,</span> <span class="s1">&#39;AphelionInternal&#39;</span><span class="p">),</span>  <span class="c1"># ADCIS</span>
                <span class="p">(</span><span class="mi">36864</span><span class="p">,</span> <span class="s1">&#39;ExifVersion&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36867</span><span class="p">,</span> <span class="s1">&#39;DateTimeOriginal&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36868</span><span class="p">,</span> <span class="s1">&#39;DateTimeDigitized&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36873</span><span class="p">,</span> <span class="s1">&#39;GooglePlusUploadCode&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36880</span><span class="p">,</span> <span class="s1">&#39;OffsetTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36881</span><span class="p">,</span> <span class="s1">&#39;OffsetTimeOriginal&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36882</span><span class="p">,</span> <span class="s1">&#39;OffsetTimeDigitized&#39;</span><span class="p">),</span>
                <span class="c1"># TODO, Pilatus/CHESS/TV6 36864..37120 conflicting with Exif</span>
                <span class="p">(</span><span class="mi">36864</span><span class="p">,</span> <span class="s1">&#39;TVX_Unknown&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36865</span><span class="p">,</span> <span class="s1">&#39;TVX_NumExposure&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36866</span><span class="p">,</span> <span class="s1">&#39;TVX_NumBackground&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36867</span><span class="p">,</span> <span class="s1">&#39;TVX_ExposureTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36868</span><span class="p">,</span> <span class="s1">&#39;TVX_BackgroundTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36870</span><span class="p">,</span> <span class="s1">&#39;TVX_Unknown&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36873</span><span class="p">,</span> <span class="s1">&#39;TVX_SubBpp&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36874</span><span class="p">,</span> <span class="s1">&#39;TVX_SubWide&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36875</span><span class="p">,</span> <span class="s1">&#39;TVX_SubHigh&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36876</span><span class="p">,</span> <span class="s1">&#39;TVX_BlackLevel&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36877</span><span class="p">,</span> <span class="s1">&#39;TVX_DarkCurrent&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36878</span><span class="p">,</span> <span class="s1">&#39;TVX_ReadNoise&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36879</span><span class="p">,</span> <span class="s1">&#39;TVX_DarkCurrentNoise&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">36880</span><span class="p">,</span> <span class="s1">&#39;TVX_BeamMonitor&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37120</span><span class="p">,</span> <span class="s1">&#39;TVX_UserVariables&#39;</span><span class="p">),</span>  <span class="c1"># A/D values</span>
                <span class="p">(</span><span class="mi">37121</span><span class="p">,</span> <span class="s1">&#39;ComponentsConfiguration&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37122</span><span class="p">,</span> <span class="s1">&#39;CompressedBitsPerPixel&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37377</span><span class="p">,</span> <span class="s1">&#39;ShutterSpeedValue&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37378</span><span class="p">,</span> <span class="s1">&#39;ApertureValue&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37379</span><span class="p">,</span> <span class="s1">&#39;BrightnessValue&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37380</span><span class="p">,</span> <span class="s1">&#39;ExposureBiasValue&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37381</span><span class="p">,</span> <span class="s1">&#39;MaxApertureValue&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37382</span><span class="p">,</span> <span class="s1">&#39;SubjectDistance&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37383</span><span class="p">,</span> <span class="s1">&#39;MeteringMode&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37384</span><span class="p">,</span> <span class="s1">&#39;LightSource&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37385</span><span class="p">,</span> <span class="s1">&#39;Flash&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37386</span><span class="p">,</span> <span class="s1">&#39;FocalLength&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37387</span><span class="p">,</span> <span class="s1">&#39;FlashEnergy&#39;</span><span class="p">),</span>  <span class="c1"># 37387</span>
                <span class="p">(</span><span class="mi">37388</span><span class="p">,</span> <span class="s1">&#39;SpatialFrequencyResponse&#39;</span><span class="p">),</span>  <span class="c1"># 37388</span>
                <span class="p">(</span><span class="mi">37389</span><span class="p">,</span> <span class="s1">&#39;Noise&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37390</span><span class="p">,</span> <span class="s1">&#39;FocalPlaneXResolution&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37391</span><span class="p">,</span> <span class="s1">&#39;FocalPlaneYResolution&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37392</span><span class="p">,</span> <span class="s1">&#39;FocalPlaneResolutionUnit&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37393</span><span class="p">,</span> <span class="s1">&#39;ImageNumber&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37394</span><span class="p">,</span> <span class="s1">&#39;SecurityClassification&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37395</span><span class="p">,</span> <span class="s1">&#39;ImageHistory&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37396</span><span class="p">,</span> <span class="s1">&#39;SubjectLocation&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37397</span><span class="p">,</span> <span class="s1">&#39;ExposureIndex&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37398</span><span class="p">,</span> <span class="s1">&#39;TIFFEPStandardID&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37399</span><span class="p">,</span> <span class="s1">&#39;SensingMethod&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37434</span><span class="p">,</span> <span class="s1">&#39;CIP3DataFile&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37435</span><span class="p">,</span> <span class="s1">&#39;CIP3Sheet&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37436</span><span class="p">,</span> <span class="s1">&#39;CIP3Side&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37439</span><span class="p">,</span> <span class="s1">&#39;StoNits&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37500</span><span class="p">,</span> <span class="s1">&#39;MakerNote&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37510</span><span class="p">,</span> <span class="s1">&#39;UserComment&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37520</span><span class="p">,</span> <span class="s1">&#39;SubsecTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37521</span><span class="p">,</span> <span class="s1">&#39;SubsecTimeOriginal&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37522</span><span class="p">,</span> <span class="s1">&#39;SubsecTimeDigitized&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37679</span><span class="p">,</span> <span class="s1">&#39;MODIText&#39;</span><span class="p">),</span>  <span class="c1"># Microsoft Office Document Imaging</span>
                <span class="p">(</span><span class="mi">37680</span><span class="p">,</span> <span class="s1">&#39;MODIOLEPropertySetStorage&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37681</span><span class="p">,</span> <span class="s1">&#39;MODIPositioning&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37706</span><span class="p">,</span> <span class="s1">&#39;TVIPS&#39;</span><span class="p">),</span>  <span class="c1"># offset to TemData structure</span>
                <span class="p">(</span><span class="mi">37707</span><span class="p">,</span> <span class="s1">&#39;TVIPS1&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37708</span><span class="p">,</span> <span class="s1">&#39;TVIPS2&#39;</span><span class="p">),</span>  <span class="c1"># same TemData structure as undefined</span>
                <span class="p">(</span><span class="mi">37724</span><span class="p">,</span> <span class="s1">&#39;ImageSourceData&#39;</span><span class="p">),</span>  <span class="c1"># Photoshop</span>
                <span class="p">(</span><span class="mi">37888</span><span class="p">,</span> <span class="s1">&#39;Temperature&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37889</span><span class="p">,</span> <span class="s1">&#39;Humidity&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37890</span><span class="p">,</span> <span class="s1">&#39;Pressure&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37891</span><span class="p">,</span> <span class="s1">&#39;WaterDepth&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37892</span><span class="p">,</span> <span class="s1">&#39;Acceleration&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">37893</span><span class="p">,</span> <span class="s1">&#39;CameraElevationAngle&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40000</span><span class="p">,</span> <span class="s1">&#39;XPos&#39;</span><span class="p">),</span>  <span class="c1"># Janelia</span>
                <span class="p">(</span><span class="mi">40001</span><span class="p">,</span> <span class="s1">&#39;YPos&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40002</span><span class="p">,</span> <span class="s1">&#39;ZPos&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40001</span><span class="p">,</span> <span class="s1">&#39;MC_IpWinScal&#39;</span><span class="p">),</span>  <span class="c1"># Media Cybernetics</span>
                <span class="p">(</span><span class="mi">40001</span><span class="p">,</span> <span class="s1">&#39;RecipName&#39;</span><span class="p">),</span>  <span class="c1"># MS FAX</span>
                <span class="p">(</span><span class="mi">40002</span><span class="p">,</span> <span class="s1">&#39;RecipNumber&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40003</span><span class="p">,</span> <span class="s1">&#39;SenderName&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40004</span><span class="p">,</span> <span class="s1">&#39;Routing&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40005</span><span class="p">,</span> <span class="s1">&#39;CallerId&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40006</span><span class="p">,</span> <span class="s1">&#39;TSID&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40007</span><span class="p">,</span> <span class="s1">&#39;CSID&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40008</span><span class="p">,</span> <span class="s1">&#39;FaxTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40100</span><span class="p">,</span> <span class="s1">&#39;MC_IdOld&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40106</span><span class="p">,</span> <span class="s1">&#39;MC_Unknown&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40965</span><span class="p">,</span> <span class="s1">&#39;InteroperabilityTag&#39;</span><span class="p">),</span>  <span class="c1"># InteropOffset</span>
                <span class="p">(</span><span class="mi">40091</span><span class="p">,</span> <span class="s1">&#39;XPTitle&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40092</span><span class="p">,</span> <span class="s1">&#39;XPComment&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40093</span><span class="p">,</span> <span class="s1">&#39;XPAuthor&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40094</span><span class="p">,</span> <span class="s1">&#39;XPKeywords&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40095</span><span class="p">,</span> <span class="s1">&#39;XPSubject&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40960</span><span class="p">,</span> <span class="s1">&#39;FlashpixVersion&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40961</span><span class="p">,</span> <span class="s1">&#39;ColorSpace&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40962</span><span class="p">,</span> <span class="s1">&#39;PixelXDimension&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40963</span><span class="p">,</span> <span class="s1">&#39;PixelYDimension&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40964</span><span class="p">,</span> <span class="s1">&#39;RelatedSoundFile&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40976</span><span class="p">,</span> <span class="s1">&#39;SamsungRawPointersOffset&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">40977</span><span class="p">,</span> <span class="s1">&#39;SamsungRawPointersLength&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41217</span><span class="p">,</span> <span class="s1">&#39;SamsungRawByteOrder&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41218</span><span class="p">,</span> <span class="s1">&#39;SamsungRawUnknown&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41483</span><span class="p">,</span> <span class="s1">&#39;FlashEnergy&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41484</span><span class="p">,</span> <span class="s1">&#39;SpatialFrequencyResponse&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41485</span><span class="p">,</span> <span class="s1">&#39;Noise&#39;</span><span class="p">),</span>  <span class="c1"># 37389</span>
                <span class="p">(</span><span class="mi">41486</span><span class="p">,</span> <span class="s1">&#39;FocalPlaneXResolution&#39;</span><span class="p">),</span>  <span class="c1"># 37390</span>
                <span class="p">(</span><span class="mi">41487</span><span class="p">,</span> <span class="s1">&#39;FocalPlaneYResolution&#39;</span><span class="p">),</span>  <span class="c1"># 37391</span>
                <span class="p">(</span><span class="mi">41488</span><span class="p">,</span> <span class="s1">&#39;FocalPlaneResolutionUnit&#39;</span><span class="p">),</span>  <span class="c1"># 37392</span>
                <span class="p">(</span><span class="mi">41489</span><span class="p">,</span> <span class="s1">&#39;ImageNumber&#39;</span><span class="p">),</span>  <span class="c1"># 37393</span>
                <span class="p">(</span><span class="mi">41490</span><span class="p">,</span> <span class="s1">&#39;SecurityClassification&#39;</span><span class="p">),</span>  <span class="c1"># 37394</span>
                <span class="p">(</span><span class="mi">41491</span><span class="p">,</span> <span class="s1">&#39;ImageHistory&#39;</span><span class="p">),</span>  <span class="c1"># 37395</span>
                <span class="p">(</span><span class="mi">41492</span><span class="p">,</span> <span class="s1">&#39;SubjectLocation&#39;</span><span class="p">),</span>  <span class="c1"># 37395</span>
                <span class="p">(</span><span class="mi">41493</span><span class="p">,</span> <span class="s1">&#39;ExposureIndex &#39;</span><span class="p">),</span>  <span class="c1"># 37397</span>
                <span class="p">(</span><span class="mi">41494</span><span class="p">,</span> <span class="s1">&#39;TIFF-EPStandardID&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41495</span><span class="p">,</span> <span class="s1">&#39;SensingMethod&#39;</span><span class="p">),</span>  <span class="c1"># 37399</span>
                <span class="p">(</span><span class="mi">41728</span><span class="p">,</span> <span class="s1">&#39;FileSource&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41729</span><span class="p">,</span> <span class="s1">&#39;SceneType&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41730</span><span class="p">,</span> <span class="s1">&#39;CFAPattern&#39;</span><span class="p">),</span>  <span class="c1"># 33422</span>
                <span class="p">(</span><span class="mi">41985</span><span class="p">,</span> <span class="s1">&#39;CustomRendered&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41986</span><span class="p">,</span> <span class="s1">&#39;ExposureMode&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41987</span><span class="p">,</span> <span class="s1">&#39;WhiteBalance&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41988</span><span class="p">,</span> <span class="s1">&#39;DigitalZoomRatio&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41989</span><span class="p">,</span> <span class="s1">&#39;FocalLengthIn35mmFilm&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41990</span><span class="p">,</span> <span class="s1">&#39;SceneCaptureType&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41991</span><span class="p">,</span> <span class="s1">&#39;GainControl&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41992</span><span class="p">,</span> <span class="s1">&#39;Contrast&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41993</span><span class="p">,</span> <span class="s1">&#39;Saturation&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41994</span><span class="p">,</span> <span class="s1">&#39;Sharpness&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41995</span><span class="p">,</span> <span class="s1">&#39;DeviceSettingDescription&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">41996</span><span class="p">,</span> <span class="s1">&#39;SubjectDistanceRange&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">42016</span><span class="p">,</span> <span class="s1">&#39;ImageUniqueID&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">42032</span><span class="p">,</span> <span class="s1">&#39;CameraOwnerName&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">42033</span><span class="p">,</span> <span class="s1">&#39;BodySerialNumber&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">42034</span><span class="p">,</span> <span class="s1">&#39;LensSpecification&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">42035</span><span class="p">,</span> <span class="s1">&#39;LensMake&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">42036</span><span class="p">,</span> <span class="s1">&#39;LensModel&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">42037</span><span class="p">,</span> <span class="s1">&#39;LensSerialNumber&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">42080</span><span class="p">,</span> <span class="s1">&#39;CompositeImage&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">42081</span><span class="p">,</span> <span class="s1">&#39;SourceImageNumberCompositeImage&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">42082</span><span class="p">,</span> <span class="s1">&#39;SourceExposureTimesCompositeImage&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">42112</span><span class="p">,</span> <span class="s1">&#39;GDAL_METADATA&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">42113</span><span class="p">,</span> <span class="s1">&#39;GDAL_NODATA&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">42240</span><span class="p">,</span> <span class="s1">&#39;Gamma&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">43314</span><span class="p">,</span> <span class="s1">&#39;NIHImageHeader&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">44992</span><span class="p">,</span> <span class="s1">&#39;ExpandSoftware&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">44993</span><span class="p">,</span> <span class="s1">&#39;ExpandLens&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">44994</span><span class="p">,</span> <span class="s1">&#39;ExpandFilm&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">44995</span><span class="p">,</span> <span class="s1">&#39;ExpandFilterLens&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">44996</span><span class="p">,</span> <span class="s1">&#39;ExpandScanner&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">44997</span><span class="p">,</span> <span class="s1">&#39;ExpandFlashLamp&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">48129</span><span class="p">,</span> <span class="s1">&#39;PixelFormat&#39;</span><span class="p">),</span>  <span class="c1"># HDP and WDP</span>
                <span class="p">(</span><span class="mi">48130</span><span class="p">,</span> <span class="s1">&#39;Transformation&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">48131</span><span class="p">,</span> <span class="s1">&#39;Uncompressed&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">48132</span><span class="p">,</span> <span class="s1">&#39;ImageType&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">48256</span><span class="p">,</span> <span class="s1">&#39;ImageWidth&#39;</span><span class="p">),</span>  <span class="c1"># 256</span>
                <span class="p">(</span><span class="mi">48257</span><span class="p">,</span> <span class="s1">&#39;ImageHeight&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">48258</span><span class="p">,</span> <span class="s1">&#39;WidthResolution&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">48259</span><span class="p">,</span> <span class="s1">&#39;HeightResolution&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">48320</span><span class="p">,</span> <span class="s1">&#39;ImageOffset&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">48321</span><span class="p">,</span> <span class="s1">&#39;ImageByteCount&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">48322</span><span class="p">,</span> <span class="s1">&#39;AlphaOffset&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">48323</span><span class="p">,</span> <span class="s1">&#39;AlphaByteCount&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">48324</span><span class="p">,</span> <span class="s1">&#39;ImageDataDiscard&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">48325</span><span class="p">,</span> <span class="s1">&#39;AlphaDataDiscard&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50003</span><span class="p">,</span> <span class="s1">&#39;KodakAPP3&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50215</span><span class="p">,</span> <span class="s1">&#39;OceScanjobDescription&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50216</span><span class="p">,</span> <span class="s1">&#39;OceApplicationSelector&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50217</span><span class="p">,</span> <span class="s1">&#39;OceIdentificationNumber&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50218</span><span class="p">,</span> <span class="s1">&#39;OceImageLogicCharacteristics&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50255</span><span class="p">,</span> <span class="s1">&#39;Annotations&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50288</span><span class="p">,</span> <span class="s1">&#39;MC_Id&#39;</span><span class="p">),</span>  <span class="c1"># Media Cybernetics</span>
                <span class="p">(</span><span class="mi">50289</span><span class="p">,</span> <span class="s1">&#39;MC_XYPosition&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50290</span><span class="p">,</span> <span class="s1">&#39;MC_ZPosition&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50291</span><span class="p">,</span> <span class="s1">&#39;MC_XYCalibration&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50292</span><span class="p">,</span> <span class="s1">&#39;MC_LensCharacteristics&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50293</span><span class="p">,</span> <span class="s1">&#39;MC_ChannelName&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50294</span><span class="p">,</span> <span class="s1">&#39;MC_ExcitationWavelength&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50295</span><span class="p">,</span> <span class="s1">&#39;MC_TimeStamp&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50296</span><span class="p">,</span> <span class="s1">&#39;MC_FrameProperties&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50341</span><span class="p">,</span> <span class="s1">&#39;PrintImageMatching&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50495</span><span class="p">,</span> <span class="s1">&#39;PCO_RAW&#39;</span><span class="p">),</span>  <span class="c1"># TODO, PCO CamWare</span>
                <span class="p">(</span><span class="mi">50547</span><span class="p">,</span> <span class="s1">&#39;OriginalFileName&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50560</span><span class="p">,</span> <span class="s1">&#39;USPTO_OriginalContentType&#39;</span><span class="p">),</span>  <span class="c1"># US Patent Office</span>
                <span class="p">(</span><span class="mi">50561</span><span class="p">,</span> <span class="s1">&#39;USPTO_RotationCode&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50648</span><span class="p">,</span> <span class="s1">&#39;CR2Unknown1&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50649</span><span class="p">,</span> <span class="s1">&#39;CR2Unknown2&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50656</span><span class="p">,</span> <span class="s1">&#39;CR2CFAPattern&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50674</span><span class="p">,</span> <span class="s1">&#39;LercParameters&#39;</span><span class="p">),</span>  <span class="c1"># ESGI 50674 .. 50677</span>
                <span class="p">(</span><span class="mi">50706</span><span class="p">,</span> <span class="s1">&#39;DNGVersion&#39;</span><span class="p">),</span>  <span class="c1"># DNG 50706 .. 51114</span>
                <span class="p">(</span><span class="mi">50707</span><span class="p">,</span> <span class="s1">&#39;DNGBackwardVersion&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50708</span><span class="p">,</span> <span class="s1">&#39;UniqueCameraModel&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50709</span><span class="p">,</span> <span class="s1">&#39;LocalizedCameraModel&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50710</span><span class="p">,</span> <span class="s1">&#39;CFAPlaneColor&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50711</span><span class="p">,</span> <span class="s1">&#39;CFALayout&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50712</span><span class="p">,</span> <span class="s1">&#39;LinearizationTable&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50713</span><span class="p">,</span> <span class="s1">&#39;BlackLevelRepeatDim&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50714</span><span class="p">,</span> <span class="s1">&#39;BlackLevel&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50715</span><span class="p">,</span> <span class="s1">&#39;BlackLevelDeltaH&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50716</span><span class="p">,</span> <span class="s1">&#39;BlackLevelDeltaV&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50717</span><span class="p">,</span> <span class="s1">&#39;WhiteLevel&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50718</span><span class="p">,</span> <span class="s1">&#39;DefaultScale&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50719</span><span class="p">,</span> <span class="s1">&#39;DefaultCropOrigin&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50720</span><span class="p">,</span> <span class="s1">&#39;DefaultCropSize&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50721</span><span class="p">,</span> <span class="s1">&#39;ColorMatrix1&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50722</span><span class="p">,</span> <span class="s1">&#39;ColorMatrix2&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50723</span><span class="p">,</span> <span class="s1">&#39;CameraCalibration1&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50724</span><span class="p">,</span> <span class="s1">&#39;CameraCalibration2&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50725</span><span class="p">,</span> <span class="s1">&#39;ReductionMatrix1&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50726</span><span class="p">,</span> <span class="s1">&#39;ReductionMatrix2&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50727</span><span class="p">,</span> <span class="s1">&#39;AnalogBalance&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50728</span><span class="p">,</span> <span class="s1">&#39;AsShotNeutral&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50729</span><span class="p">,</span> <span class="s1">&#39;AsShotWhiteXY&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50730</span><span class="p">,</span> <span class="s1">&#39;BaselineExposure&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50731</span><span class="p">,</span> <span class="s1">&#39;BaselineNoise&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50732</span><span class="p">,</span> <span class="s1">&#39;BaselineSharpness&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50733</span><span class="p">,</span> <span class="s1">&#39;BayerGreenSplit&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50734</span><span class="p">,</span> <span class="s1">&#39;LinearResponseLimit&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50735</span><span class="p">,</span> <span class="s1">&#39;CameraSerialNumber&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50736</span><span class="p">,</span> <span class="s1">&#39;LensInfo&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50737</span><span class="p">,</span> <span class="s1">&#39;ChromaBlurRadius&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50738</span><span class="p">,</span> <span class="s1">&#39;AntiAliasStrength&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50739</span><span class="p">,</span> <span class="s1">&#39;ShadowScale&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50740</span><span class="p">,</span> <span class="s1">&#39;DNGPrivateData&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50741</span><span class="p">,</span> <span class="s1">&#39;MakerNoteSafety&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50752</span><span class="p">,</span> <span class="s1">&#39;RawImageSegmentation&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50778</span><span class="p">,</span> <span class="s1">&#39;CalibrationIlluminant1&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50779</span><span class="p">,</span> <span class="s1">&#39;CalibrationIlluminant2&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50780</span><span class="p">,</span> <span class="s1">&#39;BestQualityScale&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50781</span><span class="p">,</span> <span class="s1">&#39;RawDataUniqueID&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50784</span><span class="p">,</span> <span class="s1">&#39;AliasLayerMetadata&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50827</span><span class="p">,</span> <span class="s1">&#39;OriginalRawFileName&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50828</span><span class="p">,</span> <span class="s1">&#39;OriginalRawFileData&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50829</span><span class="p">,</span> <span class="s1">&#39;ActiveArea&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50830</span><span class="p">,</span> <span class="s1">&#39;MaskedAreas&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50831</span><span class="p">,</span> <span class="s1">&#39;AsShotICCProfile&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50832</span><span class="p">,</span> <span class="s1">&#39;AsShotPreProfileMatrix&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50833</span><span class="p">,</span> <span class="s1">&#39;CurrentICCProfile&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50834</span><span class="p">,</span> <span class="s1">&#39;CurrentPreProfileMatrix&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50838</span><span class="p">,</span> <span class="s1">&#39;IJMetadataByteCounts&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50839</span><span class="p">,</span> <span class="s1">&#39;IJMetadata&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50844</span><span class="p">,</span> <span class="s1">&#39;RPCCoefficientTag&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50879</span><span class="p">,</span> <span class="s1">&#39;ColorimetricReference&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50885</span><span class="p">,</span> <span class="s1">&#39;SRawType&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50898</span><span class="p">,</span> <span class="s1">&#39;PanasonicTitle&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50899</span><span class="p">,</span> <span class="s1">&#39;PanasonicTitle2&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50908</span><span class="p">,</span> <span class="s1">&#39;RSID&#39;</span><span class="p">),</span>  <span class="c1"># DGIWG</span>
                <span class="p">(</span><span class="mi">50909</span><span class="p">,</span> <span class="s1">&#39;GEO_METADATA&#39;</span><span class="p">),</span>  <span class="c1"># DGIWG XML</span>
                <span class="p">(</span><span class="mi">50931</span><span class="p">,</span> <span class="s1">&#39;CameraCalibrationSignature&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50932</span><span class="p">,</span> <span class="s1">&#39;ProfileCalibrationSignature&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50933</span><span class="p">,</span> <span class="s1">&#39;ProfileIFD&#39;</span><span class="p">),</span>  <span class="c1"># EXTRACAMERAPROFILES</span>
                <span class="p">(</span><span class="mi">50934</span><span class="p">,</span> <span class="s1">&#39;AsShotProfileName&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50935</span><span class="p">,</span> <span class="s1">&#39;NoiseReductionApplied&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50936</span><span class="p">,</span> <span class="s1">&#39;ProfileName&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50937</span><span class="p">,</span> <span class="s1">&#39;ProfileHueSatMapDims&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50938</span><span class="p">,</span> <span class="s1">&#39;ProfileHueSatMapData1&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50939</span><span class="p">,</span> <span class="s1">&#39;ProfileHueSatMapData2&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50940</span><span class="p">,</span> <span class="s1">&#39;ProfileToneCurve&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50941</span><span class="p">,</span> <span class="s1">&#39;ProfileEmbedPolicy&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50942</span><span class="p">,</span> <span class="s1">&#39;ProfileCopyright&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50964</span><span class="p">,</span> <span class="s1">&#39;ForwardMatrix1&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50965</span><span class="p">,</span> <span class="s1">&#39;ForwardMatrix2&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50966</span><span class="p">,</span> <span class="s1">&#39;PreviewApplicationName&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50967</span><span class="p">,</span> <span class="s1">&#39;PreviewApplicationVersion&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50968</span><span class="p">,</span> <span class="s1">&#39;PreviewSettingsName&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50969</span><span class="p">,</span> <span class="s1">&#39;PreviewSettingsDigest&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50970</span><span class="p">,</span> <span class="s1">&#39;PreviewColorSpace&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50971</span><span class="p">,</span> <span class="s1">&#39;PreviewDateTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50972</span><span class="p">,</span> <span class="s1">&#39;RawImageDigest&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50973</span><span class="p">,</span> <span class="s1">&#39;OriginalRawFileDigest&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50974</span><span class="p">,</span> <span class="s1">&#39;SubTileBlockSize&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50975</span><span class="p">,</span> <span class="s1">&#39;RowInterleaveFactor&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50981</span><span class="p">,</span> <span class="s1">&#39;ProfileLookTableDims&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">50982</span><span class="p">,</span> <span class="s1">&#39;ProfileLookTableData&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51008</span><span class="p">,</span> <span class="s1">&#39;OpcodeList1&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51009</span><span class="p">,</span> <span class="s1">&#39;OpcodeList2&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51022</span><span class="p">,</span> <span class="s1">&#39;OpcodeList3&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51023</span><span class="p">,</span> <span class="s1">&#39;FibicsXML&#39;</span><span class="p">),</span>  <span class="c1">#</span>
                <span class="p">(</span><span class="mi">51041</span><span class="p">,</span> <span class="s1">&#39;NoiseProfile&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51043</span><span class="p">,</span> <span class="s1">&#39;TimeCodes&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51044</span><span class="p">,</span> <span class="s1">&#39;FrameRate&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51058</span><span class="p">,</span> <span class="s1">&#39;TStop&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51081</span><span class="p">,</span> <span class="s1">&#39;ReelName&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51089</span><span class="p">,</span> <span class="s1">&#39;OriginalDefaultFinalSize&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51090</span><span class="p">,</span> <span class="s1">&#39;OriginalBestQualitySize&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51091</span><span class="p">,</span> <span class="s1">&#39;OriginalDefaultCropSize&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51105</span><span class="p">,</span> <span class="s1">&#39;CameraLabel&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51107</span><span class="p">,</span> <span class="s1">&#39;ProfileHueSatMapEncoding&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51108</span><span class="p">,</span> <span class="s1">&#39;ProfileLookTableEncoding&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51109</span><span class="p">,</span> <span class="s1">&#39;BaselineExposureOffset&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51110</span><span class="p">,</span> <span class="s1">&#39;DefaultBlackRender&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51111</span><span class="p">,</span> <span class="s1">&#39;NewRawImageDigest&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51112</span><span class="p">,</span> <span class="s1">&#39;RawToPreviewGain&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51113</span><span class="p">,</span> <span class="s1">&#39;CacheBlob&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51114</span><span class="p">,</span> <span class="s1">&#39;CacheVersion&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51123</span><span class="p">,</span> <span class="s1">&#39;MicroManagerMetadata&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51125</span><span class="p">,</span> <span class="s1">&#39;DefaultUserCrop&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51159</span><span class="p">,</span> <span class="s1">&#39;ZIFmetadata&#39;</span><span class="p">),</span>  <span class="c1"># Objective Pathology Services</span>
                <span class="p">(</span><span class="mi">51160</span><span class="p">,</span> <span class="s1">&#39;ZIFannotations&#39;</span><span class="p">),</span>  <span class="c1"># Objective Pathology Services</span>
                <span class="p">(</span><span class="mi">51177</span><span class="p">,</span> <span class="s1">&#39;DepthFormat&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51178</span><span class="p">,</span> <span class="s1">&#39;DepthNear&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51179</span><span class="p">,</span> <span class="s1">&#39;DepthFar&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51180</span><span class="p">,</span> <span class="s1">&#39;DepthUnits&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51181</span><span class="p">,</span> <span class="s1">&#39;DepthMeasureType&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">51182</span><span class="p">,</span> <span class="s1">&#39;EnhanceParams&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">59932</span><span class="p">,</span> <span class="s1">&#39;Padding&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">59933</span><span class="p">,</span> <span class="s1">&#39;OffsetSchema&#39;</span><span class="p">),</span>
                <span class="c1"># Reusable Tags 65000-65535</span>
                <span class="c1"># (65000,  DimapDocumentXML&#39;),</span>
                <span class="c1"># (65001, &#39;EER_XML&#39;),</span>
                <span class="c1"># 65000-65112,  Photoshop Camera RAW EXIF tags</span>
                <span class="c1"># (65000, &#39;OwnerName&#39;),</span>
                <span class="c1"># (65001, &#39;SerialNumber&#39;),</span>
                <span class="c1"># (65002, &#39;Lens&#39;),</span>
                <span class="c1"># (65024, &#39;KodakKDCPrivateIFD&#39;),</span>
                <span class="c1"># (65100, &#39;RawFile&#39;),</span>
                <span class="c1"># (65101, &#39;Converter&#39;),</span>
                <span class="c1"># (65102, &#39;WhiteBalance&#39;),</span>
                <span class="c1"># (65105, &#39;Exposure&#39;),</span>
                <span class="c1"># (65106, &#39;Shadows&#39;),</span>
                <span class="c1"># (65107, &#39;Brightness&#39;),</span>
                <span class="c1"># (65108, &#39;Contrast&#39;),</span>
                <span class="c1"># (65109, &#39;Saturation&#39;),</span>
                <span class="c1"># (65110, &#39;Sharpness&#39;),</span>
                <span class="c1"># (65111, &#39;Smoothness&#39;),</span>
                <span class="c1"># (65112, &#39;MoireFilter&#39;),</span>
                <span class="p">(</span><span class="mi">65200</span><span class="p">,</span> <span class="s1">&#39;FlexXML&#39;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">TAG_READERS</span><span class="p">():</span>
        <span class="c1"># map tag codes to import functions</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mi">301</span><span class="p">:</span> <span class="n">read_colormap</span><span class="p">,</span>
            <span class="mi">320</span><span class="p">:</span> <span class="n">read_colormap</span><span class="p">,</span>
            <span class="c1"># 700: read_bytes,  # read_utf8,</span>
            <span class="c1"># 34377: read_bytes,</span>
            <span class="mi">33723</span><span class="p">:</span> <span class="n">read_bytes</span><span class="p">,</span>
            <span class="c1"># 34675: read_bytes,</span>
            <span class="mi">33628</span><span class="p">:</span> <span class="n">read_uic1tag</span><span class="p">,</span>  <span class="c1"># Universal Imaging Corp STK</span>
            <span class="mi">33629</span><span class="p">:</span> <span class="n">read_uic2tag</span><span class="p">,</span>
            <span class="mi">33630</span><span class="p">:</span> <span class="n">read_uic3tag</span><span class="p">,</span>
            <span class="mi">33631</span><span class="p">:</span> <span class="n">read_uic4tag</span><span class="p">,</span>
            <span class="mi">34118</span><span class="p">:</span> <span class="n">read_cz_sem</span><span class="p">,</span>  <span class="c1"># Carl Zeiss SEM</span>
            <span class="mi">34361</span><span class="p">:</span> <span class="n">read_mm_header</span><span class="p">,</span>  <span class="c1"># Olympus FluoView</span>
            <span class="mi">34362</span><span class="p">:</span> <span class="n">read_mm_stamp</span><span class="p">,</span>
            <span class="mi">34363</span><span class="p">:</span> <span class="n">read_numpy</span><span class="p">,</span>  <span class="c1"># MM_Unknown</span>
            <span class="mi">34386</span><span class="p">:</span> <span class="n">read_numpy</span><span class="p">,</span>  <span class="c1"># MM_UserBlock</span>
            <span class="mi">34412</span><span class="p">:</span> <span class="n">read_cz_lsminfo</span><span class="p">,</span>  <span class="c1"># Carl Zeiss LSM</span>
            <span class="mi">34680</span><span class="p">:</span> <span class="n">read_fei_metadata</span><span class="p">,</span>  <span class="c1"># S-FEG</span>
            <span class="mi">34682</span><span class="p">:</span> <span class="n">read_fei_metadata</span><span class="p">,</span>  <span class="c1"># Helios NanoLab</span>
            <span class="mi">37706</span><span class="p">:</span> <span class="n">read_tvips_header</span><span class="p">,</span>  <span class="c1"># TVIPS EMMENU</span>
            <span class="mi">37724</span><span class="p">:</span> <span class="n">read_bytes</span><span class="p">,</span>  <span class="c1"># ImageSourceData</span>
            <span class="mi">33923</span><span class="p">:</span> <span class="n">read_bytes</span><span class="p">,</span>  <span class="c1"># read_leica_magic</span>
            <span class="mi">43314</span><span class="p">:</span> <span class="n">read_nih_image_header</span><span class="p">,</span>
            <span class="c1"># 40001: read_bytes,</span>
            <span class="mi">40100</span><span class="p">:</span> <span class="n">read_bytes</span><span class="p">,</span>
            <span class="mi">50288</span><span class="p">:</span> <span class="n">read_bytes</span><span class="p">,</span>
            <span class="mi">50296</span><span class="p">:</span> <span class="n">read_bytes</span><span class="p">,</span>
            <span class="mi">50839</span><span class="p">:</span> <span class="n">read_bytes</span><span class="p">,</span>
            <span class="mi">51123</span><span class="p">:</span> <span class="n">read_json</span><span class="p">,</span>
            <span class="mi">33471</span><span class="p">:</span> <span class="n">read_sis_ini</span><span class="p">,</span>
            <span class="mi">33560</span><span class="p">:</span> <span class="n">read_sis</span><span class="p">,</span>
            <span class="mi">34665</span><span class="p">:</span> <span class="n">read_exif_ifd</span><span class="p">,</span>
            <span class="mi">34853</span><span class="p">:</span> <span class="n">read_gps_ifd</span><span class="p">,</span>  <span class="c1"># conflicts with OlympusSIS</span>
            <span class="mi">40965</span><span class="p">:</span> <span class="n">read_interoperability_ifd</span><span class="p">,</span>
            <span class="mi">65426</span><span class="p">:</span> <span class="n">read_numpy</span><span class="p">,</span>  <span class="c1"># NDPI McuStarts</span>
            <span class="mi">65432</span><span class="p">:</span> <span class="n">read_numpy</span><span class="p">,</span>  <span class="c1"># NDPI McuStartsHighBytes</span>
            <span class="mi">65439</span><span class="p">:</span> <span class="n">read_numpy</span><span class="p">,</span>  <span class="c1"># NDPI unknown</span>
            <span class="mi">65459</span><span class="p">:</span> <span class="n">read_bytes</span><span class="p">,</span>  <span class="c1"># NDPI bytes, not string</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">TAG_LOAD</span><span class="p">():</span>
        <span class="c1"># tags whose values are not delay loaded</span>
        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="mi">258</span><span class="p">,</span>  <span class="c1"># BitsPerSample</span>
                <span class="mi">270</span><span class="p">,</span>  <span class="c1"># ImageDescription</span>
                <span class="mi">273</span><span class="p">,</span>  <span class="c1"># StripOffsets</span>
                <span class="mi">277</span><span class="p">,</span>  <span class="c1"># SamplesPerPixel</span>
                <span class="mi">279</span><span class="p">,</span>  <span class="c1"># StripByteCounts</span>
                <span class="mi">282</span><span class="p">,</span>  <span class="c1"># XResolution</span>
                <span class="mi">283</span><span class="p">,</span>  <span class="c1"># YResolution</span>
                <span class="c1"># 301,  # TransferFunction</span>
                <span class="mi">305</span><span class="p">,</span>  <span class="c1"># Software</span>
                <span class="c1"># 306,  # DateTime</span>
                <span class="c1"># 320,  # ColorMap</span>
                <span class="mi">324</span><span class="p">,</span>  <span class="c1"># TileOffsets</span>
                <span class="mi">325</span><span class="p">,</span>  <span class="c1"># TileByteCounts</span>
                <span class="mi">330</span><span class="p">,</span>  <span class="c1"># SubIFDs</span>
                <span class="mi">338</span><span class="p">,</span>  <span class="c1"># ExtraSamples</span>
                <span class="mi">339</span><span class="p">,</span>  <span class="c1"># SampleFormat</span>
                <span class="mi">347</span><span class="p">,</span>  <span class="c1"># JPEGTables</span>
                <span class="mi">513</span><span class="p">,</span>  <span class="c1"># JPEGInterchangeFormat</span>
                <span class="mi">514</span><span class="p">,</span>  <span class="c1"># JPEGInterchangeFormatLength</span>
                <span class="mi">530</span><span class="p">,</span>  <span class="c1"># YCbCrSubSampling</span>
                <span class="mi">33628</span><span class="p">,</span>  <span class="c1"># UIC1tag</span>
                <span class="mi">42113</span><span class="p">,</span>  <span class="c1"># GDAL_NODATA</span>
                <span class="mi">50838</span><span class="p">,</span>  <span class="c1"># IJMetadataByteCounts</span>
                <span class="mi">50839</span><span class="p">,</span>  <span class="c1"># IJMetadata</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">TAG_TUPLE</span><span class="p">():</span>
        <span class="c1"># tags whose values must be stored as tuples</span>
        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">273</span><span class="p">,</span> <span class="mi">279</span><span class="p">,</span> <span class="mi">324</span><span class="p">,</span> <span class="mi">325</span><span class="p">,</span> <span class="mi">330</span><span class="p">,</span> <span class="mi">338</span><span class="p">,</span> <span class="mi">513</span><span class="p">,</span> <span class="mi">514</span><span class="p">,</span> <span class="mi">530</span><span class="p">,</span> <span class="mi">531</span><span class="p">,</span> <span class="mi">34736</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">TAG_ATTRIBUTES</span><span class="p">():</span>
        <span class="c1"># map tag codes to TiffPage attribute names</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mi">254</span><span class="p">:</span> <span class="s1">&#39;subfiletype&#39;</span><span class="p">,</span>
            <span class="mi">256</span><span class="p">:</span> <span class="s1">&#39;imagewidth&#39;</span><span class="p">,</span>
            <span class="mi">257</span><span class="p">:</span> <span class="s1">&#39;imagelength&#39;</span><span class="p">,</span>
            <span class="c1"># 258: &#39;bitspersample&#39;,  # set manually</span>
            <span class="mi">259</span><span class="p">:</span> <span class="s1">&#39;compression&#39;</span><span class="p">,</span>
            <span class="mi">262</span><span class="p">:</span> <span class="s1">&#39;photometric&#39;</span><span class="p">,</span>
            <span class="mi">266</span><span class="p">:</span> <span class="s1">&#39;fillorder&#39;</span><span class="p">,</span>
            <span class="mi">270</span><span class="p">:</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span>
            <span class="mi">277</span><span class="p">:</span> <span class="s1">&#39;samplesperpixel&#39;</span><span class="p">,</span>
            <span class="mi">278</span><span class="p">:</span> <span class="s1">&#39;rowsperstrip&#39;</span><span class="p">,</span>
            <span class="mi">284</span><span class="p">:</span> <span class="s1">&#39;planarconfig&#39;</span><span class="p">,</span>
            <span class="c1"># 301: &#39;transferfunction&#39;,  # delay load</span>
            <span class="mi">305</span><span class="p">:</span> <span class="s1">&#39;software&#39;</span><span class="p">,</span>
            <span class="c1"># 320: &#39;colormap&#39;,  # delay load</span>
            <span class="mi">317</span><span class="p">:</span> <span class="s1">&#39;predictor&#39;</span><span class="p">,</span>
            <span class="mi">322</span><span class="p">:</span> <span class="s1">&#39;tilewidth&#39;</span><span class="p">,</span>
            <span class="mi">323</span><span class="p">:</span> <span class="s1">&#39;tilelength&#39;</span><span class="p">,</span>
            <span class="mi">330</span><span class="p">:</span> <span class="s1">&#39;subifds&#39;</span><span class="p">,</span>
            <span class="mi">338</span><span class="p">:</span> <span class="s1">&#39;extrasamples&#39;</span><span class="p">,</span>
            <span class="c1"># 339: &#39;sampleformat&#39;,  # set manually</span>
            <span class="mi">347</span><span class="p">:</span> <span class="s1">&#39;jpegtables&#39;</span><span class="p">,</span>
            <span class="mi">530</span><span class="p">:</span> <span class="s1">&#39;subsampling&#39;</span><span class="p">,</span>
            <span class="mi">32997</span><span class="p">:</span> <span class="s1">&#39;imagedepth&#39;</span><span class="p">,</span>
            <span class="mi">32998</span><span class="p">:</span> <span class="s1">&#39;tiledepth&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">TAG_ENUM</span><span class="p">():</span>
        <span class="c1"># map tag codes to Enums</span>
        <span class="k">class</span> <span class="nc">TAG_ENUM</span><span class="p">:</span>

            <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_codes&#39;</span><span class="p">,)</span>

            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_codes</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="mi">254</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="mi">255</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="mi">259</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">COMPRESSION</span><span class="p">,</span>
                    <span class="mi">262</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="p">,</span>
                    <span class="mi">263</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="mi">266</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="mi">274</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="mi">284</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PLANARCONFIG</span><span class="p">,</span>
                    <span class="mi">290</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="mi">296</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="mi">300</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="mi">317</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="mi">338</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="mi">339</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">SAMPLEFORMAT</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_codes</span>

            <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_codes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">value</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">254</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">FILETYPE</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">255</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">OFILETYPE</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">263</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">THRESHHOLD</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">266</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">FILLORDER</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">274</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">ORIENTATION</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">290</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">GRAYRESPONSEUNIT</span>
                <span class="c1"># elif key == 292:</span>
                <span class="c1">#     value = TIFF.GROUP3OPT</span>
                <span class="c1"># elif key == 293:</span>
                <span class="c1">#     value = TIFF.GROUP4OPT</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">296</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">RESUNIT</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">300</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">COLORRESPONSEUNIT</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">317</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PREDICTOR</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">338</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">EXTRASAMPLE</span>
                <span class="c1"># elif key == 512:</span>
                <span class="c1">#     TIFF.JPEGPROC</span>
                <span class="c1"># elif key == 531:</span>
                <span class="c1">#     TIFF.YCBCRPOSITION</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_codes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">return</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">TAG_ENUM</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">FILETYPE</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">FILETYPE</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntFlag</span><span class="p">):</span>
            <span class="n">UNDEFINED</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">REDUCEDIMAGE</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">PAGE</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">MASK</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">MACRO</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># Aperio SVS, or DNG Depth map</span>
            <span class="n">ENHANCED</span> <span class="o">=</span> <span class="mi">16</span>  <span class="c1"># DNG</span>
            <span class="n">DNG</span> <span class="o">=</span> <span class="mi">65536</span>  <span class="c1"># 65537: Alternative, 65540: Semantic mask</span>

        <span class="k">return</span> <span class="n">FILETYPE</span>

    <span class="k">def</span> <span class="nf">OFILETYPE</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">OFILETYPE</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">UNDEFINED</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">IMAGE</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">REDUCEDIMAGE</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">PAGE</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="k">return</span> <span class="n">OFILETYPE</span>

    <span class="k">def</span> <span class="nf">COMPRESSION</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">COMPRESSION</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">NONE</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Uncompressed</span>
            <span class="n">CCITTRLE</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># CCITT 1D</span>
            <span class="n">CCITT_T4</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># T4/Group 3 Fax</span>
            <span class="n">CCITT_T6</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># T6/Group 4 Fax</span>
            <span class="n">LZW</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">OJPEG</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># old-style JPEG</span>
            <span class="n">JPEG</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">ADOBE_DEFLATE</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="n">JBIG_BW</span> <span class="o">=</span> <span class="mi">9</span>
            <span class="n">JBIG_COLOR</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">JPEG_99</span> <span class="o">=</span> <span class="mi">99</span>
            <span class="n">KODAK_262</span> <span class="o">=</span> <span class="mi">262</span>
            <span class="n">JPEGXR_NDPI</span> <span class="o">=</span> <span class="mi">22610</span>
            <span class="n">NEXT</span> <span class="o">=</span> <span class="mi">32766</span>
            <span class="n">SONY_ARW</span> <span class="o">=</span> <span class="mi">32767</span>
            <span class="n">PACKED_RAW</span> <span class="o">=</span> <span class="mi">32769</span>
            <span class="n">SAMSUNG_SRW</span> <span class="o">=</span> <span class="mi">32770</span>
            <span class="n">CCIRLEW</span> <span class="o">=</span> <span class="mi">32771</span>
            <span class="n">SAMSUNG_SRW2</span> <span class="o">=</span> <span class="mi">32772</span>
            <span class="n">PACKBITS</span> <span class="o">=</span> <span class="mi">32773</span>
            <span class="n">THUNDERSCAN</span> <span class="o">=</span> <span class="mi">32809</span>
            <span class="n">IT8CTPAD</span> <span class="o">=</span> <span class="mi">32895</span>
            <span class="n">IT8LW</span> <span class="o">=</span> <span class="mi">32896</span>
            <span class="n">IT8MP</span> <span class="o">=</span> <span class="mi">32897</span>
            <span class="n">IT8BL</span> <span class="o">=</span> <span class="mi">32898</span>
            <span class="n">PIXARFILM</span> <span class="o">=</span> <span class="mi">32908</span>
            <span class="n">PIXARLOG</span> <span class="o">=</span> <span class="mi">32909</span>
            <span class="n">DEFLATE</span> <span class="o">=</span> <span class="mi">32946</span>
            <span class="n">DCS</span> <span class="o">=</span> <span class="mi">32947</span>
            <span class="n">APERIO_JP2000_YCBC</span> <span class="o">=</span> <span class="mi">33003</span>  <span class="c1"># Leica Aperio</span>
            <span class="n">JPEG_2000_LOSSY</span> <span class="o">=</span> <span class="mi">33004</span>  <span class="c1"># BioFormats</span>
            <span class="n">APERIO_JP2000_RGB</span> <span class="o">=</span> <span class="mi">33005</span>  <span class="c1"># Leica Aperio</span>
            <span class="n">ALT_JPEG</span> <span class="o">=</span> <span class="mi">33007</span>  <span class="c1"># BioFormats</span>
            <span class="n">JBIG</span> <span class="o">=</span> <span class="mi">34661</span>
            <span class="n">SGILOG</span> <span class="o">=</span> <span class="mi">34676</span>
            <span class="n">SGILOG24</span> <span class="o">=</span> <span class="mi">34677</span>
            <span class="n">JPEG2000</span> <span class="o">=</span> <span class="mi">34712</span>
            <span class="n">NIKON_NEF</span> <span class="o">=</span> <span class="mi">34713</span>
            <span class="n">JBIG2</span> <span class="o">=</span> <span class="mi">34715</span>
            <span class="n">MDI_BINARY</span> <span class="o">=</span> <span class="mi">34718</span>  <span class="c1"># Microsoft Document Imaging</span>
            <span class="n">MDI_PROGRESSIVE</span> <span class="o">=</span> <span class="mi">34719</span>  <span class="c1"># Microsoft Document Imaging</span>
            <span class="n">MDI_VECTOR</span> <span class="o">=</span> <span class="mi">34720</span>  <span class="c1"># Microsoft Document Imaging</span>
            <span class="n">LERC</span> <span class="o">=</span> <span class="mi">34887</span>  <span class="c1"># ESRI Lerc</span>
            <span class="n">JPEG_LOSSY</span> <span class="o">=</span> <span class="mi">34892</span>  <span class="c1"># DNG</span>
            <span class="n">LZMA</span> <span class="o">=</span> <span class="mi">34925</span>
            <span class="n">ZSTD_DEPRECATED</span> <span class="o">=</span> <span class="mi">34926</span>
            <span class="n">WEBP_DEPRECATED</span> <span class="o">=</span> <span class="mi">34927</span>
            <span class="n">PNG</span> <span class="o">=</span> <span class="mi">34933</span>  <span class="c1"># Objective Pathology Services</span>
            <span class="n">JPEGXR</span> <span class="o">=</span> <span class="mi">34934</span>  <span class="c1"># Objective Pathology Services</span>
            <span class="n">ZSTD</span> <span class="o">=</span> <span class="mi">50000</span>
            <span class="n">WEBP</span> <span class="o">=</span> <span class="mi">50001</span>
            <span class="n">JPEGXL</span> <span class="o">=</span> <span class="mi">50002</span>  <span class="c1"># JXL</span>
            <span class="n">PIXTIFF</span> <span class="o">=</span> <span class="mi">50013</span>
            <span class="c1"># EER_V0 = 65000</span>
            <span class="c1"># EER_V1 = 65001</span>
            <span class="c1"># KODAK_DCR = 65000</span>
            <span class="c1"># PENTAX_PEF = 65535</span>

            <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span> <span class="o">!=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">COMPRESSION</span>

    <span class="k">def</span> <span class="nf">PHOTOMETRIC</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">PHOTOMETRIC</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">MINISWHITE</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">MINISBLACK</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">RGB</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">PALETTE</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">MASK</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">SEPARATED</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># CMYK</span>
            <span class="n">YCBCR</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">CIELAB</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="n">ICCLAB</span> <span class="o">=</span> <span class="mi">9</span>
            <span class="n">ITULAB</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">CFA</span> <span class="o">=</span> <span class="mi">32803</span>  <span class="c1"># Color Filter Array</span>
            <span class="n">LOGL</span> <span class="o">=</span> <span class="mi">32844</span>
            <span class="n">LOGLUV</span> <span class="o">=</span> <span class="mi">32845</span>
            <span class="n">LINEAR_RAW</span> <span class="o">=</span> <span class="mi">34892</span>
            <span class="n">DEPTH_MAP</span> <span class="o">=</span> <span class="mi">51177</span>  <span class="c1"># DNG 1.5</span>
            <span class="n">SEMANTIC_MASK</span> <span class="o">=</span> <span class="mi">52527</span>  <span class="c1"># DNG 1.6</span>

        <span class="k">return</span> <span class="n">PHOTOMETRIC</span>

    <span class="k">def</span> <span class="nf">PHOTOMETRIC_SAMPLES</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># MINISWHITE</span>
            <span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># MINISBLACK</span>
            <span class="mi">2</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># RGB</span>
            <span class="mi">3</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># PALETTE</span>
            <span class="mi">4</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># MASK</span>
            <span class="mi">5</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>  <span class="c1"># SEPARATED</span>
            <span class="mi">6</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># YCBCR</span>
            <span class="mi">8</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># CIELAB</span>
            <span class="mi">9</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># ICCLAB</span>
            <span class="mi">10</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># ITULAB</span>
            <span class="mi">32803</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># CFA</span>
            <span class="mi">32844</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># LOGL ?</span>
            <span class="mi">32845</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># LOGLUV</span>
            <span class="mi">34892</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># LINEAR_RAW ?</span>
            <span class="mi">51177</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># DEPTH_MAP ?</span>
            <span class="mi">52527</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># SEMANTIC_MASK ?</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">THRESHHOLD</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">THRESHHOLD</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">BILEVEL</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">HALFTONE</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">ERRORDIFFUSE</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="k">return</span> <span class="n">THRESHHOLD</span>

    <span class="k">def</span> <span class="nf">FILLORDER</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">FILLORDER</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">MSB2LSB</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">LSB2MSB</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="n">FILLORDER</span>

    <span class="k">def</span> <span class="nf">ORIENTATION</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">ORIENTATION</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">TOPLEFT</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">TOPRIGHT</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">BOTRIGHT</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">BOTLEFT</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">LEFTTOP</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">RIGHTTOP</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">RIGHTBOT</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">LEFTBOT</span> <span class="o">=</span> <span class="mi">8</span>

        <span class="k">return</span> <span class="n">ORIENTATION</span>

    <span class="k">def</span> <span class="nf">PLANARCONFIG</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">PLANARCONFIG</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">CONTIG</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># CHUNKY</span>
            <span class="n">SEPARATE</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="n">PLANARCONFIG</span>

    <span class="k">def</span> <span class="nf">GRAYRESPONSEUNIT</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">GRAYRESPONSEUNIT</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">_10S</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">_100S</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">_1000S</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">_10000S</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">_100000S</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">return</span> <span class="n">GRAYRESPONSEUNIT</span>

    <span class="k">def</span> <span class="nf">GROUP4OPT</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">GROUP4OPT</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">UNCOMPRESSED</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="n">GROUP4OPT</span>

    <span class="k">def</span> <span class="nf">RESUNIT</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">RESUNIT</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">NONE</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">INCH</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">CENTIMETER</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">MILLIMETER</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># DNG</span>
            <span class="n">MICROMETER</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># DNG</span>

            <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span> <span class="o">!=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">RESUNIT</span>

    <span class="k">def</span> <span class="nf">COLORRESPONSEUNIT</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">COLORRESPONSEUNIT</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">_10S</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">_100S</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">_1000S</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">_10000S</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">_100000S</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">return</span> <span class="n">COLORRESPONSEUNIT</span>

    <span class="k">def</span> <span class="nf">PREDICTOR</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">PREDICTOR</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">NONE</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">HORIZONTAL</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">FLOATINGPOINT</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">HORIZONTALX2</span> <span class="o">=</span> <span class="mi">34892</span>  <span class="c1"># DNG</span>
            <span class="n">HORIZONTALX4</span> <span class="o">=</span> <span class="mi">34893</span>
            <span class="n">FLOATINGPOINTX2</span> <span class="o">=</span> <span class="mi">34894</span>
            <span class="n">FLOATINGPOINTX4</span> <span class="o">=</span> <span class="mi">34895</span>

            <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span> <span class="o">!=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">PREDICTOR</span>

    <span class="k">def</span> <span class="nf">EXTRASAMPLE</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">EXTRASAMPLE</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">UNSPECIFIED</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ASSOCALPHA</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">UNASSALPHA</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="n">EXTRASAMPLE</span>

    <span class="k">def</span> <span class="nf">SAMPLEFORMAT</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">SAMPLEFORMAT</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">UINT</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">INT</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">IEEEFP</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">VOID</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">COMPLEXINT</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">COMPLEXIEEEFP</span> <span class="o">=</span> <span class="mi">6</span>

        <span class="k">return</span> <span class="n">SAMPLEFORMAT</span>

    <span class="k">def</span> <span class="nf">DATATYPES</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">DATATYPES</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">BYTE</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 8-bit unsigned integer</span>
            <span class="n">ASCII</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># 8-bit byte that contains a 7-bit ASCII code;</span>
            <span class="c1">#            the last byte must be NULL (binary zero)</span>
            <span class="n">SHORT</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># 16-bit (2-byte) unsigned integer</span>
            <span class="n">LONG</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># 32-bit (4-byte) unsigned integer</span>
            <span class="n">RATIONAL</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># two LONGs: the first represents the numerator</span>
            <span class="c1">#               of a fraction; the second, the denominator</span>
            <span class="n">SBYTE</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># an 8-bit signed (twos-complement) integer</span>
            <span class="n">UNDEFINED</span> <span class="o">=</span> <span class="mi">7</span>  <span class="c1"># an 8-bit byte that may contain anything,</span>
            <span class="c1">#                depending on the definition of the field</span>
            <span class="n">SSHORT</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># A 16-bit (2-byte) signed (twos-complement) integer</span>
            <span class="n">SLONG</span> <span class="o">=</span> <span class="mi">9</span>  <span class="c1"># a 32-bit (4-byte) signed (twos-complement) integer</span>
            <span class="n">SRATIONAL</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># two SLONGs: the first represents the numerator</span>
            <span class="c1">#                 of a fraction, the second the denominator</span>
            <span class="n">FLOAT</span> <span class="o">=</span> <span class="mi">11</span>  <span class="c1"># single precision (4-byte) IEEE format</span>
            <span class="n">DOUBLE</span> <span class="o">=</span> <span class="mi">12</span>  <span class="c1"># double precision (8-byte) IEEE format</span>
            <span class="n">IFD</span> <span class="o">=</span> <span class="mi">13</span>  <span class="c1"># unsigned 4 byte IFD offset</span>
            <span class="n">UNICODE</span> <span class="o">=</span> <span class="mi">14</span>
            <span class="n">COMPLEX</span> <span class="o">=</span> <span class="mi">15</span>
            <span class="n">LONG8</span> <span class="o">=</span> <span class="mi">16</span>  <span class="c1"># unsigned 8 byte integer (BigTiff)</span>
            <span class="n">SLONG8</span> <span class="o">=</span> <span class="mi">17</span>  <span class="c1"># signed 8 byte integer (BigTiff)</span>
            <span class="n">IFD8</span> <span class="o">=</span> <span class="mi">18</span>  <span class="c1"># unsigned 8 byte IFD offset (BigTiff)</span>

        <span class="k">return</span> <span class="n">DATATYPES</span>

    <span class="k">def</span> <span class="nf">DATA_FORMATS</span><span class="p">():</span>
        <span class="c1"># map TIFF DATATYPES to Python struct formats</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;1B&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;1s&#39;</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;1H&#39;</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;1I&#39;</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;2I&#39;</span><span class="p">,</span>
            <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;1b&#39;</span><span class="p">,</span>
            <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;1B&#39;</span><span class="p">,</span>
            <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span>
            <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;1i&#39;</span><span class="p">,</span>
            <span class="mi">10</span><span class="p">:</span> <span class="s1">&#39;2i&#39;</span><span class="p">,</span>
            <span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;1f&#39;</span><span class="p">,</span>
            <span class="mi">12</span><span class="p">:</span> <span class="s1">&#39;1d&#39;</span><span class="p">,</span>
            <span class="mi">13</span><span class="p">:</span> <span class="s1">&#39;1I&#39;</span><span class="p">,</span>
            <span class="c1"># 14: &#39;&#39;,</span>
            <span class="c1"># 15: &#39;&#39;,</span>
            <span class="mi">16</span><span class="p">:</span> <span class="s1">&#39;1Q&#39;</span><span class="p">,</span>
            <span class="mi">17</span><span class="p">:</span> <span class="s1">&#39;1q&#39;</span><span class="p">,</span>
            <span class="mi">18</span><span class="p">:</span> <span class="s1">&#39;1Q&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">DATA_DTYPES</span><span class="p">():</span>
        <span class="c1"># map numpy dtypes to TIFF DATATYPES</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;2I&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
            <span class="s1">&#39;2i&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
            <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
            <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
            <span class="s1">&#39;q&#39;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">SAMPLE_DTYPES</span><span class="p">():</span>
        <span class="c1"># map SampleFormat and BitsPerSample to numpy dtype</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="c1"># UINT</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span>  <span class="c1"># bitmap</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">14</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">18</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">22</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">23</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">24</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">26</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">27</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">29</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span>
            <span class="c1"># VOID : treat as UINT</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span>  <span class="c1"># bitmap</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">13</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">14</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">17</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">18</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">19</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">22</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">23</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">24</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">25</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">27</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">28</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">29</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">30</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">31</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">32</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span>
            <span class="c1"># INT</span>
            <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">32</span><span class="p">):</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span>
            <span class="c1"># IEEEFP</span>
            <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">24</span><span class="p">):</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span>  <span class="c1"># float24 bit not supported by numpy</span>
            <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">):</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span>
            <span class="c1"># COMPLEXIEEEFP</span>
            <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">128</span><span class="p">):</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span>
            <span class="c1"># RGB565</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="c1"># COMPLEXINT : not supported by numpy</span>
            <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">32</span><span class="p">):</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">PREDICTORS</span><span class="p">():</span>
        <span class="c1"># map PREDICTOR to predictor encode functions</span>

        <span class="k">class</span> <span class="nc">PREDICTORS</span><span class="p">:</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">identityfunc</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="n">identityfunc</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">imagecodecs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_encode</span>

            <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">delta_encode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">floatpred_encode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34892</span><span class="p">:</span>

                        <span class="k">def</span> <span class="nf">codec</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">delta_encode</span><span class="p">(</span>
                                <span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="mi">2</span>
                            <span class="p">)</span>

                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34893</span><span class="p">:</span>

                        <span class="k">def</span> <span class="nf">codec</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">delta_encode</span><span class="p">(</span>
                                <span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="mi">4</span>
                            <span class="p">)</span>

                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34894</span><span class="p">:</span>

                        <span class="k">def</span> <span class="nf">codec</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">floatpred_encode</span><span class="p">(</span>
                                <span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="mi">2</span>
                            <span class="p">)</span>

                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34895</span><span class="p">:</span>

                        <span class="k">def</span> <span class="nf">codec</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">floatpred_encode</span><span class="p">(</span>
                                <span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="mi">4</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> is not a known PREDICTOR&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">TIFF</span><span class="o">.</span><span class="n">PREDICTOR</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">!r}</span><span class="s1">&#39;</span>
                        <span class="s2">&quot; requires the &#39;imagecodecs&#39; package&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">codec</span>
                <span class="k">return</span> <span class="n">codec</span>

        <span class="k">return</span> <span class="n">PREDICTORS</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">UNPREDICTORS</span><span class="p">():</span>
        <span class="c1"># map PREDICTOR to predictor decode functions</span>

        <span class="k">class</span> <span class="nc">UNPREDICTORS</span><span class="p">:</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">identityfunc</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="n">identityfunc</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">imagecodecs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_decode</span>

            <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">delta_decode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">floatpred_decode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34892</span><span class="p">:</span>

                        <span class="k">def</span> <span class="nf">codec</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">delta_decode</span><span class="p">(</span>
                                <span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="mi">2</span>
                            <span class="p">)</span>

                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34893</span><span class="p">:</span>

                        <span class="k">def</span> <span class="nf">codec</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">delta_decode</span><span class="p">(</span>
                                <span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="mi">4</span>
                            <span class="p">)</span>

                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34894</span><span class="p">:</span>

                        <span class="k">def</span> <span class="nf">codec</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">floatpred_decode</span><span class="p">(</span>
                                <span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="mi">2</span>
                            <span class="p">)</span>

                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34895</span><span class="p">:</span>

                        <span class="k">def</span> <span class="nf">codec</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">floatpred_decode</span><span class="p">(</span>
                                <span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="mi">4</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> is not a known PREDICTOR&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">TIFF</span><span class="o">.</span><span class="n">PREDICTOR</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">!r}</span><span class="s1">&#39;</span>
                        <span class="s2">&quot; requires the &#39;imagecodecs&#39; package&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">codec</span>
                <span class="k">return</span> <span class="n">codec</span>

        <span class="k">return</span> <span class="n">UNPREDICTORS</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">COMPRESSORS</span><span class="p">():</span>
        <span class="c1"># map COMPRESSION to compress functions</span>

        <span class="k">class</span> <span class="nc">COMPRESSORS</span><span class="p">:</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">identityfunc</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="n">identityfunc</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">imagecodecs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">zlib_encode</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">[</span><span class="mi">32946</span><span class="p">]</span> <span class="o">=</span> <span class="n">zlib_encode</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">[</span><span class="mi">34925</span><span class="p">]</span> <span class="o">=</span> <span class="n">lzma_encode</span>

            <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">lzw_encode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">jpeg_encode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">8</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">32946</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="nb">hasattr</span><span class="p">(</span><span class="n">imagecodecs</span><span class="p">,</span> <span class="s1">&#39;DEFLATE&#39;</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">DEFLATE</span>
                        <span class="p">):</span>
                            <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">deflate_encode</span>
                        <span class="k">elif</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">ZLIB</span><span class="p">:</span>
                            <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">zlib_encode</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">codec</span> <span class="o">=</span> <span class="n">zlib_encode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">32773</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">packbits_encode</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="n">key</span> <span class="o">==</span> <span class="mi">33003</span>
                        <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">33004</span>
                        <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">33005</span>
                        <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34712</span>
                    <span class="p">):</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">jpeg2k_encode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34887</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">lerc_encode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34892</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">jpeg8_encode</span>  <span class="c1"># DNG lossy</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34925</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">LZMA</span><span class="p">:</span>
                            <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">lzma_encode</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">codec</span> <span class="o">=</span> <span class="n">lzma_encode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34933</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">png_encode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34934</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">22610</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">jpegxr_encode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">50000</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">zstd_encode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">50001</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">webp_encode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">50002</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">jpegxl_encode</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">TIFF</span><span class="o">.</span><span class="n">COMPRESSION</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">!r}</span><span class="s1"> not supported&#39;</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> is not a known COMPRESSION&#39;</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">TIFF</span><span class="o">.</span><span class="n">COMPRESSION</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                        <span class="s2">&quot;requires the &#39;imagecodecs&#39; package&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">codec</span>
                <span class="k">return</span> <span class="n">codec</span>

        <span class="k">return</span> <span class="n">COMPRESSORS</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">DECOMPRESSORS</span><span class="p">():</span>
        <span class="c1"># map COMPRESSION to decompress functions</span>

        <span class="k">class</span> <span class="nc">DECOMPRESSORS</span><span class="p">:</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">identityfunc</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="n">identityfunc</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">imagecodecs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">zlib_decode</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">[</span><span class="mi">32773</span><span class="p">]</span> <span class="o">=</span> <span class="n">packbits_decode</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">[</span><span class="mi">32946</span><span class="p">]</span> <span class="o">=</span> <span class="n">zlib_decode</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">[</span><span class="mi">34925</span><span class="p">]</span> <span class="o">=</span> <span class="n">lzma_decode</span>

            <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">lzw_decode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">7</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">33007</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">jpeg_decode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">8</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">32946</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="nb">hasattr</span><span class="p">(</span><span class="n">imagecodecs</span><span class="p">,</span> <span class="s1">&#39;DEFLATE&#39;</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">DEFLATE</span>
                        <span class="p">):</span>
                            <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">deflate_decode</span>
                        <span class="k">elif</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">ZLIB</span><span class="p">:</span>
                            <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">zlib_decode</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">codec</span> <span class="o">=</span> <span class="n">zlib_decode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">32773</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">packbits_decode</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="n">key</span> <span class="o">==</span> <span class="mi">33003</span>
                        <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">33004</span>
                        <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">33005</span>
                        <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34712</span>
                    <span class="p">):</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">jpeg2k_decode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34887</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">lerc_decode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34892</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">jpeg8_decode</span>  <span class="c1"># DNG lossy</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34925</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">LZMA</span><span class="p">:</span>
                            <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">lzma_decode</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">codec</span> <span class="o">=</span> <span class="n">lzma_decode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34933</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">png_decode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34934</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">22610</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">jpegxr_decode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">50000</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34926</span><span class="p">:</span>  <span class="c1"># 34926 deprecated</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">zstd_decode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">50001</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34927</span><span class="p">:</span>  <span class="c1"># 34927 deprecated</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">webp_decode</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">50002</span><span class="p">:</span>
                        <span class="n">codec</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">jpegxl_decode</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">TIFF</span><span class="o">.</span><span class="n">COMPRESSION</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">!r}</span><span class="s1"> not supported&#39;</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> is not a known COMPRESSION&#39;</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">TIFF</span><span class="o">.</span><span class="n">COMPRESSION</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                        <span class="s2">&quot;requires the &#39;imagecodecs&#39; package&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_codecs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">codec</span>
                <span class="k">return</span> <span class="n">codec</span>

            <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">DECOMPRESSORS</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">FRAME_ATTRS</span><span class="p">():</span>
        <span class="c1"># attributes that a TiffFrame shares with its keyframe</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="s1">&#39;ndim&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="s1">&#39;is_final&#39;</span><span class="p">,</span> <span class="s1">&#39;decode&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">FILE_FLAGS</span><span class="p">():</span>
        <span class="c1"># TiffFile and TiffPage &#39;is_\*&#39; attributes</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;reduced&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mask&#39;</span><span class="p">,</span>
            <span class="s1">&#39;final&#39;</span><span class="p">,</span>
            <span class="s1">&#39;memmappable&#39;</span><span class="p">,</span>
            <span class="s1">&#39;contiguous&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tiled&#39;</span><span class="p">,</span>
            <span class="s1">&#39;subsampled&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">TiffPage</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;is_&#39;</span> <span class="ow">and</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">FILE_PATTERNS</span><span class="p">():</span>
        <span class="c1"># predefined FileSequence patterns</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;axes&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;(?ix)</span>
<span class="s2">                # matches Olympus OIF and Leica TIFF series</span>
<span class="s2">                _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))</span>
<span class="s2">                _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s2">                _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s2">                _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s2">                _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s2">                _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s2">                _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s2">                &quot;&quot;&quot;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">FILE_EXTENSIONS</span><span class="p">():</span>
        <span class="c1"># TIFF file extensions</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s1">&#39;tif&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tiff&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ome.tif&#39;</span><span class="p">,</span>
            <span class="s1">&#39;lsm&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stk&#39;</span><span class="p">,</span>
            <span class="s1">&#39;qpi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pcoraw&#39;</span><span class="p">,</span>
            <span class="s1">&#39;qptiff&#39;</span><span class="p">,</span>
            <span class="s1">&#39;gel&#39;</span><span class="p">,</span>
            <span class="s1">&#39;seq&#39;</span><span class="p">,</span>
            <span class="s1">&#39;svs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;scn&#39;</span><span class="p">,</span>
            <span class="s1">&#39;zif&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ndpi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bif&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tf8&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tf2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;btf&#39;</span><span class="p">,</span>
            <span class="s1">&#39;eer&#39;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">FILEOPEN_FILTER</span><span class="p">():</span>
        <span class="c1"># string for use in Windows File Open box</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ext</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1"> files&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;*.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">FILE_EXTENSIONS</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[(</span><span class="s1">&#39;allfiles&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">AXES_LABELS</span><span class="p">():</span>

        <span class="c1"># TODO: is there a standard for character axes labels?</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span>  <span class="c1"># height</span>
            <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="s1">&#39;depth&#39;</span><span class="p">,</span>
            <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="s1">&#39;sample&#39;</span><span class="p">,</span>  <span class="c1"># rgb(a), cmyk</span>
            <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="s1">&#39;series&#39;</span><span class="p">,</span>  <span class="c1"># general sequence of frames/planes/pages/IFDs</span>
            <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="s1">&#39;channel&#39;</span><span class="p">,</span>  <span class="c1"># color, emission wavelength</span>
            <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="s1">&#39;angle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="s1">&#39;phase&#39;</span><span class="p">,</span>  <span class="c1"># formerly F    # P is Position in LSM!</span>
            <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="s1">&#39;tile&#39;</span><span class="p">,</span>  <span class="c1"># region, point, mosaic</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="s1">&#39;lifetime&#39;</span><span class="p">,</span>  <span class="c1"># histogram</span>
            <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="s1">&#39;lambda&#39;</span><span class="p">,</span>  <span class="c1"># excitation wavelength</span>
            <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="s1">&#39;exposure&#39;</span><span class="p">,</span>  <span class="c1"># lux</span>
            <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="s1">&#39;event&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="s1">&#39;other&#39;</span><span class="p">,</span>
            <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="s1">&#39;mosaic&#39;</span><span class="p">,</span>  <span class="c1"># LSM 6</span>
        <span class="p">}</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
        <span class="k">return</span> <span class="n">axes</span>

    <span class="k">def</span> <span class="nf">NDPI_TAGS</span><span class="p">():</span>
        <span class="c1"># 65420 - 65458  Private Hamamatsu NDPI tags</span>
        <span class="c1"># TODO: obtain specification</span>
        <span class="k">return</span> <span class="n">TiffTagRegistry</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="mi">65324</span><span class="p">,</span> <span class="s1">&#39;OffsetHighBytes&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65325</span><span class="p">,</span> <span class="s1">&#39;ByteCountHighBytes&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65420</span><span class="p">,</span> <span class="s1">&#39;FileFormat&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65421</span><span class="p">,</span> <span class="s1">&#39;Magnification&#39;</span><span class="p">),</span>  <span class="c1"># SourceLens</span>
                <span class="p">(</span><span class="mi">65422</span><span class="p">,</span> <span class="s1">&#39;XOffsetFromSlideCenter&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65423</span><span class="p">,</span> <span class="s1">&#39;YOffsetFromSlideCenter&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65424</span><span class="p">,</span> <span class="s1">&#39;ZOffsetFromSlideCenter&#39;</span><span class="p">),</span>  <span class="c1"># FocalPlane</span>
                <span class="p">(</span><span class="mi">65425</span><span class="p">,</span> <span class="s1">&#39;TissueIndex&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65426</span><span class="p">,</span> <span class="s1">&#39;McuStarts&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65427</span><span class="p">,</span> <span class="s1">&#39;SlideLabel&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65428</span><span class="p">,</span> <span class="s1">&#39;AuthCode&#39;</span><span class="p">),</span>  <span class="c1"># ?</span>
                <span class="p">(</span><span class="mi">65429</span><span class="p">,</span> <span class="s1">&#39;65429&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65430</span><span class="p">,</span> <span class="s1">&#39;65430&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65431</span><span class="p">,</span> <span class="s1">&#39;65431&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65432</span><span class="p">,</span> <span class="s1">&#39;McuStartsHighBytes&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65433</span><span class="p">,</span> <span class="s1">&#39;65433&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65434</span><span class="p">,</span> <span class="s1">&#39;Fluorescence&#39;</span><span class="p">),</span>  <span class="c1"># FilterSetName</span>
                <span class="p">(</span><span class="mi">65435</span><span class="p">,</span> <span class="s1">&#39;ExposureRatio&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65436</span><span class="p">,</span> <span class="s1">&#39;RedMultiplier&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65437</span><span class="p">,</span> <span class="s1">&#39;GreenMultiplier&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65438</span><span class="p">,</span> <span class="s1">&#39;BlueMultiplier&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65439</span><span class="p">,</span> <span class="s1">&#39;FocusPoints&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65440</span><span class="p">,</span> <span class="s1">&#39;FocusPointRegions&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65441</span><span class="p">,</span> <span class="s1">&#39;CaptureMode&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65442</span><span class="p">,</span> <span class="s1">&#39;ScannerSerialNumber&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65443</span><span class="p">,</span> <span class="s1">&#39;65443&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65444</span><span class="p">,</span> <span class="s1">&#39;JpegQuality&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65445</span><span class="p">,</span> <span class="s1">&#39;RefocusInterval&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65446</span><span class="p">,</span> <span class="s1">&#39;FocusOffset&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65447</span><span class="p">,</span> <span class="s1">&#39;BlankLines&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65448</span><span class="p">,</span> <span class="s1">&#39;FirmwareVersion&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65449</span><span class="p">,</span> <span class="s1">&#39;Comments&#39;</span><span class="p">),</span>  <span class="c1"># PropertyMap, CalibrationInfo</span>
                <span class="p">(</span><span class="mi">65450</span><span class="p">,</span> <span class="s1">&#39;LabelObscured&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65451</span><span class="p">,</span> <span class="s1">&#39;Wavelength&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65452</span><span class="p">,</span> <span class="s1">&#39;65452&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65453</span><span class="p">,</span> <span class="s1">&#39;LampAge&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65454</span><span class="p">,</span> <span class="s1">&#39;ExposureTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65455</span><span class="p">,</span> <span class="s1">&#39;FocusTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65456</span><span class="p">,</span> <span class="s1">&#39;ScanTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65457</span><span class="p">,</span> <span class="s1">&#39;WriteTime&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65458</span><span class="p">,</span> <span class="s1">&#39;FullyAutoFocus&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65500</span><span class="p">,</span> <span class="s1">&#39;DefaultGamma&#39;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">EXIF_TAGS</span><span class="p">():</span>
        <span class="c1"># 65000 - 65112  Photoshop Camera RAW EXIF tags</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">TiffTagRegistry</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="mi">65000</span><span class="p">,</span> <span class="s1">&#39;OwnerName&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65001</span><span class="p">,</span> <span class="s1">&#39;SerialNumber&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65002</span><span class="p">,</span> <span class="s1">&#39;Lens&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65100</span><span class="p">,</span> <span class="s1">&#39;RawFile&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65101</span><span class="p">,</span> <span class="s1">&#39;Converter&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65102</span><span class="p">,</span> <span class="s1">&#39;WhiteBalance&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65105</span><span class="p">,</span> <span class="s1">&#39;Exposure&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65106</span><span class="p">,</span> <span class="s1">&#39;Shadows&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65107</span><span class="p">,</span> <span class="s1">&#39;Brightness&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65108</span><span class="p">,</span> <span class="s1">&#39;Contrast&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65109</span><span class="p">,</span> <span class="s1">&#39;Saturation&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65110</span><span class="p">,</span> <span class="s1">&#39;Sharpness&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65111</span><span class="p">,</span> <span class="s1">&#39;Smoothness&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">65112</span><span class="p">,</span> <span class="s1">&#39;MoireFilter&#39;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">TAGS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tags</span>

    <span class="k">def</span> <span class="nf">GPS_TAGS</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">TiffTagRegistry</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;GPSVersionID&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;GPSLatitudeRef&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;GPSLatitude&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;GPSLongitudeRef&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;GPSLongitude&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;GPSAltitudeRef&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;GPSAltitude&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;GPSTimeStamp&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;GPSSatellites&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;GPSStatus&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;GPSMeasureMode&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;GPSDOP&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;GPSSpeedRef&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;GPSSpeed&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;GPSTrackRef&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;GPSTrack&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;GPSImgDirectionRef&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="s1">&#39;GPSImgDirection&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;GPSMapDatum&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="s1">&#39;GPSDestLatitudeRef&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;GPSDestLatitude&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="s1">&#39;GPSDestLongitudeRef&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="s1">&#39;GPSDestLongitude&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="s1">&#39;GPSDestBearingRef&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s1">&#39;GPSDestBearing&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;GPSDestDistanceRef&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="s1">&#39;GPSDestDistance&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">27</span><span class="p">,</span> <span class="s1">&#39;GPSProcessingMethod&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="s1">&#39;GPSAreaInformation&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">29</span><span class="p">,</span> <span class="s1">&#39;GPSDateStamp&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;GPSDifferential&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="s1">&#39;GPSHPositioningError&#39;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">IOP_TAGS</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">TiffTagRegistry</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;InteroperabilityIndex&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;InteroperabilityVersion&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="s1">&#39;RelatedImageFileFormat&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4097</span><span class="p">,</span> <span class="s1">&#39;RelatedImageWidth&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4098</span><span class="p">,</span> <span class="s1">&#39;RelatedImageLength&#39;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">GEO_KEYS</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.tifffile_geodb</span> <span class="kn">import</span> <span class="n">GeoKeys</span>  <span class="c1"># delayed import</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">tifffile_geodb</span> <span class="kn">import</span> <span class="n">GeoKeys</span>  <span class="c1"># delayed import</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>

                <span class="k">class</span> <span class="nc">GeoKeys</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
                    <span class="k">pass</span>

        <span class="k">return</span> <span class="n">GeoKeys</span>

    <span class="k">def</span> <span class="nf">GEO_CODES</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.tifffile_geodb</span> <span class="kn">import</span> <span class="n">GEO_CODES</span>  <span class="c1"># delayed import</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">tifffile_geodb</span> <span class="kn">import</span> <span class="n">GEO_CODES</span>  <span class="c1"># delayed import</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="n">GEO_CODES</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">GEO_CODES</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;MagicNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;StructureSize&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DimensionX&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DimensionY&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DimensionZ&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DimensionChannels&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DimensionTime&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DataType&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>  <span class="c1"># DATATYPES</span>
            <span class="p">(</span><span class="s1">&#39;ThumbnailX&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ThumbnailY&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;VoxelSizeX&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;VoxelSizeY&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;VoxelSizeZ&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OriginX&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OriginY&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OriginZ&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ScanType&#39;</span><span class="p">,</span> <span class="s1">&#39;u2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SpectralScan&#39;</span><span class="p">,</span> <span class="s1">&#39;u2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TypeOfData&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>  <span class="c1"># TYPEOFDATA</span>
            <span class="p">(</span><span class="s1">&#39;OffsetVectorOverlay&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetInputLut&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetOutputLut&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetChannelColors&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TimeIntervall&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetChannelDataTypes&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetScanInformation&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>  <span class="c1"># SCANINFO</span>
            <span class="p">(</span><span class="s1">&#39;OffsetKsData&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetTimeStamps&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetEventList&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetRoi&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetBleachRoi&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetNextRecording&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="c1"># LSM 2.0 ends here</span>
            <span class="p">(</span><span class="s1">&#39;DisplayAspectX&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DisplayAspectY&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DisplayAspectZ&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DisplayAspectTime&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetMeanOfRoisOverlay&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetTopoIsolineOverlay&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetTopoProfileOverlay&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetLinescanOverlay&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ToolbarFlags&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetChannelWavelength&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetChannelFactors&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ObjectiveSphereCorrection&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetUnmixParameters&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="c1"># LSM 3.2, 4.0 end here</span>
            <span class="p">(</span><span class="s1">&#39;OffsetAcquisitionParameters&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetCharacteristics&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetPalette&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TimeDifferenceX&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TimeDifferenceY&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TimeDifferenceZ&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;InternalUse1&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DimensionP&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DimensionM&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DimensionsReserved&#39;</span><span class="p">,</span> <span class="s1">&#39;16i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetTilePositions&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;9u4&#39;</span><span class="p">),</span>  <span class="c1"># Reserved</span>
            <span class="p">(</span><span class="s1">&#39;OffsetPositions&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="c1"># (&#39;&#39;, &#39;21u4&#39;),  # must be 0</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO_READERS</span><span class="p">():</span>
        <span class="c1"># import functions for CZ_LSMINFO sub-records</span>
        <span class="c1"># TODO: read more CZ_LSMINFO sub-records</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;ScanInformation&#39;</span><span class="p">:</span> <span class="n">read_lsm_scaninfo</span><span class="p">,</span>
            <span class="s1">&#39;TimeStamps&#39;</span><span class="p">:</span> <span class="n">read_lsm_timestamps</span><span class="p">,</span>
            <span class="s1">&#39;EventList&#39;</span><span class="p">:</span> <span class="n">read_lsm_eventlist</span><span class="p">,</span>
            <span class="s1">&#39;ChannelColors&#39;</span><span class="p">:</span> <span class="n">read_lsm_channelcolors</span><span class="p">,</span>
            <span class="s1">&#39;Positions&#39;</span><span class="p">:</span> <span class="n">read_lsm_positions</span><span class="p">,</span>
            <span class="s1">&#39;TilePositions&#39;</span><span class="p">:</span> <span class="n">read_lsm_positions</span><span class="p">,</span>
            <span class="s1">&#39;VectorOverlay&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;InputLut&#39;</span><span class="p">:</span> <span class="n">read_lsm_lookuptable</span><span class="p">,</span>
            <span class="s1">&#39;OutputLut&#39;</span><span class="p">:</span> <span class="n">read_lsm_lookuptable</span><span class="p">,</span>
            <span class="s1">&#39;TimeIntervall&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;ChannelDataTypes&#39;</span><span class="p">:</span> <span class="n">read_lsm_channeldatatypes</span><span class="p">,</span>
            <span class="s1">&#39;KsData&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;Roi&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;BleachRoi&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;NextRecording&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># read with TiffFile(fh, offset=)</span>
            <span class="s1">&#39;MeanOfRoisOverlay&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;TopoIsolineOverlay&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;TopoProfileOverlay&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;ChannelWavelength&#39;</span><span class="p">:</span> <span class="n">read_lsm_channelwavelength</span><span class="p">,</span>
            <span class="s1">&#39;SphereCorrection&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;ChannelFactors&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;UnmixParameters&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;AcquisitionParameters&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;Characteristics&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO_SCANTYPE</span><span class="p">():</span>
        <span class="c1"># map CZ_LSMINFO.ScanType to dimension order</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;XYZCT&#39;</span><span class="p">,</span>  <span class="c1"># &#39;Stack&#39; normal x-y-z-scan</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;XYZCT&#39;</span><span class="p">,</span>  <span class="c1"># &#39;Z-Scan&#39; x-z-plane Y=1</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;XYZCT&#39;</span><span class="p">,</span>  <span class="c1"># &#39;Line&#39;</span>
            <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;XYTCZ&#39;</span><span class="p">,</span>  <span class="c1"># &#39;Time Series Plane&#39; time series x-y  XYCTZ ? Z=1</span>
            <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;XYZTC&#39;</span><span class="p">,</span>  <span class="c1"># &#39;Time Series z-Scan&#39; time series x-z</span>
            <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;XYTCZ&#39;</span><span class="p">,</span>  <span class="c1"># &#39;Time Series Mean-of-ROIs&#39;</span>
            <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;XYZTC&#39;</span><span class="p">,</span>  <span class="c1"># &#39;Time Series Stack&#39; time series x-y-z</span>
            <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;XYCTZ&#39;</span><span class="p">,</span>  <span class="c1"># Spline Scan</span>
            <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;XYCZT&#39;</span><span class="p">,</span>  <span class="c1"># Spline Plane x-z</span>
            <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;XYTCZ&#39;</span><span class="p">,</span>  <span class="c1"># Time Series Spline Plane x-z</span>
            <span class="mi">10</span><span class="p">:</span> <span class="s1">&#39;XYZCT&#39;</span><span class="p">,</span>  <span class="c1"># &#39;Time Series Point&#39; point mode</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO_DIMENSIONS</span><span class="p">():</span>
        <span class="c1"># map dimension codes to CZ_LSMINFO attribute</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="s1">&#39;DimensionX&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="s1">&#39;DimensionY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="s1">&#39;DimensionZ&#39;</span><span class="p">,</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="s1">&#39;DimensionChannels&#39;</span><span class="p">,</span>
            <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;DimensionTime&#39;</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="s1">&#39;DimensionP&#39;</span><span class="p">,</span>
            <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="s1">&#39;DimensionM&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO_DATATYPES</span><span class="p">():</span>
        <span class="c1"># description of CZ_LSMINFO.DataType</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;varying data types&#39;</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;8 bit unsigned integer&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;12 bit unsigned integer&#39;</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;32 bit float&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO_TYPEOFDATA</span><span class="p">():</span>
        <span class="c1"># description of CZ_LSMINFO.TypeOfData</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;Original scan data&#39;</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;Calculated data&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;3D reconstruction&#39;</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;Topography height map&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO_SCANINFO_ARRAYS</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mh">0x20000000</span><span class="p">:</span> <span class="s1">&#39;Tracks&#39;</span><span class="p">,</span>
            <span class="mh">0x30000000</span><span class="p">:</span> <span class="s1">&#39;Lasers&#39;</span><span class="p">,</span>
            <span class="mh">0x60000000</span><span class="p">:</span> <span class="s1">&#39;DetectionChannels&#39;</span><span class="p">,</span>
            <span class="mh">0x80000000</span><span class="p">:</span> <span class="s1">&#39;IlluminationChannels&#39;</span><span class="p">,</span>
            <span class="mh">0xA0000000</span><span class="p">:</span> <span class="s1">&#39;BeamSplitters&#39;</span><span class="p">,</span>
            <span class="mh">0xC0000000</span><span class="p">:</span> <span class="s1">&#39;DataChannels&#39;</span><span class="p">,</span>
            <span class="mh">0x11000000</span><span class="p">:</span> <span class="s1">&#39;Timers&#39;</span><span class="p">,</span>
            <span class="mh">0x13000000</span><span class="p">:</span> <span class="s1">&#39;Markers&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO_SCANINFO_STRUCTS</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="c1"># 0x10000000: &#39;Recording&#39;,</span>
            <span class="mh">0x40000000</span><span class="p">:</span> <span class="s1">&#39;Track&#39;</span><span class="p">,</span>
            <span class="mh">0x50000000</span><span class="p">:</span> <span class="s1">&#39;Laser&#39;</span><span class="p">,</span>
            <span class="mh">0x70000000</span><span class="p">:</span> <span class="s1">&#39;DetectionChannel&#39;</span><span class="p">,</span>
            <span class="mh">0x90000000</span><span class="p">:</span> <span class="s1">&#39;IlluminationChannel&#39;</span><span class="p">,</span>
            <span class="mh">0xB0000000</span><span class="p">:</span> <span class="s1">&#39;BeamSplitter&#39;</span><span class="p">,</span>
            <span class="mh">0xD0000000</span><span class="p">:</span> <span class="s1">&#39;DataChannel&#39;</span><span class="p">,</span>
            <span class="mh">0x12000000</span><span class="p">:</span> <span class="s1">&#39;Timer&#39;</span><span class="p">,</span>
            <span class="mh">0x14000000</span><span class="p">:</span> <span class="s1">&#39;Marker&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO_SCANINFO_ATTRIBUTES</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="c1"># Recording</span>
            <span class="mh">0x10000001</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
            <span class="mh">0x10000002</span><span class="p">:</span> <span class="s1">&#39;Description&#39;</span><span class="p">,</span>
            <span class="mh">0x10000003</span><span class="p">:</span> <span class="s1">&#39;Notes&#39;</span><span class="p">,</span>
            <span class="mh">0x10000004</span><span class="p">:</span> <span class="s1">&#39;Objective&#39;</span><span class="p">,</span>
            <span class="mh">0x10000005</span><span class="p">:</span> <span class="s1">&#39;ProcessingSummary&#39;</span><span class="p">,</span>
            <span class="mh">0x10000006</span><span class="p">:</span> <span class="s1">&#39;SpecialScanMode&#39;</span><span class="p">,</span>
            <span class="mh">0x10000007</span><span class="p">:</span> <span class="s1">&#39;ScanType&#39;</span><span class="p">,</span>
            <span class="mh">0x10000008</span><span class="p">:</span> <span class="s1">&#39;ScanMode&#39;</span><span class="p">,</span>
            <span class="mh">0x10000009</span><span class="p">:</span> <span class="s1">&#39;NumberOfStacks&#39;</span><span class="p">,</span>
            <span class="mh">0x1000000A</span><span class="p">:</span> <span class="s1">&#39;LinesPerPlane&#39;</span><span class="p">,</span>
            <span class="mh">0x1000000B</span><span class="p">:</span> <span class="s1">&#39;SamplesPerLine&#39;</span><span class="p">,</span>
            <span class="mh">0x1000000C</span><span class="p">:</span> <span class="s1">&#39;PlanesPerVolume&#39;</span><span class="p">,</span>
            <span class="mh">0x1000000D</span><span class="p">:</span> <span class="s1">&#39;ImagesWidth&#39;</span><span class="p">,</span>
            <span class="mh">0x1000000E</span><span class="p">:</span> <span class="s1">&#39;ImagesHeight&#39;</span><span class="p">,</span>
            <span class="mh">0x1000000F</span><span class="p">:</span> <span class="s1">&#39;ImagesNumberPlanes&#39;</span><span class="p">,</span>
            <span class="mh">0x10000010</span><span class="p">:</span> <span class="s1">&#39;ImagesNumberStacks&#39;</span><span class="p">,</span>
            <span class="mh">0x10000011</span><span class="p">:</span> <span class="s1">&#39;ImagesNumberChannels&#39;</span><span class="p">,</span>
            <span class="mh">0x10000012</span><span class="p">:</span> <span class="s1">&#39;LinscanXySize&#39;</span><span class="p">,</span>
            <span class="mh">0x10000013</span><span class="p">:</span> <span class="s1">&#39;ScanDirection&#39;</span><span class="p">,</span>
            <span class="mh">0x10000014</span><span class="p">:</span> <span class="s1">&#39;TimeSeries&#39;</span><span class="p">,</span>
            <span class="mh">0x10000015</span><span class="p">:</span> <span class="s1">&#39;OriginalScanData&#39;</span><span class="p">,</span>
            <span class="mh">0x10000016</span><span class="p">:</span> <span class="s1">&#39;ZoomX&#39;</span><span class="p">,</span>
            <span class="mh">0x10000017</span><span class="p">:</span> <span class="s1">&#39;ZoomY&#39;</span><span class="p">,</span>
            <span class="mh">0x10000018</span><span class="p">:</span> <span class="s1">&#39;ZoomZ&#39;</span><span class="p">,</span>
            <span class="mh">0x10000019</span><span class="p">:</span> <span class="s1">&#39;Sample0X&#39;</span><span class="p">,</span>
            <span class="mh">0x1000001A</span><span class="p">:</span> <span class="s1">&#39;Sample0Y&#39;</span><span class="p">,</span>
            <span class="mh">0x1000001B</span><span class="p">:</span> <span class="s1">&#39;Sample0Z&#39;</span><span class="p">,</span>
            <span class="mh">0x1000001C</span><span class="p">:</span> <span class="s1">&#39;SampleSpacing&#39;</span><span class="p">,</span>
            <span class="mh">0x1000001D</span><span class="p">:</span> <span class="s1">&#39;LineSpacing&#39;</span><span class="p">,</span>
            <span class="mh">0x1000001E</span><span class="p">:</span> <span class="s1">&#39;PlaneSpacing&#39;</span><span class="p">,</span>
            <span class="mh">0x1000001F</span><span class="p">:</span> <span class="s1">&#39;PlaneWidth&#39;</span><span class="p">,</span>
            <span class="mh">0x10000020</span><span class="p">:</span> <span class="s1">&#39;PlaneHeight&#39;</span><span class="p">,</span>
            <span class="mh">0x10000021</span><span class="p">:</span> <span class="s1">&#39;VolumeDepth&#39;</span><span class="p">,</span>
            <span class="mh">0x10000023</span><span class="p">:</span> <span class="s1">&#39;Nutation&#39;</span><span class="p">,</span>
            <span class="mh">0x10000034</span><span class="p">:</span> <span class="s1">&#39;Rotation&#39;</span><span class="p">,</span>
            <span class="mh">0x10000035</span><span class="p">:</span> <span class="s1">&#39;Precession&#39;</span><span class="p">,</span>
            <span class="mh">0x10000036</span><span class="p">:</span> <span class="s1">&#39;Sample0time&#39;</span><span class="p">,</span>
            <span class="mh">0x10000037</span><span class="p">:</span> <span class="s1">&#39;StartScanTriggerIn&#39;</span><span class="p">,</span>
            <span class="mh">0x10000038</span><span class="p">:</span> <span class="s1">&#39;StartScanTriggerOut&#39;</span><span class="p">,</span>
            <span class="mh">0x10000039</span><span class="p">:</span> <span class="s1">&#39;StartScanEvent&#39;</span><span class="p">,</span>
            <span class="mh">0x10000040</span><span class="p">:</span> <span class="s1">&#39;StartScanTime&#39;</span><span class="p">,</span>
            <span class="mh">0x10000041</span><span class="p">:</span> <span class="s1">&#39;StopScanTriggerIn&#39;</span><span class="p">,</span>
            <span class="mh">0x10000042</span><span class="p">:</span> <span class="s1">&#39;StopScanTriggerOut&#39;</span><span class="p">,</span>
            <span class="mh">0x10000043</span><span class="p">:</span> <span class="s1">&#39;StopScanEvent&#39;</span><span class="p">,</span>
            <span class="mh">0x10000044</span><span class="p">:</span> <span class="s1">&#39;StopScanTime&#39;</span><span class="p">,</span>
            <span class="mh">0x10000045</span><span class="p">:</span> <span class="s1">&#39;UseRois&#39;</span><span class="p">,</span>
            <span class="mh">0x10000046</span><span class="p">:</span> <span class="s1">&#39;UseReducedMemoryRois&#39;</span><span class="p">,</span>
            <span class="mh">0x10000047</span><span class="p">:</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span>
            <span class="mh">0x10000048</span><span class="p">:</span> <span class="s1">&#39;UseBcCorrection&#39;</span><span class="p">,</span>
            <span class="mh">0x10000049</span><span class="p">:</span> <span class="s1">&#39;PositionBcCorrection1&#39;</span><span class="p">,</span>
            <span class="mh">0x10000050</span><span class="p">:</span> <span class="s1">&#39;PositionBcCorrection2&#39;</span><span class="p">,</span>
            <span class="mh">0x10000051</span><span class="p">:</span> <span class="s1">&#39;InterpolationY&#39;</span><span class="p">,</span>
            <span class="mh">0x10000052</span><span class="p">:</span> <span class="s1">&#39;CameraBinning&#39;</span><span class="p">,</span>
            <span class="mh">0x10000053</span><span class="p">:</span> <span class="s1">&#39;CameraSupersampling&#39;</span><span class="p">,</span>
            <span class="mh">0x10000054</span><span class="p">:</span> <span class="s1">&#39;CameraFrameWidth&#39;</span><span class="p">,</span>
            <span class="mh">0x10000055</span><span class="p">:</span> <span class="s1">&#39;CameraFrameHeight&#39;</span><span class="p">,</span>
            <span class="mh">0x10000056</span><span class="p">:</span> <span class="s1">&#39;CameraOffsetX&#39;</span><span class="p">,</span>
            <span class="mh">0x10000057</span><span class="p">:</span> <span class="s1">&#39;CameraOffsetY&#39;</span><span class="p">,</span>
            <span class="mh">0x10000059</span><span class="p">:</span> <span class="s1">&#39;RtBinning&#39;</span><span class="p">,</span>
            <span class="mh">0x1000005A</span><span class="p">:</span> <span class="s1">&#39;RtFrameWidth&#39;</span><span class="p">,</span>
            <span class="mh">0x1000005B</span><span class="p">:</span> <span class="s1">&#39;RtFrameHeight&#39;</span><span class="p">,</span>
            <span class="mh">0x1000005C</span><span class="p">:</span> <span class="s1">&#39;RtRegionWidth&#39;</span><span class="p">,</span>
            <span class="mh">0x1000005D</span><span class="p">:</span> <span class="s1">&#39;RtRegionHeight&#39;</span><span class="p">,</span>
            <span class="mh">0x1000005E</span><span class="p">:</span> <span class="s1">&#39;RtOffsetX&#39;</span><span class="p">,</span>
            <span class="mh">0x1000005F</span><span class="p">:</span> <span class="s1">&#39;RtOffsetY&#39;</span><span class="p">,</span>
            <span class="mh">0x10000060</span><span class="p">:</span> <span class="s1">&#39;RtZoom&#39;</span><span class="p">,</span>
            <span class="mh">0x10000061</span><span class="p">:</span> <span class="s1">&#39;RtLinePeriod&#39;</span><span class="p">,</span>
            <span class="mh">0x10000062</span><span class="p">:</span> <span class="s1">&#39;Prescan&#39;</span><span class="p">,</span>
            <span class="mh">0x10000063</span><span class="p">:</span> <span class="s1">&#39;ScanDirectionZ&#39;</span><span class="p">,</span>
            <span class="c1"># Track</span>
            <span class="mh">0x40000001</span><span class="p">:</span> <span class="s1">&#39;MultiplexType&#39;</span><span class="p">,</span>  <span class="c1"># 0 After Line; 1 After Frame</span>
            <span class="mh">0x40000002</span><span class="p">:</span> <span class="s1">&#39;MultiplexOrder&#39;</span><span class="p">,</span>
            <span class="mh">0x40000003</span><span class="p">:</span> <span class="s1">&#39;SamplingMode&#39;</span><span class="p">,</span>  <span class="c1"># 0 Sample; 1 Line Avg; 2 Frame Avg</span>
            <span class="mh">0x40000004</span><span class="p">:</span> <span class="s1">&#39;SamplingMethod&#39;</span><span class="p">,</span>  <span class="c1"># 1 Mean; 2 Sum</span>
            <span class="mh">0x40000005</span><span class="p">:</span> <span class="s1">&#39;SamplingNumber&#39;</span><span class="p">,</span>
            <span class="mh">0x40000006</span><span class="p">:</span> <span class="s1">&#39;Acquire&#39;</span><span class="p">,</span>
            <span class="mh">0x40000007</span><span class="p">:</span> <span class="s1">&#39;SampleObservationTime&#39;</span><span class="p">,</span>
            <span class="mh">0x4000000B</span><span class="p">:</span> <span class="s1">&#39;TimeBetweenStacks&#39;</span><span class="p">,</span>
            <span class="mh">0x4000000C</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
            <span class="mh">0x4000000D</span><span class="p">:</span> <span class="s1">&#39;Collimator1Name&#39;</span><span class="p">,</span>
            <span class="mh">0x4000000E</span><span class="p">:</span> <span class="s1">&#39;Collimator1Position&#39;</span><span class="p">,</span>
            <span class="mh">0x4000000F</span><span class="p">:</span> <span class="s1">&#39;Collimator2Name&#39;</span><span class="p">,</span>
            <span class="mh">0x40000010</span><span class="p">:</span> <span class="s1">&#39;Collimator2Position&#39;</span><span class="p">,</span>
            <span class="mh">0x40000011</span><span class="p">:</span> <span class="s1">&#39;IsBleachTrack&#39;</span><span class="p">,</span>
            <span class="mh">0x40000012</span><span class="p">:</span> <span class="s1">&#39;IsBleachAfterScanNumber&#39;</span><span class="p">,</span>
            <span class="mh">0x40000013</span><span class="p">:</span> <span class="s1">&#39;BleachScanNumber&#39;</span><span class="p">,</span>
            <span class="mh">0x40000014</span><span class="p">:</span> <span class="s1">&#39;TriggerIn&#39;</span><span class="p">,</span>
            <span class="mh">0x40000015</span><span class="p">:</span> <span class="s1">&#39;TriggerOut&#39;</span><span class="p">,</span>
            <span class="mh">0x40000016</span><span class="p">:</span> <span class="s1">&#39;IsRatioTrack&#39;</span><span class="p">,</span>
            <span class="mh">0x40000017</span><span class="p">:</span> <span class="s1">&#39;BleachCount&#39;</span><span class="p">,</span>
            <span class="mh">0x40000018</span><span class="p">:</span> <span class="s1">&#39;SpiCenterWavelength&#39;</span><span class="p">,</span>
            <span class="mh">0x40000019</span><span class="p">:</span> <span class="s1">&#39;PixelTime&#39;</span><span class="p">,</span>
            <span class="mh">0x40000021</span><span class="p">:</span> <span class="s1">&#39;CondensorFrontlens&#39;</span><span class="p">,</span>
            <span class="mh">0x40000023</span><span class="p">:</span> <span class="s1">&#39;FieldStopValue&#39;</span><span class="p">,</span>
            <span class="mh">0x40000024</span><span class="p">:</span> <span class="s1">&#39;IdCondensorAperture&#39;</span><span class="p">,</span>
            <span class="mh">0x40000025</span><span class="p">:</span> <span class="s1">&#39;CondensorAperture&#39;</span><span class="p">,</span>
            <span class="mh">0x40000026</span><span class="p">:</span> <span class="s1">&#39;IdCondensorRevolver&#39;</span><span class="p">,</span>
            <span class="mh">0x40000027</span><span class="p">:</span> <span class="s1">&#39;CondensorFilter&#39;</span><span class="p">,</span>
            <span class="mh">0x40000028</span><span class="p">:</span> <span class="s1">&#39;IdTransmissionFilter1&#39;</span><span class="p">,</span>
            <span class="mh">0x40000029</span><span class="p">:</span> <span class="s1">&#39;IdTransmission1&#39;</span><span class="p">,</span>
            <span class="mh">0x40000030</span><span class="p">:</span> <span class="s1">&#39;IdTransmissionFilter2&#39;</span><span class="p">,</span>
            <span class="mh">0x40000031</span><span class="p">:</span> <span class="s1">&#39;IdTransmission2&#39;</span><span class="p">,</span>
            <span class="mh">0x40000032</span><span class="p">:</span> <span class="s1">&#39;RepeatBleach&#39;</span><span class="p">,</span>
            <span class="mh">0x40000033</span><span class="p">:</span> <span class="s1">&#39;EnableSpotBleachPos&#39;</span><span class="p">,</span>
            <span class="mh">0x40000034</span><span class="p">:</span> <span class="s1">&#39;SpotBleachPosx&#39;</span><span class="p">,</span>
            <span class="mh">0x40000035</span><span class="p">:</span> <span class="s1">&#39;SpotBleachPosy&#39;</span><span class="p">,</span>
            <span class="mh">0x40000036</span><span class="p">:</span> <span class="s1">&#39;SpotBleachPosz&#39;</span><span class="p">,</span>
            <span class="mh">0x40000037</span><span class="p">:</span> <span class="s1">&#39;IdTubelens&#39;</span><span class="p">,</span>
            <span class="mh">0x40000038</span><span class="p">:</span> <span class="s1">&#39;IdTubelensPosition&#39;</span><span class="p">,</span>
            <span class="mh">0x40000039</span><span class="p">:</span> <span class="s1">&#39;TransmittedLight&#39;</span><span class="p">,</span>
            <span class="mh">0x4000003A</span><span class="p">:</span> <span class="s1">&#39;ReflectedLight&#39;</span><span class="p">,</span>
            <span class="mh">0x4000003B</span><span class="p">:</span> <span class="s1">&#39;SimultanGrabAndBleach&#39;</span><span class="p">,</span>
            <span class="mh">0x4000003C</span><span class="p">:</span> <span class="s1">&#39;BleachPixelTime&#39;</span><span class="p">,</span>
            <span class="c1"># Laser</span>
            <span class="mh">0x50000001</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
            <span class="mh">0x50000002</span><span class="p">:</span> <span class="s1">&#39;Acquire&#39;</span><span class="p">,</span>
            <span class="mh">0x50000003</span><span class="p">:</span> <span class="s1">&#39;Power&#39;</span><span class="p">,</span>
            <span class="c1"># DetectionChannel</span>
            <span class="mh">0x70000001</span><span class="p">:</span> <span class="s1">&#39;IntegrationMode&#39;</span><span class="p">,</span>
            <span class="mh">0x70000002</span><span class="p">:</span> <span class="s1">&#39;SpecialMode&#39;</span><span class="p">,</span>
            <span class="mh">0x70000003</span><span class="p">:</span> <span class="s1">&#39;DetectorGainFirst&#39;</span><span class="p">,</span>
            <span class="mh">0x70000004</span><span class="p">:</span> <span class="s1">&#39;DetectorGainLast&#39;</span><span class="p">,</span>
            <span class="mh">0x70000005</span><span class="p">:</span> <span class="s1">&#39;AmplifierGainFirst&#39;</span><span class="p">,</span>
            <span class="mh">0x70000006</span><span class="p">:</span> <span class="s1">&#39;AmplifierGainLast&#39;</span><span class="p">,</span>
            <span class="mh">0x70000007</span><span class="p">:</span> <span class="s1">&#39;AmplifierOffsFirst&#39;</span><span class="p">,</span>
            <span class="mh">0x70000008</span><span class="p">:</span> <span class="s1">&#39;AmplifierOffsLast&#39;</span><span class="p">,</span>
            <span class="mh">0x70000009</span><span class="p">:</span> <span class="s1">&#39;PinholeDiameter&#39;</span><span class="p">,</span>
            <span class="mh">0x7000000A</span><span class="p">:</span> <span class="s1">&#39;CountingTrigger&#39;</span><span class="p">,</span>
            <span class="mh">0x7000000B</span><span class="p">:</span> <span class="s1">&#39;Acquire&#39;</span><span class="p">,</span>
            <span class="mh">0x7000000C</span><span class="p">:</span> <span class="s1">&#39;PointDetectorName&#39;</span><span class="p">,</span>
            <span class="mh">0x7000000D</span><span class="p">:</span> <span class="s1">&#39;AmplifierName&#39;</span><span class="p">,</span>
            <span class="mh">0x7000000E</span><span class="p">:</span> <span class="s1">&#39;PinholeName&#39;</span><span class="p">,</span>
            <span class="mh">0x7000000F</span><span class="p">:</span> <span class="s1">&#39;FilterSetName&#39;</span><span class="p">,</span>
            <span class="mh">0x70000010</span><span class="p">:</span> <span class="s1">&#39;FilterName&#39;</span><span class="p">,</span>
            <span class="mh">0x70000013</span><span class="p">:</span> <span class="s1">&#39;IntegratorName&#39;</span><span class="p">,</span>
            <span class="mh">0x70000014</span><span class="p">:</span> <span class="s1">&#39;ChannelName&#39;</span><span class="p">,</span>
            <span class="mh">0x70000015</span><span class="p">:</span> <span class="s1">&#39;DetectorGainBc1&#39;</span><span class="p">,</span>
            <span class="mh">0x70000016</span><span class="p">:</span> <span class="s1">&#39;DetectorGainBc2&#39;</span><span class="p">,</span>
            <span class="mh">0x70000017</span><span class="p">:</span> <span class="s1">&#39;AmplifierGainBc1&#39;</span><span class="p">,</span>
            <span class="mh">0x70000018</span><span class="p">:</span> <span class="s1">&#39;AmplifierGainBc2&#39;</span><span class="p">,</span>
            <span class="mh">0x70000019</span><span class="p">:</span> <span class="s1">&#39;AmplifierOffsetBc1&#39;</span><span class="p">,</span>
            <span class="mh">0x70000020</span><span class="p">:</span> <span class="s1">&#39;AmplifierOffsetBc2&#39;</span><span class="p">,</span>
            <span class="mh">0x70000021</span><span class="p">:</span> <span class="s1">&#39;SpectralScanChannels&#39;</span><span class="p">,</span>
            <span class="mh">0x70000022</span><span class="p">:</span> <span class="s1">&#39;SpiWavelengthStart&#39;</span><span class="p">,</span>
            <span class="mh">0x70000023</span><span class="p">:</span> <span class="s1">&#39;SpiWavelengthStop&#39;</span><span class="p">,</span>
            <span class="mh">0x70000026</span><span class="p">:</span> <span class="s1">&#39;DyeName&#39;</span><span class="p">,</span>
            <span class="mh">0x70000027</span><span class="p">:</span> <span class="s1">&#39;DyeFolder&#39;</span><span class="p">,</span>
            <span class="c1"># IlluminationChannel</span>
            <span class="mh">0x90000001</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
            <span class="mh">0x90000002</span><span class="p">:</span> <span class="s1">&#39;Power&#39;</span><span class="p">,</span>
            <span class="mh">0x90000003</span><span class="p">:</span> <span class="s1">&#39;Wavelength&#39;</span><span class="p">,</span>
            <span class="mh">0x90000004</span><span class="p">:</span> <span class="s1">&#39;Aquire&#39;</span><span class="p">,</span>
            <span class="mh">0x90000005</span><span class="p">:</span> <span class="s1">&#39;DetchannelName&#39;</span><span class="p">,</span>
            <span class="mh">0x90000006</span><span class="p">:</span> <span class="s1">&#39;PowerBc1&#39;</span><span class="p">,</span>
            <span class="mh">0x90000007</span><span class="p">:</span> <span class="s1">&#39;PowerBc2&#39;</span><span class="p">,</span>
            <span class="c1"># BeamSplitter</span>
            <span class="mh">0xB0000001</span><span class="p">:</span> <span class="s1">&#39;FilterSet&#39;</span><span class="p">,</span>
            <span class="mh">0xB0000002</span><span class="p">:</span> <span class="s1">&#39;Filter&#39;</span><span class="p">,</span>
            <span class="mh">0xB0000003</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
            <span class="c1"># DataChannel</span>
            <span class="mh">0xD0000001</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
            <span class="mh">0xD0000003</span><span class="p">:</span> <span class="s1">&#39;Acquire&#39;</span><span class="p">,</span>
            <span class="mh">0xD0000004</span><span class="p">:</span> <span class="s1">&#39;Color&#39;</span><span class="p">,</span>
            <span class="mh">0xD0000005</span><span class="p">:</span> <span class="s1">&#39;SampleType&#39;</span><span class="p">,</span>
            <span class="mh">0xD0000006</span><span class="p">:</span> <span class="s1">&#39;BitsPerSample&#39;</span><span class="p">,</span>
            <span class="mh">0xD0000007</span><span class="p">:</span> <span class="s1">&#39;RatioType&#39;</span><span class="p">,</span>
            <span class="mh">0xD0000008</span><span class="p">:</span> <span class="s1">&#39;RatioTrack1&#39;</span><span class="p">,</span>
            <span class="mh">0xD0000009</span><span class="p">:</span> <span class="s1">&#39;RatioTrack2&#39;</span><span class="p">,</span>
            <span class="mh">0xD000000A</span><span class="p">:</span> <span class="s1">&#39;RatioChannel1&#39;</span><span class="p">,</span>
            <span class="mh">0xD000000B</span><span class="p">:</span> <span class="s1">&#39;RatioChannel2&#39;</span><span class="p">,</span>
            <span class="mh">0xD000000C</span><span class="p">:</span> <span class="s1">&#39;RatioConst1&#39;</span><span class="p">,</span>
            <span class="mh">0xD000000D</span><span class="p">:</span> <span class="s1">&#39;RatioConst2&#39;</span><span class="p">,</span>
            <span class="mh">0xD000000E</span><span class="p">:</span> <span class="s1">&#39;RatioConst3&#39;</span><span class="p">,</span>
            <span class="mh">0xD000000F</span><span class="p">:</span> <span class="s1">&#39;RatioConst4&#39;</span><span class="p">,</span>
            <span class="mh">0xD0000010</span><span class="p">:</span> <span class="s1">&#39;RatioConst5&#39;</span><span class="p">,</span>
            <span class="mh">0xD0000011</span><span class="p">:</span> <span class="s1">&#39;RatioConst6&#39;</span><span class="p">,</span>
            <span class="mh">0xD0000012</span><span class="p">:</span> <span class="s1">&#39;RatioFirstImages1&#39;</span><span class="p">,</span>
            <span class="mh">0xD0000013</span><span class="p">:</span> <span class="s1">&#39;RatioFirstImages2&#39;</span><span class="p">,</span>
            <span class="mh">0xD0000014</span><span class="p">:</span> <span class="s1">&#39;DyeName&#39;</span><span class="p">,</span>
            <span class="mh">0xD0000015</span><span class="p">:</span> <span class="s1">&#39;DyeFolder&#39;</span><span class="p">,</span>
            <span class="mh">0xD0000016</span><span class="p">:</span> <span class="s1">&#39;Spectrum&#39;</span><span class="p">,</span>
            <span class="mh">0xD0000017</span><span class="p">:</span> <span class="s1">&#39;Acquire&#39;</span><span class="p">,</span>
            <span class="c1"># Timer</span>
            <span class="mh">0x12000001</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
            <span class="mh">0x12000002</span><span class="p">:</span> <span class="s1">&#39;Description&#39;</span><span class="p">,</span>
            <span class="mh">0x12000003</span><span class="p">:</span> <span class="s1">&#39;Interval&#39;</span><span class="p">,</span>
            <span class="mh">0x12000004</span><span class="p">:</span> <span class="s1">&#39;TriggerIn&#39;</span><span class="p">,</span>
            <span class="mh">0x12000005</span><span class="p">:</span> <span class="s1">&#39;TriggerOut&#39;</span><span class="p">,</span>
            <span class="mh">0x12000006</span><span class="p">:</span> <span class="s1">&#39;ActivationTime&#39;</span><span class="p">,</span>
            <span class="mh">0x12000007</span><span class="p">:</span> <span class="s1">&#39;ActivationNumber&#39;</span><span class="p">,</span>
            <span class="c1"># Marker</span>
            <span class="mh">0x14000001</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
            <span class="mh">0x14000002</span><span class="p">:</span> <span class="s1">&#39;Description&#39;</span><span class="p">,</span>
            <span class="mh">0x14000003</span><span class="p">:</span> <span class="s1">&#39;TriggerIn&#39;</span><span class="p">,</span>
            <span class="mh">0x14000004</span><span class="p">:</span> <span class="s1">&#39;TriggerOut&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">CZ_LSM_LUTTYPE</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">CZ_LSM_LUTTYPE</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">NORMAL</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ORIGINAL</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">RAMP</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">POLYLINE</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">SPLINE</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">GAMMA</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">return</span> <span class="n">CZ_LSM_LUTTYPE</span>

    <span class="k">def</span> <span class="nf">CZ_LSM_SUBBLOCK_TYPE</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">CZ_LSM_SUBBLOCK_TYPE</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">END</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">GAMMA</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">BRIGHTNESS</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">CONTRAST</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">RAMP</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">KNOTS</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">PALETTE_12_TO_12</span> <span class="o">=</span> <span class="mi">6</span>

        <span class="k">return</span> <span class="n">CZ_LSM_SUBBLOCK_TYPE</span>

    <span class="k">def</span> <span class="nf">NIH_IMAGE_HEADER</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;FileID&#39;</span><span class="p">,</span> <span class="s1">&#39;a8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;nLines&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PixelsPerLine&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Version&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OldLutMode&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OldnColors&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Colors&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;OldColorStart&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ColorWidth&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ExtraColors&#39;</span><span class="p">,</span> <span class="s1">&#39;u2&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;nExtraColors&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ForegroundIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BackgroundIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;XScale&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Unused2&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Unused3&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;UnitsID&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>  <span class="c1"># NIH_UNITS_TYPE</span>
            <span class="p">(</span><span class="s1">&#39;p1&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="s1">&#39;p2&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="s1">&#39;CurveFitType&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>  <span class="c1"># NIH_CURVEFIT_TYPE</span>
            <span class="p">(</span><span class="s1">&#39;nCoefficients&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Coeff&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;UMsize&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;UM&#39;</span><span class="p">,</span> <span class="s1">&#39;a15&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;UnusedBoolean&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BinaryPic&#39;</span><span class="p">,</span> <span class="s1">&#39;b1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SliceStart&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SliceEnd&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ScaleMagnification&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;nSlices&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SliceSpacing&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CurrentSlice&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FrameInterval&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PixelAspectRatio&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ColorStart&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ColorEnd&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;nColors&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Fill1&#39;</span><span class="p">,</span> <span class="s1">&#39;3u2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Fill2&#39;</span><span class="p">,</span> <span class="s1">&#39;3u2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Table&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">),</span>  <span class="c1"># NIH_COLORTABLE_TYPE</span>
            <span class="p">(</span><span class="s1">&#39;LutMode&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">),</span>  <span class="c1"># NIH_LUTMODE_TYPE</span>
            <span class="p">(</span><span class="s1">&#39;InvertedTable&#39;</span><span class="p">,</span> <span class="s1">&#39;b1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ZeroClip&#39;</span><span class="p">,</span> <span class="s1">&#39;b1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;XUnitSize&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;XUnit&#39;</span><span class="p">,</span> <span class="s1">&#39;a11&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;StackType&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>  <span class="c1"># NIH_STACKTYPE_TYPE</span>
            <span class="c1"># (&#39;UnusedBytes&#39;, &#39;u1&#39;, 200)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">NIH_COLORTABLE_TYPE</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s1">&#39;CustomTable&#39;</span><span class="p">,</span>
            <span class="s1">&#39;AppleDefault&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Pseudo20&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Pseudo32&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Rainbow&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Fire1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Fire2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Ice&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Grays&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Spectrum&#39;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">NIH_LUTMODE_TYPE</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s1">&#39;PseudoColor&#39;</span><span class="p">,</span>
            <span class="s1">&#39;OldAppleDefault&#39;</span><span class="p">,</span>
            <span class="s1">&#39;OldSpectrum&#39;</span><span class="p">,</span>
            <span class="s1">&#39;GrayScale&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ColorLut&#39;</span><span class="p">,</span>
            <span class="s1">&#39;CustomGrayscale&#39;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">NIH_CURVEFIT_TYPE</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s1">&#39;StraightLine&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Poly2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Poly3&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Poly4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Poly5&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ExpoFit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PowerFit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;LogFit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;RodbardFit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SpareFit1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Uncalibrated&#39;</span><span class="p">,</span>
            <span class="s1">&#39;UncalibratedOD&#39;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">NIH_UNITS_TYPE</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s1">&#39;Nanometers&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Micrometers&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Millimeters&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Centimeters&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Meters&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Kilometers&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Inches&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Feet&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Miles&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Pixels&#39;</span><span class="p">,</span>
            <span class="s1">&#39;OtherUnits&#39;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">TVIPS_HEADER_V1</span><span class="p">():</span>
        <span class="c1"># TVIPS TemData structure from EMMENU Help file</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;Version&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CommentV1&#39;</span><span class="p">,</span> <span class="s1">&#39;a80&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;HighTension&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SphericalAberration&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;IlluminationAperture&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Magnification&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PostMagnification&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FocalLength&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Defocus&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Astigmatism&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;AstigmatismDirection&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BiprismVoltage&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SpecimenTiltAngle&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SpecimenTiltDirection&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;IlluminationTiltDirection&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;IlluminationTiltAngle&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageMode&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;EnergySpread&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ChromaticAberration&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ShutterType&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DefocusSpread&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CcdNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CcdSize&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetXV1&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetYV1&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PhysicalPixelSize&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Binning&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ReadoutSpeed&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GainV1&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SensitivityV1&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ExposureTimeV1&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FlatCorrected&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DeadPxCorrected&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageMean&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageStd&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DisplacementX&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DisplacementY&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DateV1&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TimeV1&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageMin&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageMax&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageStatisticsQuality&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">TVIPS_HEADER_V2</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;ImageName&#39;</span><span class="p">,</span> <span class="s1">&#39;V160&#39;</span><span class="p">),</span>  <span class="c1"># utf16</span>
            <span class="p">(</span><span class="s1">&#39;ImageFolder&#39;</span><span class="p">,</span> <span class="s1">&#39;V160&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageSizeX&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageSizeY&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageSizeZ&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageSizeE&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageDataType&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Comment&#39;</span><span class="p">,</span> <span class="s1">&#39;V1024&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageHistory&#39;</span><span class="p">,</span> <span class="s1">&#39;V1024&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Scaling&#39;</span><span class="p">,</span> <span class="s1">&#39;16f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageStatistics&#39;</span><span class="p">,</span> <span class="s1">&#39;16c16&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageType&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageDisplaType&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PixelSizeX&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>  <span class="c1"># distance between two px in x, [nm]</span>
            <span class="p">(</span><span class="s1">&#39;PixelSizeY&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>  <span class="c1"># distance between two px in y, [nm]</span>
            <span class="p">(</span><span class="s1">&#39;ImageDistanceZ&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageDistanceE&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageMisc&#39;</span><span class="p">,</span> <span class="s1">&#39;32f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemType&#39;</span><span class="p">,</span> <span class="s1">&#39;V160&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemHighTension&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemAberrations&#39;</span><span class="p">,</span> <span class="s1">&#39;32f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemEnergy&#39;</span><span class="p">,</span> <span class="s1">&#39;32f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemMode&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemMagnification&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemMagnificationCorrection&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PostMagnification&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemStageType&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemStagePosition&#39;</span><span class="p">,</span> <span class="s1">&#39;5f4&#39;</span><span class="p">),</span>  <span class="c1"># x, y, z, a, b</span>
            <span class="p">(</span><span class="s1">&#39;TemImageShift&#39;</span><span class="p">,</span> <span class="s1">&#39;2f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemBeamShift&#39;</span><span class="p">,</span> <span class="s1">&#39;2f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemBeamTilt&#39;</span><span class="p">,</span> <span class="s1">&#39;2f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TilingParameters&#39;</span><span class="p">,</span> <span class="s1">&#39;7f4&#39;</span><span class="p">),</span>  <span class="c1"># 0: tiling? 1:x 2:y 3: max x</span>
            <span class="c1">#                               4: max y 5: overlap x 6: overlap y</span>
            <span class="p">(</span><span class="s1">&#39;TemIllumination&#39;</span><span class="p">,</span> <span class="s1">&#39;3f4&#39;</span><span class="p">),</span>  <span class="c1"># 0: spotsize 1: intensity</span>
            <span class="p">(</span><span class="s1">&#39;TemShutter&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemMisc&#39;</span><span class="p">,</span> <span class="s1">&#39;32f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CameraType&#39;</span><span class="p">,</span> <span class="s1">&#39;V160&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PhysicalPixelSizeX&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PhysicalPixelSizeY&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetX&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetY&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BinningX&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BinningY&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ExposureTime&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Gain&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ReadoutRate&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FlatfieldDescription&#39;</span><span class="p">,</span> <span class="s1">&#39;V160&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Sensitivity&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Dose&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CamMisc&#39;</span><span class="p">,</span> <span class="s1">&#39;32f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FeiMicroscopeInformation&#39;</span><span class="p">,</span> <span class="s1">&#39;V1024&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FeiSpecimenInformation&#39;</span><span class="p">,</span> <span class="s1">&#39;V1024&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Magic&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">MM_HEADER</span><span class="p">():</span>
        <span class="c1"># Olympus FluoView MM_Header</span>
        <span class="n">MM_DIMENSION</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;a16&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Size&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Origin&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Resolution&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Unit&#39;</span><span class="p">,</span> <span class="s1">&#39;a64&#39;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;HeaderFlag&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageType&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageName&#39;</span><span class="p">,</span> <span class="s1">&#39;a257&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetData&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PaletteSize&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetPalette0&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetPalette1&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CommentSize&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetComment&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Dimensions&#39;</span><span class="p">,</span> <span class="n">MM_DIMENSION</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetPosition&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MapType&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MapMin&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MapMax&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MinValue&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MaxValue&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetMap&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Offset&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GrayChannel&#39;</span><span class="p">,</span> <span class="n">MM_DIMENSION</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetThumbnail&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;VoiceField&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetVoiceField&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">MM_DIMENSIONS</span><span class="p">():</span>
        <span class="c1"># map FluoView MM_Header.Dimensions to axes characters</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="s1">&#39;Z&#39;</span><span class="p">,</span>
            <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span>
            <span class="s1">&#39;CH&#39;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span>
            <span class="s1">&#39;WAVELENGTH&#39;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span>
            <span class="s1">&#39;TIME&#39;</span><span class="p">:</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span>
            <span class="s1">&#39;XY&#39;</span><span class="p">:</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span>
            <span class="s1">&#39;EVENT&#39;</span><span class="p">:</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span>
            <span class="s1">&#39;EXPOSURE&#39;</span><span class="p">:</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">UIC_TAGS</span><span class="p">():</span>
        <span class="c1"># map Universal Imaging Corporation MetaMorph internal tag ids to</span>
        <span class="c1"># name and type</span>
        <span class="kn">from</span> <span class="nn">fractions</span> <span class="kn">import</span> <span class="n">Fraction</span>  <span class="c1"># delayed import</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;AutoScale&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MinScale&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MaxScale&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SpatialCalibration&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;XCalibration&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;YCalibration&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CalibrationUnits&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ThreshState&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ThreshStateRed&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;tagid_10&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>  <span class="c1"># undefined</span>
            <span class="p">(</span><span class="s1">&#39;ThreshStateGreen&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ThreshStateBlue&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ThreshStateLo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ThreshStateHi&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Zoom&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CreateTime&#39;</span><span class="p">,</span> <span class="n">julian_datetime</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;LastSavedTime&#39;</span><span class="p">,</span> <span class="n">julian_datetime</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;currentBuffer&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;grayFit&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;grayPointCount&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;grayX&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;grayY&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;grayMin&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;grayMax&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;grayUnitName&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;StandardLUT&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;wavelength&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;StagePosition&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%i</span><span class="s1">,2,2)u4&#39;</span><span class="p">),</span>  <span class="c1"># N xy positions as fract</span>
            <span class="p">(</span><span class="s1">&#39;CameraChipOffset&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%i</span><span class="s1">,2,2)u4&#39;</span><span class="p">),</span>  <span class="c1"># N xy offsets as fract</span>
            <span class="p">(</span><span class="s1">&#39;OverlayMask&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OverlayCompress&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Overlay&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SpecialOverlayMask&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SpecialOverlayCompress&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SpecialOverlay&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageProperty&#39;</span><span class="p">,</span> <span class="n">read_uic_image_property</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;StageLabel&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">p&#39;</span><span class="p">),</span>  <span class="c1"># N str</span>
            <span class="p">(</span><span class="s1">&#39;AutoScaleLoInfo&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;AutoScaleHiInfo&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;AbsoluteZ&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%i</span><span class="s1">,2)u4&#39;</span><span class="p">),</span>  <span class="c1"># N fractions</span>
            <span class="p">(</span><span class="s1">&#39;AbsoluteZValid&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%i</span><span class="s1">,)u4&#39;</span><span class="p">),</span>  <span class="c1"># N long</span>
            <span class="p">(</span><span class="s1">&#39;Gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">),</span>  <span class="c1"># &#39;I&#39; uses offset</span>
            <span class="p">(</span><span class="s1">&#39;GammaRed&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GammaGreen&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GammaBlue&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CameraBin&#39;</span><span class="p">,</span> <span class="s1">&#39;2I&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;NewLUT&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImagePropertyEx&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PlaneProperty&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;UserLutTable&#39;</span><span class="p">,</span> <span class="s1">&#39;(256,3)u1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;RedAutoScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;RedAutoScaleLoInfo&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;RedAutoScaleHiInfo&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;RedMinScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;RedMaxScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GreenAutoScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GreenAutoScaleLoInfo&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GreenAutoScaleHiInfo&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GreenMinScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GreenMaxScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BlueAutoScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BlueAutoScaleLoInfo&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BlueAutoScaleHiInfo&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BlueMinScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BlueMaxScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="c1"># (&#39;OverlayPlaneColor&#39;, read_uic_overlay_plane_color),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">PILATUS_HEADER</span><span class="p">():</span>
        <span class="c1"># PILATUS CBF Header Specification, Version 1.4</span>
        <span class="c1"># map key to [value_indices], type</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;Detector&#39;</span><span class="p">:</span> <span class="p">([</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)],</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s1">&#39;Pixel_size&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Silicon&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">3</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Exposure_time&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Exposure_period&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Tau&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Count_cutoff&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;Threshold_setting&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Gain_setting&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s1">&#39;N_excluded_pixels&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;Excluded_pixels&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s1">&#39;Flat_field&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s1">&#39;Trim_file&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s1">&#39;Image_path&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span>
            <span class="c1"># optional</span>
            <span class="s1">&#39;Wavelength&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Energy_range&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Detector_distance&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Detector_Voffset&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Beam_xy&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Flux&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s1">&#39;Filter_transmission&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Start_angle&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Angle_increment&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Detector_2theta&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Polarization&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Alpha&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Kappa&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Phi&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Phi_increment&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Chi&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Chi_increment&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Oscillation_axis&#39;</span><span class="p">:</span> <span class="p">([</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)],</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s1">&#39;N_oscillations&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;Start_position&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Position_increment&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Shutter_time&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Omega&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Omega_increment&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">ALLOCATIONGRANULARITY</span><span class="p">():</span>
        <span class="c1"># alignment for writing contiguous data to TIFF</span>
        <span class="kn">import</span> <span class="nn">mmap</span>  <span class="c1"># delayed import</span>

        <span class="k">return</span> <span class="n">mmap</span><span class="o">.</span><span class="n">ALLOCATIONGRANULARITY</span>

    <span class="k">def</span> <span class="nf">MAXWORKERS</span><span class="p">():</span>
        <span class="c1"># half of CPU cores</span>
        <span class="kn">import</span> <span class="nn">multiprocessing</span>  <span class="c1"># delayed import</span>

        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">CHUNKMODE</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">CHUNKMODE</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">NONE</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">PLANE</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">PAGE</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">FILE</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="k">return</span> <span class="n">CHUNKMODE</span>


<span class="k">def</span> <span class="nf">read_tags</span><span class="p">(</span>
    <span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">,</span> <span class="n">tagnames</span><span class="p">,</span> <span class="n">customtags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxifds</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read tags from chain of IFDs and return as list of dicts.</span>

<span class="sd">    The file handle position must be at a valid IFD header.</span>
<span class="sd">    Does not work with NDPI.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">offsetsize</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">offsetformat</span> <span class="o">=</span> <span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;I&#39;</span>
        <span class="n">tagnosize</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">tagnoformat</span> <span class="o">=</span> <span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;H&#39;</span>
        <span class="n">tagsize</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">tagformat1</span> <span class="o">=</span> <span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;HH&#39;</span>
        <span class="n">tagformat2</span> <span class="o">=</span> <span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;I4s&#39;</span>
    <span class="k">elif</span> <span class="n">offsetsize</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">offsetformat</span> <span class="o">=</span> <span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;Q&#39;</span>
        <span class="n">tagnosize</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">tagnoformat</span> <span class="o">=</span> <span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;Q&#39;</span>
        <span class="n">tagsize</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">tagformat1</span> <span class="o">=</span> <span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;HH&#39;</span>
        <span class="n">tagformat2</span> <span class="o">=</span> <span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;Q8s&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid offset size&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">customtags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">customtags</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">maxifds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">maxifds</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unpack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maxifds</span><span class="p">:</span>
        <span class="c1"># loop over IFDs</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tagno</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">tagnoformat</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tagnosize</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tagno</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;suspicious number of tags </span><span class="si">{</span><span class="n">tagno</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">log_warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.read_tags&gt; corrupted tag list @</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="p">)</span>
            <span class="k">break</span>

        <span class="n">tags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tagsize</span> <span class="o">*</span> <span class="n">tagno</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tagno</span><span class="p">):</span>
            <span class="n">code</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">tagformat1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span> <span class="p">:</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])</span>
            <span class="n">count</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span>
                <span class="n">tagformat2</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">:</span> <span class="n">index</span> <span class="o">+</span> <span class="n">tagsize</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="n">tagsize</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">tagnames</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">valueformat</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DATA_FORMATS</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;invalid data type </span><span class="si">{</span><span class="n">dtype</span><span class="si">!r}</span><span class="s1"> for tag #</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>

            <span class="n">valuesize</span> <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">valueformat</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">valuesize</span> <span class="o">&gt;</span> <span class="n">offsetsize</span> <span class="ow">or</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">customtags</span><span class="p">:</span>
                <span class="n">valueoffset</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">valueoffset</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="ow">or</span> <span class="n">valueoffset</span> <span class="o">+</span> <span class="n">valuesize</span> <span class="o">&gt;</span> <span class="n">fh</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TiffFileError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;invalid value offset </span><span class="si">{</span><span class="n">valueoffset</span><span class="si">}</span><span class="s1"> for tag #</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">valueoffset</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">customtags</span><span class="p">:</span>
                    <span class="n">readfunc</span> <span class="o">=</span> <span class="n">customtags</span><span class="p">[</span><span class="n">code</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">readfunc</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="c1"># BYTES, ASCII, UNDEFINED</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">valuesize</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="n">valuesize</span><span class="p">:</span>
                        <span class="n">log_warning</span><span class="p">(</span>
                            <span class="s1">&#39;&lt;tifffile.read_tags&gt; &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;could not read all values for tag #</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">tagnames</span><span class="p">:</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">byteorder</span><span class="p">,</span> <span class="n">count</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">valueformat</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">valueformat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">valuesize</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">read_numpy</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                <span class="c1"># BYTES, ASCII, UNDEFINED</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span><span class="n">valuesize</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">byteorder</span><span class="p">,</span> <span class="n">count</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">valueformat</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">valueformat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">value</span><span class="p">[:</span><span class="n">valuesize</span><span class="p">])</span>

            <span class="n">process</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">customtags</span>
                <span class="ow">and</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_TUPLE</span>
                <span class="ow">and</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="mi">7</span>  <span class="c1"># UNDEFINED</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">process</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># TIFF ASCII fields can contain multiple strings,</span>
                <span class="c1">#   each terminated with a NUL</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                    <span class="n">log_warning</span><span class="p">(</span>
                        <span class="s1">&#39;&lt;tifffile.read_tags&gt; &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;coercing invalid ASCII to bytes for tag #</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_ENUM</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_ENUM</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">259</span><span class="p">,</span> <span class="mi">317</span><span class="p">):</span>
                            <span class="c1"># ignore compression/predictor</span>
                            <span class="n">log_warning</span><span class="p">(</span>
                                <span class="s1">&#39;&lt;tifffile.read_tags&gt; &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;failed for tag #</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span>
                            <span class="p">)</span>
                <span class="k">if</span> <span class="n">process</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>

        <span class="c1"># read offset to next page</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">offsetsize</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">fh</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">log_warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.read_tags&gt; invalid next page offset </span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="k">break</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">maxifds</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_exif_ifd</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read EXIF tags from file and return as dict.&quot;&quot;&quot;</span>
    <span class="n">exif</span> <span class="o">=</span> <span class="n">read_tags</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">,</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">EXIF_TAGS</span><span class="p">,</span> <span class="n">maxifds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ExifVersion&#39;</span><span class="p">,</span> <span class="s1">&#39;FlashpixVersion&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exif</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">exif</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="s1">&#39;UserComment&#39;</span> <span class="ow">in</span> <span class="n">exif</span><span class="p">:</span>
        <span class="n">idcode</span> <span class="o">=</span> <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;UserComment&#39;</span><span class="p">][:</span><span class="mi">8</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">idcode</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;ASCII</span><span class="se">\x00\x00\x00</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;UserComment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">exif</span><span class="p">[</span><span class="s1">&#39;UserComment&#39;</span><span class="p">][</span><span class="mi">8</span><span class="p">:])</span>
            <span class="k">elif</span> <span class="n">idcode</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;UNICODE</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;UserComment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;UserComment&#39;</span><span class="p">][</span><span class="mi">8</span><span class="p">:]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-16&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">exif</span>


<span class="k">def</span> <span class="nf">read_gps_ifd</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read GPS tags from file and return as dict.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">read_tags</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">,</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">GPS_TAGS</span><span class="p">,</span> <span class="n">maxifds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_interoperability_ifd</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read Interoperability tags from file and return as dict.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">read_tags</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">,</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">IOP_TAGS</span><span class="p">,</span> <span class="n">maxifds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_bytes</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read tag data from file and return as bytes.&quot;&quot;&quot;</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;B&#39;</span> <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">byteorder</span> <span class="o">+</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DATA_FORMATS</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">count</span> <span class="o">*=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">count</span><span class="p">:</span>
        <span class="n">log_warning</span><span class="p">(</span>
            <span class="s1">&#39;&lt;tifffile.read_bytes&gt; &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;failed to read </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1"> bytes, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">read_utf8</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read tag data from file and return as Unicode string.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">read_numpy</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read tag data from file and return as numpy array.&quot;&quot;&quot;</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span> <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">byteorder</span> <span class="o">+</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DATA_FORMATS</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_colormap</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read ColorMap/TransferFunction from file and return as numpy array.&quot;&quot;&quot;</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DATA_FORMATS</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">count</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cmap</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cmap</span>


<span class="k">def</span> <span class="nf">read_json</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read JSON tag data from file and return as object.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&lt;tifffile.read_json&gt; </span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">read_mm_header</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read FluoView mm_header tag from file and return as dict.&quot;&quot;&quot;</span>
    <span class="n">mmh</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_record</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">MM_HEADER</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)</span>
    <span class="n">mmh</span> <span class="o">=</span> <span class="n">recarray2dict</span><span class="p">(</span><span class="n">mmh</span><span class="p">)</span>
    <span class="n">mmh</span><span class="p">[</span><span class="s1">&#39;Dimensions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">bytes2str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">mmh</span><span class="p">[</span><span class="s1">&#39;Dimensions&#39;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">mmh</span><span class="p">[</span><span class="s1">&#39;GrayChannel&#39;</span><span class="p">]</span>
    <span class="n">mmh</span><span class="p">[</span><span class="s1">&#39;GrayChannel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">bytes2str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
        <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="n">bytes2str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">mmh</span>


<span class="k">def</span> <span class="nf">read_mm_stamp</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read FluoView mm_stamp tag from file and return as numpy.ndarray.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_uic1tag</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">,</span> <span class="n">planecount</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MetaMorph STK UIC1Tag from file and return as dict.</span>

<span class="sd">    Return empty dictionary if planecount is unknown.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="ow">or</span> <span class="n">byteorder</span> <span class="o">!=</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;invalid UIC1Tag </span><span class="si">{</span><span class="n">byteorder</span><span class="si">}{</span><span class="n">dtype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="c1"># pre MetaMorph 2.5 (not tested)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;u4&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ZDistance&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
            <span class="n">tagid</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tagid</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">):</span>
                <span class="c1"># silently skip unexpected tags</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">read_uic_tag</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">tagid</span><span class="p">,</span> <span class="n">planecount</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_uic2tag</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">planecount</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MetaMorph STK UIC2Tag from file and return as dict.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">byteorder</span> <span class="o">!=</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid UIC2Tag&#39;</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;u4&#39;</span><span class="p">,</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">planecount</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">planecount</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;ZDistance&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;DateCreated&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>  <span class="c1"># julian days</span>
        <span class="s1">&#39;TimeCreated&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span>  <span class="c1"># milliseconds</span>
        <span class="s1">&#39;DateModified&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span>  <span class="c1"># julian days</span>
        <span class="s1">&#39;TimeModified&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">],</span>  <span class="c1"># milliseconds</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">read_uic3tag</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">planecount</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MetaMorph STK UIC3Tag from file and return as dict.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">byteorder</span> <span class="o">!=</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid UIC3Tag&#39;</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;u4&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">planecount</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">planecount</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Wavelengths&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]}</span>


<span class="k">def</span> <span class="nf">read_uic4tag</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">planecount</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MetaMorph STK UIC4Tag from file and return as dict.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">byteorder</span> <span class="o">!=</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid UIC4Tag&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">tagid</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;H&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tagid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">read_uic_tag</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">tagid</span><span class="p">,</span> <span class="n">planecount</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_uic_tag</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">tagid</span><span class="p">,</span> <span class="n">planecount</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read a single UIC tag value from file and return tag name and value.</span>

<span class="sd">    UIC1Tags use an offset.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">read_int</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1">I&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">count</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">value</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">UIC_TAGS</span><span class="p">[</span><span class="n">tagid</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="c1"># unknown tag</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;_TagId</span><span class="si">{</span><span class="n">tagid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">read_int</span><span class="p">()</span>

    <span class="n">Fraction</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">UIC_TAGS</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">offset</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">off</span> <span class="o">=</span> <span class="n">read_int</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">off</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="s1">&#39;&lt;tifffile.read_uic_tag&gt; &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;invalid offset for tag </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s1"> @</span><span class="si">{</span><span class="n">off</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">off</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># skip</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">read_int</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># int</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">read_int</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="n">Fraction</span><span class="p">:</span>
        <span class="c1"># fraction</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">read_int</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="n">julian_datetime</span><span class="p">:</span>
        <span class="c1"># datetime</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">julian_datetime</span><span class="p">(</span><span class="o">*</span><span class="n">read_int</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="n">read_uic_image_property</span><span class="p">:</span>
        <span class="c1"># ImagePropertyEx</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">read_uic_image_property</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># pascal string</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">read_int</span><span class="p">()</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">))[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">offset</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">log_warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.read_uic_tag&gt; invalid string in tag </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;invalid string size </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">planecount</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">p&#39;</span><span class="p">:</span>
        <span class="c1"># sequence of pascal strings</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">planecount</span><span class="p">):</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">read_int</span><span class="p">()</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">))[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">string</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>
                <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">offset</span><span class="p">:</span>
                <span class="n">log_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.read_uic_tag&gt; invalid string in tag </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;invalid string size: </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># struct or numpy type</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="n">dtype</span>
        <span class="k">if</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">dtype</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span> <span class="o">%</span> <span class="n">planecount</span>
        <span class="k">if</span> <span class="s1">&#39;(&#39;</span> <span class="ow">in</span> <span class="n">dtype</span><span class="p">:</span>
            <span class="c1"># numpy type</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># assume fractions</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">value</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># struct format</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">dtype</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">offset</span><span class="p">:</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">read_uic_image_property</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read UIC ImagePropertyEx tag from file and return as dict.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: test this</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">))[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">flags</span><span class="p">,</span> <span class="n">prop</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;IB&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_cz_lsminfo</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read CZ_LSMINFO tag from file and return as dict.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">byteorder</span> <span class="o">!=</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid CZ_LSMINFO structure&#39;</span><span class="p">)</span>
    <span class="n">magic_number</span><span class="p">,</span> <span class="n">structure_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;II&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">magic_number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">50350412</span><span class="p">,</span> <span class="mi">67127628</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid CZ_LSMINFO structure&#39;</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_CUR</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">structure_size</span> <span class="o">&lt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span><span class="p">:</span>
        <span class="c1"># adjust structure according to structure_size</span>
        <span class="n">lsminfo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">structure_size</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">lsminfo</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lsminfo</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO</span>

    <span class="n">lsminfo</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_record</span><span class="p">(</span><span class="n">lsminfo</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)</span>
    <span class="n">lsminfo</span> <span class="o">=</span> <span class="n">recarray2dict</span><span class="p">(</span><span class="n">lsminfo</span><span class="p">)</span>

    <span class="c1"># read LSM info subrecords at offsets</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">reader</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO_READERS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">reader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">lsminfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Offset&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lsminfo</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">reader</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">lsminfo</span>


<span class="k">def</span> <span class="nf">read_lsm_channeldatatypes</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read LSM channel data type.&quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;u4&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_lsm_channelwavelength</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read LSM channel wavelength ranges from file and return as list.&quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;2f8&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_lsm_positions</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read LSM positions from file and return as list.&quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;3f8&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_lsm_timestamps</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read LSM time stamps from file and return as list.&quot;&quot;&quot;</span>
    <span class="n">size</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;ii&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">count</span><span class="p">):</span>
        <span class="n">log_warning</span><span class="p">(</span>
            <span class="s1">&#39;&lt;tifffile.read_lsm_timestamps&gt; invalid LSM TimeStamps block&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="c1"># return struct.unpack(f&#39;&lt;{count}d&#39;, fh.read(8 * count))</span>
    <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;f8&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_lsm_eventlist</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read LSM events from file and return as list of (time, type, text).&quot;&quot;&quot;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;II&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">esize</span><span class="p">,</span> <span class="n">etime</span><span class="p">,</span> <span class="n">etype</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;IdI&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
        <span class="n">etext</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">esize</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)))</span>
        <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">etime</span><span class="p">,</span> <span class="n">etype</span><span class="p">,</span> <span class="n">etext</span><span class="p">))</span>
        <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">events</span>


<span class="k">def</span> <span class="nf">read_lsm_channelcolors</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read LSM ChannelColors structure from file and return as dict.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Mono&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Colors&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;ColorNames&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">ncolors</span><span class="p">,</span> <span class="n">nnames</span><span class="p">,</span> <span class="n">coffset</span><span class="p">,</span> <span class="n">noffset</span><span class="p">,</span> <span class="n">mono</span><span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
        <span class="s1">&#39;&lt;IIIIII&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">ncolors</span> <span class="o">!=</span> <span class="n">nnames</span><span class="p">:</span>
        <span class="n">log_warning</span><span class="p">(</span>
            <span class="s1">&#39;&lt;tifffile.read_lsm_channelcolors&gt; &#39;</span>
            <span class="s1">&#39;invalid LSM ChannelColors structure&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Mono&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">mono</span><span class="p">)</span>
    <span class="c1"># Colors</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">coffset</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ncolors</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ncolors</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Colors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="c1"># ColorNames</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">noffset</span><span class="p">)</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">noffset</span><span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bytes2str</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span> <span class="p">:</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">size</span><span class="p">]))</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">size</span> <span class="p">:]</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ColorNames&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">names</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_lsm_lookuptable</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read LSM lookup tables from file and return as dict.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="p">(</span>
        <span class="n">size</span><span class="p">,</span>
        <span class="n">nsubblocks</span><span class="p">,</span>
        <span class="n">nchannels</span><span class="p">,</span>
        <span class="n">luttype</span><span class="p">,</span>
        <span class="n">advanced</span><span class="p">,</span>
        <span class="n">currentchannel</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;iiiiii&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
        <span class="n">log_warning</span><span class="p">(</span>
            <span class="s1">&#39;&lt;tifffile.read_lsm_lookuptable&gt; &#39;</span>
            <span class="s1">&#39;invalid LSM LookupTables structure&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># reserved</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;LutType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSM_LUTTYPE</span><span class="p">(</span><span class="n">luttype</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Advanced&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">advanced</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;NumberChannels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nchannels</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;CurrentChannel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">currentchannel</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;SubBlocks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subblocks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsubblocks</span><span class="p">):</span>
        <span class="n">sbtype</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sbtype</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">8</span>
        <span class="k">if</span> <span class="n">sbtype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;f8&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nchannels</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sbtype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;f8&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nchannels</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sbtype</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;f8&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nchannels</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sbtype</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># the data type is wrongly documented as f8</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;i4&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nchannels</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">sbtype</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="c1"># the data type is wrongly documented as f8</span>
            <span class="n">nknots</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># undocumented</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;i4&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nchannels</span> <span class="o">*</span> <span class="n">nknots</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nchannels</span><span class="p">,</span> <span class="n">nknots</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">sbtype</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;i2&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nchannels</span> <span class="o">*</span> <span class="mi">4096</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4096</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_warning</span><span class="p">(</span>
                <span class="s1">&#39;&lt;tifffile.read_lsm_lookuptable&gt; &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;invalid LSM SubBlock type </span><span class="si">{</span><span class="n">sbtype</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="k">break</span>
        <span class="n">subblocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSM_SUBBLOCK_TYPE</span><span class="p">(</span><span class="n">sbtype</span><span class="p">),</span> <span class="s1">&#39;Data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_lsm_scaninfo</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read LSM ScanInfo structure from file and return as dict.&quot;&quot;&quot;</span>
    <span class="n">block</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">block</span><span class="p">]</span>
    <span class="n">unpack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span>
    <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x10000000</span><span class="p">:</span>
        <span class="c1"># not a Recording sub block</span>
        <span class="n">log_warning</span><span class="p">(</span>
            <span class="s1">&#39;&lt;tifffile.read_lsm_scaninfo&gt; invalid LSM ScanInfo structure&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">block</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">entry</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;III&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># ascii</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># long</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="c1"># rational</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;d&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO_SCANINFO_ARRAYS</span><span class="p">:</span>
            <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO_SCANINFO_ARRAYS</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span>
            <span class="n">newobj</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">block</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">newobj</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">newobj</span>
        <span class="k">elif</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO_SCANINFO_STRUCTS</span><span class="p">:</span>
            <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="n">newobj</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">block</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newobj</span><span class="p">)</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">newobj</span>
        <span class="k">elif</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO_SCANINFO_ATTRIBUTES</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO_SCANINFO_ATTRIBUTES</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span>
            <span class="n">block</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">entry</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">:</span>
            <span class="c1"># end sub block</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># unknown entry</span>
            <span class="n">block</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Entry0x</span><span class="si">{</span><span class="n">entry</span><span class="si">:</span><span class="s1">x</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blocks</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">block</span>


<span class="k">def</span> <span class="nf">read_sis</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read OlympusSIS structure and return as dict.</span>

<span class="sd">    No specification is avaliable. Only few fields are known.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="p">(</span><span class="n">magic</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tagcount</span><span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
        <span class="s1">&#39;&lt;4s6xhhhhh6x32sh&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">magic</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;SIS0&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid OlympusSIS structure&#39;</span><span class="p">)</span>

    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span>
            <span class="mi">1900</span> <span class="o">+</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">tagcount</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tagcount</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">tagtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;hhI&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">])</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tagtype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># general data</span>
            <span class="p">(</span><span class="n">lenexp</span><span class="p">,</span> <span class="n">xcal</span><span class="p">,</span> <span class="n">ycal</span><span class="p">,</span> <span class="n">mag</span><span class="p">,</span> <span class="n">camname</span><span class="p">,</span> <span class="n">pictype</span><span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                <span class="s1">&#39;&lt;10xhdd8xd2x34s32s&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">112</span><span class="p">)</span>  <span class="c1"># 220</span>
            <span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">lenexp</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;pixelsizex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xcal</span> <span class="o">*</span> <span class="n">m</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;pixelsizey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ycal</span> <span class="o">*</span> <span class="n">m</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;magnification&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;cameraname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">camname</span><span class="p">))</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;picturetype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">pictype</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">tagtype</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
            <span class="c1"># channel data</span>
            <span class="k">continue</span>
            <span class="c1"># TODO: does not seem to work?</span>
            <span class="c1"># (length, _, exptime, emv, _, camname, _, mictype,</span>
            <span class="c1">#  ) = struct.unpack(&#39;&lt;h22sId4s32s48s32s&#39;, fh.read(152))  # 720</span>
            <span class="c1"># result[&#39;exposuretime&#39;] = exptime</span>
            <span class="c1"># result[&#39;emvoltage&#39;] = emv</span>
            <span class="c1"># result[&#39;cameraname2&#39;] = bytes2str(stripnull(camname))</span>
            <span class="c1"># result[&#39;microscopename&#39;] = bytes2str(stripnull(mictype))</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_sis_ini</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read OlympusSIS INI string and return as dict.&quot;&quot;&quot;</span>
    <span class="n">inistr</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
    <span class="n">inistr</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">inistr</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">olympusini_metadata</span><span class="p">(</span><span class="n">inistr</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">log_warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;&lt;tifffile.olympusini_metadata&gt; </span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">read_tvips_header</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read TVIPS EM-MENU headers and return as dict.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_record</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">TVIPS_HEADER_V1</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">typestr</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TVIPS_HEADER_V1</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_record</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">TVIPS_HEADER_V2</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Magic&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="mh">0xAAAAAAAA</span><span class="p">):</span>
            <span class="n">log_warning</span><span class="p">(</span>
                <span class="s1">&#39;&lt;tifffile.read_tvips_header&gt; invalid TVIPS v2 magic number&#39;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="c1"># decode utf16 strings</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">typestr</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TVIPS_HEADER_V2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">typestr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-16&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">stripnull</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="c1"># convert nm to m</span>
        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="s1">&#39;XY&#39;</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;PhysicalPixelSize&#39;</span> <span class="o">+</span> <span class="n">axis</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">1e9</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;PixelSize&#39;</span> <span class="o">+</span> <span class="n">axis</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">1e9</span>
    <span class="k">elif</span> <span class="n">header</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">log_warning</span><span class="p">(</span>
            <span class="s1">&#39;&lt;tifffile.read_tvips_header&gt; unknown TVIPS header version&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_fei_metadata</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read FEI SFEG/HELIOS headers and return as dict.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">section</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">count</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">):</span>
            <span class="n">section</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">result</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">section</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">section</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_cz_sem</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read Zeiss SEM tag and return as dict.</span>

<span class="sd">    See https://sourceforge.net/p/gwyddion/mailman/message/29275000/ for</span>
<span class="sd">    unnamed values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="p">()}</span>
    <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">count</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">v</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">number</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">number</span> <span class="o">!=</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">number</span>
                    <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">number</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">number</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">number</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;No&#39;</span><span class="p">,</span> <span class="s1">&#39;Off&#39;</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Yes&#39;</span><span class="p">,</span> <span class="s1">&#39;On&#39;</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unit</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">unit</span><span class="p">,)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">astype</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)),)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_nih_image_header</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read NIH_IMAGE_HEADER tag from file and return as dict.&quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_record</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">NIH_IMAGE_HEADER</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(</span><span class="n">byteorder</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">recarray2dict</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">a</span><span class="p">[</span><span class="s1">&#39;XUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;XUnit&#39;</span><span class="p">][:</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;XUnitSize&#39;</span><span class="p">]]</span>
    <span class="n">a</span><span class="p">[</span><span class="s1">&#39;UM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;UM&#39;</span><span class="p">][:</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;UMsize&#39;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">read_scanimage_metadata</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read ScanImage BigTIFF v3 or v4 static and ROI metadata from open file.</span>

<span class="sd">    Return non-varying frame data, ROI group data, and version as</span>
<span class="sd">    tuple(dict, dict, int).</span>

<span class="sd">    The settings can be used to read image data and metadata without parsing</span>
<span class="sd">    the TIFF file.</span>

<span class="sd">    Raise ValueError if file does not contain valid ScanImage metadata.</span>

<span class="sd">    Frame data and ROI groups can alternatively be obtained from the Software</span>
<span class="sd">    and Artist tags of any TIFF page.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">byteorder</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;2sH&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">byteorder</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;II&#39;</span> <span class="ow">or</span> <span class="n">version</span> <span class="o">!=</span> <span class="mi">43</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not a BigTIFF file&#39;</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">magic</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">size0</span><span class="p">,</span> <span class="n">size1</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;IIII&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">magic</span> <span class="o">!=</span> <span class="mi">117637889</span> <span class="ow">or</span> <span class="n">version</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;invalid magic </span><span class="si">{</span><span class="n">magic</span><span class="si">}</span><span class="s1"> or version </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s1"> number&#39;</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;file must be opened in binary mode&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not a ScanImage BigTIFF v3 or v4 file&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

    <span class="n">frame_data</span> <span class="o">=</span> <span class="n">matlabstr2py</span><span class="p">(</span><span class="n">bytes2str</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">roi_data</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">size1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">size1</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">frame_data</span><span class="p">,</span> <span class="n">roi_data</span><span class="p">,</span> <span class="n">version</span>


<span class="k">def</span> <span class="nf">read_micromanager_metadata</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MicroManager non-TIFF settings from open file and return as dict.</span>

<span class="sd">    The settings can be used to read image data without parsing the TIFF file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">byteorder</span> <span class="o">=</span> <span class="p">{</span><span class="sa">b</span><span class="s1">&#39;II&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;MM&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">}[</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not a MicroManager TIFF file&#39;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="p">(</span>
        <span class="n">index_header</span><span class="p">,</span>  <span class="c1"># Index map</span>
        <span class="n">index_offset</span><span class="p">,</span>
        <span class="n">display_header</span><span class="p">,</span>
        <span class="n">display_offset</span><span class="p">,</span>
        <span class="n">comments_header</span><span class="p">,</span>
        <span class="n">comments_offset</span><span class="p">,</span>
        <span class="n">summary_header</span><span class="p">,</span>
        <span class="n">summary_length</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;IIIIIIII&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">summary_header</span> <span class="o">==</span> <span class="mi">2355492</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span>
            <span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">summary_length</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_warning</span><span class="p">(</span>
            <span class="s1">&#39;&lt;tifffile.read_micromanager_metadata&gt; &#39;</span>
            <span class="s1">&#39;invalid MicroManager summary header&#39;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">index_header</span> <span class="o">==</span> <span class="mi">54773648</span><span class="p">:</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">index_offset</span><span class="p">)</span>
        <span class="n">header</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">header</span> <span class="o">==</span> <span class="mi">3453623</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                <span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;IIIII&#39;</span> <span class="o">*</span> <span class="n">count</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="n">count</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;IndexMap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;Channel&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[::</span><span class="mi">5</span><span class="p">],</span>
                <span class="s1">&#39;Slice&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">5</span><span class="p">],</span>
                <span class="s1">&#39;Frame&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">5</span><span class="p">],</span>
                <span class="s1">&#39;Position&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">::</span><span class="mi">5</span><span class="p">],</span>
                <span class="s1">&#39;Offset&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">::</span><span class="mi">5</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_warning</span><span class="p">(</span>
                <span class="s1">&#39;&lt;tifffile.read_micromanager_metadata&gt; &#39;</span>
                <span class="s1">&#39;invalid MicroManager index header&#39;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_warning</span><span class="p">(</span>
            <span class="s1">&#39;&lt;tifffile.read_micromanager_metadata&gt; &#39;</span>
            <span class="s1">&#39;invalid MicroManager index header&#39;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">display_header</span> <span class="o">==</span> <span class="mi">483765892</span><span class="p">:</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">display_offset</span><span class="p">)</span>
        <span class="n">header</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">header</span> <span class="o">==</span> <span class="mi">347834724</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;DisplaySettings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span>
                <span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_warning</span><span class="p">(</span>
                <span class="s1">&#39;&lt;tifffile.read_micromanager_metadata&gt; &#39;</span>
                <span class="s1">&#39;invalid MicroManager display header&#39;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_warning</span><span class="p">(</span>
            <span class="s1">&#39;&lt;tifffile.read_micromanager_metadata&gt; &#39;</span>
            <span class="s1">&#39;invalid MicroManager display header&#39;</span>
        <span class="p">)</span>

    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;MajorVersion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">comments_header</span> <span class="o">==</span> <span class="mi">99384722</span><span class="p">:</span>
        <span class="c1"># Micro-Manager multipage TIFF</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">comments_offset</span><span class="p">)</span>
        <span class="n">header</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">header</span> <span class="o">==</span> <span class="mi">84720485</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Comments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_warning</span><span class="p">(</span>
                <span class="s1">&#39;&lt;tifffile.read_micromanager_metadata&gt; &#39;</span>
                <span class="s1">&#39;invalid MicroManager comments header&#39;</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">comments_header</span> <span class="o">==</span> <span class="mi">483729</span><span class="p">:</span>
        <span class="c1"># NDTiffStorage</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;MajorVersion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comments_offset</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_warning</span><span class="p">(</span>
            <span class="s1">&#39;&lt;tifffile.read_micromanager_metadata&gt; &#39;</span>
            <span class="s1">&#39;invalid MicroManager comments header&#39;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_metaseries_catalog</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MetaSeries non-TIFF hint catalog from file.</span>

<span class="sd">    Raise ValueError if the file does not contain a valid hint catalog.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: implement read_metaseries_catalog</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<span class="k">def</span> <span class="nf">imagej_metadata_tag</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return IJMetadata and IJMetadataByteCounts tags from metadata dict.</span>

<span class="sd">    The tags can be passed to TiffWriter.write() as extratags.</span>

<span class="sd">    The metadata dict may contain the following keys and values:</span>

<span class="sd">        Info : str</span>
<span class="sd">            Human-readable information as string.</span>
<span class="sd">        Labels : sequence of str</span>
<span class="sd">            Human-readable labels for each channel.</span>
<span class="sd">        Ranges : sequence of doubles</span>
<span class="sd">            Lower and upper values for each channel.</span>
<span class="sd">        LUTs : sequence of (3, 256) uint8 ndarrays</span>
<span class="sd">            Color palettes for each channel.</span>
<span class="sd">        Plot : bytes</span>
<span class="sd">            Undocumented ImageJ internal format.</span>
<span class="sd">        ROI: bytes</span>
<span class="sd">            Undocumented ImageJ internal region of interest format.</span>
<span class="sd">        Overlays : bytes</span>
<span class="sd">            Undocumented ImageJ internal format.</span>
<span class="sd">        Properties : {str: str}</span>
<span class="sd">            Map of key, value items as strings.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">()</span>
    <span class="n">header</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;IJIJ&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;JIJI&#39;</span><span class="p">}[</span><span class="n">byteorder</span><span class="p">]]</span>
    <span class="n">bytecounts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_string</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-16&#39;</span> <span class="o">+</span> <span class="p">{</span><span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;be&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="s1">&#39;le&#39;</span><span class="p">}[</span><span class="n">byteorder</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_doubles</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;d&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ndarray</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="n">metadata_types</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;Info&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="n">_string</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Labels&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;labl&#39;</span><span class="p">,</span> <span class="n">_string</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Ranges&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;rang&#39;</span><span class="p">,</span> <span class="n">_doubles</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;LUTs&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;luts&#39;</span><span class="p">,</span> <span class="n">_ndarray</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Plot&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;plot&#39;</span><span class="p">,</span> <span class="n">_bytes</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;roi &#39;</span><span class="p">,</span> <span class="n">_bytes</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Overlays&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;over&#39;</span><span class="p">,</span> <span class="n">_bytes</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Properties&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;prop&#39;</span><span class="p">,</span> <span class="n">_string</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">metadata_types</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
            <span class="n">mtype</span> <span class="o">=</span> <span class="n">mtype</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">item</span><span class="p">]</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mtype</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">)</span>
            <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">bytecounts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">body</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">body</span>
    <span class="n">bytecounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="n">bytecounts</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;I&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bytecounts</span><span class="p">)),</span> <span class="o">*</span><span class="n">bytecounts</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="p">(</span><span class="mi">50839</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">50838</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bytecounts</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span><span class="p">,</span> <span class="n">bytecounts</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">imagej_metadata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bytecounts</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return IJMetadata tag value as dict.</span>

<span class="sd">    The &#39;Info&#39; string can have multiple formats, e.g. OIF or ScanImage,</span>
<span class="sd">    that might be parsed into dicts using the matlabstr2py or</span>
<span class="sd">    oiffile.SettingsFile functions.</span>
<span class="sd">    &#39;ROI&#39; and &#39;Overlays&#39; are returned as bytes, which can be parsed with the</span>
<span class="sd">    ImagejRoi.frombytes() function of the roifile package.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_string</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-16&#39;</span> <span class="o">+</span> <span class="p">{</span><span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;be&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="s1">&#39;le&#39;</span><span class="p">}[</span><span class="n">byteorder</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_doubles</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;d&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span><span class="p">)),</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lut</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;uint8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="c1"># big-endian</span>
    <span class="n">metadata_types</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sa">b</span><span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Info&#39;</span><span class="p">,</span> <span class="n">_string</span><span class="p">),</span>
        <span class="sa">b</span><span class="s1">&#39;labl&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Labels&#39;</span><span class="p">,</span> <span class="n">_string</span><span class="p">),</span>
        <span class="sa">b</span><span class="s1">&#39;rang&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Ranges&#39;</span><span class="p">,</span> <span class="n">_doubles</span><span class="p">),</span>
        <span class="sa">b</span><span class="s1">&#39;luts&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;LUTs&#39;</span><span class="p">,</span> <span class="n">_lut</span><span class="p">),</span>
        <span class="sa">b</span><span class="s1">&#39;plot&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Plot&#39;</span><span class="p">,</span> <span class="n">_bytes</span><span class="p">),</span>
        <span class="sa">b</span><span class="s1">&#39;roi &#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="n">_bytes</span><span class="p">),</span>
        <span class="sa">b</span><span class="s1">&#39;over&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Overlays&#39;</span><span class="p">,</span> <span class="n">_bytes</span><span class="p">),</span>
        <span class="sa">b</span><span class="s1">&#39;prop&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Properties&#39;</span><span class="p">,</span> <span class="n">_string</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="c1"># little-endian</span>
    <span class="n">metadata_types</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadata_types</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">bytecounts</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no ImageJ metadata&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;IJIJ&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;JIJI&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid ImageJ metadata&#39;</span><span class="p">)</span>

    <span class="n">header_size</span> <span class="o">=</span> <span class="n">bytecounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">header_size</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="ow">or</span> <span class="n">header_size</span> <span class="o">&gt;</span> <span class="mi">804</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid ImageJ metadata header size&#39;</span><span class="p">)</span>

    <span class="n">ntypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">header_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
        <span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;4sI&#39;</span> <span class="o">*</span> <span class="n">ntypes</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span> <span class="p">:</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">ntypes</span> <span class="o">*</span> <span class="mi">8</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">ntypes</span> <span class="o">*</span> <span class="mi">8</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">header</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">metadata_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mtype</span><span class="p">,</span> <span class="p">(</span><span class="n">bytes2str</span><span class="p">(</span><span class="n">mtype</span><span class="p">),</span> <span class="n">_bytes</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">pos1</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">bytecounts</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos1</span><span class="p">],</span> <span class="n">byteorder</span><span class="p">))</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos1</span>
        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">values</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Properties&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prop</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Properties&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">prop</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prop</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">imagej_description_metadata</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return metatata from ImageJ image description as dict.</span>

<span class="sd">    Raise ValueError if not a valid ImageJ description.</span>

<span class="sd">    &gt;&gt;&gt; description = &#39;ImageJ=1.11a\nimages=510\nhyperstack=true\n&#39;</span>
<span class="sd">    &gt;&gt;&gt; imagej_description_metadata(description)  # doctest: +SKIP</span>
<span class="sd">    {&#39;ImageJ&#39;: &#39;1.11a&#39;, &#39;images&#39;: 510, &#39;hyperstack&#39;: True}</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_bool</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;true&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}[</span><span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">description</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">_bool</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">if</span> <span class="s1">&#39;ImageJ&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not an ImageJ image description&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">imagej_description</span><span class="p">(</span>
    <span class="n">shape</span><span class="p">,</span>
    <span class="n">rgb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">colormaped</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hyperstack</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return ImageJ image description from data shape.</span>

<span class="sd">    ImageJ can handle up to 6 dimensions in order TZCYXS.</span>

<span class="sd">    &gt;&gt;&gt; imagej_description((51, 5, 2, 196, 171))  # doctest: +SKIP</span>
<span class="sd">    ImageJ=1.11a</span>
<span class="sd">    images=510</span>
<span class="sd">    channels=2</span>
<span class="sd">    slices=5</span>
<span class="sd">    frames=51</span>
<span class="sd">    hyperstack=true</span>
<span class="sd">    mode=grayscale</span>
<span class="sd">    loop=false</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">colormaped</span><span class="p">:</span>
        <span class="n">hyperstack</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ImageJ&#39;</span><span class="p">,</span> <span class="s1">&#39;1.11a&#39;</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">imagej_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="n">rgb</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
    <span class="n">rgb</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="n">append</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;ImageJ=</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;images=</span><span class="si">{</span><span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hyperstack</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hyperstack</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">append</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;hyperstack=true&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">append</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;hyperstack=</span><span class="si">{</span><span class="nb">bool</span><span class="p">(</span><span class="n">hyperstack</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;channels=</span><span class="si">{</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rgb</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">colormaped</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;grayscale&#39;</span>
    <span class="k">if</span> <span class="n">hyperstack</span> <span class="ow">and</span> <span class="n">mode</span><span class="p">:</span>
        <span class="n">append</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;slices=</span><span class="si">{</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;frames=</span><span class="si">{</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">append</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;loop=false&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">append</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;loop=</span><span class="si">{</span><span class="nb">bool</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="s1">&#39;channels&#39;</span><span class="p">,</span> <span class="s1">&#39;slices&#39;</span><span class="p">,</span> <span class="s1">&#39;frames&#39;</span><span class="p">):</span>
            <span class="n">append</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span> <span class="o">+</span> <span class="n">append</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">imagej_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return shape normalized to 6D ImageJ hyperstack TZCYXS.</span>

<span class="sd">    Raise ValueError if not a valid ImageJ hyperstack shape or axes order.</span>

<span class="sd">    &gt;&gt;&gt; imagej_shape((2, 3, 4, 5, 3), False)</span>
<span class="sd">    (2, 3, 4, 5, 3, 1)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">)</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ImageJ hyperstack must be 2-6 dimensional&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">axes</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ndim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ImageJ hyperstack shape and axes do not match&#39;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="s1">&#39;TZCYXS&#39;</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;ImageJ hyperstack axes must be in TZCYXS order&#39;</span>
                <span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
        <span class="n">ndims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">newshape</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="s1">&#39;TZCYXS&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ndims</span> <span class="ow">and</span> <span class="n">ax</span> <span class="o">==</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">newshape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newshape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">newshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;ImageJ hyperstack must contain 1, 3, or 4 samples&#39;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">newshape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rgb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">rgb</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ImageJ hyperstack is not a RGB image&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rgb</span> <span class="ow">and</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ImageJ hyperstack is not a grayscale image&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rgb</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">6</span> <span class="o">-</span> <span class="n">ndim</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">-</span> <span class="n">ndim</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>


<span class="k">def</span> <span class="nf">jpeg_decode_colorspace</span><span class="p">(</span><span class="n">photometric</span><span class="p">,</span> <span class="n">planarconfig</span><span class="p">,</span> <span class="n">extrasamples</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return JPEG and output colorspace for jpeg_decode function.&quot;&quot;&quot;</span>
    <span class="n">colorspace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">outcolorspace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">extrasamples</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">photometric</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
        <span class="c1"># YCBCR -&gt; RGB</span>
        <span class="n">outcolorspace</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># RGB</span>
    <span class="k">elif</span> <span class="n">photometric</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">colorspace</span> <span class="o">=</span> <span class="n">outcolorspace</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># RGB</span>
    <span class="k">elif</span> <span class="n">photometric</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="c1"># CMYK</span>
        <span class="n">outcolorspace</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">photometric</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">outcolorspace</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="p">(</span><span class="n">photometric</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
    <span class="k">return</span> <span class="n">colorspace</span><span class="p">,</span> <span class="n">outcolorspace</span>


<span class="k">def</span> <span class="nf">jpeg_shape</span><span class="p">(</span><span class="n">jpeg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return bitdepth and shape of JPEG image.&quot;&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">jpeg</span><span class="p">):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;H&#39;</span><span class="p">,</span> <span class="n">jpeg</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="n">marker</span> <span class="o">==</span> <span class="mh">0xFFD8</span><span class="p">:</span>
            <span class="c1"># start of image</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">marker</span> <span class="o">==</span> <span class="mh">0xFFD9</span><span class="p">:</span>
            <span class="c1"># end of image</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="mh">0xFFD0</span> <span class="o">&lt;=</span> <span class="n">marker</span> <span class="o">&lt;=</span> <span class="mh">0xFFD7</span><span class="p">:</span>
            <span class="c1"># restart marker</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">marker</span> <span class="o">==</span> <span class="mh">0xFF01</span><span class="p">:</span>
            <span class="c1"># private marker</span>
            <span class="k">continue</span>

        <span class="n">length</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;H&#39;</span><span class="p">,</span> <span class="n">jpeg</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="mh">0xFFC0</span> <span class="o">&lt;=</span> <span class="n">marker</span> <span class="o">&lt;=</span> <span class="mh">0xFFC3</span><span class="p">:</span>
            <span class="c1"># start of frame</span>
            <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;BHHB&#39;</span><span class="p">,</span> <span class="n">jpeg</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">6</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">marker</span> <span class="o">==</span> <span class="mh">0xFFDA</span><span class="p">:</span>
            <span class="c1"># start of scan</span>
            <span class="k">break</span>

        <span class="c1"># skip to next marker</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">2</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no SOF marker found&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">ndpi_jpeg_tile</span><span class="p">(</span><span class="n">jpeg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return tile shape and JPEG header from JPEG with restart markers.&quot;&quot;&quot;</span>
    <span class="n">restartinterval</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sofoffset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sosoffset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">jpeg</span><span class="p">):</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;H&#39;</span><span class="p">,</span> <span class="n">jpeg</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="n">marker</span> <span class="o">==</span> <span class="mh">0xFFD8</span><span class="p">:</span>
            <span class="c1"># start of image</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">marker</span> <span class="o">==</span> <span class="mh">0xFFD9</span><span class="p">:</span>
            <span class="c1"># end of image</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="mh">0xFFD0</span> <span class="o">&lt;=</span> <span class="n">marker</span> <span class="o">&lt;=</span> <span class="mh">0xFFD7</span><span class="p">:</span>
            <span class="c1"># restart marker</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">marker</span> <span class="o">==</span> <span class="mh">0xFF01</span><span class="p">:</span>
            <span class="c1"># private marker</span>
            <span class="k">continue</span>

        <span class="n">length</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;H&#39;</span><span class="p">,</span> <span class="n">jpeg</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="n">marker</span> <span class="o">==</span> <span class="mh">0xFFDD</span><span class="p">:</span>
            <span class="c1"># define restart interval</span>
            <span class="n">restartinterval</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;H&#39;</span><span class="p">,</span> <span class="n">jpeg</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">marker</span> <span class="o">==</span> <span class="mh">0xFFC0</span><span class="p">:</span>
            <span class="c1"># start of frame</span>
            <span class="n">sofoffset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">precision</span><span class="p">,</span> <span class="n">imlength</span><span class="p">,</span> <span class="n">imwidth</span><span class="p">,</span> <span class="n">ncomponents</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                <span class="s1">&#39;&gt;BHHB&#39;</span><span class="p">,</span> <span class="n">jpeg</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">6</span>
            <span class="n">mcuwidth</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">mcuheight</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncomponents</span><span class="p">):</span>
                <span class="n">cid</span><span class="p">,</span> <span class="n">factor</span><span class="p">,</span> <span class="n">table</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;BBB&#39;</span><span class="p">,</span> <span class="n">jpeg</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">])</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">3</span>
                <span class="k">if</span> <span class="n">factor</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="n">mcuwidth</span><span class="p">:</span>
                    <span class="n">mcuwidth</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>
                <span class="k">if</span> <span class="n">factor</span> <span class="o">&amp;</span> <span class="mb">0b00001111</span> <span class="o">&gt;</span> <span class="n">mcuheight</span><span class="p">:</span>
                    <span class="n">mcuheight</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">&amp;</span> <span class="mb">0b00001111</span>
            <span class="n">mcuwidth</span> <span class="o">*=</span> <span class="mi">8</span>
            <span class="n">mcuheight</span> <span class="o">*=</span> <span class="mi">8</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">sofoffset</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="n">marker</span> <span class="o">==</span> <span class="mh">0xFFDA</span><span class="p">:</span>
            <span class="c1"># start of scan</span>
            <span class="n">sosoffset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="k">break</span>

        <span class="c1"># skip to next marker</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">restartinterval</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">sofoffset</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">sosoffset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;missing required JPEG markers&#39;</span><span class="p">)</span>

    <span class="c1"># patch jpeg header for tile size</span>
    <span class="n">tilelength</span> <span class="o">=</span> <span class="n">mcuheight</span>
    <span class="n">tilewidth</span> <span class="o">=</span> <span class="n">restartinterval</span> <span class="o">*</span> <span class="n">mcuwidth</span>
    <span class="n">jpegheader</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">jpeg</span><span class="p">[:</span><span class="n">sofoffset</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;HH&#39;</span><span class="p">,</span> <span class="n">tilelength</span><span class="p">,</span> <span class="n">tilewidth</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">jpeg</span><span class="p">[</span><span class="n">sofoffset</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">:</span> <span class="n">sosoffset</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">tilelength</span><span class="p">,</span> <span class="n">tilewidth</span><span class="p">,</span> <span class="n">jpegheader</span>


<span class="k">def</span> <span class="nf">json_description</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return JSON image description from data shape and other metadata.</span>

<span class="sd">    Return UTF-8 encoded JSON.</span>

<span class="sd">    &gt;&gt;&gt; json_description((256, 256, 3), axes=&#39;YXS&#39;)  # doctest: +SKIP</span>
<span class="sd">    b&#39;{&quot;shape&quot;: [256, 256, 3], &quot;axes&quot;: &quot;YXS&quot;}&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>  <span class="c1"># .encode()</span>


<span class="k">def</span> <span class="nf">json_description_metadata</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return metatata from JSON formated image description as dict.</span>

<span class="sd">    Raise ValuError if description is of unknown format.</span>

<span class="sd">    &gt;&gt;&gt; description = &#39;{&quot;shape&quot;: [256, 256, 3], &quot;axes&quot;: &quot;YXS&quot;}&#39;</span>
<span class="sd">    &gt;&gt;&gt; json_description_metadata(description)  # doctest: +SKIP</span>
<span class="sd">    {&#39;shape&#39;: [256, 256, 3], &#39;axes&#39;: &#39;YXS&#39;}</span>
<span class="sd">    &gt;&gt;&gt; json_description_metadata(&#39;shape=(256, 256, 3)&#39;)</span>
<span class="sd">    {&#39;shape&#39;: (256, 256, 3)}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">description</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shape=&#39;</span><span class="p">:</span>
        <span class="c1"># old-style &#39;shaped&#39; description; not JSON</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">description</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">description</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;{&#39;</span> <span class="ow">and</span> <span class="n">description</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;}&#39;</span><span class="p">:</span>
        <span class="c1"># JSON description</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid JSON image description&#39;</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">fluoview_description_metadata</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">ignoresections</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return metatata from FluoView image description as dict.</span>

<span class="sd">    The FluoView image description format is unspecified. Expect failures.</span>

<span class="sd">    &gt;&gt;&gt; descr = (&#39;[Intensity Mapping]\nMap Ch0: Range=00000 to 02047\n&#39;</span>
<span class="sd">    ...          &#39;[Intensity Mapping End]&#39;)</span>
<span class="sd">    &gt;&gt;&gt; fluoview_description_metadata(descr)</span>
<span class="sd">    {&#39;Intensity Mapping&#39;: {&#39;Map Ch0: Range&#39;: &#39;00000 to 02047&#39;}}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid FluoView image description&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ignoresections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ignoresections</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Region Info (Fields)&#39;</span><span class="p">,</span> <span class="s1">&#39;Protocol Description&#39;</span><span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">sections</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">]</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">description</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;[&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39; End]&#39;</span><span class="p">:</span>
                <span class="c1"># close section</span>
                <span class="k">del</span> <span class="n">sections</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">section</span> <span class="o">=</span> <span class="n">sections</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
                    <span class="n">section</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">section</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LUT &#39;</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">section</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span>
                    <span class="n">section</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
                <span class="k">continue</span>
            <span class="c1"># new section</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LUT &#39;</span><span class="p">:</span>
                <span class="n">section</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ignoresections</span><span class="p">:</span>
                <span class="n">section</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">comment</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">section</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">section</span>
            <span class="k">continue</span>
        <span class="c1"># add entry</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">section</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">section</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">continue</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span>
        <span class="k">if</span> <span class="n">key</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RGB &#39;</span><span class="p">:</span>
            <span class="n">section</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span> <span class="k">for</span> <span class="n">rgb</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">section</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">pilatus_description_metadata</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return metatata from Pilatus image description as dict.</span>

<span class="sd">    Return metadata from Pilatus pixel array detectors by Dectris, created</span>
<span class="sd">    by camserver or TVX software.</span>

<span class="sd">    &gt;&gt;&gt; pilatus_description_metadata(&#39;# Pixel_size 172e-6 m x 172e-6 m&#39;)</span>
<span class="sd">    {&#39;Pixel_size&#39;: (0.000172, 0.000172)}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;# &#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s1">&#39;#:=,()&#39;</span><span class="p">:</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">description</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;  &#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PILATUS_HEADER</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;DateTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                    <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H %M %S.</span><span class="si">%f</span><span class="s1">&#39;</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">continue</span>
        <span class="n">indices</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PILATUS_HEADER</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="c1"># assumes one slice</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">and</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;not&#39;</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NaN&#39;</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">svs_description_metadata</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return metatata from Aperio image description as dict.</span>

<span class="sd">    The Aperio image description format is unspecified. Expect failures.</span>

<span class="sd">    &gt;&gt;&gt; svs_description_metadata(&#39;Aperio Image Library v1.0&#39;)</span>
<span class="sd">    {&#39;Header&#39;: &#39;Aperio Image Library v1.0&#39;}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Aperio &#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid Aperio image description&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; = &#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">stk_description_metadata</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return metadata from MetaMorph image description as list of dict.</span>

<span class="sd">    The MetaMorph image description format is unspecified. Expect failures.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">log_warning</span><span class="p">(</span>
            <span class="s1">&#39;&lt;tifffile.stk_description_metadata&gt; &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">description</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">plane</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span>
                <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">metaseries_description_metadata</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return metatata from MetaSeries image description as dict.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;MetaData&gt;&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid MetaSeries image description&#39;</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">xml.etree</span> <span class="kn">import</span> <span class="n">ElementTree</span> <span class="k">as</span> <span class="n">etree</span>  <span class="c1"># delayed import</span>

    <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;float&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="s1">&#39;int&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">asbool</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="c1"># recursive</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="n">attrib</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">attrib</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attrib</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">attrib</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="n">t</span><span class="p">](</span><span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="n">adict</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="s1">&#39;Description&#39;</span> <span class="ow">in</span> <span class="n">adict</span><span class="p">:</span>
        <span class="n">adict</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adict</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&amp;#13;&amp;#10;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">adict</span>


<span class="k">def</span> <span class="nf">scanimage_description_metadata</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return metatata from ScanImage image description as dict.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">matlabstr2py</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">scanimage_artist_metadata</span><span class="p">(</span><span class="n">artist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return metatata from ScanImage artist tag as dict.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">artist</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">log_warning</span><span class="p">(</span>
            <span class="s1">&#39;&lt;tifffile.scanimage_artist_metadata&gt; &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">olympusini_metadata</span><span class="p">(</span><span class="n">inistr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return OlympusSIS metadata from INI string.</span>

<span class="sd">    No documentation is available.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">keyindex</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="c1"># split key into name and index</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;0123456789&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">index</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bands</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">zpos</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tpos</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">inistr</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;;&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;[&#39;</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;]&#39;</span><span class="p">:</span>
            <span class="n">section_name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="n">section_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">section</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">section_name</span> <span class="o">==</span> <span class="s1">&#39;Dimension&#39;</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;axes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">section_name</span> <span class="o">==</span> <span class="s1">&#39;ASD&#39;</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">section_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">section_name</span> <span class="o">==</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;Dimension&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">section_name</span><span class="p">][</span><span class="s1">&#39;ZPos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zpos</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">section_name</span> <span class="o">==</span> <span class="s1">&#39;Time&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;Dimension&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">section_name</span><span class="p">][</span><span class="s1">&#39;TimePos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpos</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">section_name</span> <span class="o">==</span> <span class="s1">&#39;Band&#39;</span><span class="p">:</span>
                <span class="n">nbands</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Dimension&#39;</span><span class="p">][</span><span class="s1">&#39;Band&#39;</span><span class="p">]</span>
                <span class="n">bands</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;LUT&#39;</span><span class="p">:</span> <span class="p">[]}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbands</span><span class="p">)]</span>
                <span class="n">result</span><span class="p">[</span><span class="n">section_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">bands</span>
                <span class="n">iband</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">astype</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">section_name</span> <span class="o">==</span> <span class="s1">&#39;Dimension&#39;</span><span class="p">:</span>
                <span class="n">section</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">section_name</span> <span class="o">==</span> <span class="s1">&#39;ASD&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;Count&#39;</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ASD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{}]</span> <span class="o">*</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">keyindex</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ASD&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="n">section_name</span> <span class="o">==</span> <span class="s1">&#39;Band&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LUT&#39;</span><span class="p">:</span>
                    <span class="n">lut</span> <span class="o">=</span> <span class="n">bands</span><span class="p">[</span><span class="n">iband</span><span class="p">][</span><span class="s1">&#39;LUT&#39;</span><span class="p">]</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">lut</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">ord</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">ord</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">])]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">iband</span> <span class="o">=</span> <span class="n">keyindex</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">bands</span><span class="p">[</span><span class="n">iband</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="n">key</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ZPos&#39;</span> <span class="ow">and</span> <span class="n">zpos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">zpos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TimePos&#39;</span> <span class="ow">and</span> <span class="n">tpos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tpos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">section</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">if</span> <span class="s1">&#39;axes&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">sisaxes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Band&#39;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">}</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;axes&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sisaxes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
                <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;axes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="s1">&#39;ZPos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="s1">&#39;ZPos&#39;</span><span class="p">][:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Dimension&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">]],</span> <span class="s1">&#39;float64&#39;</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">][</span><span class="s1">&#39;TimePos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">][</span><span class="s1">&#39;TimePos&#39;</span><span class="p">][:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Dimension&#39;</span><span class="p">][</span><span class="s1">&#39;Time&#39;</span><span class="p">]],</span> <span class="s1">&#39;int32&#39;</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">:</span>
        <span class="n">band</span><span class="p">[</span><span class="s1">&#39;LUT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">band</span><span class="p">[</span><span class="s1">&#39;LUT&#39;</span><span class="p">],</span> <span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">unpack_rgb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bitspersample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return array from bytes containing packed samples.</span>

<span class="sd">    Use to unpack RGB565 or RGB555 to RGB888 format.</span>
<span class="sd">    Works on little-endian platforms only.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : byte str</span>
<span class="sd">        The data to be decoded. Samples in each pixel are stored consecutively.</span>
<span class="sd">        Pixels are aligned to 8, 16, or 32 bit boundaries.</span>
<span class="sd">    dtype : numpy.dtype</span>
<span class="sd">        The sample data type. The byteorder applies also to the data stream.</span>
<span class="sd">    bitspersample : tuple</span>
<span class="sd">        Number of bits for each sample in a pixel.</span>
<span class="sd">    rescale : bool</span>
<span class="sd">        Upscale samples to the number of bits in dtype.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        Flattened array of unpacked samples of native dtype.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; data = struct.pack(&#39;BBBB&#39;, 0x21, 0x08, 0xff, 0xff)</span>
<span class="sd">    &gt;&gt;&gt; print(unpack_rgb(data, &#39;&lt;B&#39;, (5, 6, 5), False))</span>
<span class="sd">    [ 1  1  1 31 63 31]</span>
<span class="sd">    &gt;&gt;&gt; print(unpack_rgb(data, &#39;&lt;B&#39;, (5, 6, 5)))</span>
<span class="sd">    [  8   4   8 255 255 255]</span>
<span class="sd">    &gt;&gt;&gt; print(unpack_rgb(data, &#39;&lt;B&#39;, (5, 5, 5)))</span>
<span class="sd">    [ 16   8   8 255 255 255]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bitspersample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bitspersample</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;&lt;B&#39;</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">bits</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">bits</span> <span class="o">&lt;=</span> <span class="mi">32</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bitspersample</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sample size not supported: </span><span class="si">{</span><span class="n">bitspersample</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="s1">&#39;BHI&#39;</span> <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">&gt;=</span> <span class="n">bits</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">+</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bps</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]))</span>
        <span class="n">t</span> <span class="o">&amp;=</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;0b&#39;</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span> <span class="o">*</span> <span class="n">bps</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rescale</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="p">((</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">//</span> <span class="n">bps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">bps</span>
            <span class="k">if</span> <span class="n">o</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">o</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">bps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">//=</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">o</span> <span class="o">-</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">result</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">float24_decode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return float32 array from float24.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;float24_decode&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">zlib_encode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compress Zlib DEFLATE.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">zlib</span>

    <span class="k">return</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">6</span> <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">level</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">zlib_decode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decompress Zlib DEFLATE.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">zlib</span>

    <span class="k">return</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">lzma_encode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compress LZMA.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">lzma</span>

    <span class="k">return</span> <span class="n">lzma</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">lzma_decode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decompress LZMA.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">lzma</span>

    <span class="k">return</span> <span class="n">lzma</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="k">if</span> <span class="n">imagecodecs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">delta_encode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Encode Delta.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dist</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dist </span><span class="si">{</span><span class="n">dist</span><span class="si">}</span><span class="s1"> not implemented&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">if</span> <span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;u</span><span class="si">{</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span>
        <span class="n">key</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">key</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">diff</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">diff</span>

    <span class="k">def</span> <span class="nf">delta_decode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decode Delta.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dist</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dist </span><span class="si">{</span><span class="n">dist</span><span class="si">}</span><span class="s1"> not implemented&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">out</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span>
            <span class="p">)</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;u</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">view</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">view</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bitorder_decode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_bitorder</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Reverse bits in each byte of bytes or numpy array.</span>

<span class="sd">        Decode data where pixels with lower column values are stored in the</span>
<span class="sd">        lower-order bits of the bytes (TIFF FillOrder is LSB2MSB).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : bytes or ndarray</span>
<span class="sd">            The data to be bit reversed. If bytes, a new bit-reversed</span>
<span class="sd">            bytes is returned. Numpy arrays are bit-reversed in-place.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; bitorder_decode(b&#39;\x01\x64&#39;)</span>
<span class="sd">        b&#39;\x80&amp;&#39;</span>
<span class="sd">        &gt;&gt;&gt; data = numpy.array([1, 666], dtype=&#39;uint16&#39;)</span>
<span class="sd">        &gt;&gt;&gt; bitorder_decode(data)</span>
<span class="sd">        &gt;&gt;&gt; data</span>
<span class="sd">        array([  128, 16473], dtype=uint16)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_bitorder</span><span class="p">:</span>
            <span class="n">_bitorder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x80</span><span class="s1">@</span><span class="se">\xc0</span><span class="s1"> </span><span class="se">\xa0</span><span class="s1">`</span><span class="se">\xe0\x10\x90</span><span class="s1">P</span><span class="se">\xd0</span><span class="s1">0</span><span class="se">\xb0</span><span class="s1">p</span><span class="se">\xf0\x08\x88</span><span class="s1">H&#39;</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xc8</span><span class="s1">(</span><span class="se">\xa8</span><span class="s1">h</span><span class="se">\xe8\x18\x98</span><span class="s1">X</span><span class="se">\xd8</span><span class="s1">8</span><span class="se">\xb8</span><span class="s1">x</span><span class="se">\xf8\x04\x84</span><span class="s1">D</span><span class="se">\xc4</span><span class="s1">$</span><span class="se">\xa4</span><span class="s1">d&#39;</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xe4\x14\x94</span><span class="s1">T</span><span class="se">\xd4</span><span class="s1">4</span><span class="se">\xb4</span><span class="s1">t</span><span class="se">\xf4\x0c\x8c</span><span class="s1">L</span><span class="se">\xcc</span><span class="s1">,</span><span class="se">\xac</span><span class="s1">l</span><span class="se">\xec\x1c\x9c</span><span class="s1">&#39;</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\\\xdc</span><span class="s1">&lt;</span><span class="se">\xbc</span><span class="s1">|</span><span class="se">\xfc\x02\x82</span><span class="s1">B</span><span class="se">\xc2</span><span class="s1">&quot;</span><span class="se">\xa2</span><span class="s1">b</span><span class="se">\xe2\x12\x92</span><span class="s1">R</span><span class="se">\xd2</span><span class="s1">2&#39;</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xb2</span><span class="s1">r</span><span class="se">\xf2\n\x8a</span><span class="s1">J</span><span class="se">\xca</span><span class="s1">*</span><span class="se">\xaa</span><span class="s1">j</span><span class="se">\xea\x1a\x9a</span><span class="s1">Z</span><span class="se">\xda</span><span class="s1">:</span><span class="se">\xba</span><span class="s1">z</span><span class="se">\xfa</span><span class="s1">&#39;</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x06\x86</span><span class="s1">F</span><span class="se">\xc6</span><span class="s1">&amp;</span><span class="se">\xa6</span><span class="s1">f</span><span class="se">\xe6\x16\x96</span><span class="s1">V</span><span class="se">\xd6</span><span class="s1">6</span><span class="se">\xb6</span><span class="s1">v</span><span class="se">\xf6\x0e\x8e</span><span class="s1">N&#39;</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xce</span><span class="s1">.</span><span class="se">\xae</span><span class="s1">n</span><span class="se">\xee\x1e\x9e</span><span class="s1">^</span><span class="se">\xde</span><span class="s1">&gt;</span><span class="se">\xbe</span><span class="s1">~</span><span class="se">\xfe\x01\x81</span><span class="s1">A</span><span class="se">\xc1</span><span class="s1">!</span><span class="se">\xa1</span><span class="s1">a&#39;</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xe1\x11\x91</span><span class="s1">Q</span><span class="se">\xd1</span><span class="s1">1</span><span class="se">\xb1</span><span class="s1">q</span><span class="se">\xf1\t\x89</span><span class="s1">I</span><span class="se">\xc9</span><span class="s1">)</span><span class="se">\xa9</span><span class="s1">i</span><span class="se">\xe9\x19</span><span class="s1">&#39;</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x99</span><span class="s1">Y</span><span class="se">\xd9</span><span class="s1">9</span><span class="se">\xb9</span><span class="s1">y</span><span class="se">\xf9\x05\x85</span><span class="s1">E</span><span class="se">\xc5</span><span class="s1">%</span><span class="se">\xa5</span><span class="s1">e</span><span class="se">\xe5\x15\x95</span><span class="s1">U</span><span class="se">\xd5</span><span class="s1">5&#39;</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xb5</span><span class="s1">u</span><span class="se">\xf5\r\x8d</span><span class="s1">M</span><span class="se">\xcd</span><span class="s1">-</span><span class="se">\xad</span><span class="s1">m</span><span class="se">\xed\x1d\x9d</span><span class="s1">]</span><span class="se">\xdd</span><span class="s1">=</span><span class="se">\xbd</span><span class="s1">}</span><span class="se">\xfd</span><span class="s1">&#39;</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x03\x83</span><span class="s1">C</span><span class="se">\xc3</span><span class="s1">#</span><span class="se">\xa3</span><span class="s1">c</span><span class="se">\xe3\x13\x93</span><span class="s1">S</span><span class="se">\xd3</span><span class="s1">3</span><span class="se">\xb3</span><span class="s1">s</span><span class="se">\xf3\x0b\x8b</span><span class="s1">K&#39;</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xcb</span><span class="s1">+</span><span class="se">\xab</span><span class="s1">k</span><span class="se">\xeb\x1b\x9b</span><span class="s1">[</span><span class="se">\xdb</span><span class="s1">;</span><span class="se">\xbb</span><span class="s1">{</span><span class="se">\xfb\x07\x87</span><span class="s1">G</span><span class="se">\xc7\&#39;\xa7</span><span class="s1">g&#39;</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xe7\x17\x97</span><span class="s1">W</span><span class="se">\xd7</span><span class="s1">7</span><span class="se">\xb7</span><span class="s1">w</span><span class="se">\xf7\x0f\x8f</span><span class="s1">O</span><span class="se">\xcf</span><span class="s1">/</span><span class="se">\xaf</span><span class="s1">o</span><span class="se">\xef\x1f\x9f</span><span class="s1">_&#39;</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xdf</span><span class="s1">?</span><span class="se">\xbf\x7f\xff</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="n">_bitorder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">_bitorder</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">_bitorder</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">view</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">view</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">_bitorder</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;slices of arrays not supported&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">packints_encode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bitspersample</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tightly pack integers.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;packints_encode&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">packints_decode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">bitspersample</span><span class="p">,</span> <span class="n">runlen</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decompress bytes to array of integers.</span>

<span class="sd">        This implementation only handles itemsizes 1, 8, 16, 32, and 64 bits.</span>
<span class="sd">        Install the imagecodecs package for decoding other integer sizes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : byte str</span>
<span class="sd">            Data to decompress.</span>
<span class="sd">        dtype : numpy.dtype or str</span>
<span class="sd">            A numpy boolean or integer type.</span>
<span class="sd">        bitspersample : int</span>
<span class="sd">            Number of bits per integer.</span>
<span class="sd">        runlen : int</span>
<span class="sd">            Number of consecutive integers, after which to start at next byte.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; packints_decode(b&#39;a&#39;, &#39;B&#39;, 1)</span>
<span class="sd">        array([0, 1, 1, 0, 0, 0, 0, 1], dtype=uint8)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">bitspersample</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># bitarray</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;|B&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">runlen</span> <span class="o">%</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">runlen</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">runlen</span> <span class="o">%</span> <span class="mi">8</span><span class="p">))</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:</span><span class="n">runlen</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bitspersample</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;unpacking </span><span class="si">{</span><span class="n">bitspersample</span><span class="si">}</span><span class="s1">-bit integers &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;to </span><span class="si">{</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="si">}</span><span class="s1"> not supported&#39;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">packbits_decode</span><span class="p">(</span><span class="n">encoded</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Decompress PackBits encoded byte string.</span>

<span class="sd">        &gt;&gt;&gt; packbits_decode(b&#39;\x80\x80&#39;)  # NOP</span>
<span class="sd">        b&#39;&#39;</span>
<span class="sd">        &gt;&gt;&gt; packbits_decode(b&#39;\x02123&#39;)</span>
<span class="sd">        b&#39;123&#39;</span>
<span class="sd">        &gt;&gt;&gt; packbits_decode(</span>
<span class="sd">        ...   b&#39;\xfe\xaa\x02\x80\x00\x2a\xfd\xaa\x03\x80\x00\x2a\x22\xf7\xaa&#39;</span>
<span class="sd">        ...     )[:-5]</span>
<span class="sd">        b&#39;\xaa\xaa\xaa\x80\x00*\xaa\xaa\xaa\xaa\x80\x00*&quot;\xaa\xaa\xaa\xaa\xaa&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out_extend</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">extend</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">129</span><span class="p">:</span>
                    <span class="c1"># replicate</span>
                    <span class="n">out_extend</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">258</span> <span class="o">-</span> <span class="n">n</span><span class="p">))</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">129</span><span class="p">:</span>
                    <span class="c1"># literal</span>
                    <span class="n">out_extend</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">])</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="n">n</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


<span class="k">else</span><span class="p">:</span>
    <span class="n">bitorder_decode</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">bitorder_decode</span>  <span class="c1"># noqa</span>
    <span class="n">packints_decode</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">packints_decode</span>  <span class="c1"># noqa</span>
    <span class="n">packints_encode</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">packints_encode</span>  <span class="c1"># noqa</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">float24_decode</span> <span class="o">=</span> <span class="n">imagecodecs</span><span class="o">.</span><span class="n">float24_decode</span>  <span class="c1"># noqa</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="k">def</span> <span class="nf">apply_colormap</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">colormap</span><span class="p">,</span> <span class="n">contig</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return palette-colored image.</span>

<span class="sd">    The image values are used to index the colormap on axis 1. The returned</span>
<span class="sd">    image is of shape image.shape+colormap.shape[0] and dtype colormap.dtype.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : numpy.ndarray</span>
<span class="sd">        Indexes into the colormap.</span>
<span class="sd">    colormap : numpy.ndarray</span>
<span class="sd">        RGB lookup table aka palette of shape (3, 2**bits_per_sample).</span>
<span class="sd">    contig : bool</span>
<span class="sd">        If True, return a contiguous array.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; image = numpy.arange(256, dtype=&#39;uint8&#39;)</span>
<span class="sd">    &gt;&gt;&gt; colormap = numpy.vstack([image, image, image]).astype(&#39;uint16&#39;) * 256</span>
<span class="sd">    &gt;&gt;&gt; apply_colormap(image, colormap)[-1]</span>
<span class="sd">    array([65280, 65280, 65280], dtype=uint16)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rollaxis</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">contig</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span>


<span class="k">def</span> <span class="nf">parse_filenames</span><span class="p">(</span>
    <span class="n">files</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">axesorder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">categories</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_shape</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return shape and axes from sequence of file names matching pattern.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : sequence of str</span>
<span class="sd">        Sequence of file names to parse.</span>
<span class="sd">    pattern : str</span>
<span class="sd">        Regular expression pattern matching axes labels and chunk indices</span>
<span class="sd">        in file names. By default, no pattern matching is performed.</span>
<span class="sd">        Axes labels can be specified by matching groups preceding the index</span>
<span class="sd">        groups in the file name, be provided as group names for the index</span>
<span class="sd">        groups, or be omitted.</span>
<span class="sd">        The predefined &#39;axes&#39; pattern matches Olympus OIF and Leica TIFF</span>
<span class="sd">        series.</span>
<span class="sd">    axesorder : sequence of int (optional)</span>
<span class="sd">        Indices of axes in pattern. By default axes are returned in the order</span>
<span class="sd">        they appear in pattern.</span>
<span class="sd">    categories : dict of dicts (optional)</span>
<span class="sd">        Map of index group matches to integer indices.</span>
<span class="sd">        {&#39;axislabel&#39;: {&#39;category&#39;: index}}</span>
<span class="sd">    _shape : tuple of int (optional)</span>
<span class="sd">        Shape of the file sequence. If None (default), the shape is</span>
<span class="sd">        maximum-minimum+1 of the parsed indices for each dimension.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    labels : tuple of str</span>
<span class="sd">        Axes labels for each dimension.</span>
<span class="sd">    shape : tuple of int</span>
<span class="sd">        Shape of file series.</span>
<span class="sd">    indices : sequence of tuples</span>
<span class="sd">        Index of each file in shape.</span>
<span class="sd">    files : sequence of str</span>
<span class="sd">        Filtered sequence of file names.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; parse_filenames(</span>
<span class="sd">    ...     [&#39;c1001.ext&#39;, &#39;c2002.ext&#39;], r&#39;([^\d])(\d)(?P&lt;t&gt;\d+)\.ext&#39;</span>
<span class="sd">    ... )</span>
<span class="sd">    ((&#39;c&#39;, &#39;t&#39;), (2, 2), [(0, 0), (1, 1)], [&#39;c1001.ext&#39;, &#39;c2002.ext&#39;])</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: add option to filter files that do not match pattern</span>

    <span class="n">shape</span> <span class="o">=</span> <span class="n">_shape</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;shape </span><span class="si">{</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),)</span><span class="si">}</span><span class="s1"> does not fit provided shape </span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),),</span>
            <span class="nb">tuple</span><span class="p">((</span><span class="n">i</span><span class="p">,)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">))),</span>
            <span class="n">files</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">pattern</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">FILE_PATTERNS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid pattern&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">categories</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
        <span class="c1"># return axes labels and indices from file name</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">groupindex</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">groupindex</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pattern does not match file name </span><span class="si">{</span><span class="n">fname</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">groupindex</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">groupindex</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">m</span>  <span class="c1"># axis label for next index</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="s1">&#39;Q&#39;</span>  <span class="c1"># no preceding axis letter</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">categories</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>
                <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;invalid index </span><span class="si">{</span><span class="n">m</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
            <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">indices</span>

    <span class="n">normpaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">normpaths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">normpaths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonpath</span><span class="p">(</span><span class="n">normpaths</span><span class="p">)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">normpaths</span><span class="p">:</span>
        <span class="n">lbl</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">fname</span><span class="p">[</span><span class="n">prefix</span><span class="p">:])</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">lbl</span>
            <span class="k">if</span> <span class="n">axesorder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">axesorder</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axesorder</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)))</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;invalid axesorder </span><span class="si">{</span><span class="n">axesorder</span><span class="si">!r}</span><span class="s1"> for </span><span class="si">{</span><span class="n">labels</span><span class="si">!r}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">labels</span> <span class="o">!=</span> <span class="n">lbl</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;axes labels do not match within image sequence&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axesorder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axesorder</span><span class="p">]</span>
        <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">axesorder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axesorder</span><span class="p">)</span>

    <span class="c1"># determine shape</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">intp</span><span class="p">)</span>
    <span class="n">parsedshape</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">startindex</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">-=</span> <span class="n">startindex</span>
        <span class="n">parsedshape</span> <span class="o">-=</span> <span class="n">startindex</span>
        <span class="n">parsedshape</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parsedshape</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsedshape</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
        <span class="n">i</span> <span class="o">&gt;</span> <span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">parsedshape</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;parsed shape </span><span class="si">{</span><span class="n">parsedshape</span><span class="si">}</span><span class="s1"> does not fit provided shape </span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>

    <span class="k">return</span> <span class="n">labels</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">files</span>


<span class="k">def</span> <span class="nf">iter_images</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return iterator over pages in data array of normalized shape.&quot;&quot;&quot;</span>
    <span class="k">yield from</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">iter_tiles</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">tile</span><span class="p">,</span> <span class="n">tiles</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return iterator over tiles in data array of normalized shape.&quot;&quot;&quot;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">chunk</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">tile</span> <span class="o">+</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid tile shape&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ty</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">c1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">ty</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">c2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="n">tx</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">chunk</span><span class="p">[</span><span class="n">c1</span><span class="p">:,</span> <span class="n">c2</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">chunk</span><span class="p">[:</span><span class="n">c1</span><span class="p">,</span> <span class="p">:</span><span class="n">c2</span><span class="p">]</span> <span class="o">=</span> <span class="n">plane</span><span class="p">[</span>
                            <span class="mi">0</span><span class="p">,</span>
                            <span class="n">ty</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">ty</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">c1</span><span class="p">,</span>
                            <span class="n">tx</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">tx</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c2</span><span class="p">,</span>
                        <span class="p">]</span>
                        <span class="k">yield</span> <span class="n">chunk</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">ty</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                            <span class="n">c0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">tz</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">c1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">ty</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">c2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="n">tx</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="n">chunk</span><span class="p">[</span><span class="n">c0</span><span class="p">:,</span> <span class="n">c1</span><span class="p">:,</span> <span class="n">c2</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">chunk</span><span class="p">[:</span><span class="n">c0</span><span class="p">,</span> <span class="p">:</span><span class="n">c1</span><span class="p">,</span> <span class="p">:</span><span class="n">c2</span><span class="p">]</span> <span class="o">=</span> <span class="n">plane</span><span class="p">[</span>
                                <span class="n">tz</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">tz</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">c0</span><span class="p">,</span>
                                <span class="n">ty</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">ty</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c1</span><span class="p">,</span>
                                <span class="n">tx</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">:</span> <span class="n">tx</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">c2</span><span class="p">,</span>
                            <span class="p">]</span>
                            <span class="k">if</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="c1"># squeeze for image compressors</span>
                                <span class="k">yield</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">yield</span> <span class="n">chunk</span>


<span class="k">def</span> <span class="nf">pad_tile</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return tile padded to tile shape.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tile</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">dtype</span> <span class="ow">or</span> <span class="n">tile</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">&gt;</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid tile shape or dtype&#39;</span><span class="p">)</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">tile</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="n">pad</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">reorient</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">orientation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return reoriented view of image array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : numpy.ndarray</span>
<span class="sd">        Non-squeezed output of asarray() functions.</span>
<span class="sd">        Axes -3 and -2 must be image length and width respectively.</span>
<span class="sd">    orientation : int or str</span>
<span class="sd">        One of TIFF.ORIENTATION names or values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orient</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">ORIENTATION</span>
    <span class="n">orientation</span> <span class="o">=</span> <span class="n">enumarg</span><span class="p">(</span><span class="n">orient</span><span class="p">,</span> <span class="n">orientation</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">orient</span><span class="o">.</span><span class="n">TOPLEFT</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">image</span>
    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">orient</span><span class="o">.</span><span class="n">TOPRIGHT</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">orient</span><span class="o">.</span><span class="n">BOTLEFT</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">orient</span><span class="o">.</span><span class="n">BOTRIGHT</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">orient</span><span class="o">.</span><span class="n">LEFTTOP</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">orient</span><span class="o">.</span><span class="n">RIGHTTOP</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">orient</span><span class="o">.</span><span class="n">RIGHTBOT</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">orient</span><span class="o">.</span><span class="n">LEFTBOT</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">image</span>


<span class="k">def</span> <span class="nf">repeat_nd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">repeats</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return read-only view into input array with elements repeated.</span>

<span class="sd">    Zoom nD image by integer factors using nearest neighbor interpolation</span>
<span class="sd">    (box filter).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a : array-like</span>
<span class="sd">        Input array.</span>
<span class="sd">    repeats : sequence of int</span>
<span class="sd">        The number of repetitions to apply along each dimension of input array.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; repeat_nd([[1, 2], [3, 4]], (2, 2))</span>
<span class="sd">    array([[1, 1, 2, 2],</span>
<span class="sd">           [1, 1, 2, 2],</span>
<span class="sd">           [3, 3, 4, 4],</span>
<span class="sd">           [3, 3, 4, 4]])</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">reshape</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">strides</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">strides</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">repeats</span><span class="p">):</span>
        <span class="n">shape</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
        <span class="n">strides</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">reshape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">strides</span><span class="p">,</span> <span class="n">writeable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">reshape</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">reshape_nd</span><span class="p">(</span><span class="n">data_or_shape</span><span class="p">,</span> <span class="n">ndim</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return image array or shape with at least ndim dimensions.</span>

<span class="sd">    Prepend 1s to image shape as necessary.</span>

<span class="sd">    &gt;&gt;&gt; reshape_nd(numpy.empty(0), 1).shape</span>
<span class="sd">    (0,)</span>
<span class="sd">    &gt;&gt;&gt; reshape_nd(numpy.empty(1), 2).shape</span>
<span class="sd">    (1, 1)</span>
<span class="sd">    &gt;&gt;&gt; reshape_nd(numpy.empty((2, 3)), 3).shape</span>
<span class="sd">    (1, 2, 3)</span>
<span class="sd">    &gt;&gt;&gt; reshape_nd(numpy.empty((3, 4, 5)), 3).shape</span>
<span class="sd">    (3, 4, 5)</span>
<span class="sd">    &gt;&gt;&gt; reshape_nd((2, 3), 3)</span>
<span class="sd">    (1, 2, 3)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_shape</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_or_shape</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">data_or_shape</span> <span class="k">if</span> <span class="n">is_shape</span> <span class="k">else</span> <span class="n">data_or_shape</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ndim</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data_or_shape</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span> <span class="o">+</span> <span class="n">shape</span>
    <span class="k">return</span> <span class="n">shape</span> <span class="k">if</span> <span class="n">is_shape</span> <span class="k">else</span> <span class="n">data_or_shape</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">squeeze_axes</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return shape and axes with single-dimensional entries removed.</span>

<span class="sd">    Remove unused dimensions unless their axes are listed in &#39;skip&#39;.</span>

<span class="sd">    &gt;&gt;&gt; squeeze_axes((5, 1, 2, 1, 1), &#39;TZYXC&#39;)</span>
<span class="sd">    ((5, 2, 1), &#39;TYX&#39;)</span>

<span class="sd">    &gt;&gt;&gt; squeeze_axes((1,), &#39;Q&#39;)</span>
<span class="sd">    ((1,), &#39;Q&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;dimensions of axes and shape do not match&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">skip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="s1">&#39;XY&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shape_squeezed</span><span class="p">,</span> <span class="n">axes_squeezed</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="o">*</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">skip</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c1"># not enough values to unpack, return last axis</span>
        <span class="n">shape_squeezed</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">axes_squeezed</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape_squeezed</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes_squeezed</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">transpose_axes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">asaxes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return image with its axes permuted to match specified axes.</span>

<span class="sd">    A view is returned if possible.</span>

<span class="sd">    &gt;&gt;&gt; transpose_axes(numpy.zeros((2, 3, 4, 5)), &#39;TYXC&#39;, asaxes=&#39;CTZYX&#39;).shape</span>
<span class="sd">    (5, 2, 1, 3, 4)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">asaxes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unknown axis </span><span class="si">{</span><span class="n">ax</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># add missing axes to image</span>
    <span class="k">if</span> <span class="n">asaxes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">asaxes</span> <span class="o">=</span> <span class="s1">&#39;CTZYX&#39;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">asaxes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">+</span> <span class="n">axes</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">shape</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># transpose axes</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="n">axes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">asaxes</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">image</span>


<span class="k">def</span> <span class="nf">reshape_axes</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">newshape</span><span class="p">,</span> <span class="n">unknown</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return axes matching new shape.</span>

<span class="sd">    By default, unknown dimensions are labelled &#39;Q&#39;.</span>

<span class="sd">    &gt;&gt;&gt; reshape_axes(&#39;YXS&#39;, (219, 301, 1), (219, 301))</span>
<span class="sd">    &#39;YX&#39;</span>
<span class="sd">    &gt;&gt;&gt; reshape_axes(&#39;IYX&#39;, (12, 219, 301), (3, 4, 219, 1, 301, 1))</span>
<span class="sd">    &#39;QQYQXQ&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">newshape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">newshape</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;axes do not match shape&#39;</span><span class="p">)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">newsize</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">newshape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="n">newsize</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cannot reshape </span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">newshape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">axes</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">newshape</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="n">lendiff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">newshape</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">lendiff</span><span class="p">:</span>
        <span class="n">newshape</span> <span class="o">=</span> <span class="n">newshape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="n">lendiff</span>

    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">prodns</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">prods</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ns</span> <span class="ow">in</span> <span class="n">newshape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">prodns</span> <span class="o">*=</span> <span class="n">ns</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ns</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">ns</span> <span class="o">==</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">prodns</span> <span class="o">==</span> <span class="n">prods</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">prods</span> <span class="o">*=</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">unknown</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unknown</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unknown</span> <span class="o">=</span> <span class="s1">&#39;Q&#39;</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unknown</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">lendiff</span><span class="p">:]))</span>


<span class="k">def</span> <span class="nf">subresolution</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return level of subresolution of series or page b vs a.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">axes</span> <span class="o">!=</span> <span class="n">b</span><span class="o">.</span><span class="n">axes</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">b</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">level</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">in</span> <span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">p</span> <span class="o">**</span> <span class="n">r</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">((</span><span class="n">i</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">level</span> <span class="o">=</span> <span class="n">r</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">p</span> <span class="o">**</span> <span class="n">level</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">((</span><span class="n">i</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">level</span>


<span class="k">def</span> <span class="nf">pyramidize_series</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">isreduced</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pyramidize list of TiffPageSeries in-place.</span>

<span class="sd">    TiffPageSeries that are a subresolution of another TiffPageSeries are</span>
<span class="sd">    appended to the other&#39;s TiffPageSeries levels and removed from the list.</span>
<span class="sd">    Levels are to be ordered by size using the same downsampling factor.</span>
<span class="sd">    TiffPageSeries of subifds cannot be pyramid top levels.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">samplingfactors</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="c1"># subifds cannot be pyramid top levels</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">isreduced</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">b</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">is_reduced</span><span class="p">:</span>
                <span class="c1"># pyramid levels must be reduced</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>  <span class="c1"># not a pyramid level</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">samplingfactors</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">subresolution</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">f</span>
                        <span class="k">break</span>  <span class="c1"># not a pyramid level</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>  <span class="c1"># not a pyramid level</span>
            <span class="k">elif</span> <span class="n">subresolution</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="n">a</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">series</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">stack_pages</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxworkers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read data from sequence of TiffPage/Frame and stack them vertically.</span>

<span class="sd">    Additional parameters are passsed to the TiffPage.asarray function.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">npages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">npages</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no pages&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">npages</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;maxworkers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxworkers</span>
        <span class="k">return</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">page0</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">keyframe</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pages</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">npages</span><span class="p">,)</span> <span class="o">+</span> <span class="n">page0</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">page0</span><span class="o">.</span><span class="n">dtype</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">create_output</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>

    <span class="c1"># TODO: benchmark and optimize this</span>
    <span class="k">if</span> <span class="n">maxworkers</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">maxworkers</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># auto-detect</span>
        <span class="n">page_maxworkers</span> <span class="o">=</span> <span class="n">page0</span><span class="o">.</span><span class="n">maxworkers</span>
        <span class="n">maxworkers</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">npages</span><span class="p">,</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">MAXWORKERS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maxworkers</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">page_maxworkers</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">maxworkers</span> <span class="o">=</span> <span class="n">page_maxworkers</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">npages</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">maxworkers</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">page_maxworkers</span> <span class="o">&lt;=</span> <span class="mi">2</span>
            <span class="ow">and</span> <span class="n">page0</span><span class="o">.</span><span class="n">compression</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="n">page0</span><span class="o">.</span><span class="n">fillorder</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="n">page0</span><span class="o">.</span><span class="n">predictor</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="n">maxworkers</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">page_maxworkers</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">maxworkers</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">maxworkers</span> <span class="o">=</span> <span class="n">page_maxworkers</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">npages</span> <span class="o">&gt;</span> <span class="n">maxworkers</span> <span class="ow">or</span> <span class="n">page0</span><span class="o">.</span><span class="n">maxworkers</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">page_maxworkers</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">page_maxworkers</span> <span class="o">=</span> <span class="n">maxworkers</span>
        <span class="n">maxworkers</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;maxworkers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_maxworkers</span>

    <span class="n">filehandle</span> <span class="o">=</span> <span class="n">page0</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
    <span class="n">haslock</span> <span class="o">=</span> <span class="n">filehandle</span><span class="o">.</span><span class="n">has_lock</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">haslock</span> <span class="ow">and</span> <span class="n">maxworkers</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">page_maxworkers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">filehandle</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">filecache</span> <span class="o">=</span> <span class="n">FileCache</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">maxworkers</span><span class="p">),</span> <span class="n">lock</span><span class="o">=</span><span class="n">filehandle</span><span class="o">.</span><span class="n">lock</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">filecache</span><span class="o">=</span><span class="n">filecache</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># read, decode, and copy page data</span>
        <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filecache</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="p">)</span>
            <span class="n">page</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lock</span><span class="o">=</span><span class="n">filecache</span><span class="o">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">filecache</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">maxworkers</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
            <span class="n">func</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">page0</span><span class="o">.</span><span class="n">decode</span>  <span class="c1"># init TiffPage.decode function</span>
        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">maxworkers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">npages</span><span class="p">)):</span>
                <span class="k">pass</span>

    <span class="n">filecache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">haslock</span><span class="p">:</span>
        <span class="n">filehandle</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">create_output</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return numpy array where image data of shape and dtype can be copied.</span>

<span class="sd">    The &#39;out&#39; parameter may have the following values or types:</span>

<span class="sd">    None</span>
<span class="sd">        A zeroed array of shape and dtype is created and returned.</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        An existing writable array of compatible dtype and shape. A view of</span>
<span class="sd">        the same array is returned after verification.</span>
<span class="sd">    &#39;memmap&#39; or &#39;memmap:tempdir&#39;</span>
<span class="sd">        A memory-map to an array stored in a temporary binary file on disk</span>
<span class="sd">        is created and returned.</span>
<span class="sd">    str or open file</span>
<span class="sd">        The file name or file object used to create a memory-map to an array</span>
<span class="sd">        stored in a binary file on disk. The created memory-mapped array is</span>
<span class="sd">        returned.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fillvalue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fillvalue</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">fillvalue</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="n">product</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;incompatible output shape&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">can_cast</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;incompatible output dtype&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">out</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;memmap&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>

        <span class="n">tempdir</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;.memmap&#39;</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">tempdir</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">matlabstr2py</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return Python object from Matlab string representation.</span>

<span class="sd">    Return str, bool, int, float, list (Matlab arrays or cells), or</span>
<span class="sd">    dict (Matlab structures) types.</span>

<span class="sd">    Use to access ScanImage metadata.</span>

<span class="sd">    &gt;&gt;&gt; matlabstr2py(&#39;1&#39;)</span>
<span class="sd">    1</span>
<span class="sd">    &gt;&gt;&gt; matlabstr2py(&quot;[&#39;x y z&#39; true false; 1 2.0 -3e4; NaN Inf @class]&quot;)</span>
<span class="sd">    [[&#39;x y z&#39;, True, False], [1, 2.0, -30000.0], [nan, inf, &#39;@class&#39;]]</span>
<span class="sd">    &gt;&gt;&gt; d = matlabstr2py(</span>
<span class="sd">    ...     &quot;SI.hChannels.channelType = {&#39;stripe&#39; &#39;stripe&#39;}\n&quot;</span>
<span class="sd">    ...     &quot;SI.hChannels.channelsActive = 2&quot;</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; d[&#39;SI.hChannels.channelType&#39;]</span>
<span class="sd">    [&#39;stripe&#39;, &#39;stripe&#39;]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: handle invalid input</span>
    <span class="c1"># TODO: review unboxing of multidimensional arrays</span>

    <span class="k">def</span> <span class="nf">lex</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="c1"># return sequence of tokens from matlab string representation</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;[&#39;</span><span class="p">]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">next_token</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;;&#39;</span><span class="p">:</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;[&#39;</span><span class="p">:</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;]&#39;</span><span class="p">:</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tokens</span>

    <span class="k">def</span> <span class="nf">next_token</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="c1"># return next token in matlab string</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39; &#39;</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">length</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">i</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;{[;]}&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39; {[;]}&#39;</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="n">j</span>

    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fail</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># return Python value of token</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fail</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="k">return</span> <span class="n">s</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fail</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">or</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fail</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&gt;&#39;</span> <span class="ow">or</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">if</span> <span class="n">fail</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="s2">&quot; &#39;;[]</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;@&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;zeros(&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ones(&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">s</span> <span class="ow">or</span> <span class="s1">&#39;e&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># nan, inf</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fail</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="c1"># return Python value from string representation of Matlab value</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fail</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">add2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">add2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">lex</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="s1">&#39;[{&#39;</span><span class="p">:</span>
                <span class="n">add2</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="ow">in</span> <span class="s1">&#39;]}&#39;</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">levels</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">add2</span> <span class="o">=</span> <span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">add2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">add2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">string</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">string</span><span class="p">:</span>
        <span class="c1"># structure</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;%&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">k</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s2">&quot; &#39;;[]</span><span class="si">{}</span><span class="s2">&lt;&gt;&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>
    <span class="k">return</span> <span class="n">parse</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">stripnull</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return string truncated at first null character.</span>

<span class="sd">    Clean NULL terminated C strings. For Unicode strings use null=&#39;\0&#39;.</span>

<span class="sd">    &gt;&gt;&gt; stripnull(b&#39;string\x00\x00&#39;)</span>
<span class="sd">    b&#39;string&#39;</span>
<span class="sd">    &gt;&gt;&gt; stripnull(b&#39;string\x00string\x00\x00&#39;, first=False)</span>
<span class="sd">    b&#39;string\x00string&#39;</span>
<span class="sd">    &gt;&gt;&gt; stripnull(&#39;string\x00&#39;, null=&#39;\0&#39;)</span>
<span class="sd">    &#39;string&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">string</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">string</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
    <span class="n">null</span> <span class="o">=</span> <span class="n">null</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">null</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">string</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">stripascii</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return string truncated at last byte that is 7-bit ASCII.</span>

<span class="sd">    Clean NULL separated and terminated TIFF strings.</span>

<span class="sd">    &gt;&gt;&gt; stripascii(b&#39;string\x00string\n\x01\x00&#39;)</span>
<span class="sd">    b&#39;string\x00string\n&#39;</span>
<span class="sd">    &gt;&gt;&gt; stripascii(b&#39;\x00&#39;)</span>
<span class="sd">    b&#39;&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: pythonize this</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="mi">8</span> <span class="o">&lt;</span> <span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">127</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">string</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">asbool</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">true</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">false</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return string as bool if possible, else raise TypeError.</span>

<span class="sd">    &gt;&gt;&gt; asbool(b&#39; False &#39;)</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; asbool(&#39;ON&#39;, [&#39;on&#39;], [&#39;off&#39;])</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">isbytes</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">true</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="n">isbytes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">false</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">isbytes</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">true</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">false</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">raise</span> <span class="ne">TypeError</span>


<span class="k">def</span> <span class="nf">astype</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return argument as one of types if possible.</span>

<span class="sd">    &gt;&gt;&gt; astype(&#39;42&#39;)</span>
<span class="sd">    42</span>
<span class="sd">    &gt;&gt;&gt; astype(&#39;3.14&#39;)</span>
<span class="sd">    3.14</span>
<span class="sd">    &gt;&gt;&gt; astype(&#39;True&#39;)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; astype(b&#39;Neee-Wom&#39;)</span>
<span class="sd">    &#39;Neee-Wom&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">types</span> <span class="o">=</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">asbool</span><span class="p">,</span> <span class="n">bytes2str</span>
    <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">typ</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">UnicodeEncodeError</span><span class="p">):</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">format_size</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1536</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return file size as string from byte size.</span>

<span class="sd">    &gt;&gt;&gt; format_size(1234)</span>
<span class="sd">    &#39;1234 B&#39;</span>
<span class="sd">    &gt;&gt;&gt; format_size(12345678901)</span>
<span class="sd">    &#39;11.50 GiB&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1"> B&#39;</span>
    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;KiB&#39;</span><span class="p">,</span> <span class="s1">&#39;MiB&#39;</span><span class="p">,</span> <span class="s1">&#39;GiB&#39;</span><span class="p">,</span> <span class="s1">&#39;TiB&#39;</span><span class="p">,</span> <span class="s1">&#39;PiB&#39;</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">/=</span> <span class="mf">1024.0</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">size</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="s1">&#39;ginormous&#39;</span>


<span class="k">def</span> <span class="nf">identityfunc</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Single argument identity function.</span>

<span class="sd">    &gt;&gt;&gt; identityfunc(&#39;arg&#39;)</span>
<span class="sd">    &#39;arg&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">arg</span>


<span class="k">def</span> <span class="nf">nullfunc</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Null function.</span>

<span class="sd">    &gt;&gt;&gt; nullfunc(&#39;arg&#39;, kwarg=&#39;kwarg&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">sequence</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return tuple containing value if value is not a tuple or list.</span>

<span class="sd">    &gt;&gt;&gt; sequence(1)</span>
<span class="sd">    (1,)</span>
<span class="sd">    &gt;&gt;&gt; sequence([1])</span>
<span class="sd">    [1]</span>
<span class="sd">    &gt;&gt;&gt; sequence(&#39;ab&#39;)</span>
<span class="sd">    (&#39;ab&#39;,)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="k">else</span> <span class="p">(</span><span class="n">value</span><span class="p">,)</span>


<span class="k">def</span> <span class="nf">product</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return product of sequence of numbers.</span>

<span class="sd">    Equivalent of functools.reduce(operator.mul, iterable, 1).</span>
<span class="sd">    Multiplying numpy integers might overflow.</span>

<span class="sd">    &gt;&gt;&gt; product([2**8, 2**30])</span>
<span class="sd">    274877906944</span>
<span class="sd">    &gt;&gt;&gt; product([])</span>
<span class="sd">    1</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prod</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="n">prod</span> <span class="o">*=</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">prod</span>


<span class="k">def</span> <span class="nf">natural_sorted</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return human sorted list of strings.</span>

<span class="sd">    E.g. for sorting file names.</span>

<span class="sd">    &gt;&gt;&gt; natural_sorted([&#39;f1&#39;, &#39;f2&#39;, &#39;f10&#39;])</span>
<span class="sd">    [&#39;f1&#39;, &#39;f2&#39;, &#39;f10&#39;]</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">sortkey</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">else</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">x</span><span class="p">)]</span>

    <span class="n">numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">sortkey</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">epics_datetime</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">nsec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return datetime object from epicsTSSec and epicsTSNsec tag values.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">sec</span> <span class="o">+</span> <span class="mi">631152000</span> <span class="o">+</span> <span class="n">nsec</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">excel_datetime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return datetime object from timestamp in Excel serial format.</span>

<span class="sd">    Convert LSM time stamps.</span>

<span class="sd">    &gt;&gt;&gt; excel_datetime(40237.029999999795)</span>
<span class="sd">    datetime.datetime(2010, 2, 28, 0, 43, 11, 999982)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="mi">693594</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">epoch</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">julian_datetime</span><span class="p">(</span><span class="n">julianday</span><span class="p">,</span> <span class="n">milisecond</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return datetime from days since 1/1/4713 BC and ms since midnight.</span>

<span class="sd">    Convert Julian dates according to MetaMorph.</span>

<span class="sd">    &gt;&gt;&gt; julian_datetime(2451576, 54362783)</span>
<span class="sd">    datetime.datetime(2000, 2, 2, 15, 6, 2, 783)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">julianday</span> <span class="o">&lt;=</span> <span class="mi">1721423</span><span class="p">:</span>
        <span class="c1"># no datetime before year 1</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">julianday</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">2299160</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">trunc</span><span class="p">((</span><span class="n">a</span> <span class="o">-</span> <span class="mf">1867216.25</span><span class="p">)</span> <span class="o">/</span> <span class="mf">36524.25</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">//</span> <span class="mi">4</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1524</span> <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">1721423</span> <span class="k">else</span> <span class="mi">1158</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">trunc</span><span class="p">((</span><span class="n">b</span> <span class="o">-</span> <span class="mf">122.1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">365.25</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">trunc</span><span class="p">(</span><span class="mf">365.25</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">trunc</span><span class="p">((</span><span class="n">b</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="mf">30.6001</span><span class="p">)</span>

    <span class="n">day</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">d</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">trunc</span><span class="p">(</span><span class="mf">30.6001</span> <span class="o">*</span> <span class="n">e</span><span class="p">)</span>
    <span class="n">month</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="mf">13.5</span> <span class="k">else</span> <span class="mi">13</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="p">(</span><span class="mi">4716</span> <span class="k">if</span> <span class="n">month</span> <span class="o">&gt;</span> <span class="mf">2.5</span> <span class="k">else</span> <span class="mi">4715</span><span class="p">)</span>

    <span class="n">hour</span><span class="p">,</span> <span class="n">milisecond</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">milisecond</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">minute</span><span class="p">,</span> <span class="n">milisecond</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">milisecond</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">second</span><span class="p">,</span> <span class="n">milisecond</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">milisecond</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">milisecond</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">byteorder_isnative</span><span class="p">(</span><span class="n">byteorder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return if byteorder matches the system&#39;s byteorder.</span>

<span class="sd">    &gt;&gt;&gt; byteorder_isnative(&#39;=&#39;)</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span> <span class="ow">or</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;big&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">byteorder</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">)</span> <span class="o">==</span> <span class="n">keys</span><span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">byteorder_compare</span><span class="p">(</span><span class="n">byteorder</span><span class="p">,</span> <span class="n">byteorder2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return if byteorders match.</span>

<span class="sd">    &gt;&gt;&gt; byteorder_compare(&#39;&lt;&#39;, &#39;&lt;&#39;)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; byteorder_compare(&#39;&gt;&#39;, &#39;&lt;&#39;)</span>
<span class="sd">    False</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="n">byteorder2</span> <span class="ow">or</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;|&#39;</span> <span class="ow">or</span> <span class="n">byteorder2</span> <span class="o">==</span> <span class="s1">&#39;|&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
        <span class="n">byteorder</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;big&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">}[</span><span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">byteorder2</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
        <span class="n">byteorder2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;big&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">}[</span><span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="n">byteorder2</span>


<span class="k">def</span> <span class="nf">recarray2dict</span><span class="p">(</span><span class="n">recarray</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return numpy.recarray as dict.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: subarrays</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">descr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">recarray</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">descr</span><span class="p">,</span> <span class="n">recarray</span><span class="p">):</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">descr</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dtype</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">xml2dict</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return XML as dict.</span>

<span class="sd">    &gt;&gt;&gt; xml2dict(&#39;&lt;?xml version=&quot;1.0&quot; ?&gt;&lt;root attr=&quot;name&quot;&gt;&lt;key&gt;1&lt;/key&gt;&lt;/root&gt;&#39;)</span>
<span class="sd">    {&#39;root&#39;: {&#39;key&#39;: 1, &#39;attr&#39;: &#39;name&#39;}}</span>
<span class="sd">    &gt;&gt;&gt; xml2dict(&#39;&lt;level1&gt;&lt;level2&gt;3.5322&lt;/level2&gt;&lt;/level1&gt;&#39;)</span>
<span class="sd">    {&#39;level1&#39;: {&#39;level2&#39;: 3.5322}}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">xml.etree</span> <span class="kn">import</span> <span class="n">ElementTree</span> <span class="k">as</span> <span class="n">etree</span>  <span class="c1"># delayed import</span>

    <span class="n">at</span> <span class="o">=</span> <span class="n">tx</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="n">at</span><span class="p">,</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">prefix</span>

    <span class="k">def</span> <span class="nf">astype</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="c1"># return string value as int, float, bool, or unchanged</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">asbool</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">t</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">etree2dict</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="c1"># adapted from https://stackoverflow.com/a/10077069/453463</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">tag</span>
        <span class="k">if</span> <span class="n">sanitize</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">attrib</span> <span class="k">else</span> <span class="kc">None</span><span class="p">}</span>
        <span class="n">children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dc</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">etree2dict</span><span class="p">,</span> <span class="n">children</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">astype</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">astype</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">astype</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">at</span> <span class="o">+</span> <span class="n">k</span><span class="p">,</span> <span class="n">astype</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">children</span> <span class="ow">or</span> <span class="n">t</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">tx</span> <span class="o">+</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">return</span> <span class="n">etree2dict</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">xml</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">hexdump</span><span class="p">(</span><span class="n">bytestr</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">snipat</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">modulo</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ellipsis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return hexdump representation of bytes.</span>

<span class="sd">    &gt;&gt;&gt; hexdump(binascii.unhexlify(&#39;49492a00080000000e00fe0004000100&#39;))</span>
<span class="sd">    &#39;49 49 2a 00 08 00 00 00 0e 00 fe 00 04 00 01 00 II*.............&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bytestr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">height</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="n">bytesperline</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="n">modulo</span> <span class="o">*</span> <span class="p">(((</span><span class="n">width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span> <span class="o">//</span> <span class="n">modulo</span><span class="p">),</span> <span class="n">size</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">bytesperline</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="n">nlines</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">0</span><span class="si">%i</span><span class="s1">x: &#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="si">%x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">size</span><span class="p">)</span>
        <span class="n">bytesperline</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="n">modulo</span> <span class="o">*</span> <span class="p">(((</span><span class="n">width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">addr</span> <span class="o">%</span> <span class="mi">1</span><span class="p">))</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span> <span class="o">//</span> <span class="n">modulo</span><span class="p">),</span> <span class="n">size</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">bytesperline</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">bytesperline</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">addr</span> <span class="o">%</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">nlines</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">bytesperline</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">snipat</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">snipat</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">snipat</span> <span class="o">=</span> <span class="n">height</span>
    <span class="k">elif</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">snipat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">snipat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">snipat</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">snipat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">snipat</span> <span class="o">+=</span> <span class="n">height</span>

    <span class="k">if</span> <span class="n">height</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nlines</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bytestr</span><span class="p">[:</span><span class="n">bytesperline</span><span class="p">])]</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="n">height</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">bytesperline</span>
    <span class="k">elif</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">nlines</span> <span class="o">&lt;=</span> <span class="n">height</span><span class="p">:</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bytestr</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">snipat</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">bytesperline</span> <span class="o">*</span> <span class="p">(</span><span class="n">nlines</span> <span class="o">-</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[(</span><span class="n">start</span><span class="p">,</span> <span class="n">bytestr</span><span class="p">[</span><span class="n">start</span><span class="p">:])]</span>  <span class="c1"># (start, None)</span>
    <span class="k">elif</span> <span class="n">snipat</span> <span class="o">&gt;=</span> <span class="n">height</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">bytesperline</span> <span class="o">*</span> <span class="n">height</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bytestr</span><span class="p">[:</span><span class="n">end</span><span class="p">])]</span>  <span class="c1"># (end, None)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end1</span> <span class="o">=</span> <span class="n">bytesperline</span> <span class="o">*</span> <span class="n">snipat</span>
        <span class="n">end2</span> <span class="o">=</span> <span class="n">bytesperline</span> <span class="o">*</span> <span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">snipat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bytestr</span><span class="p">[:</span><span class="n">end1</span><span class="p">]),</span>
            <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">end1</span> <span class="o">-</span> <span class="n">end2</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">end2</span><span class="p">,</span> <span class="n">bytestr</span><span class="p">[</span><span class="n">size</span> <span class="o">-</span> <span class="n">end2</span> <span class="p">:]),</span>
        <span class="p">]</span>

    <span class="n">ellipsis</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;...&#39;</span> <span class="k">if</span> <span class="n">ellipsis</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ellipsis</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;cp1252&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">bytestr</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bytestr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ellipsis</span><span class="p">)</span>  <span class="c1"># &#39;skip %i bytes&#39; % start)</span>
            <span class="k">continue</span>
        <span class="n">hexstr</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">bytestr</span><span class="p">)</span>
        <span class="n">strstr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">br</span><span class="s1">&#39;[^\x20-\x7f]&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">bytestr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bytestr</span><span class="p">),</span> <span class="n">bytesperline</span><span class="p">):</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">hexstr</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">bytesperline</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">start</span><span class="p">))</span> <span class="k">if</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">addr</span>
            <span class="n">r</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">bytesperline</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">r</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
            <span class="n">r</span> <span class="o">+=</span> <span class="n">strstr</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">bytesperline</span><span class="p">]</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">isprintable</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return if all characters in string are printable.</span>

<span class="sd">    &gt;&gt;&gt; isprintable(&#39;abc&#39;)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; isprintable(b&#39;\01&#39;)</span>
<span class="sd">    False</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">string</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">isprintable</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">isprintable</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="k">def</span> <span class="nf">clean_whitespace</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return string with compressed whitespace.&quot;&quot;&quot;</span>
    <span class="n">string</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">compact</span><span class="p">:</span>
        <span class="n">string</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[ &#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">pformat_xml</span><span class="p">(</span><span class="n">xml</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return pretty formatted XML.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>  <span class="c1"># delayed import</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">xml</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">xml</span><span class="p">))</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span>
            <span class="n">tree</span><span class="p">,</span>
            <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">tree</span><span class="o">.</span><span class="n">docinfo</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">xml</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&gt;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;</span><span class="se">\n</span><span class="s1">&lt;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xml</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pformat</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">79</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return pretty formatted representation of object as string.</span>

<span class="sd">    Whitespace might be altered.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">height</span> <span class="o">=</span> <span class="mi">1024</span>
    <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mi">256</span>

    <span class="n">npopt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">get_printoptions</span><span class="p">()</span>
    <span class="n">numpy</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">arg</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&lt;?xml&#39;</span> <span class="ow">or</span> <span class="n">arg</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;OME&gt;&#39;</span><span class="p">:</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">isprintable</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">clean_whitespace</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="o">**</span><span class="n">npopt</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">hexdump</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="n">modulo</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">arg</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&lt;?xml&#39;</span> <span class="ow">or</span> <span class="n">arg</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;OME&gt;&#39;</span><span class="p">:</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[:</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">width</span><span class="p">]</span> <span class="k">if</span> <span class="n">height</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">pformat_xml</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="c1"># too slow</span>
        <span class="c1"># else:</span>
        <span class="c1">#    import textwrap  # delayed import</span>
        <span class="c1">#    return &#39;\n&#39;.join(</span>
        <span class="c1">#        textwrap.wrap(arg, width=width, max_lines=height, tabsize=2)</span>
        <span class="c1">#    )</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">record</span><span class="p">):</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">pprint</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pprint</span>  <span class="c1"># delayed import</span>

        <span class="n">arg</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="n">compact</span><span class="p">)</span>

    <span class="n">numpy</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="o">**</span><span class="n">npopt</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">height</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[:</span> <span class="n">width</span> <span class="o">*</span> <span class="n">width</span><span class="p">]</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">clean_whitespace</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arg</span><span class="p">[:</span><span class="n">width</span><span class="p">]</span>

    <span class="n">argl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">height</span><span class="p">:</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">line</span><span class="p">[:</span><span class="n">width</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">argl</span><span class="p">[:</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;...&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">argl</span><span class="p">[</span><span class="o">-</span><span class="n">height</span> <span class="o">//</span> <span class="mi">2</span> <span class="p">:]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">[:</span><span class="n">width</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">argl</span><span class="p">[:</span><span class="n">height</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">arg</span>


<span class="k">def</span> <span class="nf">snipstr</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">79</span><span class="p">,</span> <span class="n">snipat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ellipsis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return string cut to specified length.</span>

<span class="sd">    &gt;&gt;&gt; snipstr(&#39;abcdefghijklmnop&#39;, 8)</span>
<span class="sd">    &#39;abc...op&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">snipat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">snipat</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="k">if</span> <span class="n">ellipsis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">ellipsis</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;...&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ellipsis</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\u2026</span><span class="s1">&#39;</span>
    <span class="n">esize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ellipsis</span><span class="p">)</span>

    <span class="n">splitlines</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="c1"># TODO: finish and test multiline snip</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">splitlines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ellipsis</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">linelen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">linelen</span> <span class="o">&lt;=</span> <span class="n">width</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">split</span> <span class="o">=</span> <span class="n">snipat</span>
        <span class="k">if</span> <span class="n">split</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">split</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">split</span> <span class="o">=</span> <span class="n">linelen</span>
        <span class="k">elif</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">split</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">linelen</span> <span class="o">*</span> <span class="n">split</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">split</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">split</span> <span class="o">+=</span> <span class="n">linelen</span>
            <span class="k">if</span> <span class="n">split</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">split</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">esize</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="n">esize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">split</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="o">-</span><span class="n">width</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">[:</span><span class="n">width</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">split</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ellipsis</span> <span class="o">+</span> <span class="n">string</span><span class="p">[</span><span class="n">esize</span> <span class="o">-</span> <span class="n">width</span> <span class="p">:])</span>
        <span class="k">elif</span> <span class="n">split</span> <span class="o">&gt;=</span> <span class="n">linelen</span> <span class="ow">or</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="n">esize</span> <span class="o">+</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">[:</span> <span class="n">width</span> <span class="o">-</span> <span class="n">esize</span><span class="p">]</span> <span class="o">+</span> <span class="n">ellipsis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">splitlen</span> <span class="o">=</span> <span class="n">linelen</span> <span class="o">-</span> <span class="n">width</span> <span class="o">+</span> <span class="n">esize</span>
            <span class="n">end1</span> <span class="o">=</span> <span class="n">split</span> <span class="o">-</span> <span class="n">splitlen</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">end2</span> <span class="o">=</span> <span class="n">end1</span> <span class="o">+</span> <span class="n">splitlen</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">[:</span><span class="n">end1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ellipsis</span> <span class="o">+</span> <span class="n">string</span><span class="p">[</span><span class="n">end2</span><span class="p">:])</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">enumstr</span><span class="p">(</span><span class="n">enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return short string representation of Enum instance.&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">enum</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name</span>


<span class="k">def</span> <span class="nf">enumarg</span><span class="p">(</span><span class="n">enum</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return enum member from its name or value.</span>

<span class="sd">    &gt;&gt;&gt; enumarg(TIFF.PHOTOMETRIC, 2)</span>
<span class="sd">    &lt;PHOTOMETRIC.RGB: 2&gt;</span>
<span class="sd">    &gt;&gt;&gt; enumarg(TIFF.PHOTOMETRIC, &#39;RGB&#39;)</span>
<span class="sd">    &lt;PHOTOMETRIC.RGB: 2&gt;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">enum</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">enum</span><span class="p">[</span><span class="n">arg</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;invalid argument </span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parse_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">keyvalues</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return dict with keys from keys|keyvals and values from kwargs|keyvals.</span>

<span class="sd">    Existing keys are deleted from kwargs.</span>

<span class="sd">    &gt;&gt;&gt; kwargs = {&#39;one&#39;: 1, &#39;two&#39;: 2, &#39;four&#39;: 4}</span>
<span class="sd">    &gt;&gt;&gt; kwargs2 = parse_kwargs(kwargs, &#39;two&#39;, &#39;three&#39;, four=None, five=5)</span>
<span class="sd">    &gt;&gt;&gt; kwargs == {&#39;one&#39;: 1}</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; kwargs2 == {&#39;two&#39;: 2, &#39;four&#39;: 4, &#39;five&#39;: 5}</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">keyvalues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">update_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">keyvalues</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update dict with keys and values if keys do not already exist.</span>

<span class="sd">    &gt;&gt;&gt; kwargs = {&#39;one&#39;: 1, }</span>
<span class="sd">    &gt;&gt;&gt; update_kwargs(kwargs, one=None, two=2)</span>
<span class="sd">    &gt;&gt;&gt; kwargs == {&#39;one&#39;: 1, &#39;two&#39;: 2}</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">keyvalues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">log_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Log message with level WARNING.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">logging</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">validate_jhove</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">jhove</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate TIFF file using jhove -m TIFF-hul.</span>

<span class="sd">    Raise ValueError if jhove outputs an error message unless the message</span>
<span class="sd">    contains one of the strings in &#39;ignore&#39;.</span>

<span class="sd">    JHOVE does not support bigtiff or more than 50 IFDs.</span>

<span class="sd">    See `JHOVE TIFF-hul Module &lt;http://jhove.sourceforge.net/tiff-hul.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>

    <span class="k">if</span> <span class="n">ignore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ignore</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;More than 50 IFDs&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">jhove</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">jhove</span> <span class="o">=</span> <span class="s1">&#39;jhove&#39;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="n">jhove</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;TIFF-hul&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;ErrorMessage: &#39;</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;ErrorMessage: &#39;</span><span class="p">):</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">14</span><span class="p">:]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">error</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="k">break</span>


<span class="k">def</span> <span class="nf">tiffcomment</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return or replace ImageDescription value in first page of TIFF file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="mi">270</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">comment</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;r+b&#39;</span>
    <span class="k">with</span> <span class="n">TiffFile</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no </span><span class="si">{</span><span class="n">TIFF</span><span class="o">.</span><span class="n">TAGS</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="si">}</span><span class="s1"> tag found&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span>
        <span class="n">tag</span><span class="o">.</span><span class="n">overwrite</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">tiff2fsspec</span><span class="p">(</span>
    <span class="n">filename</span><span class="p">,</span>
    <span class="n">url</span><span class="p">,</span>
    <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">chunkmode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write fsspec ReferenceFileSystem JSON from TIFF file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span>
    <span class="k">with</span> <span class="n">TiffFile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">tif</span><span class="o">.</span><span class="n">aszarr</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">chunkmode</span><span class="o">=</span><span class="n">chunkmode</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
            <span class="n">store</span><span class="o">.</span><span class="n">write_fsspec</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">lsm2bin</span><span class="p">(</span><span class="n">lsmfile</span><span class="p">,</span> <span class="n">binfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert [MP]TZCYX LSM file to series of BIN files.</span>

<span class="sd">    One BIN file containing &#39;ZCYX&#39; data are created for each position, time,</span>
<span class="sd">    and tile. The position, time, and tile indices are encoded at the end</span>
<span class="sd">    of the filenames.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="nb">print</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">nullfunc</span>

    <span class="k">if</span> <span class="n">tile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tile</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">binfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">binfile</span> <span class="o">=</span> <span class="n">lsmfile</span>
    <span class="k">elif</span> <span class="n">binfile</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="n">binfile</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">binfile</span><span class="p">:</span>
        <span class="n">binfile</span> <span class="o">+=</span> <span class="s1">&#39;_(z</span><span class="si">%i</span><span class="s1">c</span><span class="si">%i</span><span class="s1">y</span><span class="si">%i</span><span class="s1">x</span><span class="si">%i</span><span class="s1">)_m</span><span class="si">%%</span><span class="s1">ip</span><span class="si">%%</span><span class="s1">it</span><span class="si">%%</span><span class="s1">03iy</span><span class="si">%%</span><span class="s1">ix</span><span class="si">%%</span><span class="s1">i.bin&#39;</span>

    <span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Opening LSM file... &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">TiffFile</span><span class="p">(</span><span class="n">lsmfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">lsm</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lsm</span><span class="o">.</span><span class="n">is_lsm</span><span class="p">:</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">lsm</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not a LSM file&#39;</span><span class="p">)</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">lsm</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># first series contains the image data</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">get_axes</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>

        <span class="n">verbose</span><span class="p">(</span><span class="n">timer</span><span class="p">)</span>
        <span class="c1"># verbose(lsm, flush=True)</span>
        <span class="n">verbose</span><span class="p">(</span>
            <span class="s1">&#39;Image</span><span class="se">\n</span><span class="s1">  axes:  </span><span class="si">{}</span><span class="se">\n</span><span class="s1">  shape: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">  dtype: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">  size:  </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">axes</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">format_size</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">series</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;TZCYX&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not a *TZCYX LSM file&#39;</span><span class="p">)</span>

        <span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Copying image from LSM to BIN files&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">tiles</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="n">tile</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">tile</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">binfile</span><span class="p">:</span>
            <span class="n">binfile</span> <span class="o">=</span> <span class="n">binfile</span> <span class="o">%</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span> <span class="o">+</span> <span class="n">shape</span>
        <span class="c1"># cache for ZCYX stacks and output files</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
            <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
        <span class="p">)</span>
        <span class="c1"># iterate over Tiff pages containing data</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># mosaic axis</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># position axis</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>  <span class="c1"># time axis</span>
                    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>  <span class="c1"># z slices</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># tile y</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># tile x</span>
                            <span class="n">out</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span>
                                <span class="o">...</span><span class="p">,</span>
                                <span class="n">y</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">x</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="p">]</span>
                            <span class="k">if</span> <span class="n">binfile</span><span class="p">:</span>
                                <span class="n">out</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">binfile</span> <span class="o">%</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
                            <span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">photometric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">planarconfig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bitspersample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">figure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">96</span><span class="p">,</span>
    <span class="n">subplot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">maxdim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot n-dimensional images using matplotlib.pyplot.</span>

<span class="sd">    Return figure, subplot, and plot axis.</span>
<span class="sd">    Requires pyplot already imported C{from matplotlib import pyplot}.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : nd array</span>
<span class="sd">        The image data.</span>
<span class="sd">    photometric : {&#39;MINISWHITE&#39;, &#39;MINISBLACK&#39;, &#39;RGB&#39;, or &#39;PALETTE&#39;}</span>
<span class="sd">        The color space of the image data.</span>
<span class="sd">    planarconfig : {&#39;CONTIG&#39; or &#39;SEPARATE&#39;}</span>
<span class="sd">        Defines how components of each pixel are stored.</span>
<span class="sd">    bitspersample : int</span>
<span class="sd">        Number of bits per channel in integer RGB images.</span>
<span class="sd">    interpolation : str</span>
<span class="sd">        The image interpolation method used in matplotlib.imshow. By default,</span>
<span class="sd">        &#39;nearest&#39; is used for image dimensions &lt;= 512, else &#39;bilinear&#39;.</span>
<span class="sd">    cmap : str or matplotlib.colors.Colormap</span>
<span class="sd">        The colormap maps non-RGBA scalar data to colors.</span>
<span class="sd">    vmin, vmax : scalar</span>
<span class="sd">        Data range covered by the colormap. By default, the complete</span>
<span class="sd">        range of the data is covered.</span>
<span class="sd">    figure : matplotlib.figure.Figure</span>
<span class="sd">        Matplotlib figure to use for plotting.</span>
<span class="sd">    title : str</span>
<span class="sd">        Window and subplot title.</span>
<span class="sd">    subplot : int</span>
<span class="sd">        A matplotlib.pyplot.subplot axis.</span>
<span class="sd">    maxdim : int</span>
<span class="sd">        Maximum image width and length.</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        Additional arguments for matplotlib.pyplot.imshow.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: rewrite detection of isrgb, iscontig</span>
    <span class="c1"># TODO: use planarconfig</span>
    <span class="k">if</span> <span class="n">photometric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">photometric</span> <span class="o">=</span> <span class="s1">&#39;RGB&#39;</span>
    <span class="k">if</span> <span class="n">maxdim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">maxdim</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">16</span>
    <span class="n">isrgb</span> <span class="o">=</span> <span class="n">photometric</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="s1">&#39;YCBCR&#39;</span><span class="p">)</span>  <span class="c1"># &#39;PALETTE&#39;, &#39;YCBCR&#39;</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;float16&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
        <span class="n">isrgb</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">isrgb</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="ow">or</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="p">):</span>
        <span class="n">isrgb</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">photometric</span> <span class="o">=</span> <span class="s1">&#39;MINISBLACK&#39;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">photometric</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;MINISWHITE&#39;</span><span class="p">,</span> <span class="s1">&#39;MINISBLACK&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">reshape_nd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">reshape_nd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">dims</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span>
    <span class="k">if</span> <span class="n">dims</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not an image&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dims</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">isrgb</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">isrgb</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">isrgb</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">8</span>
            <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">//</span> <span class="mi">8</span>
        <span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">isrgb</span> <span class="o">=</span> <span class="n">isrgb</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">dims</span> <span class="o">-=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">isrgb</span> <span class="k">else</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">interpolation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="mi">512</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">interpolation</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">interpolation</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">isrgb</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">maxdim</span><span class="p">,</span> <span class="p">:</span><span class="n">maxdim</span><span class="p">,</span> <span class="p">:</span><span class="n">maxdim</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;bilinear&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">maxdim</span><span class="p">,</span> <span class="p">:</span><span class="n">maxdim</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;bilinear&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span>

    <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="s1">&#39;PALETTE&#39;</span> <span class="ow">and</span> <span class="n">isrgb</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">datamax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">datamax</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">datamax</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span>  <span class="c1"># possible precision loss</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s1">&#39;ui&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">isrgb</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">bitspersample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bitspersample</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">bitspersample</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="c1"># bitspersample can be tuple, e.g. (5, 6, 5)</span>
            <span class="n">bitspersample</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="n">datamax</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">bitspersample</span>
        <span class="k">if</span> <span class="n">isrgb</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bitspersample</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">bitspersample</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">bitspersample</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">bitspersample</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span>  <span class="c1"># precision loss</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nodata</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mf">1e30</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">datamax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">datamax</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">isrgb</span> <span class="ow">and</span> <span class="n">datamax</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">/=</span> <span class="n">datamax</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="n">datamax</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
        <span class="n">datamax</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">datamax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">datamax</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">isrgb</span><span class="p">:</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">datamax</span>
        <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>
                <span class="n">dtmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">min</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">vmin</span> <span class="o">==</span> <span class="n">dtmin</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">dtmin</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
                <span class="n">dtmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">min</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">vmin</span> <span class="o">==</span> <span class="n">dtmin</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">dtmin</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">pyplot</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;matplotlib.pyplot&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">figure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;sans-serif&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span>
            <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">10.3</span><span class="p">,</span> <span class="mf">6.3</span><span class="p">),</span>
            <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span> <span class="k">if</span> <span class="n">title</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span>
            <span class="n">bottom</span><span class="o">=</span><span class="mf">0.03</span> <span class="o">*</span> <span class="p">(</span><span class="n">dims</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">top</span><span class="o">=</span><span class="mf">0.98</span> <span class="o">-</span> <span class="n">size</span> <span class="o">*</span> <span class="mf">0.03</span><span class="p">,</span>
            <span class="n">left</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
            <span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="n">wspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">subplot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subplot</span> <span class="o">=</span> <span class="mi">111</span>
    <span class="n">subplot</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">subplot</span><span class="p">)</span>
    <span class="n">subplot</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="s1">&#39;Windows-1252&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s1">&#39;buf&#39;</span> <span class="ow">or</span> <span class="n">vmin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;coolwarm&#39;</span>
        <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="s1">&#39;MINISWHITE&#39;</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">+=</span> <span class="s1">&#39;_r&#39;</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="n">dims</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()),</span>
        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
        <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">isrgb</span><span class="p">:</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>  <span class="c1"># panchor=(0.55, 0.5), fraction=0.05</span>

    <span class="k">def</span> <span class="nf">format_coord</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c1"># callback function to format coordinate display in toolbar</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dims</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">curaxdat</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span><span class="si">}</span><span class="s1"> @ </span><span class="si">{</span><span class="n">current</span><span class="si">}</span><span class="s1"> [</span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s1">4</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">4</span><span class="si">}</span><span class="s1">]&#39;</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span><span class="si">}</span><span class="s1"> @ [</span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s1">4</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">4</span><span class="si">}</span><span class="s1">]&#39;</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">none</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="n">subplot</span><span class="o">.</span><span class="n">format_coord</span> <span class="o">=</span> <span class="n">format_coord</span>
    <span class="n">image</span><span class="o">.</span><span class="n">get_cursor_data</span> <span class="o">=</span> <span class="n">none</span>
    <span class="n">image</span><span class="o">.</span><span class="n">format_cursor_data</span> <span class="o">=</span> <span class="n">none</span>

    <span class="k">if</span> <span class="n">dims</span><span class="p">:</span>
        <span class="n">current</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="n">dims</span><span class="p">)</span>
        <span class="n">curaxdat</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">current</span><span class="p">)]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()]</span>
        <span class="n">sliders</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.03</span> <span class="o">*</span> <span class="p">(</span><span class="n">axis</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">0.725</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">]),</span>
                <span class="sa">f</span><span class="s1">&#39;Dimension </span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">,</span>
                <span class="n">valfmt</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;%.0f [</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">slider</span> <span class="ow">in</span> <span class="n">sliders</span><span class="p">:</span>
            <span class="n">slider</span><span class="o">.</span><span class="n">drawon</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">def</span> <span class="nf">set_image</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">sliders</span><span class="o">=</span><span class="n">sliders</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">):</span>
            <span class="c1"># change image and redraw canvas</span>
            <span class="n">curaxdat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">current</span><span class="p">)]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">image</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">curaxdat</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sliders</span><span class="p">,</span> <span class="n">current</span><span class="p">):</span>
                <span class="n">ctrl</span><span class="o">.</span><span class="n">eventson</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">ctrl</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="n">ctrl</span><span class="o">.</span><span class="n">eventson</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">on_changed</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="n">current</span><span class="p">):</span>
            <span class="c1"># callback function for slider change event</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
            <span class="n">curaxdat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">current</span><span class="p">[</span><span class="n">axis</span><span class="p">]:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">current</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">set_image</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">on_keypressed</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="n">current</span><span class="p">):</span>
            <span class="c1"># callback function for key press event</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">curaxdat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">in</span> <span class="s1">&#39;0123456789&#39;</span><span class="p">:</span>
                <span class="n">on_changed</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
                <span class="n">on_changed</span><span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
                <span class="n">on_changed</span><span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
                <span class="n">curaxdat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">axis</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span>
                <span class="n">curaxdat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">axis</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
                <span class="n">on_changed</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;home&#39;</span><span class="p">:</span>
                <span class="n">on_changed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>

        <span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">on_keypressed</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sliders</span><span class="p">):</span>
            <span class="n">ctrl</span><span class="o">.</span><span class="n">on_changed</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">axis</span><span class="p">:</span> <span class="n">on_changed</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">figure</span><span class="p">,</span> <span class="n">subplot</span><span class="p">,</span> <span class="n">image</span>


<span class="k">def</span> <span class="nf">_app_show</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Block the GUI. For use as skimage plugin.&quot;&quot;&quot;</span>
    <span class="n">pyplot</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;matplotlib.pyplot&#39;</span><span class="p">]</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">askopenfilename</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return file name(s) from Tkinter&#39;s file open dialog.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">Tk</span><span class="p">,</span> <span class="n">filedialog</span>

    <span class="n">root</span> <span class="o">=</span> <span class="n">Tk</span><span class="p">()</span>
    <span class="n">root</span><span class="o">.</span><span class="n">withdraw</span><span class="p">()</span>
    <span class="n">root</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">filedialog</span><span class="o">.</span><span class="n">askopenfilename</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">root</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">filenames</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Tifffile command line usage main function.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">logging</span>
    <span class="kn">import</span> <span class="nn">optparse</span>  <span class="c1"># TODO: use argparse</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span>
        <span class="n">usage</span><span class="o">=</span><span class="s1">&#39;usage: %prog [options] path&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Display image data in TIFF files.&#39;</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;%prog </span><span class="si">{</span><span class="n">__version__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">prog</span><span class="o">=</span><span class="s1">&#39;tifffile&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span>
    <span class="n">opt</span><span class="p">(</span>
        <span class="s1">&#39;-p&#39;</span><span class="p">,</span>
        <span class="s1">&#39;--page&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;page&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;display single page&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span>
        <span class="s1">&#39;-s&#39;</span><span class="p">,</span>
        <span class="s1">&#39;--series&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;series&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;display series of pages of same shape&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span>
        <span class="s1">&#39;-l&#39;</span><span class="p">,</span>
        <span class="s1">&#39;--level&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;level&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;display pyramid level of series&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span>
        <span class="s1">&#39;--nomultifile&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;nomultifile&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;do not read OME series from multiple files&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span>
        <span class="s1">&#39;--noplots&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;noplots&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;maximum number of plots&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span>
        <span class="s1">&#39;--interpol&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;interpol&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;INTERPOL&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;image interpolation method&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s1">&#39;--dpi&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;dpi&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">96</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;plot resolution&#39;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span>
        <span class="s1">&#39;--vmin&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;vmin&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;minimum value for colormapping&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span>
        <span class="s1">&#39;--vmax&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;maximum value for colormapping&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span>
        <span class="s1">&#39;--debug&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;raise exception on failures&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span>
        <span class="s1">&#39;--doctest&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;doctest&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;runs the docstring examples&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--detail&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;detail&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s1">&#39;-q&#39;</span><span class="p">,</span> <span class="s1">&#39;--quiet&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;quiet&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>

    <span class="n">settings</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">doctest</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">doctest</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">tifffile.tifffile</span> <span class="k">as</span> <span class="nn">m</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">optionflags</span><span class="o">=</span><span class="n">doctest</span><span class="o">.</span><span class="n">ELLIPSIS</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">askopenfilename</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Select a TIFF file&#39;</span><span class="p">,</span> <span class="n">filetypes</span><span class="o">=</span><span class="n">TIFF</span><span class="o">.</span><span class="n">FILEOPEN_FILTER</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No file specified&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">path</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="s1">&#39;?*&#39;</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No files match the pattern&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># TODO: handle image sequences</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Reading TIFF header:&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tif</span> <span class="o">=</span> <span class="n">TiffFile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">_multifile</span><span class="o">=</span><span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">nomultifile</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">timer</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tif</span><span class="o">.</span><span class="n">is_ome</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">norgb</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">noplots</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading image data: &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">notnone</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">page</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">images</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span>
                        <span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">page</span><span class="p">),</span>
                        <span class="n">tif</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">page</span><span class="p">],</span>
                        <span class="kc">None</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">series</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">series</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">series</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">level</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">level</span>
                <span class="k">elif</span> <span class="n">series</span><span class="o">.</span><span class="n">is_pyramidal</span> <span class="ow">and</span> <span class="n">product</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span><span class="p">:</span>
                    <span class="n">level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">series</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
                        <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">product</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span><span class="p">:</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">images</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span>
                        <span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">series</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">),</span>
                        <span class="n">notnone</span><span class="p">(</span><span class="n">tif</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">_pages</span><span class="p">),</span>
                        <span class="n">tif</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">series</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tif</span><span class="o">.</span><span class="n">series</span><span class="p">[:</span> <span class="n">settings</span><span class="o">.</span><span class="n">noplots</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
                            <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">product</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">31</span><span class="p">:</span>
                                <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span>
                                <span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">),</span>
                                <span class="n">notnone</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">_pages</span><span class="p">),</span>
                                <span class="n">tif</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="n">notnone</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pages</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                            <span class="k">raise</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Series </span><span class="si">{}</span><span class="s1"> failed with </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">... &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">i</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">exc</span>
                            <span class="p">),</span>
                            <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                        <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">timer</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generating report:&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;   &#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">TiffFile</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">tif</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">detail</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">timer</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
    <span class="n">tif</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">images</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">noplots</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib</span>

            <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;TkAgg&#39;</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&lt;tifffile.main&gt; </span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">keyframe</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">keyframe</span>
                <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">vmin</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">vmax</span>
                <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">nodata</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">vmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">&gt;</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">nodata</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">if</span> <span class="n">tif</span><span class="o">.</span><span class="n">is_stk</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">vmin</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">stk_metadata</span><span class="p">[</span><span class="s1">&#39;MinScale&#39;</span><span class="p">]</span>
                        <span class="n">vmax</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">stk_metadata</span><span class="p">[</span><span class="s1">&#39;MaxScale&#39;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">vmax</span> <span class="o">&lt;=</span> <span class="n">vmin</span><span class="p">:</span>
                            <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">vmin</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">vmax</span>
                <span class="k">if</span> <span class="n">series</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">series</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="se">\n</span><span class="s1"> </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">photometric</span> <span class="o">=</span> <span class="s1">&#39;MINISBLACK&#39;</span>
                <span class="k">if</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">photometric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
                    <span class="n">photometric</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">photometric</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                <span class="n">imshow</span><span class="p">(</span>
                    <span class="n">img</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                    <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
                    <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                    <span class="n">bitspersample</span><span class="o">=</span><span class="n">keyframe</span><span class="o">.</span><span class="n">bitspersample</span><span class="p">,</span>
                    <span class="n">nodata</span><span class="o">=</span><span class="n">keyframe</span><span class="o">.</span><span class="n">nodata</span><span class="p">,</span>
                    <span class="n">photometric</span><span class="o">=</span><span class="n">photometric</span><span class="p">,</span>
                    <span class="n">interpolation</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">interpol</span><span class="p">,</span>
                    <span class="n">dpi</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">dpi</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">bytes2str</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;strict&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return Unicode string from encoded bytes.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;cp1252&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">bytestr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;cp1252&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return bytes from Unicode string, else pass through.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">s</span>


<span class="c1"># aliases and deprecated</span>
<span class="n">imsave</span> <span class="o">=</span> <span class="n">imwrite</span>
<span class="n">TiffWriter</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="n">TiffWriter</span><span class="o">.</span><span class="n">write</span>
<span class="n">TiffReader</span> <span class="o">=</span> <span class="n">TiffFile</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Hanjin Liu.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>